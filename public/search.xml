<?xml version="1.0" encoding="utf-8"?>
<search> 
  
    
    <entry>
      <title><![CDATA[颠覆发展-读《极简欧洲史》]]></title>
      <url>/2020/02/02/%E9%A2%A0%E8%A6%86%E5%8F%91%E5%B1%95-%E8%AF%BB%E3%80%8A%E6%9E%81%E7%AE%80%E6%AC%A7%E6%B4%B2%E5%8F%B2%E3%80%8B/</url>
      <content type="html"><![CDATA[<blockquote>
<p>我们的目的是找出欧洲文明的基本元素，看这些元素如何通过时间重新组合，从古旧中重塑新的样貌。<br><strong>看旧的东西如何屹立不倒，风云再现，肺炎亦然！</strong></p>
</blockquote>
<h3 id="一、先说肺炎"><a href="#一、先说肺炎" class="headerlink" title="一、先说肺炎"></a>一、先说肺炎</h3><p><strong>1.1、针对肺炎知识</strong><br>推荐一篇介绍文章，很用心。回形针：<a href="https://mp.weixin.qq.com/s/fnu8urcvf3qrq6WDIIJWZg" target="_blank" rel="external">关于肺炎的一切</a>。(推荐再忙也看看）</p>
<p><strong>1.2、针对思考方式</strong><br>也推荐一篇文章，多数观点认可。量子学派：<a href="https://mp.weixin.qq.com/s/6LE8bjAVPBkmLau8RbKhYQ" target="_blank" rel="external">越是在关键时刻，越是要独立思考</a></p>
<p><strong>1.3、针对红十字会</strong><br>暴露了才能解决问题，相信一定会有更高效的组织来颠覆发展，就像新教发展基督教一样！</p>
<blockquote>
<p>中世纪多数人加入圣职体制的初衷：<code>只是因为他是当时最庞大也是最有钱的组织</code>。</p>
</blockquote>
<p><strong>1.4、针对疫情</strong><br>面对疫情，衷心的感谢各位医疗工作者、一线人员的付出和努力！<br>多难兴邦，相信大家众志成城，定能度过难关，深度复盘！<br>也希望各位小伙伴，<code>带上口罩，勤洗手</code>！</p>
<p><strong>1.5 针对小页面</strong></p>
<blockquote>
<p>个人尤为触动的是，本着力所能及开发了几个页面，却得到了远超预期的反馈和协助，也让自己看到，<code>真的有一大批人在默默的做着一些事情！</code></p>
</blockquote>
<p>mark一下，第一次访问流量过万，第一次发起github项目，再接再厉！<br><strong>github</strong>：<a href="https://github.com/cuihuan/2019_nCov" target="_blank" rel="external">https://github.com/cuihuan/2019_nCov</a><br><strong>网站</strong>：<a href="http://cuihuan.net/wuhan/news.html">http://cuihuan.net/wuhan/news.html</a></p>
<p><a href="http://cuihuan.net/wp_content/new/book/2019-nCov.jpeg"><img src="http://cuihuan.net/wp_content/new/book/2019-nCov.jpeg" alt="2019-nCov"></a></p>
<h3 id="二、概述"><a href="#二、概述" class="headerlink" title="二、概述"></a>二、概述</h3><p>言归正传，春节结束前读完了这本书，短小精悍。不同于一般按照时间逻辑，<strong>本书采用平行结构，以希腊&amp;罗马文化，基督教文化和日耳曼战士文化三要素的角度阐述了欧洲的简史</strong>。</p>
<p>极简欧洲史虽缺少了历史辩证全面的思考，但多了几分演义的色彩，值得一读。</p>
<p>全书分为两大部分，先总述，后展开。</p>
<ul>
<li>第一部分，概述了希腊罗马文化，基督教文化和日耳曼战士文化，如何产生、迭代、融合，形成中世纪政教合一的社会。</li>
<li>第二部分，分场景阐述了文艺复兴、宗教改革、启蒙运动、科学革命、浪漫主义思潮、世界大战等，如何造就了当今的欧洲文化。</li>
</ul>
<p>总的来看，<strong>欧洲文明是个不断颠覆发展的过程，欧洲文明最大发明就是科学本身！</strong></p>
<p><a href="http://cuihuan.net/wp_content/new/book/jijianouzhoushi.jpeg"><img src="http://cuihuan.net/wp_content/new/book/jijianouzhoushi.jpeg" alt="极简欧洲史"></a></p>
<h3 id="三、文章摘录"><a href="#三、文章摘录" class="headerlink" title="三、文章摘录"></a>三、文章摘录</h3><blockquote>
<p>欧洲文明的三个基本元素：希腊&amp;罗马文化，基督教，日耳曼战士文化</p>
</blockquote>
<blockquote>
<p>欧洲文明分为三个时代：古典时代，中世纪和近代</p>
</blockquote>
<blockquote>
<p>希腊文化：<code>唯有答案简单，才能近乎正确</code>。</p>
</blockquote>
<blockquote>
<p>十诫首戒：除我以外，你不可有别的神<br>犹太人一直相信，宇宙只有一个神，这是极不寻常的观点，希腊人和罗马人憧憬多神，这比较普遍。</p>
</blockquote>
<blockquote>
<p>三大元素的第一次结合是君士坦丁大帝赋予了基督教合法地位。<br>日耳曼：能靠流血换到的东西却去汗流浃背，是没骨气，等而下的事情。<br>日耳曼战士支持基督教是最后一个连接</p>
</blockquote>
<blockquote>
<p>耶稣回答：凯撒的归凯撒，上帝的归上帝。<br>你应当全心、全灵、全意爱耶和华你的天竺，要爱你的邻居如同爱你自己。<br><code>耶稣把犹太人的道德教训转化成了宇宙大爱。他关于爱的教诲，凌驾于一切法律之上</code>。</p>
</blockquote>
<blockquote>
<p>几何学是个简单，有呀，有逻辑的系统，非常赏心；几何学是引导人类认知宇宙本质的一个途径。</p>
</blockquote>
<blockquote>
<p>欧洲贵族：’土地你拿去，其他留给我’，<code>&#39;并非所有的东西都贵国王所有&#39;，是欧洲政府思维的基石</code>。</p>
</blockquote>
<blockquote>
<p><code>对政府有所设限</code>对经济的发展有举足轻重的影响，欧洲经济之所以能够一飞冲天，成长速度非其他地区所能比拟，”商人有保障“是个关键</p>
</blockquote>
<blockquote>
<p>文艺复兴：行动像天使，悟性像神明。</p>
</blockquote>
<blockquote>
<p>圣职体制不单有自己的法律、刑罚和监狱，还有自订的税收制度，多数人加入教会，只是因为他是当时最庞大也是最有钱的组织。</p>
</blockquote>
<blockquote>
<p>新教教义：”因信称义“是新教的基本观点，你根本不必做任何事就能得救，尤其不必对神父的指示言听计从。只要你相信上帝，保持信仰就行了。<br>基督教并不是罗马人的宗教。</p>
</blockquote>
<blockquote>
<p>法国启蒙运动，社会的两股非理性的强大势力，一个是教会，一个是法国国王。<code>教会和国王的地位之所以屹立不摇，靠的就是人民的无知</code>。</p>
</blockquote>
<blockquote>
<p>启蒙运动信息是：宗教就是迷信，因此，尽管宗教曾经是欧洲文明的核心，现在他不得不靠边站，由理性取而代之。</p>
</blockquote>
<blockquote>
<p>浪漫主义运动：崇尚感受，情绪以及所有强烈的情感。<code>艺术是穷尽灵魂，讨薪剖腹地将热情，痛苦，绝望赤裸裸的摊在第一线</code>=&gt;文明是人为的，它束缚了我们，局限了我们。</p>
</blockquote>
<blockquote>
<p><code>文艺复兴，宗教改革，科学革命，启蒙运动，浪漫主义运动，以不同的方式削减了教会的权威</code>。</p>
</blockquote>
<blockquote>
<p>苏格拉底：质疑一切，任何事物不能只看表面，他认为一般人的意见不具备理性的基础，提倡争辩才能出结果。苏格拉底问答法。<code>没有反思的生活不值得</code>；活着不是目的，好好活着才是。</p>
</blockquote>
<blockquote>
<p>柏拉图：理想主义哲学家，我们在世间的所见所感，只是存在与另一个崇高灵魂界中的完美形体的影子。</p>
</blockquote>
<blockquote>
<p>亚里士多德：三段论【概述，明确叙述，推出结论】<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">每一猫都有四只脚</span><br><span class="line">喵喵是只猫</span><br><span class="line">所以喵喵有四只脚。</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>从医第一课，<code>希波克拉底誓言</code>：谨慎，有医德，时时以病人的福祉为念<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">希波克拉底誓言</span><br><span class="line"></span><br><span class="line">仰赖医神阿波罗·埃斯克雷波斯及天地诺神为证，鄙人敬谨直誓，愿以自身能力及判断力所及，遵守此约。</span><br><span class="line">凡授我艺者，敬之如父母，作为终身同业伴侣，彼有急需，我接济之。视彼儿女，犹我兄弟，如欲受业，当免费并无条件传授之。</span><br><span class="line"></span><br><span class="line">凡我所知，无论口授书传，俱传之吾与吾师之子及发誓遵守此约之生徒，此外不传与他人。 </span><br><span class="line"></span><br><span class="line">我愿尽余之能力与判断力所及，遵守为病家谋利益之信条，并检柬一切堕落和害人行为，我不得将危害药品给与他人，并不作该项之指导，虽有人请求亦必不与之。尤不为妇人施堕胎手术。</span><br><span class="line"></span><br><span class="line">我愿以此纯洁与神圣之精神，终身执行我职务。凡患结石者，我不施手术，此则有待于专家为之。 </span><br><span class="line"></span><br><span class="line">无论至于何处，遇男或女，贵人及奴婢，我之唯一目的，为病家谋幸福，并检点吾身，不作各种害人及恶劣行为，尤不作诱奸之事。</span><br><span class="line"></span><br><span class="line">凡我所见所闻，无论有无业务关系，我认为应守秘密者，我愿保守秘密。</span><br><span class="line"></span><br><span class="line">尚使我严守上述誓言时，请求神祗让我生命与医术能得无上光荣，我苟违誓，天地鬼神实共亟之。</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>20200202 于西山林语</p>
]]></content>
      
        
        <tags>
            
            <tag> 2020读书 </tag>
            
            <tag> 读书笔记 </tag>
            
            <tag> 《极简欧洲史》 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[公信力-《图解区块链》读书笔记]]></title>
      <url>/2020/01/26/%E5%85%AC%E4%BF%A1%E5%8A%9B-%E3%80%8A%E5%9B%BE%E8%A7%A3%E5%8C%BA%E5%9D%97%E9%93%BE%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/</url>
      <content type="html"><![CDATA[<blockquote>
<p>智人之所以能够以劣势的生理特性横扫五大洲，成为唯一存活下来的人类，并且主导了地球进化的方向，其原因在于<code>其通过独有的语言和文字创造了虚构的概念。人类通过对这些&quot;虚构的概念共识&quot;实现了大规模合作的可能</code>，从而创造了人类辉煌。 ——《人类简史》<br>利用可信程序获取公信力，区块链可能成为这种虚构的力量。</p>
</blockquote>
<h3 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h3><p>庚子春节注定与众不同，新冠肆虐，小拽积极响应国家号召，不恐慌，不传谣，躺在家里给社会做贡献^_^。</p>
<p>最近几年，区块链和比特币一直是追捧的热点，闲来无事，翻了翻15年解读区块链的一本书，算是回望历史，结果充分佐证了一句话：<code>拿后来的认知水平去质疑过去的应对策略，是很不负责任的，肺炎亦然</code>。</p>
<p>本书整体打分2星，除了复盘看看，不值得一读。<br>笔记主要记录了区块链的一些思考、应用和golang的一个简单实现。</p>
<p><a href="http://cuihuan.net/wp_content/new/book/tujiequkuailian.jpeg"><img src="http://cuihuan.net/wp_content/new/book/tujiequkuailian.jpeg" alt="乌镇"></a></p>
<h3 id="一、是什么？"><a href="#一、是什么？" class="headerlink" title="一、是什么？"></a>一、是什么？</h3><p>区块链到底是什么，不同领域认识偏差很大，常被用到的词有”自由”、”信任”、”价值转移”、”安全”等等。</p>
<blockquote>
<p>百科定义：区块链是一个信息技术领域的术语。从本质上讲，它是一个共享数据库，存储于其中的数据或信息，具有“不可伪造”“全程留痕”“可以追溯”“公开透明”“集体维护”等特征。基于这些特征，区块链技术奠定了坚实的“信任“基础，创造了可靠的“合作”机制，具有广阔的运用前景。</p>
</blockquote>
<p>从程序员角度看什么是区块链</p>
<blockquote>
<p>小拽定义：区块链是一种<code>开发完成后，任何人无法干预运行的可靠程序</code>。</p>
</blockquote>
<p>之所以这样定义，小拽认为，区块链有两个关键技术目标：<strong>不可干预和可靠运行</strong>。进而达到<strong>程序具有公信力</strong>的最终目标。</p>
<ul>
<li><strong>不可干预</strong>：要求具有公信力的算法和架构设计，设计者本人也无法直接修改，只能按照既定规则运转，不可篡改。例如比特币使用的算法，即使创始人中本聪也无法修改。</li>
<li><strong>可靠运行</strong>需要提供分布式存储，异常容灾，可扩展等架构能力，来保证稳定的运行，不会被攻击，出异常。例如比特币目前来看分布式存储，选举机制，容量也是可以从1M扩展到8M(国际扩展到20M)。</li>
</ul>
<p>而最终达到的目标是大家认可，也就是具有了所谓的“公信力”。<strong>信任本就贵，公信价更高</strong>。而公信力的获取和维持成本极高，例如银行要维持自己的公信力，花大量资金拿牌照（找背书），在核心区建网点（提面子），还要有准备金，审计等等；而国家甚至要考军队来维持公信力。</p>
<p>简而言之<strong>区块链就是一个不能被篡改的，大家都觉的​灰常靠谱的数据记录方式！</strong></p>
<h3 id="二、如何用？"><a href="#二、如何用？" class="headerlink" title="二、如何用？"></a>二、如何用？</h3><p>区块链的关键意义在于<strong>利用可信程序获取公信力</strong>，那么如何应用？仁者见仁智者见智，小拽列举一些小的思考。</p>
<ul>
<li><strong>可信记录</strong>：比如电子病例、电子学历、电子合同、电子护照等。一旦通过区块链记录下来，就不能被以任何手段篡改，可以降低机构的公信成本。那么问题来了，写错了怎么办？答案是只能写一个新的，就像财务系统一样，钱记录错了，是不能擦掉的，只能后面新入一笔账。</li>
<li><strong>保险行业</strong>：保险行业接近三分之一的成本用于管理费用，那么如果区块链可以解决公信力，那么互助险是否可以利用区块链记录分摊过程来降低管理成本？</li>
<li><strong>股权交易</strong>：这个本身就是完全靠公信力来支撑的运营方式，</li>
<li><strong>电子商务</strong>：有了区块链的公信力，是否还需要“支付宝”，是否可以有更可靠的预付款和信用链？</li>
<li><strong>物联网</strong>：每个物联网设备的“数字化身份”、“验证”、“记录”，链式不可篡改的结构是否解决这块问题？</li>
<li><strong>反洗钱</strong>：所以记录至少是公开透明，不可篡改的，是否可以更利于追查？</li>
</ul>
<h3 id="三、Golang实现一个简单的区块链"><a href="#三、Golang实现一个简单的区块链" class="headerlink" title="三、Golang实现一个简单的区块链"></a>三、Golang实现一个简单的区块链</h3><p>具体看代码，入门golang写的一个小栗子，核心是信息加密和链<br>实际应用中有一个经典的链式结构参考：《热点账户设计》</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"crypto/sha256"</span></span><br><span class="line">    <span class="string">"encoding/hex"</span></span><br><span class="line">    <span class="string">"encoding/json"</span></span><br><span class="line">    <span class="string">"io"</span></span><br><span class="line">    <span class="string">"log"</span></span><br><span class="line">    <span class="string">"net/http"</span></span><br><span class="line">    <span class="string">"os"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line"></span><br><span class="line">    <span class="string">"github.com/davecgh/go-spew/spew"</span></span><br><span class="line">    <span class="string">"github.com/gorilla/mux"</span></span><br><span class="line">    <span class="string">"github.com/joho/godotenv"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Block <span class="keyword">struct</span> &#123;</span><br><span class="line">    Index     <span class="keyword">int</span>       <span class="comment">// 是这个块在整个链中的位置</span></span><br><span class="line">    Timestamp <span class="keyword">string</span>    <span class="comment">// 生成块的时间戳</span></span><br><span class="line">    BPM       <span class="keyword">int</span>       <span class="comment">// 心跳</span></span><br><span class="line">    Hash      <span class="keyword">string</span>    <span class="comment">// SHA256 生成的散列值</span></span><br><span class="line">    PrevHash  <span class="keyword">string</span>    <span class="comment">// 前一块的hash散列值</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 整个区块链</span></span><br><span class="line"><span class="keyword">var</span> Blockchain []Block</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Message <span class="keyword">struct</span> &#123;</span><br><span class="line">    BPM <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 计算给定的数据的 SHA256 散列值</span></span><br><span class="line"><span class="comment">// 这个 calculateHash 函数接受一个块，通过块中的 Index，Timestamp，BPM，以及 PrevHash 值来计算出 SHA256 散列值</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">calculateHash</span><span class="params">(block Block)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	record := <span class="keyword">string</span>(block.Index) + block.Timestamp + <span class="keyword">string</span>(block.BPM) + block.PrevHash</span><br><span class="line">	h := sha256.New()</span><br><span class="line">	h.Write([]<span class="keyword">byte</span>(record))</span><br><span class="line">	hashed := h.Sum(<span class="literal">nil</span>)</span><br><span class="line">	<span class="keyword">return</span> hex.EncodeToString(hashed)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成新的区块链，通过迁移块的hash + 时间戳 + 特定参数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">generateBlock</span><span class="params">(oldBlock Block, BPM <span class="keyword">int</span>)</span> <span class="params">(Block, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> newBlock Block</span><br><span class="line">	t := time.Now()</span><br><span class="line">	newBlock.Index = oldBlock.Index + <span class="number">1</span></span><br><span class="line">	newBlock.Timestamp = t.String()</span><br><span class="line">	newBlock.BPM = BPM</span><br><span class="line">	newBlock.PrevHash = oldBlock.Hash</span><br><span class="line">	newBlock.Hash = calculateHash(newBlock)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> newBlock, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 校验块，主要检查区块的传递是否正确，</span></span><br><span class="line"><span class="comment">// 通过Prehash 与前一块的hash是否一致，通过cal算出当前hash是否一致</span></span><br><span class="line"><span class="comment">// 校验的原则：始终选择最长的链</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">isBlockValid</span><span class="params">(preBlock, afterBlock Block)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> preBlock.Index+<span class="number">1</span> != afterBlock.Index &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> preBlock.Hash != afterBlock.PrevHash &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> calculateHash(preBlock) != afterBlock.Hash &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 最长的链标识数据是最新的，所以需要一个函数来将本地过期的链切换成最新的</span></span><br><span class="line"><span class="comment">// 检查长度，直接替换</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">replaceChain</span><span class="params">(newBlocks []Block)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(newBlocks) &gt; <span class="built_in">len</span>(Blockchain) &#123;</span><br><span class="line">		Blockchain = newBlocks</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span></span><br><span class="line"><span class="comment">// 上面是xiaozhuaichain 的主要函数，下面采用web方式来展现</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化web服务</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">run</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    handler := makeMuxRouter()</span><br><span class="line">    httpAddr := os.Getenv(<span class="string">"ADDR"</span>)</span><br><span class="line">    log.Println(<span class="string">"Listening on "</span>, os.Getenv(<span class="string">"ADDR"</span>))</span><br><span class="line">    s := &amp;http.Server&#123;</span><br><span class="line">        Addr:           <span class="string">":"</span> + httpAddr,</span><br><span class="line">        Handler:        handler,</span><br><span class="line">        ReadTimeout:    <span class="number">10</span> * time.Second,</span><br><span class="line">        WriteTimeout:   <span class="number">10</span> * time.Second,</span><br><span class="line">        MaxHeaderBytes: <span class="number">1</span> &lt;&lt; <span class="number">20</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> err := s.ListenAndServe(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// get 请求来查看链，post请求来写链</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">makeMuxRouter</span><span class="params">()</span> <span class="title">http</span>.<span class="title">Handler</span></span> &#123;</span><br><span class="line">    muxRouter := mux.NewRouter()</span><br><span class="line">    muxRouter.HandleFunc(<span class="string">"/"</span>, handleGetXiaozhuaiChain).Methods(<span class="string">"GET"</span>)</span><br><span class="line">    muxRouter.HandleFunc(<span class="string">"/"</span>, handleWriteBlock).Methods(<span class="string">"POST"</span>)</span><br><span class="line">    <span class="keyword">return</span> muxRouter</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 读取</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleGetXiaozhuaiChain</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">    bytes, err := json.MarshalIndent(Blockchain, <span class="string">""</span>, <span class="string">"  "</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        http.Error(w, err.Error(), http.StatusInternalServerError)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    io.WriteString(w, <span class="keyword">string</span>(bytes))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 写入</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleWriteBlock</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> m Message</span><br><span class="line"></span><br><span class="line">    decoder := json.NewDecoder(r.Body)</span><br><span class="line">    <span class="keyword">if</span> err := decoder.Decode(&amp;m); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        respondWithJSON(w, r, http.StatusBadRequest, r.Body)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> r.Body.Close()</span><br><span class="line"></span><br><span class="line">    newBlock, err := generateBlock(Blockchain[<span class="built_in">len</span>(Blockchain)<span class="number">-1</span>], m.BPM)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        respondWithJSON(w, r, http.StatusInternalServerError, m)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> isBlockValid(newBlock, Blockchain[<span class="built_in">len</span>(Blockchain)<span class="number">-1</span>]) &#123;</span><br><span class="line">        newBlockchain := <span class="built_in">append</span>(Blockchain, newBlock)</span><br><span class="line">        replaceChain(newBlockchain)</span><br><span class="line">        spew.Dump(Blockchain)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    respondWithJSON(w, r, http.StatusCreated, newBlock)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// response</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">respondWithJSON</span><span class="params">(w http.ResponseWriter, r *http.Request, code <span class="keyword">int</span>, payload <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">    response, err := json.MarshalIndent(payload, <span class="string">""</span>, <span class="string">"  "</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        w.WriteHeader(http.StatusInternalServerError)</span><br><span class="line">        w.Write([]<span class="keyword">byte</span>(<span class="string">"HTTP 500: Internal Server Error"</span>))</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    w.WriteHeader(code)</span><br><span class="line">    w.Write(response)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    err := godotenv.Load()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        t := time.Now()</span><br><span class="line">        <span class="comment">// 小拽，第一个创世块</span></span><br><span class="line">        genesisBlock := Block&#123;<span class="number">0</span>, t.String(), <span class="number">0</span>, <span class="string">""</span>, <span class="string">""</span>&#125;</span><br><span class="line">        spew.Dump(genesisBlock)</span><br><span class="line">        Blockchain = <span class="built_in">append</span>(Blockchain, genesisBlock)</span><br><span class="line">    &#125;()</span><br><span class="line">    log.Fatal(run())</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="四、一点摘录"><a href="#四、一点摘录" class="headerlink" title="四、一点摘录"></a>四、一点摘录</h3><p>P12：区块链的五大特性：<code>去中心化(Decentralized)、集体维护(Colletively maitain)、高度透明（Transparent）、去信任(Trustless)</code>。</p>
<p>P18：央行发型数字货币的原则（周小川）</p>
<ul>
<li>提供便利和安全性</li>
<li>保护隐私与维护社会秩序、打击违法犯罪的平衡（<code>显然比特币打破了平衡</code>）</li>
<li>有利于货币政策的有效运行和传导</li>
<li>保留货币主权的控制力<br>（显然，比特币或者目前已知的电子货币还都不具备）</li>
</ul>
<p>P89：区块链的关键意义：无需中介和公信力。两大意义主要通过共享账本和共识机制两种技术实现。</p>
<p>P10：区块链的每个区块的三要素：本区块的ID，加密一段时间内全部的信息体，上一区块ID。</p>
<p>P16：现钞的发行和汇拢基于“中央银行-商业银行机构”的二元体系来完成。数字货币的发行和运行同样要基于该体系，但是“运送”和“保管”会发生变化，运送方式有物理运送变为电子运送，保存方式变为云计算空间——周小川</p>
<p>P19：R3的核心职能是指定银行业区块链技术开发的行业标准。目的是要做一个全球的去中心化的实时银行间清结算系统。</p>
<p>P43：中国对比特币是绝对禁止，但是对区块链“是一项可选的技术”<br>（15年对于区块链已经是认可的，但比特别明令禁止，和目前差异不大）</p>
<p>P111：2016年2月，央行明确表示发行数字货币的战略目标，争取早日退出央行的数字货币。</p>
<p><br></p>
<p>20200126 于西山林语</p>
]]></content>
      
        
        <tags>
            
            <tag> 2020读书 </tag>
            
            <tag> 《图解区块链》 </tag>
            
            <tag> 读书笔记 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[2020小拽书单]]></title>
      <url>/2020/01/26/2020%E5%B0%8F%E6%8B%BD%E4%B9%A6%E5%8D%95/</url>
      <content type="html"><![CDATA[<blockquote>
<p>高效的读书，一定要从选书开始。小拽2020所读的一些书、读书笔记和推荐级别。</p>
</blockquote>
<hr>
<table>
<thead>
<tr>
<th>书名</th>
<th>读书笔记</th>
<th>推荐等级</th>
<th>关键词</th>
<th>分类</th>
</tr>
</thead>
<tbody>
<tr>
<td>《谁动了我的奶酪》</td>
<td><a href="http://cuihuan.net/2020/01/04/book-%E8%B0%81%E5%8A%A8%E4%BA%86%E6%88%91%E7%9A%84%E5%A5%B6%E9%85%AA/">享受变化</a></td>
<td>※※※</td>
<td>享受变化</td>
<td>个人成长</td>
</tr>
<tr>
<td>《图解区块链》</td>
<td></td>
<td>※※</td>
<td>区块链</td>
<td>互联网</td>
</tr>
</tbody>
</table>
]]></content>
      
        
        <tags>
            
            <tag> 2020书单 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[享受变化-读《谁动了我的奶酪》]]></title>
      <url>/2020/01/04/book-%E8%B0%81%E5%8A%A8%E4%BA%86%E6%88%91%E7%9A%84%E5%A5%B6%E9%85%AA/</url>
      <content type="html"><![CDATA[<blockquote>
<p>引言：支持者也好，批评者也罢，他们都有自己的道理。其实，<code>重要的并不是“奶酪”这个故事本身，而是你如何解读它，并且把它应用到生活中</code></p>
</blockquote>
<p>乌镇呆了两天，一直细雨濛濛，或许是淡季的原因，显的过分宁静。</p>
<p>闲来无事，重读了《谁动了我的奶酪》，挺不错的一篇释压文，读完后心情也宁静一些。</p>
<p><a href="http://cuihuan.net/wp_content/new/book/wuzhen.png"><img src="http://cuihuan.net/wp_content/new/book/wuzhen.jpeg" alt="乌镇"></a><br><a href="http://cuihuan.net/wp_content/new/book/move_cheese.png"><img src="http://cuihuan.net/wp_content/new/book/move_cheese.jpeg" alt="谁动了我的奶酪"></a></p>
<h2 id="一、看书中事"><a href="#一、看书中事" class="headerlink" title="一、看书中事"></a>一、看书中事</h2><p>书中的小故事很简单直白：两个小老鼠和两个小矮人在迷宫中寻找奶酪，在突然寻得一大堆向往已久的奶酪后，讲述了四个小家伙是如何处理的。同时，奶酪终究会失去的，在奶酪被动了后，又描写了四个小家伙又是如何应对的。</p>
<p>而“奶酪”是一个比喻，指的是我们生活中任何想要的东西，可以是一份工作、一种人际关系、金钱、豪宅、自由、健康等等！“奶酪”会带给我们“幸福”和“快乐”，<code>但变化总会发生，他们总会不断地拿走你的“奶酪”</code>。而作者就是想告诉我们要<code>转换一种眼光去看待变化，去处理变化</code>。</p>
<h2 id="二、想当下景"><a href="#二、想当下景" class="headerlink" title="二、想当下景"></a>二、想当下景</h2><p>相较于其他鸡汤文，作者逻辑清晰。论据是：变化是始终存在的，所以“奶酪”也一定会变化，因此是<code>&quot;不论你愿不愿意，总有人会来动你的奶酪&quot;</code>。</p>
<p>映射到当下比较火的话题，例如“中年危机”<br>年轻人的不断加入，会让你肤浅的积累淡然失色。倘若一直迷失在互联网浮夸的高薪红利下，不思进取，那么你终究会丢掉这块丰厚的“奶酪”。最终，面对裁员，你的指责、愤怒、恐惧，甚至所谓的xx权利都无法帮你守住这份“奶酪”，或许同情心和法规还能帮你捞到部分补偿“奶渣”。</p>
<p>与其恐惧必然发生的问题，是否可以换个思路：<code>直面必然会不停变化的“奶酪”，调整心态，接收变化，拥抱变化，享受变化</code>。</p>
<p>因此，不论愿不愿意，都有人会来动你的奶酪，尤其是当你的奶酪“过分鲜美”。类似的例子还有很多，例如“国企/公务员改革”，“互联网金融变革”，“网约车变革”等等。</p>
<h2 id="三、思如何为"><a href="#三、思如何为" class="headerlink" title="三、思如何为"></a>三、思如何为</h2><p>生活是个充满变化的迷宫，怎样才能找到属于自己的“奶酪”？</p>
<p>作者给了几条建议</p>
<ul>
<li>转变心态：认识到变化总会发生，你的奶酪不断的被拿走是客观事实，不必要过分焦虑和恐惧，<code>时刻做好失去奶酪的准备</code>。</li>
<li>关注变化：经常关注奶酪是否正在发生变化，自身或者行业是否将要、正在或是已经发生了变化。</li>
<li>适应变化：越快放弃旧的奶酪，你就会越早的找到新的奶酪</li>
<li>享受变化：尽情的享受探险的过程和新奶酪的美味（加一句：也没必要拿新旧奶酪做对比，失去的对于你来说已经没有意义）</li>
</ul>
<p>总的老说，与其像老白兔，费尽心机守着注定会丢失的“老奶酪”，为什么不转变心态、拥抱变化，去勇敢，快乐的追寻“新奶酪”。<code>不但能够享受探险的过程，还能获取“新奶酪”的奖励</code>。</p>
<p><strong>所以在这样一个不断变化的世界，学会适应，从而欣赏和追逐更好的事情，这对我们终归是有好处的</strong>。</p>
<p>20200104 于乌镇</p>
]]></content>
      
        
        <tags>
            
            <tag> 《谁动了我的奶酪》 </tag>
            
            <tag> 2020读书 </tag>
            
            <tag> 读后感 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[2019总结]]></title>
      <url>/2020/01/01/2019%E6%80%BB%E7%BB%93/</url>
      <content type="html"><![CDATA[<blockquote>
<p>闲云谭影日悠悠，物换星移几度秋。不管是以梦为马、不负韶华，还是无所事事、蹉跎岁月，2019都已成为过去。<br>回首向来萧瑟处，也无风雨也无晴。历史长河奔流不息，没人可以阻挡她的前进，但总想给她些许留痕。</p>
</blockquote>
<hr>
<h2 id="一、FLAG回顾"><a href="#一、FLAG回顾" class="headerlink" title="一、FLAG回顾"></a>一、<strong>FLAG回顾</strong></h2><p>2018年总结</p>
<p>2018年的总结，整体基调过于低沉，只有多喜乐、长安宁的自在，缺少西北旺、射天狼的霸气。哈哈，难怪2019有些逍遥自在（一事无成）。</p>
<p>今年开篇先定基调：<code>鸟未尽，弓未藏；广积粮，缓称王</code>。</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">==== 2019 flag 回顾 ====</span></span><br><span class="line"></span><br><span class="line">工作方面：2019立了一个flag，重新捡起博客，目标20篇文章。呵呵，结果公众号只写了10篇 ￣□￣｜｜（考虑到公司wiki还有10+篇总结，勉强及格）</span><br><span class="line"></span><br><span class="line">投资方面：2019立了一个flag，每周阅读《中国经济周刊》完成，投资年化收益超10，完成。</span><br><span class="line"></span><br><span class="line">兴趣爱好：立了个flag，学做饭，目前看，勉勉强强，总计搞定了28个菜谱（包括但不限于：煮粥，煮面^<span class="emphasis">_^）</span></span><br></pre></td></tr></table></figure>
<p>19年股票投资趋势<br><a href="http://cuihuan.net/wp_content/new/IBT/2019_finance.png"><img src="http://cuihuan.net/wp_content/new/IBT/2019_finance.png" alt="股票收益"></a></p>
<p>秀秀19年的菜谱<br><a href="http://cuihuan.net/wp_content/new/IBT/2019_eat.png"><img src="http://cuihuan.net/wp_content/new/IBT/2019_eat.png" alt="菜谱"></a></p>
<hr>
<h2 id="二、目标拆解"><a href="#二、目标拆解" class="headerlink" title="二、目标拆解"></a>二、目标拆解</h2><p> <strong>工作方面</strong>：2019年离开了做了一年半的财务系统，投身国际化了横向技术，一个全新的领域，挑战很大。主要针对企业出海，做了的两间事：<br>1、如何满足当地法规：<code>出海合规</code>。<br>2、如何符合当地习惯：<code>软件本地化（i18n）</code>。<br>19年整体算是入门吧，20年的目标是深耕，响应习大大2020年新春祝福的号召：<strong>把短板补的再扎实一些，把基础打的再牢靠一些。</strong></p>
<blockquote>
<p>2020年工作上两个flag吧，<br>1、完成企业出海这个命题作文，形成一套体系化的解决方案。<br>2、公众号技术文章数量：保十争十五。</p>
</blockquote>
<hr>
<p><strong>投资方面</strong>：19年相对18年资产配置稳了一些，得益于全球环境不错，整体稳步上升。<br>19年的投资总结就一句话：<code>寻找价值偏差，耐心等待</code>。<br>道理挺简单，就是客观要理性分析，看准了，要坚持，有耐心。举个栗子：刘强东事件是否影响了京东的根基？京东股价跌一半是否合理。同理：区块链对英伟达的影响，薅羊毛对拼多多影响，甚至贸易战对经济根基的影响。</p>
<p>19年针对线下也做了大量调研，整体结论是<code>就个人而言，ROI不高。2020年转移目标线上，结合自身优势做些尝试</code>。</p>
<blockquote>
<p>19年投资方面flag不变，继续保持每周读经济周刊！<br>加个flag，保险入门了解，产出一篇入门文章。</p>
</blockquote>
<hr>
<p><strong>生活方面</strong>：生活嘛，<strong>闹是多喜乐，静是长安宁，贵在心态</strong>。生活毕竟是自己的事情，之后的规划中，也逐步把这块放入私密了，正所谓团圆便是家肥事，何必盈仓与满箱！！！</p>
<hr>
<p><strong>兴趣爱好</strong>：2019除了学习做饭外，新get两个小兴趣，一个是德州扑克，挺有意思，前半年玩的挺多，后半年时间有点失控，逐步控制了，偶尔看看直播，高山仰止；另一个是下象棋，哈哈，小下怡情，欢迎切磋^_^！<br>关于爱好，整体来看，运动类的少了太多，配置不合理，无论是爬山、游泳、篮球、羽毛球都没啥进展。</p>
<blockquote>
<p>2020立个flag，学会自由泳+踩水！</p>
</blockquote>
<h2 id="三、忆往昔，看今朝"><a href="#三、忆往昔，看今朝" class="headerlink" title="三、忆往昔，看今朝"></a>三、忆往昔，看今朝</h2><p>同2018，最后致谢，感谢老婆和家人的支持，有了你们坚实后盾，怎么走都是路！<br>感谢工作中小伙伴，有了你们的信任和配合，稳如狗！</p>
<p>2019，以梦为马，2020 只争朝夕。</p>
<p>2020年1月1号 于杭州西湖</p>
]]></content>
      
        
        <tags>
            
            <tag> 2019总结 </tag>
            
            <tag> 2020展望 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[国际化货币那些事儿]]></title>
      <url>/2019/09/08/%E5%9B%BD%E9%99%85%E5%8C%96%E8%B4%A7%E5%B8%81%E9%82%A3%E4%BA%9B%E4%BA%8B%E5%84%BF/</url>
      <content type="html"><![CDATA[<p>内网项目总结发的一篇小文，今年12篇文章告急，滥竽充数了o(╥﹏╥)o</p>
<blockquote>
<p>第一部分涨姿势，聊聊什么是货币和国际化的场景下货币遇到的问题；<br>第二部分分享货币改造，聊聊货币改造是怎么玩的。<br>期望大家通过本文了解到货币的一些小知识，货币处理的最佳实践，以及分享下个人在项目推进中的一些总结。</p>
</blockquote>
<h3 id="一、聊聊货币"><a href="#一、聊聊货币" class="headerlink" title="一、聊聊货币"></a>一、聊聊货币</h3><p>在具体谈货币之前，先抛几个小问题<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、$<span class="number">1.000</span> 是多少钱？是<span class="number">1</span>美刀吗？还是<span class="number">1000</span>哥伦比亚比索？</span><br><span class="line"><span class="number">2</span>、哥伦比亚行程计价结果是：$<span class="number">666</span>，用户能现金支付吗？</span><br><span class="line"><span class="number">3</span>、发奖励兜底限额，来个<span class="number">888</span>万写死，够不够？</span><br></pre></td></tr></table></figure></p>
<p>显然都不行，原因可以跳转下面货币小知识。</p>
<hr>
<p>那么问题来了，货币到底是什么？<br>货币在经济学的解释是：<a href="https://wiki.mbalib.com/wiki/%E8%B4%A7%E5%B8%81" target="_blank" rel="external">货币</a> ，百科的描述是：<a href="https://baike.baidu.com/item/%E8%B4%A7%E5%B8%81/85299" target="_blank" rel="external">货币</a></p>
<p>作为世界经济体系的核心，到底是个啥，身为一名底层码农，咱也不懂，咱也不敢问，咱也不敢讲。</p>
<p>但作为工程师角度，货币无非就是我们系统中录入，存储，传递，展现的一组变量。如何规范，准确，本地化的处理这组变量就是IBT货币改造的主要内容。</p>
<hr>
<blockquote>
<p>货币小知识<br>问题一：$1.000 具体是多少钱，要看具体的语言和国家，比如在语言美国(US)和英语（en-US）的情况下，$1.000标示1美元；但是在<code>哥伦比亚(COL)西语(es-CO)的情况下，$1.000就表示1000哥伦比亚比索，西语的千分位都是&#39;.&#39;，小数点是&#39;,&#39;</code>，吃不吃惊，腻不腻害！</p>
</blockquote>
<blockquote>
<p>问题二：$666在哥伦比亚无法用现金支付，因为<code>哥伦比亚现存的最小现金是50</code>，所以在哥伦比亚的现金支付需要抹零，而且要符合法律规定的抹零。同时，<code>还有很多国家是没有分的，例如日本的最小货币单位就是日元，没有日分</code>（-_-）</p>
</blockquote>
<blockquote>
<p>问题三：888万看似很大，其实不然，例如<code>哥伦比亚的汇率和人民币差不多1:500，也就是说不到888万，也就1w多</code>。同时，<code>由于int32最多存储2147483647，21亿如果是哥伦比亚按照分存储也就4.2万</code>[21亿/100(分)/500(汇率)]，所以<code>存储和传递一定都要用长整形</code>。</p>
</blockquote>
<hr>
<p>分割线：科普到此结束，下面会重点分享下，货币改造的实践和项目总结；</p>
<h3 id="二、广告插入"><a href="#二、广告插入" class="headerlink" title="二、广告插入^_^"></a>二、广告插入^_^</h3><p>前方高能预警</p>
<blockquote>
<p>货币涨见识，时间度量衡更涨见识，<code>多国环境下的架构抽象那才叫酸爽</code>，各位架构师要不要来感受下？<br>请戳国际化出行平台工程师/架构师  <a href="https://m.zhipin.com/mpa/html/weijd/weijd-job/523fce0edb37f50e0nd-092-E1c~?aid=07b5df7e131fbe2e1w~~&amp;sid=wxs_self_jd" target="_blank" rel="external">投递链接</a> <a href="http://recruit.didichuxing.com/neitui/recommend/13381" target="_blank" rel="external">内推链接</a> <a href="http://recruit.didichuxing.com/huoshui/position/13381" target="_blank" rel="external">活水链接</a></p>
</blockquote>
<blockquote>
<p>3亿+请求一天够不够玩？不够，那如果是<code>牵涉资金和交易的流量</code>呢？敢不敢来？<br>PHP/Go研发工程师（国际化支付）<a href="https://m.zhipin.com/mpa/html/weijd/weijd-job/84844ae1920380560nd-09m0FlM~?aid=07b5df7e131fbe2e1w~~&amp;ka=wjdv2-job-otherjob" target="_blank" rel="external">投递链接</a> <a href="http://recruit.didichuxing.com/neitui/recommend/13387" target="_blank" rel="external">内推链接</a> <a href="http://recruit.didichuxing.com/huoshui/position/13387" target="_blank" rel="external">活水链接</a><br>Java研发工程师/专家（国际支付）<a href="https://m.zhipin.com/mpa/html/weijd/weijd-job/23037ec67863a0e00nd-09u4Fls~?aid=07b5df7e131fbe2e1w~~&amp;ka=wjdv2-boss-otherjob23037ec67863a0e00nd-09u4Fls~" target="_blank" rel="external">投递链接</a> <a href="http://recruit.didichuxing.com/neitui/recommend/13386" target="_blank" rel="external">内推链接</a> <a href="http://recruit.didichuxing.com/huoshui/position/13386" target="_blank" rel="external">活水链接</a></p>
</blockquote>
<h3 id="三、货币怎么玩"><a href="#三、货币怎么玩" class="headerlink" title="三、货币怎么玩"></a>三、货币怎么玩</h3><p><strong>下面部分为阉割版，牵涉过多内部示例已经处理，仅保留项目推进和问题解决的一些总结</strong></p>
<hr>
<p>货币的重要性毋庸置疑，毕竟牵涉到<code>钱</code>。<br>在我滴国际化土匪猛进的时候，货币问题在开发和线上频繁发生，给用户和业务造成了极坏的影响。举几个栗子</p>
<hr>
<p><a href="http://cuihuan.net/wp_content/new/IBT/currency_pro.png"><img src="http://cuihuan.net/wp_content/new/IBT/currency_pro.png" alt="currency_iso"></a></p>
<hr>
<blockquote>
<p>除了货币展现不一致的情况，通过上面的讲解你可能已经知道了，西语情况下2.5是有可能被理解为2500</p>
</blockquote>
<hr>
<p>自古有云：<strong>再一再二不能在再三，虽然走向了国际，但祖训不能忘</strong>。</p>
<p>为了从根本上解决货币相关的问题，IBT在六月中启动了货币改造专项行动。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">项目简介：加密，内容就是解决货币本地化处理和展示的问题，</span><br></pre></td></tr></table></figure>
<p>权知轻重，度知长短，货币改造前先来分析下存在的主要挑战。</p>
<ul>
<li>本身牵涉<strong>细节多，工程量大</strong>，100+页面，几十个模块，多部门协调</li>
<li><strong>紧排期情况下，40多个关联模块升级的稳定性风险很高</strong>，兼容性升级是重中之重，不能因为改造而引入新的问题。</li>
<li><strong>整体排期，大联调和级联上线</strong>，核心一大块：<code>API+收银+账单+fleet+各端+H5</code>的整体排期，联调环境统一部署，占仿真，占pre回归需要提前预估到。</li>
<li><strong>质量把控</strong>，<code>改造不是目的，解决问题才是</code>，那么<code>落地质量就是需要最严把的关口</code>。</li>
</ul>
<hr>
<p>说了这么多，货币改造具体是怎么玩的？有哪些经验可以在后续项目中沉淀？</p>
<p>作者本人也是第一次驾驭横向项目，总结了下货币改造一期的在实践中六个步骤和细节，下文慢慢道来，先挂个整体时间图</p>
<hr>
<p><a href="http://cuihuan.net/wp_content/new/IBT/currency_flow.png"><img src="http://cuihuan.net/wp_content/new/IBT/currency_flow.png" alt="currency_flow"></a></p>
<hr>
<p>总的来说就是项目推进的留个阶段：<code>【六步走】细梳理=》定方案=》出排期=》助落地=》控质量=》查遗漏</code><br>下面分阶段阐述各个步骤的主要工作，要点和内容参考</p>
<h4 id="3-1-问题现状梳理"><a href="#3-1-问题现状梳理" class="headerlink" title="3.1 问题现状梳理"></a>3.1 问题现状梳理</h4><p><strong>核心工作</strong>：梳理现状，分析问题，<strong>定位重点和难点</strong>。</p>
<p>货币改造的梳理阶段，梳理了IBT全量货币的存储、展现、传递现状；调研了限额、溢出、失精度，取整等技术和业务问题。梳理后重难点落在两块</p>
<ul>
<li>重点：<code>用户感知最明显的，终端展现不标准，服务端格式化不统一，以及高风险溢出字段改造</code>；</li>
<li>难点：<code>模块间错综复杂调用关系，字段梳理和兼容性改造落地</code>。</li>
</ul>
<p>贴一些该阶段的梳理和调研：<a href="http://way.xiaojukeji.com/article/17261" target="_blank" rel="external">参考内网小文</a></p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">总结：问题现状梳理的核心贵在一个<span class="string">"细"</span>字。</span><br><span class="line">处于六部曲的第一环，一定要梳理尽可能细致、细致、细致的梳理，否则后面问题会被层层放大。</span><br><span class="line">回头来看，这次货币改造还是有些梳理遗漏，给后面实践过程造成了很大的影响，例如：负号问题，券的页面归属，某些情况下司机端周流水页面等等。</span><br></pre></td></tr></table></figure>
<h4 id="3-2-标准制定发布"><a href="#3-2-标准制定发布" class="headerlink" title="3.2 标准制定发布"></a>3.2 标准制定发布</h4><p><strong>核心工作</strong>：针对调研现状和目标进行<code>问题拆解，制定权威标准和落地可行最佳实践</code></p>
<p>货币改造的标准制定阶段，按照货币的存在的<strong>全生命周期（录入，传递，处理，存储，展现）</strong>进行了过程拆解，问题拆解，草拟各个阶段处理货币的可落地标准，结合业务实际情况产出落地最佳实践。</p>
<p>对于标准和最佳实践，着重要考虑了两个方面：</p>
<ul>
<li>一是权威：保证标准的可信度。在货币的格式问题上，<code>专门成立个货币标准小组，和前线运营，产品确认当地的习惯</code>。</li>
<li>二是可行：保证方案的可行。在货币的展现阶段标准上，针对目前系统的图表展示等，对货币原值保留了标准保留。</li>
</ul>
<hr>
<blockquote>
<p>目前IBT的货币标准和军规 <a href="http://way.xiaojukeji.com/article/17261" target="_blank" rel="external">参考内网小文</a></p>
</blockquote>
<hr>
<p>格式标准举个栗子<br><a href="http://cuihuan.net/wp_content/new/IBT/currency_iso.png"><img src="http://cuihuan.net/wp_content/new/IBT/currency_iso.png" alt="currency_iso"></a></p>
<hr>
<p>处理标准举个栗子</p>
<p><a href="http://cuihuan.net/wp_content/new/IBT/currency_demo.png"><img src="http://cuihuan.net/wp_content/new/IBT/currency_demo.png" alt="currency_demo"></a></p>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">总结：制订标准和最佳实践本质上是一个可落地的方案，在权威的基础上一定要注意可行性。</span><br></pre></td></tr></table></figure>
<h4 id="3-3-方案排期拉齐"><a href="#3-3-方案排期拉齐" class="headerlink" title="3.3 方案排期拉齐"></a>3.3 方案排期拉齐</h4><p><strong>核心工作</strong>：同步方案（涵盖标准/最佳实践/军规），评估各方实现成本，产出整体排期。</p>
<p>货币改造在这个阶段做的最重要的事情就是和<code>15+团队单独沟通，同步方案</code>，结合模块现状和细节，产出团队在业务快速迭代的情况下的方案和排期。</p>
<p>沟通和消息同步是这个阶段的重要事项，最终目的是为了</p>
<ul>
<li>同步标准。<code>已读不代表理解</code>，还是需要和各个业务方，亲自小范围的沟通方案，解答疑惑，标准的原因，方案如何落地，一定要注意哪些方面</li>
<li>产出排期。家家有本难念的经，各模块的状况不一样，所以需要<code>小范围沟通，结合模块的现状产出，处理重难点，不影响整体进展排期</code>。</li>
</ul>
<p>方案拉齐阶段的一些资料供参考：<a href="http://way.xiaojukeji.com/article/17261" target="_blank" rel="external">参考内网小文</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">总结：小范围沟通是保证方案的同步效果，结合模块实际情况产出排期是结果。</span><br></pre></td></tr></table></figure>
<h4 id="3-4-整体改造落地"><a href="#3-4-整体改造落地" class="headerlink" title="3.4 整体改造落地"></a>3.4 整体改造落地</h4><p><strong>核心工作</strong>：<code>协助业务改造，工具支持，推进问题，同步风险</code>。</p>
<p>货币改造在这个阶段基本进入了业务的开发过程中，也是<strong>问题集中爆发的阶段</strong>。在这个阶段横向技术协助业务方接入SDK，协调测试环境，处理理解偏差问题，</p>
<p>针对开发中的问题，横向技术主要通过下面几个方式来推进</p>
<ul>
<li><strong>开发工具提效</strong>：针对痛点问题，从整体和工具层面来协助，比如覆盖率等，应急性的解决问题。</li>
<li><strong>横向问题推进</strong>：针对这个阶段的跨团队技术问题的解决、推进，甚至对于风险瓶颈，要亲自上手（作者在这个过程中对于很多确实工作量大和排期紧的项目也是被迫自己上）。</li>
<li><strong>风险同步</strong>：针对排期风险和业务隐藏风险，要保证消息的同步通道和效果，本次改造过程中，两次全范围排期风险同步，一次SDK风险同步。</li>
</ul>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">总结：核心是保证信息同步通道。只有风险，问题，细节，改造环境等等都完备同步了，才能把控好进度和质量</span><br></pre></td></tr></table></figure>
<p><u></u></p>
<h4 id="3-5-交付质量把控"><a href="#3-5-交付质量把控" class="headerlink" title="3.5 交付质量把控"></a>3.5 交付质量把控</h4><p><strong>核心工作</strong>：交付质量是重中之重，着重从质量通道的角度去把控。</p>
<p>该阶段货币改造过程中，这个阶段是<code>黎明前的黑暗。初期的任何信息同步和设计遗漏，在此时都会彰显</code>，比如没有做兼容，遗漏页面，遗漏接口，负数情况等等。</p>
<p>货币改在在这个阶段的主要抓手有两个：<code>质量团队+RD检查项</code>。</p>
<ul>
<li>自检项：具体到每一点，是否执行到位。</li>
<li>质量团队：QA作为最终质量的控者，从每一个细节去确认，同时从用户角度来把控。横向技术在这个阶段，参与了几乎所有case评审，共性case指定，异常情况探讨等等。</li>
</ul>
<p><u><strong><code>这个阶段特别要感谢QA同学：制定了完备的保障方案和连续两个周末加班支持</code></strong></u></p>
<hr>
<p><a href="http://cuihuan.net/wp_content/new/IBT/currency_check.png"><img src="http://cuihuan.net/wp_content/new/IBT/currency_check.png" alt="currency_check"></a></p>
<hr>
<p><a href="http://cuihuan.net/wp_content/new/IBT/currency_qa.png"><img src="http://cuihuan.net/wp_content/new/IBT/currency_qa.png" alt="currency_qa"></a></p>
<hr>
<p>列下本次整体货币质量保障方面的文档，后续的项目也可以参考借鉴：<a href="http://way.xiaojukeji.com/article/17261" target="_blank" rel="external">参考内网小文</a></p>
<h4 id="3-6-问题遗漏汇总"><a href="#3-6-问题遗漏汇总" class="headerlink" title="3.6 问题遗漏汇总"></a>3.6 问题遗漏汇总</h4><p><strong>核心工作</strong>：基本完成，一方面查漏补缺，一方面需要总结。</p>
<p>阶段性的总结是为了更好，更低成本的去实现下一次跳跃。<br>本次货币改造在这个阶段重点做了两件事情</p>
<p>查漏：梳理所有的遗留，遗留问题；针对问题复盘，针对这次货币改造内部复盘<br>总结：总结相关经验和成果</p>
<p>相关文档参考：<a href="http://way.xiaojukeji.com/article/17261" target="_blank" rel="external">参考内网小文</a></p>
<h3 id="四、小结"><a href="#四、小结" class="headerlink" title="四、小结"></a>四、小结</h3><p>国际化改造道重而任远，货币这次小小尝试，只是个开始。<br>关于时间，度量衡，数字，电话等问题域，也将逐渐展开，技术实现细节后面继续探讨^_^</p>
]]></content>
      
        
        <tags>
            
            <tag> 国际化 </tag>
            
            <tag> 货币 </tag>
            
            <tag> 项目推进 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[字符编码那些事儿]]></title>
      <url>/2019/05/12/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E9%82%A3%E4%BA%9B%E4%BA%8B%E5%84%BF/</url>
      <content type="html"><![CDATA[<blockquote>
<p>身为一名要冲出国门的国际化码农🙃，字符编码是必备课题。小拽本文依次介绍下<strong>字节，ASCII，GB2312，GBK，GB18030，UNICODE，UTF8，UTF16，ICU</strong> 等到底是什么鬼？最后理论结合实际，研究下网站中经常出现的“<strong>锟斤拷，��，烫烫烫烫烫，屯屯屯屯屯屯</strong>”是什么神兵利器O(∩_∩)O？</p>
</blockquote>
<h2 id="一、二进制和字节"><a href="#一、二进制和字节" class="headerlink" title="一、二进制和字节"></a>一、二进制和字节</h2><p>大概一百多年前，贝尔实验室制造了世界上的第一个晶体管，晶体管具有开合(0和1)的状态，这种01状态的变化被称为<code>二进制位（bit）</code>。</p>
<p>过了几年，英特尔把八个可以开合的晶体管组合，做为一个基本的记录单元，这个单元被称作<code>字节（byte）</code>，所以<strong>一个byte由8个bit构成，可以表达256种状态</strong>。</p>
<p>又过几年，祖师爷冯诺依曼设计了一台可以存储和处理（冯诺依曼体系）字节变动的机器<strong>ENIAC</strong>，后来这个机器被称作<code>计算机</code>。</p>
<h2 id="二、标准ASCII"><a href="#二、标准ASCII" class="headerlink" title="二、标准ASCII"></a>二、标准ASCII</h2><p>计算机运行是二进制，如何用二进制位来标识人类语言，就需要和计算机有一套约定关系。例如约定，0100 1111代表O，0100 1011代表K，那么存储为01001111 01001011的两个字节就代表OK，这套约定关系被称作<code>字符编码</code>。</p>
<p>冯祖师爷是的德国人，二战去了美国设计了第一台计算机。起初，只有美国人能用计算机，山姆大叔就根据英语习惯设计了一套映射约定</p>
<ul>
<li>0-31   标识控制字符，例如换行[LF]，删除[DEL]，确认[ACK]等</li>
<li>32-47  标识符号例如!@#$等</li>
<li>48-57  标识0-9是个阿拉伯数字</li>
<li>65-122 标识大小写字母</li>
</ul>
<p>大家都按着这个约定来，交流表达起来没啥问题，呵呵，都挺好。于是这个方案就一致通过了，山姆大叔也给这个约定起了个名字<code>ASCII</code>编码（<strong>American Standard Code for Information Interchange，美国信息互换标准代码</strong>）。当时世界上所有的计算机都用同样的ASCII方案来保存英文字符。</p>
<blockquote>
<p>计算机一个标准字节8bit本身可以标识256个符号，但<strong>标准的ASCII的最高位去掉用做奇偶校验，用剩余7位标识128个符号</strong>，如下图</p>
</blockquote>
<p><a href="http://cuihuan.net/wp_content/new/finance/ASCII.png"><img src="http://cuihuan.net/wp_content/new/finance/ASCII.png" alt="ASCII"></a></p>
<h2 id="三、ASCII-扩展字符集"><a href="#三、ASCII-扩展字符集" class="headerlink" title="三、ASCII 扩展字符集"></a>三、ASCII 扩展字符集</h2><p>随着计算机的发展，欧洲人开始逐步接触计算机了。</p>
<p><strong>英语用128个符号编码就够了，但是用来表示其他语言，128个符号是不够的</strong>。比如在法语中，字母上方有注音符号，它就无法用ASCII码表示。于是，一些欧洲国家就决定，<strong>利用字节中闲置的最高位编入新的符号</strong>。比如，法语中的é的编码为130（二进制10000010）。这样一来，这些欧洲国家使用的编码体系，<strong>可以表示最多256个符号</strong>。</p>
<p>IBM牵头扩充了ASCII编码128-256位的标识字符，主要是一些欧洲的常用符号，这部分扩展映射被称为<code>ASCII扩展字符集</code></p>
<h2 id="四、GB2312"><a href="#四、GB2312" class="headerlink" title="四、GB2312"></a>四、GB2312</h2><p>雄关漫道真如铁，而今迈步从头越，美帝国主义万万没有想到，二战后，大量第三世界的人民站起来了，逐步开始使用计算机。但<strong>问题是256个字符已经没啥可利用的字节状态来表示汉字了，更何况中华文明有6000多个常用汉字需要保存</strong>呢。</p>
<p>但是这难不倒智慧的中国人民，面对帝国主义的压迫，我们毫不客气的做了两件事情，并在1980年发表了这个声明</p>
<ul>
<li>互相尊重：尊重标准ASCII 规范中0-127位表示的标准字符。</li>
<li>平等互利：<strong>ASCII的128-256位，我们用来标识中文，由于中文太多，我们要使用两个字节来表示一个中文^_^</strong></li>
</ul>
<p>中国人民觉的这个声明还不错，毕竟当时计算机的使用范围也不大，基本满足需求，于是就把这种汉字方案叫做 <code>GB2312编码</code>。<strong>GB2312 是对 ASCII 的中文扩展</strong>。</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">非专业人士可以忽略： GB2312如何组合，能表示多少个？</span><br><span class="line">GB2312中用两个字节来标识一个汉字，前面的一个字节（他称之为高字节）从<span class="number">0xA1</span>用到<span class="number">0xF7</span>，后面一个字节（低字节）从<span class="number">0xA1</span>到<span class="number">0xFE</span>，简单计算</span><br><span class="line"></span><br><span class="line"><span class="number">0xA1</span>：<span class="number">10</span>*<span class="number">16</span> + <span class="number">1</span> = <span class="number">161</span>  </span><br><span class="line"><span class="number">0xF7</span>：<span class="number">15</span>*<span class="number">16</span> + <span class="number">7</span> = <span class="number">247</span> =&gt; <span class="number">247</span><span class="number">-161</span> = <span class="number">86</span></span><br><span class="line"><span class="number">0xFE</span>：<span class="number">15</span>*<span class="number">16</span> + <span class="number">14</span>= <span class="number">254</span> =&gt; <span class="number">254</span><span class="number">-161</span> = <span class="number">93</span></span><br><span class="line">因此GB2312可以标识约<span class="number">86</span>*<span class="number">93</span>=<span class="number">7998</span> 个汉字</span><br><span class="line"></span><br><span class="line">实时上 GB2312 标准共收录 <span class="number">6763</span> 个汉字，其中一级汉字 <span class="number">3755</span> 个，二级汉字 <span class="number">3008</span> 个。</span><br><span class="line">同时收录了包括拉丁字母、希腊字母、日文平假名及片假名字母、俄语西里尔字母在内的 <span class="number">682</span> 个字符。</span><br><span class="line">几乎覆盖了大陆常用的<span class="number">99.75</span>%汉字</span><br></pre></td></tr></table></figure>
<p>这样我们就可以组合出大约7000多个简体汉字了。在这些编码里，我们还把数学符号、罗马希腊的字母、日文的假名们都编进去了，连在 ASCII 里本来就有的数字、标点、字母都统统重新编了两个字节长的编码，这就是常说的<code>全角字符</code>，而原来在127号以下的那些就叫<code>半角字符</code>了。</p>
<h2 id="五、GBK"><a href="#五、GBK" class="headerlink" title="五、GBK"></a>五、GBK</h2><p>满足了基础和常用的汉字需求后，但<strong>依然会有很多人的生僻字名字打不出来，屌丝还好，但是一旦牵涉伟人名字打不出来那就坑爹了</strong>！改改改，抓紧改！</p>
<p>GB2312的编码，使用两个字符，每个都<strong>只用了后128位，不合理呀，干脆我们把低字节127号之后的内码我们也用了，不浪费</strong>。</p>
<p>说干就干，于是扩展之后的编码方案被称为<code>GBK</code>标准（不知道K是不是扩展的缩写K^_^），<strong>GBK包括了GB2312的所有内容，同时又增加了近20000个新的汉字（包括繁体字）和符号</strong>。</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">非专业人士可以忽略： GBK如何组合，能表示多少个？</span><br><span class="line">第一个字节的值从 <span class="number">0x81</span> 到 <span class="number">0xFE</span>保持不变，第二个字节的值扩展从 <span class="number">0x40</span> 到 <span class="number">0xFE</span></span><br><span class="line"></span><br><span class="line"><span class="number">0xFE</span><span class="number">-0x81</span>：<span class="number">254</span> - <span class="number">8</span>*<span class="number">16</span>+<span class="number">1</span> =<span class="number">125</span></span><br><span class="line"><span class="number">0xFE</span><span class="number">-0x40</span>：<span class="number">254</span> - <span class="number">4</span>*<span class="number">16</span> =<span class="number">190</span> </span><br><span class="line"></span><br><span class="line">因此，GBK约标识了 <span class="number">125</span>*<span class="number">190</span>  = <span class="number">23750</span> </span><br><span class="line"></span><br><span class="line">GBK 共收入 <span class="number">21886</span> 个汉字和图形符号，包括：GB2312 中的全部汉字、非汉字符号；BIG5中的全部汉字；ISO10646 相应的国家标准GB13000 中的其它 CJK 汉字</span><br><span class="line">以上合计 <span class="number">20902</span> 个汉字； 其它汉字、部首、符号，共计 <span class="number">984</span> 个。</span><br></pre></td></tr></table></figure>
<h2 id="六、GB18030"><a href="#六、GB18030" class="headerlink" title="六、GB18030"></a>六、GB18030</h2><p>中华民族大团结，<strong>后来少数民族也要用电脑了，于是我们需要再次扩展，又加了几千个新的少数民族的字</strong>，GBK扩成了<code>GB18030</code>。从此之后，中华民族的文化就可以完美的在计算机时代中传承了。 </p>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">非专业人士忽略：</span><br><span class="line">这一系列汉字编码的标准通为 `DBCS`（<span class="built_in">Double</span> <span class="built_in">Byte</span> Charecter <span class="keyword">Set</span> 双字节字符集）。</span><br><span class="line">在DBCS系列标准里，最大的特点是两字节长的汉字字符和一字节长的英文字符并存于同一套编码方案里，因此他们写的程序为了支持中文处理，</span><br><span class="line">必须要注意字串里的每一个字节的值，如果这个值是大于<span class="number">127</span>的，那么就认为一个双字节字符集里的字符出现了</span><br></pre></td></tr></table></figure>
<p>从ASCII到GB2312，再到GBK，而后GB18030，中华民族终于完成了全量中文字符的编码，简单总结下</p>
<ul>
<li>第一阶段：中国人民通过对 ASCII 编码的中文扩充改造，产生了GB2312 编码，可以表示6000多个常用汉字。</li>
<li>第二阶段：汉字实在是太多了，包括繁体和各种字符，于是产生了 GBK 编码，它包括了 GB2312 中的编码，同时扩充了很多。</li>
<li>第三阶段：中国是个多民族国家，各个民族几乎都有自己独立的语言系统，为了表示那些字符，继续把 GBK 编码扩充为 GB18030 编码，完成全量中文字符编码。</li>
</ul>
<h2 id="六、UNICODE"><a href="#六、UNICODE" class="headerlink" title="六、UNICODE"></a>六、UNICODE</h2><p>之后的世界，百花齐放，百家争鸣，<strong>各国纷纷制造自己的编码规范，同时互相不去理解对方规范，即使同一种语言也区别巨大</strong>，例如台湾地区中文采用<code>big5</code>的繁体编码，名字也牛逼大了，叫<code>大五码</code>。</p>
<p>各自为政引来了大量的问题，<strong>各个语言互不兼容</strong>，此时，一堆大佬看不下去了，勇敢的站了出来，着手解决这个问题，他们成立了一个类似于TC的组织，叫做<code>ISO</code>(International Organization for Standardization 国际标准化组织)。</p>
<p>他们采用的方法很简单：<strong>废了所有的地区性编码方案，重新搞一个包括了地球上所有文化、所有字母和符号的编码</strong>！他们打算叫它”Universal Multiple-Octet Coded Character Set”，简称 <code>UCS</code>, 俗称 “<code>UNICODE</code>“。这就是<strong>Unicode，就像它的名字都表示的，这是一种所有符号的编码</strong>！</p>
<p>UNICODE统一了各国，成为了实事上的大一统的编码规范。这种编码非常大，大到可以容纳世界上任何一个文字和标志。所以只要电脑上有 UNICODE 这种编码系统，无论是全球哪种文字，只需要保存文件的时候，保存成 UNICODE 编码就可以被其他电脑正常解释。</p>
<figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">非专业人士忽略：<span class="built_in">unicode</span> 编码</span><br><span class="line"><span class="built_in">unicode</span>开始制订时，计算机的存储器容量极大地发展了，空间再也不成为问题了。</span><br><span class="line">于是ISO就直接规定<span class="symbol">:</span></span><br><span class="line"><span class="number">1</span>：必须用两个字节，也就是<span class="number">16</span>位来统一表示所有的字符</span><br><span class="line"><span class="number">2</span>：对于ASCII里的那些“半角”字符，<span class="built_in">unicode</span>包持其原编码不变，只是将其长度由原来的<span class="number">8</span>位扩展为<span class="number">16</span>位，</span><br><span class="line"><span class="number">3</span>：其他文化和语言的字符则全部重新统一编码。</span><br><span class="line"></span><br><span class="line">由于”半角”英文符号只需要用到低<span class="number">8</span>位，所以其高<span class="number">8</span>位永远是<span class="number">0</span>，因此这种大气的方案在保存英文文本时会多浪费一倍的空间。</span><br></pre></td></tr></table></figure>
<h2 id="七、UTF，UTF8，UTF16"><a href="#七、UTF，UTF8，UTF16" class="headerlink" title="七、UTF，UTF8，UTF16"></a>七、UTF，UTF8，UTF16</h2><p>UNICODE很好的解决了不同语言统一编码的问题，但同样也不完美，有两个主要问题，</p>
<ul>
<li><strong>字符识别</strong>：如何才能区别unicode和ascii？计算机怎么知道三个字节表示一个符号，而不是分别表示三个符号呢？</li>
<li><strong>存储浪费</strong>：我们已经知道，英文字母只用一个字节表示就够了，如果unicode统一规定，每个符号用三个或四个字节表示，那么<strong>每个英文字母前都必然有二到三个字节是0，这对于存储空间来说是极大的浪费，文本文件的大小会因此大出二三倍</strong>。</li>
</ul>
<p>此时<code>UTF</code>(unicode transfer format)标准出现了，顾名思义，是<strong>UNICODE在传输和存储过程中的格式化标准</strong>，其中使用最广的是utf8和utf16</p>
<p><code>UTF-16</code>相对好理解，就是<strong>任何字符对应的数字都用两个字节来保存！我们通常对Unicode的理解就是把Unicode与UTF-16等同</strong>了。但是很显然如果都是英文字母这做有点浪费，明明用一个字节能表示一个字符为啥整两个啊。</p>
<p><code>UTF-8</code>最大的一个特点，就是它是一种<strong>变长的编码方式</strong>。它可以<strong>使用1~4个字节表示一个符号，根据不同的符号而变化字节长度</strong>，当字符在ASCII码的范围时，就用一个字节表示，保留了ASCII字符一个字节的编码做为它的一部分，注意的是unicode一个中文字符占2个字节，而UTF-8一个中文字符占3个字节）。从unicode到utf-8并不是直接的对应，而是要过一些算法和规则来转换。</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">非专业人士直接忽略：unicode 如何转换成utf<span class="number">-8</span></span><br><span class="line">以小拽的<span class="string">"拽"</span>字为例</span><br><span class="line"></span><br><span class="line">Unicode符号范围 | UTF<span class="number">-8</span>编码方式</span><br><span class="line">(十六进制) | （二进制）</span><br><span class="line">—————————————————————–</span><br><span class="line"><span class="number">0000</span> <span class="number">0000</span><span class="number">-0000</span> <span class="number">007</span>F | <span class="number">0</span>xxxxxxx</span><br><span class="line"><span class="number">0000</span> <span class="number">0080</span><span class="number">-0000</span> <span class="number">07</span>FF | <span class="number">110</span>xxxxx <span class="number">10</span>xxxxxx</span><br><span class="line"><span class="number">0000</span> <span class="number">0800</span><span class="number">-0000</span> FFFF | <span class="number">1110</span>xxxx <span class="number">10</span>xxxxxx <span class="number">10</span>xxxxxx</span><br><span class="line"><span class="number">0001</span> <span class="number">0000</span><span class="number">-0010</span> FFFF | <span class="number">11110</span>xxx <span class="number">10</span>xxxxxx <span class="number">10</span>xxxxxx <span class="number">10</span>xxxxxx</span><br><span class="line">中文一般三个字节，前置标识位</span><br><span class="line"></span><br><span class="line">举个栗子，中文：拽 unicode是<span class="number">25341</span></span><br><span class="line"><span class="number">25341</span>                    十进制 unicode</span><br><span class="line"><span class="number">0x62fd</span>                   十六进制 </span><br><span class="line"><span class="number">0110</span> <span class="number">0010</span> <span class="number">1111</span> <span class="number">1101</span>      二进制 </span><br><span class="line"></span><br><span class="line">### 套上模板</span><br><span class="line"><span class="number">0110</span>      <span class="number">001011</span>    <span class="number">111101</span>      二进制  <span class="number">25341</span></span><br><span class="line"><span class="number">1110</span>xxxx  <span class="number">10</span>xxxxxx  <span class="number">10</span>xxxxxx    模板第三行</span><br><span class="line"><span class="number">11100110</span>  <span class="number">10001011</span>  <span class="number">10111101</span>    utf8 二进制</span><br><span class="line">e   <span class="number">6</span>     <span class="number">8</span>   b     b   d       utf8 十六进制【一切为了节省】</span><br><span class="line">最终utf8拽对应的就是<span class="number">0xe68bdb</span></span><br></pre></td></tr></table></figure>
<p>UTF-8就是在互联网上使用最广的一种unicode的实现方式，这是为传输而设计的编码，并使编码无国界，这样就可以显示全世界上所有文化的字符了。</p>
<p>简单对比下GB系列，UTF8，UTF16 </p>
<ul>
<li>UTF16：不推荐使用utf16，因为<strong>utf16最初能表示的字符数有6万多，看起来很多，但是实际上目前 Unicode5.0 收录的字符已经达到99024个字符，其实不够，有可能出现乱码</strong>。</li>
<li>UTF8：国际化编码首推UTF8，兼容全量，<strong>唯一的问题是空间略有浪费</strong>!</li>
<li>GB系列：<strong>GB系列都是双字节字符集，相对节省空间，如果只是国内使用GB18030完全可以兼容所有</strong>。</li>
</ul>
<h2 id="八、“锟斤拷��”-是什么"><a href="#八、“锟斤拷��”-是什么" class="headerlink" title="八、“锟斤拷��” 是什么"></a>八、“锟斤拷��” 是什么</h2><p>通过上面介绍，可以看出来，各个编码规则是不一样的，目前互联网浏览器默认传输和解析方式是UTF8，但是部分老的网页采用GB系列，就会出现传输过程UTF8解析不了，展示GB错乱问题。</p>
<p>UNIDCODE规定：<strong>当unicode遇到解释失败的字时，会尝试用 「U+FFFD」 来代替，「U+FFFD」乃是 unicode 的一个占位符， 显示为 �</strong></p>
<p>而utf8识别为异常的传输字符后，传到页面转为双字节展示的GB会怎么样呢？<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">➜ xiaozhuai ✗ python</span><br><span class="line">Python <span class="number">2.7</span><span class="number">.10</span> (default, Aug <span class="number">17</span> <span class="number">2018</span>, <span class="number">19</span>:<span class="number">45</span>:<span class="number">58</span>)</span><br><span class="line">[GCC <span class="number">4.2</span><span class="number">.1</span> Compatible Apple LLVM <span class="number">10.0</span><span class="number">.0</span> (clang<span class="number">-1000.0</span><span class="number">.42</span>)] on darwin</span><br><span class="line">Type <span class="string">"help"</span>, <span class="string">"copyright"</span>, <span class="string">"credits"</span> <span class="keyword">or</span> <span class="string">"license"</span> <span class="keyword">for</span> more information.</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s = (<span class="string">u'\uFFFD'</span>.encode(<span class="string">'utf8'</span>)*<span class="number">2</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(s.decode(<span class="string">'gbk'</span>))</span><br><span class="line">锟斤拷</span><br></pre></td></tr></table></figure></p>
<p>也就产生了，传说中的”锟斤拷”神器！</p>
<blockquote>
<p>另外还有几个神器：”烫烫烫烫烫，屯屯屯屯屯屯”<br>“烫” 主要出没于 windows 平台下，ms 的 vc++ 编译器中， 当你在栈内开辟新内存时， vc 会使用 0xcc 来初始化填充， 很多个 0xcc 连起来就成了 烫烫烫烫烫 同理在堆内开辟新内存时， 会用 0xcd 填充，这便是 屯屯屯屯屯屯<br>不管是 “锟斤拷” 还是 “烫” 都要求最后是用GB码输出。</p>
</blockquote>
<h2 id="九、ICU"><a href="#九、ICU" class="headerlink" title="九、ICU"></a>九、ICU</h2><p>在unicode的统治下，世界各国的基本编码不会出现乱码等异常。但当中华民族逐步强大，准备冲出中国统一世界的时候，<strong>发现各国的货币，时间，数字等表示灰常不统一</strong>，例如数字1234.5，英文表示1,234.5，葡语表示确是1.234,5，很是苦恼。</p>
<p>此时IBM站了出来，叫上google,apple等小伙伴，<strong>遵循”IBM公共许可证”，开源了一套基于unicode的国际化组件</strong><code>ICU</code>(International Component for Unicode<br>)。<strong>根据各地的风俗和语言习惯，实现对数字、货币、时间、日期、和消息的格式化、解析，对字符串进行大小写转换、整理、搜索和排序等功能</strong>，ICU4C提供了强大的BIDI算法，对阿拉伯语等BIDI语言提供了完善的支持。</p>
<p><strong>ICU成为了目前国际化组件的实事标准，底层依赖UNICODE和CLDR</strong>，官方提供了C/C++和JAVA的SDK，ICU4C和ICU4J，同时，各个语言在此基础上开发了各个语言的版本，例如php的intl组件。</p>
<h2 id="十、实事标准"><a href="#十、实事标准" class="headerlink" title="十、实事标准"></a>十、实事标准</h2><p>字符编码的从产生，发展，到国际化一步一步走来，逐步形成了下列实事标准</p>
<ul>
<li>字符集：UNICODE</li>
<li>字节编码：UTF8</li>
<li>国际化：ICU</li>
</ul>
<blockquote>
<p>需要注意的是，mysql的utf8并不完全兼容标准的utf8编码，后续推出了utf8mb4完全兼容，所以推荐采用utf8mb4</p>
</blockquote>
<p>参考网站：</p>
<ul>
<li>BIDI：<a href="https://www.ibm.com/developerworks/cn/web/1404_xiayin_bidihtml/index.html" target="_blank" rel="external">https://www.ibm.com/developerworks/cn/web/1404_xiayin_bidihtml/index.html</a></li>
<li>CLDR：<a href="http://cldr.unicode.org/" target="_blank" rel="external">http://cldr.unicode.org/</a></li>
<li>ICU：<a href="http://site.icu-project.org/design/size/cldr" target="_blank" rel="external">http://site.icu-project.org/design/size/cldr</a></li>
<li>UNICODE：<a href="http://www.unicode.org/standard/versions/enumeratedversions.html" target="_blank" rel="external">http://www.unicode.org/standard/versions/enumeratedversions.html</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> 国际化 </tag>
            
            <tag> 字符编码 </tag>
            
            <tag> ICU </tag>
            
            <tag> UTF </tag>
            
            <tag> UNICODE </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[【周记】996思考和团队文化]]></title>
      <url>/2019/05/06/%E3%80%90%E5%91%A8%E8%AE%B0%E3%80%91996%E6%80%9D%E8%80%83%E5%92%8C%E5%9B%A2%E9%98%9F%E6%96%87%E5%8C%96/</url>
      <content type="html"><![CDATA[<blockquote>
<p>题记：从外卖财务团队转做出行国际化团队^_^，入了新团队。恰好新团队要求，每周要写点感悟分享，字数内容不限，转到blog</p>
</blockquote>
<h2 id="20190504-《思考996》"><a href="#20190504-《思考996》" class="headerlink" title="20190504 《思考996》"></a>20190504 《思考996》</h2><hr>

<p>本周五一旅途，来回20小时的驾驶，听完了案件一郎的《被讨厌的勇气》，在阿德勒的思想中游历了一番，颇为惬意！</p>
<p>《被讨厌的勇气》通过青年和禅师对话，分层次的剖析了束缚人的三个因素：<strong>卑缅过去，期幻未来，沉溺人际关系</strong>，之后从哲学和心理学角度来逐个击破，帮助青年挣脱束缚，解放自我！</p>
<p>正如书中所述：<strong>人生很简单，认真并且无需深刻</strong>！<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">## 解读：</span><br><span class="line">当下，过多的人在追求一些极为深刻和复杂的事情，</span><br><span class="line">而做不到一些极为简单的习惯，譬如总结，锻炼等等。</span><br><span class="line">回收蓦然，一事无成。</span><br><span class="line"></span><br><span class="line">倘若能够认真的对待每一件际遇，不浮不躁，</span><br><span class="line">不急于奔向所谓的未来，认真对待当下，</span><br><span class="line">人生一定会回馈给你一个更美好的未来！</span><br></pre></td></tr></table></figure></p>
<p>想到当下热议的996工作方式，作为一名计算机工程师，真的很庆幸自己能够生活在第三次工业革命的信息化时代，能够通过自己的技能来解决问题。回想自己这几年的工作，成长和产出的最快的时光偏偏都和996无关，却和一些认真的小习惯息息相关</p>
<ul>
<li><strong>规划总结</strong>：分时间片的规划自己的行程，珍惜规划后行程中的每一个时间片，而后对自己走过的时间片进行总结思考。每个人的能力不一样，长期的总结纠偏，教会自己把控自身的能力范围和人生轨迹，学会更多的和自我交流。而安静和轻松的环境，恰恰可以让你更深度的思考，996反之！</li>
<li><strong>持续学习</strong>：保持初心，持续学习。无论从个人还是公司角度看，持续的学习都是一个+EV的操作；所以相对于996的丧心病狂去写一堆不可维护的烂代码，做一个无法扩展的缺陷设计，真的很庆幸自己一直能够抽出一丢丢时间来持续学习。</li>
<li><strong>解决问题</strong>：在飞速发展的互联网行业，提升解决问题的能力一直是我的第一准则。尤其是和大牛们在一起解决问题，你会学习到很多解决问题的方法：需求分析，方案折中，迭代优化等等；但996绝对不是解决问题的方式，因为，真正需要解决的问题，如果平时解决不了，996依然解决不了。哈哈，偷偷告诉你，职业生涯困惑迷茫的时候，请大牛吃顿饭往往会有意想不到的收获！！！</li>
<li><strong>分享交流</strong>：实践证明，在分享出自己的观点和总结的同时，总能够收获到很多超出预期的建议。不信，你可以试试，而且，分享只需要：认真且无需深刻！</li>
</ul>
<p>对于被迫996的工作方式，小拽是完全反对，996方式的时间榨取，在长远来看一定不是全局最优的，除了榨取时间，也丧失了生活，主观能动性和创造力！</p>
<p>最后摘录阿德勒的一段话共勉，珍惜当下：</p>
<blockquote>
<p>其实人生总是处于完结状态的，即使生命终结于此时此刻，那也无需称之为不幸。无论是20岁终结还是90岁终结，都是完结的、幸福的人生。认真的过好此时此刻，每一个刹那都是一种完结。人生最大的谎言就是纠结过去，关注未来，却一直忽略此时此刻，这就是对自己的人生和无可替代的刹那撒下的最大的谎言。对于当下来说，过去和未来根本就不存在，所以我们只谈现在。</p>
</blockquote>
<blockquote>
<p>决定人生的既不是昨天也不是明天，而是此时此刻。</p>
</blockquote>
<h2 id="20190427-《思考团队文化》"><a href="#20190427-《思考团队文化》" class="headerlink" title="20190427 《思考团队文化》"></a>20190427 《思考团队文化》</h2><hr>

<p>本周对于团队文化和制度的思考。一个团队必须有自己的文化和做事方式，否则，太多的磨合和不默契会浪费很多时间。初来乍到，非常认可目前的团队文化，也希望能通过团队文化，提升大家对团队的认可，增加合作的默契！</p>
<ul>
<li><strong>follow through </strong>：做事情，有始有终，跟进到底，凡事必须要有后续的action和落地评估，show me what you do not what you say ！</li>
<li><strong>主动性</strong>：相较于被动的执行，主动的思考，抽象，沟通，推进更有利于业务和个人的成长。人非圣贤，皆有惰性，被动的制度来提升主动习惯，是养成主动性的有效方式！</li>
<li><strong>沉淀</strong>：rush和沉淀相辅相成，如同折中的思考架构和业务，每周抽出10%的时间来沉淀和思考重要不紧急的事情，无论对自身，对业务长远来看都非常重要！<br>另外，其实结合自身情况，提出两点，也希望自己能够坚持</li>
<li><strong>效率至上</strong>：不提倡无效加班，做事情讲究效率至上。为了提升效率，无论沟通，还是执行，从长远角度看，都要做到事前准备，事中高效，事后反思！</li>
<li><strong>健康团队</strong>：团队的健康不仅仅是停留在业务产出，团队健康包含但不限于小伙伴的身体健康，工作积极性，成长空间，技术氛围，竞争格局！</li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> 周记 </tag>
            
            <tag> 2019 </tag>
            
            <tag> 996思考 </tag>
            
            <tag> 团队文化 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[数据归档那些事儿]]></title>
      <url>/2019/04/03/%E6%95%B0%E6%8D%AE%E5%BD%92%E6%A1%A3%E9%82%A3%E4%BA%9B%E4%BA%8B%E5%84%BF/</url>
      <content type="html"><![CDATA[<blockquote>
<p>在<a href="http://cuihuan.net/2019/04/01/%E7%83%AD%E7%82%B9%E8%B4%A6%E6%88%B7%E9%97%AE%E9%A2%98%E5%92%8C%E5%B8%B8%E7%94%A8%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E3%80%90%E4%B8%AD%E3%80%91/">热点账户问题和常用解决方案【中】</a>这篇文章中提到，解决热点读性能的一个非常通用方式是数据归档。本篇小拽总结下在操作数据归档过程中遇到的一些问题和经验！</p>
</blockquote>
<h2 id="一、数据归档"><a href="#一、数据归档" class="headerlink" title="一、数据归档"></a>一、数据归档</h2><p>所谓数据归档就是把部分<code>低频访问的历史数据</code>从线上库迁移到归档库的过程。在设计数据归档方案的时候通常需要思考三个问题</p>
<ul>
<li>归档前：如何进行存储选型</li>
<li>归档中：如何保证迁移准确</li>
<li>归档后：如何处理数据完整性破坏所引起的问题</li>
</ul>
<p>下面也着重从这三部分来聊聊</p>
<h2 id="二、存储选型"><a href="#二、存储选型" class="headerlink" title="二、存储选型"></a>二、存储选型</h2><p><strong>存储选型</strong>是归档前要做的最重要的一件事情，目前市面上的存储方式多如牛毛，如何选择能够支撑当前业务环境的存储选型，就非常重要！</p>
<h3 id="2-1-归档的数据特点"><a href="#2-1-归档的数据特点" class="headerlink" title="2.1 归档的数据特点"></a>2.1 归档的数据特点</h3><p>既然是要选型数据归档的存储，首先来需要梳理下<strong>归档数据</strong>的特点</p>
<ul>
<li>读性能：归档数据对读性能没啥要求，能够读出来就可以</li>
<li>写性能：尽可能好的批量写入性能，能够批量1w+达标</li>
<li>压缩比：尽可能的节省空间，采用高压缩比的存储引擎</li>
<li>分布式：最好能够分布式，考虑到目前单片都40T了，非分也可</li>
<li>数据量级：上限尽可能高，考虑到实际情况，10TB+目前达标</li>
<li>一致性保证：归档是兜底，尽可能高的保证数据不会出现异常丢失</li>
</ul>
<h3 id="2-2-通用选型因素"><a href="#2-2-通用选型因素" class="headerlink" title="2.2 通用选型因素"></a>2.2 通用选型因素</h3><p>除了考虑归档数据的特点，还要考虑一些通用因素，例如</p>
<ul>
<li>公司是否运维支持：大厂这个因素很重要，如果运维支持背书，最好不过！</li>
<li>开源活跃程度：活跃度太低不能选</li>
<li>普遍使用场景：跳出存储给的通用场景的不能选</li>
</ul>
<h3 id="2-3-备选存储的特性"><a href="#2-3-备选存储的特性" class="headerlink" title="2.3 备选存储的特性"></a>2.3 备选存储的特性</h3><p>也初步总结和梳理了下可能用到的集中存储的特性</p>
<p><a href="http://cuihuan.net/wp_content/new/finance/archive_1.png"><img src="http://cuihuan.net/wp_content/new/finance/archive_1.png" alt="archive_1"></a></p>
<p>结合归档数据的特点和不同存储的优势，最终选用了</p>
<ul>
<li>rocksDB：作为存储归档数据引擎，性能和数据压缩比都不错，最主要是公司DBA愿意支持</li>
<li>ES：作为在线查询，公司运维支持</li>
<li>HIVE：作为财务数仓核心数据和全量数据中心，哈哈，为下一篇财务数据中台做铺垫^_^</li>
<li>fusion：作为幂等健破坏后的幂等健KV池</li>
</ul>
<h2 id="三、一致性保证"><a href="#三、一致性保证" class="headerlink" title="三、一致性保证"></a>三、一致性保证</h2><p><code>归档过程存在会删除线上数据，是个非常高危的操作</code>，所以操作过程中和操作之后都需要特别注意数据一致性的保证。</p>
<p>对于操作过程的一致性保证相对简单，过程通常两步<br>step1 插入确认：查询线上库-&gt;插入归档库-&gt;查询归档库-&gt;确认插入<br>step2 删除确认：删除线上库-&gt;查询线上库-&gt;确认删除<br>注意：过程中尽可能的保证读取和写入的时间，删除会锁库，大批量读会抢网络和IO，防止对线上业务造成压力，尽可能调优批量数据，推荐条目在200-1000条一次，数据量在5M-100M一次</p>
<h2 id="四、归档后问题"><a href="#四、归档后问题" class="headerlink" title="四、归档后问题"></a>四、归档后问题</h2><p><code>数据归档后，必然破坏了数据的完整性</code>，会造成下面几个问题,，需要提前考虑</p>
<h3 id="4-1-读数据穿透问题"><a href="#4-1-读数据穿透问题" class="headerlink" title="4.1 读数据穿透问题"></a>4.1 读数据穿透问题</h3><p>低频历史数据归档后，造成线上数据缺失，查询数据穿透和范围关系查询损失都会存在。因此，数据归档后，对于读操作有两种处理方式</p>
<ul>
<li>归档数据不读：最简单，但是对于某些场景可能确实不太合适。</li>
<li>读proxy兼容：通过读proxy，穿透性的选择各种存储截止。</li>
</ul>
<p>针对读数据，还有一种比较特殊的情况，就是跨区间范围关系聚合，这样就<code>需要有一份完整数据</code>来满足极端需求，目前财务系统对于这类需求统一走离线财务数仓来解决！</p>
<h3 id="4-2-写幂等破坏问题"><a href="#4-2-写幂等破坏问题" class="headerlink" title="4.2 写幂等破坏问题"></a>4.2 写幂等破坏问题</h3><p>对于写数据最大的问题就是幂等健被破坏，<code>归档了数据后，rds写入唯一健破坏，在极端情况下，可能会造成duplicate</code>。考虑到问题的出现概率和实现成本，初期可以忽略，采用人工干预的方式，归档最终要写入全量，写不进去就是duplicate了；后面可以采用前置幂等健组来挡，做到最终一致！</p>
<h3 id="4-3-数据一致性问题"><a href="#4-3-数据一致性问题" class="headerlink" title="4.3 数据一致性问题"></a>4.3 数据一致性问题</h3><p>无论是数仓数据还是归档数据，作为财务数据，一旦提供资金服务，那么就必须保证强一致性，财务目前采用离线分天统计数据的金额和数量，来保证宏观上的一致性。这里面也有需要小坑，例如数据飘移，时间gap等，关于财务数仓中遇到的坑和解决方案，后续专项讨论</p>
<h2 id="五、最终归档方案"><a href="#五、最终归档方案" class="headerlink" title="五、最终归档方案"></a>五、最终归档方案</h2><p>分析了归档前选型，归档中数据转移，归档后数据完整性问题，初步的归档方案如下图</p>
<p><a href="http://cuihuan.net/wp_content/new/finance/archive_2.png"><img src="http://cuihuan.net/wp_content/new/finance/archive_2.png" alt="archive_2"></a></p>
<p>简单梳理下核心流程</p>
<ul>
<li><p>写数据流：写数据写入online rds[备注：目前没有前置幂等拦截，后面择机完善]，写入后通过binlog准实时写入es，提供线上读服务；通过binlog小时级入hive，作为分析数据和全量数据存储；通过天级归档脚本，将历史数据导入rocksdb归档。同时，如果有日切，也会天级进行数据日切和新表创建。</p>
</li>
<li><p>读数据流：读数据过proxy，非归档期间数据直接读取es，归档数据和es没有的数据都会穿透到rocksdb。</p>
</li>
<li><p>监控流：天级监控hive，es，rocksdb，三个不同来源的数据条目和总金额，保证一致性。</p>
</li>
</ul>
<h2 id="六、总结和不足"><a href="#六、总结和不足" class="headerlink" title="六、总结和不足"></a>六、总结和不足</h2><p>本篇主要总结了小拽在数据归档过程中，如何选型，如何归档以及在归档数据后引起的问题如何处理。</p>
<p>通过数据归档，更清楚的划定了不同存储介质的功能边界，是进行数据中台搭建，赋能业务的前置准备！</p>
]]></content>
      
        
        <tags>
            
            <tag> 数据归档 </tag>
            
            <tag> 存储选型 </tag>
            
            <tag> 数据通道 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[热点账户问题和常用解决方案【中】]]></title>
      <url>/2019/04/01/%E7%83%AD%E7%82%B9%E8%B4%A6%E6%88%B7%E9%97%AE%E9%A2%98%E5%92%8C%E5%B8%B8%E7%94%A8%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E3%80%90%E4%B8%AD%E3%80%91/</url>
      <content type="html"><![CDATA[<blockquote>
<p>话接上回，上篇阐述了什么是热点账户，基本财务账户如何设计，幂等健和链式设计！本篇将针对热点账户在实践中引发的问题，梳理和拆解业务流，分析问题点，提出七种常用解决方案。</p>
</blockquote>
<h2 id="一、性能问题初现"><a href="#一、性能问题初现" class="headerlink" title="一、性能问题初现"></a>一、性能问题初现</h2><p>上线初期数据量较小，运行正常！<br>一次大促后，账户流水的总数目接近亿级别，初现性能问题：<code>系统整体的qps也就10+，但热点账户写入失败率偏高，并且随数据量增加失败率逐步升高；整个账户系统全靠上游有redo标识位不断重试，才能保证最终写入成功!</code></p>
<p>哈哈，作为一名拥有三年工作经验的老码农，面对问题，要做的第一件事，就是<code>静</code>，抽根烟静静，准备开搞！</p>
<h2 id="二、数据流拆解"><a href="#二、数据流拆解" class="headerlink" title="二、数据流拆解"></a>二、数据流拆解</h2><p>拿到问题，抽根烟静一下之后，分析问题需要三步：<strong>梳理数据流，拆解过程，定位问题点</strong>。先对财务账户更新的数据流进行拆解</p>
<p><a href="http://cuihuan.net/wp_content/new/finance/finance_hot_account_3.png"><img src="http://cuihuan.net/wp_content/new/finance/finance_hot_account_3.png" alt="finance_hot_account_3"></a></p>
<p>链式锁后的基本账户操作过程，分为如下五阶段</p>
<ul>
<li>请求阶段：账户操作请求。</li>
<li>查询阶段：查询当前账户信息。主要获取当前链，资金数据等！</li>
<li>计算阶段：对链和操作的资金进行计算，判定资金操作合规，同时保证幂等和并发！</li>
<li>写入阶段：事务同步写入流水和余额</li>
<li>响应阶段：告知上游回调</li>
</ul>
<h2 id="三、链路分析"><a href="#三、链路分析" class="headerlink" title="三、链路分析"></a>三、链路分析</h2><p>梳理数据流后，接下来分析每个阶段可能引发的问题。按照优先级，<code>先分析业务问题区域（读取阶段，计算阶段，写入阶段）</code>，通常问题会出现在业务阶段；之后，<code>再分析框架问题区域（请求阶段和回调阶段）</code>，该区域出现问题的情况偏小，但是一旦出现问题，就是比较有意思^_^！</p>
<h3 id="3-1-业务问题区域分析"><a href="#3-1-业务问题区域分析" class="headerlink" title="3.1 业务问题区域分析"></a>3.1 业务问题区域分析</h3><p>读取阶段，计算阶段，写入阶段三个阶段是具体的业务操作，从并发和耗时两个角度来分析下可能的问题点</p>
<h4 id="3-1-1-耗时分析"><a href="#3-1-1-耗时分析" class="headerlink" title="3.1.1 耗时分析"></a>3.1.1 耗时分析</h4><p>耗时分为三块</p>
<ul>
<li>查询耗时：RDS拥有亿级别数据量，<code>查询未中primary，但命中索引，业务数据体并未完全在索引中，因此访问数据走index match；数据主键聚簇，唯一健索引查询获取数据，page极难命中cache，也不会命中磁盘电梯算法优化！结合实际情况，查询耗时在10-100ms级别</code></li>
<li>写入耗时：insert 包含了自增，理论上在数据落盘是追加写，即使uniq_key去创建索引的情况下，耗时在ms级</li>
<li>过程耗时：长连接情况下，init conn时间基本可以忽略，但是读写两次往返数据库的链路时间还是需要考虑，整体预估在1-2ms之间</li>
</ul>
<p>从整体上看，预估该阶段的耗时在10-100+ms，从实际失败率来看也基本一致！</p>
<h4 id="3-1-2-并发分析"><a href="#3-1-2-并发分析" class="headerlink" title="3.1.2 并发分析"></a>3.1.2 并发分析</h4><ul>
<li>天级QPS：当时分析天级几十万单，天级QPS不到10，不高！</li>
<li>瞬间QPS：每个订单拆解到资金流后，会同时操作多次热点账户，瞬间qps相对很高，理论qps就可能达到语言上限，由于上游链路限流1024，按照10级别操作拆分，理论上满池QPS在万级别。考虑实际单量，瞬间QPS=单量(10)*拆解量(10)，实际的满额预估QPS可能到100+ ！</li>
</ul>
<p>按照上面分析，在<code>瞬时QPS达到10+的情况下，热点账户整体延时在10-100+ms，由于DB在写入uniq_key保证链点唯一，所以出现并发写入失败也在情理之中</code>；并且随着数据量的提升，读取延时增加，写入失败率会继续增加。</p>
<h3 id="3-2-框架问题区域"><a href="#3-2-框架问题区域" class="headerlink" title="3.2 框架问题区域"></a>3.2 框架问题区域</h3><p>请求阶段做为入口，一般也分为三个小阶段</p>
<ul>
<li>webserver接收请求</li>
<li>框架加载和路由</li>
<li>基础校验</li>
</ul>
<p>请求阶段核心耗时一般存在于框架加载和路由，高并发场景webserver和upstream之间的调用也是一个可能出问题点！当时财务系统，采用欢总封装的go-thrift，并且其他模块并未出现请求阶段问题，所以并未对这个阶段的latency和并发做一个衡量，重点分析了业务模块！</p>
<h2 id="四、解决方案"><a href="#四、解决方案" class="headerlink" title="四、解决方案"></a>四、解决方案</h2><h3 id="4-1-读取和写入阶段优化"><a href="#4-1-读取和写入阶段优化" class="headerlink" title="4.1 读取和写入阶段优化"></a>4.1 读取和写入阶段优化</h3><p>通过上面分析，目前问题的痛点是<code>并发读取热点账户数据高延时引发写入失败</code>，提升读性能成为了关键</p>
<blockquote>
<p>读性能提升有两个基本思路：<strong>读的时效快和读的次数少</strong></p>
</blockquote>
<p>针对上面两个基本思路，结合财务账户情况提出了五种提升读性能的解决方案</p>
<ul>
<li><strong>【读快】持久化last record</strong>：不从全量数据里面读，抽离子账户的最新信息，持久化到单独的表中或者内存中，降低整体数据量，提升了读性能。<code>缺点是要保证持久化信息的准确性，引入事务写。</code></li>
<li><strong>【读快】纵向切分-时间分库分表</strong>：按照时间进行纵向切分，降低查询范围内的数据量，提升读性能。<code>缺点是跨时间读不友好，开发量也不小</code></li>
<li><strong>【读快】纵向切分-归档</strong>：历史数据归档是<code>实现相对简单，跨时间读也比较友好，随着数据量的提升，也是必须要做</code>，之后会详细介绍归档方案和选型。</li>
<li><strong>【读快】横向切分-业务分库分表</strong>：按照账户类型或者城市分库分表，可以优化读写数据量，同时，跨表读负担也会较小。但对于热点账户或者热点城市，依然聚簇，效果不是很明显。同时，再次对热点账户进行横向分库分表也是极度不推荐，引入的极高的读写成本均。</li>
<li><strong>【读少】阶段快照</strong>：一定量或者一定时间内的数据，持久化一次。优势是极大的降低读写次数；缺点是需要复杂的逻辑来保证undo操作和数据一致性！</li>
</ul>
<p>五种解决方案各有千秋，作为一个初期的财务系统推荐采用持久化last record和数据归档来保证写入读性能和整体读的数据量。如果系统发展到了中期，推荐按照时间分库分表。如果发展到了双11或者春晚某些极端场景，牺牲掉部分准确性，采用阶段快照也是可以的。</p>
<h3 id="4-2-计算阶段优化"><a href="#4-2-计算阶段优化" class="headerlink" title="4.2 计算阶段优化"></a>4.2 计算阶段优化</h3><p>存在计算阶段造成的最大影响也就是引起了两次数据传输，通常是不可避免的，但是如果真的是要进行提升有一种方案通用方案</p>
<ul>
<li><strong>DB计算</strong>：<code>通过存储计算，转嫁计算成本给DB，减少一次链路请求。</code>但不太推荐，复杂的sql往往有坑，insert computer from select 还会造成大面积的数据隔离，很容易引起死锁。</li>
</ul>
<h3 id="4-3-请求和回调阶段优化"><a href="#4-3-请求和回调阶段优化" class="headerlink" title="4.3 请求和回调阶段优化"></a>4.3 请求和回调阶段优化</h3><p>请求阶段一般有三种形式：<strong>同步调用，异步调用和伪同步调用</strong>！<br>前两种调用非常常见：同步爆池的情况，一般采用限流来降压，采用漏桶，令牌桶等等策略；异步调用通常采用消息队列来削峰填谷；这里重点阐述对于支付和财务系统在请求阶段经常采用的伪同步的方式</p>
<p>伪同步流量较早出现在innodb，leveldb等存储引擎为了利用追加写提升写入性能，采用类WAL日志来持久化数据。通常伪同步方案采用三件套：<code>WAL日志+校验位+广播消息</code>来完成一次完整的请求！流程图一般如下</p>
<p><a href="http://cuihuan.net/wp_content/new/finance/finance_hot_account_4.png"><img src="http://cuihuan.net/wp_content/new/finance/finance_hot_account_4.png" alt="finance_hot_account_4"></a></p>
<ul>
<li>请求阶段：同步请求调用，核心要素追加写入wal日志，变更校验位，完成同步调用！此处追加写保证了快速写入，校验位来保证数据的最终写入成功。图中1，2</li>
<li>异步阶段：<code>通过读取wal日志的核心数据，进行复杂事务处理，如果成功进入下一阶段；如果失败，没问题，通过外部trigger来触发redo操作！如果多次redo依然失败，那么通过undo来回滚数据</code>。</li>
<li>回调阶段：如果成功，更改校验位，同时发布成功广播消息，关注结果和时效性的模块，可以获取最终成功的标识！如果undo回滚数据，则发布失败广播消息，告知结果失败！</li>
</ul>
<p>在伪同步的模式下指标衡量：</p>
<ul>
<li>QPS：伪同步模式，采用WAL核心要素追加写，所以写性能可以极大提升，进而满额QPS相对直接同步调用也大量提升</li>
<li>时效性：伪同步并非完全同步，所以结果需要监听回调。对于结果强一致的请求，必须监听回调，确保一致，时效性降低；对于弱一致可以认为同步回调即成功，时效性提升。</li>
<li>失败率：操作知识核心要素追加写入，真正的操作通过异步保证，整体成功率提升！</li>
</ul>
<p>对于资金处理过程，大量采用<strong>伪同步的请求方式来保证快速写入和最终一致性</strong>。</p>
<h3 id="4-4-解决方案总结"><a href="#4-4-解决方案总结" class="headerlink" title="4.4 解决方案总结"></a>4.4 解决方案总结</h3><p>总的来说，归结了七种优化方式（哈哈，上篇写的八种优化，当时总结的，现在愣是想不到还有啥了^_^）。其中请求和回调的伪同步方式，是在架构层面优化，这个在多数的财务系统和财务系统的内部数据流中都会用到；而读写和计算阶段的优化，可以跟进实际业务情况进行选型处理。</p>
<h2 id="五、事故复盘"><a href="#五、事故复盘" class="headerlink" title="五、事故复盘"></a>五、事故复盘</h2><p>面对各种优化方案，需要结合实际情况做出取舍，有的是长期方案，有的是快速方案，<code>但一定需要想清楚了再开搞</code>，过程中有一个对小拽之后影响很大的事故，引以为戒。</p>
<p>翻车过程：当时觉的读-&gt;计算-&gt;写这个过程，<code>两次读DB操作，下沉计算过程到DB后，通过DB计算，可以减少一次数据库请求</code>。于是<code>合并了一个大SQL，也就是所谓的insert ( field computer from select)</code>，觉的写了个狂赚酷炫吊炸天的SQL，一上线，库锁死了！幸好有前置的redo flag，全量redo数据恢复，要不然估计直接祭天了！</p>
<p>对于这个复杂大SQL事故，小拽总结了三个方面<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">莫炫技：没啥好说的，解决问题的成就感要远大于炫技！</span><br><span class="line">简单设计：简单的设计通常意味着可依赖；复杂的设计要尽可能的拆解，想清楚，队友都理解不了的设计，那就别上线了，可能真的需要再思考拆解下</span><br><span class="line">尊重线上：核心服务基本上线流程一定要遵守，测试，监控和回滚方案缺一不可</span><br></pre></td></tr></table></figure></p>
<h2 id="六、小结"><a href="#六、小结" class="headerlink" title="六、小结"></a>六、小结</h2><p>本篇主要针对热点账户问题提出了七种常用的解决方案，下篇将继续引申探索下，各种解决方案在不规则高并发场景，例如双十一，微博热点事件中如何套用</p>
<p>预知后事如何，下回再聊！</p>
]]></content>
      
        
        <tags>
            
            <tag> 财务系统 </tag>
            
            <tag> 热点账户 </tag>
            
            <tag> 伪同步设计 </tag>
            
            <tag> 读写优化 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[热点账户问题和常用解决方案【上】]]></title>
      <url>/2019/02/13/%E7%83%AD%E7%82%B9%E8%B4%A6%E6%88%B7%E9%97%AE%E9%A2%98%E5%92%8C%E5%B8%B8%E7%94%A8%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E3%80%90%E4%B8%8A%E3%80%91/</url>
      <content type="html"><![CDATA[<blockquote>
<p><strong>热点账户问题</strong>由来已久，一直是账户系统设计中的一个难点和瓶颈！<br>小拽将通过上中下三篇文章，分别介绍下热点账户的产生，解决方案和延伸应用！<br>本篇主要介绍下什么是热点账户？通用财务账户系统如何设计？以及其中的幂等健和链式设计等</p>
</blockquote>
<h2 id="一、热点账户问题"><a href="#一、热点账户问题" class="headerlink" title="一、热点账户问题"></a>一、热点账户问题</h2><h3 id="1-1-什么是热点账户"><a href="#1-1-什么是热点账户" class="headerlink" title="1.1 什么是热点账户"></a>1.1 什么是热点账户</h3><p><strong>热点账户</strong>：顾名思义，热点账户就是会被高频操作的账户！相较于普通的账户，热点账户数量不多，但操作频率极高！</p>
<p>热点账户从产生来源可分两大类：</p>
<ul>
<li><strong>富二代型</strong>：从产生之初就是热点账户，非常稳定。例如<strong>财务中公司的账户</strong>，每一笔资金操作都要经过公司出金账户，自然而然操作就会灰常频繁，此类账户还包括：<strong>大V账户</strong>，<strong>大KA账户</strong>等等，此类账户所引起的问题是本文重点要解决的</li>
<li><strong>暴发户型</strong>：本身是普通账户，由于热点问题变为热点帐户。例如<strong>微博出轨女猪脚账户</strong>，<strong>诺贝尔奖获得者</strong>等等，由于热点事件造成的短时间内访问暴增！此类热点账户防不胜防，超出本文的攻击范围，暂不讨论。</li>
</ul>
<h3 id="1-2-热点账户问题"><a href="#1-2-热点账户问题" class="headerlink" title="1.2 热点账户问题"></a>1.2 热点账户问题</h3><p>热点账户一旦产生便伴随着<strong>高并发，流量分布不均匀，高一致性</strong>等等问题。在实际场景中是热点账户必然存在，常常成为用户系统的瓶颈！<br>同时，热点账户问题也是高并发问题的延展，由于热点的不规则性，如何在高并发情况下，削峰填谷，弹性抗压也是很有挑战性的一个方向！</p>
<h3 id="1-3-热点账户通用解决方案的价值"><a href="#1-3-热点账户通用解决方案的价值" class="headerlink" title="1.3 热点账户通用解决方案的价值"></a>1.3 热点账户通用解决方案的价值</h3><p>热点账户除了是账户体系的一个通用问题，在高并发，流量分布不均匀，异常峰值等其他问题上，也有一定的通用性。例如<strong>微博热点问题，支付宝双11弹性变更，高频抢购问题</strong>等等。期望通过学习热点账户的八种解决方案，能够举一反三，应用于不同场景！</p>
<h2 id="二、如何设计一个财务账户"><a href="#二、如何设计一个财务账户" class="headerlink" title="二、如何设计一个财务账户"></a>二、如何设计一个财务账户</h2><p>在解决热点账户问题之前，先来看下如何设计一个简单的财务账户，来保障资金记账的安全！</p>
<h3 id="2-1-业务场景分析"><a href="#2-1-业务场景分析" class="headerlink" title="2.1 业务场景分析"></a>2.1 业务场景分析</h3><p>从业务上看，财务账户需要<strong>准确记录用户的资金变动过程和结果</strong>！因此设计一个简单财务账户至少要能包括两个部分：<strong>账户余额</strong>和<strong>账户流水</strong></p>
<p>便于理解，来张传统的账本，看下什么是流水，什么是余额<br><a href="http://cuihuan.net/wp_content/new/finance/finance_hot_account_1.png"><img src="http://cuihuan.net/wp_content/new/finance/finance_hot_account_1.png" alt="finance_hot_account_1"></a></p>
<p><strong>账户流水</strong>：账户流水也就是通俗意义上的帐或者账单！针对某个账户，每一笔资金的变更都需要记录下来，并且保障<strong>准确，不可更改</strong>！同时如图所示，流水中需要包含单据产生的原因，来源，变更额等等</p>
<p><strong>账户余额</strong>：账户余额记录用户某个场景账户的当前资金额度！在复杂的业务场景中往往需要拆分出不同的子账户和账户模型。例如，未结算子账户，可提现子账户，冻结子账户，授信账户等等。</p>
<p>从业务场景上一个账户系统核心需要准确记录余额和流水，同时，必须保障记录的<strong>准确，完备，不可变更</strong>!</p>
<h3 id="2-2-技术层面拆解"><a href="#2-2-技术层面拆解" class="headerlink" title="2.2 技术层面拆解"></a>2.2 技术层面拆解</h3><h4 id="2-2-1-基本表方案"><a href="#2-2-1-基本表方案" class="headerlink" title="2.2.1 基本表方案"></a>2.2.1 基本表方案</h4><p>通过业务场景初步分析，基本的账户系统，需要三张基本表<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">账户基本信息：账户信息表</span><br><span class="line">子账户余额信息：账户余额表</span><br><span class="line">账户流水信息：账户流水表</span><br><span class="line"></span><br><span class="line">三张表基本关系</span><br><span class="line">账户信息表 <span class="number">1</span><span class="symbol">:N</span> 账户余额表</span><br><span class="line">账户余额表 <span class="number">1</span><span class="symbol">:N</span> 账户流水表</span><br><span class="line"></span><br><span class="line"><span class="comment">## 具体账户和用户的关联可以参考三户模型</span></span><br></pre></td></tr></table></figure></p>
<h4 id="2-2-2-表字段设计"><a href="#2-2-2-表字段设计" class="headerlink" title="2.2.2 表字段设计"></a>2.2.2 表字段设计</h4><p>从技术层面看，设计具体表细节关键要解决以下几个问题</p>
<ol>
<li>防重：幂等健设计</li>
<li>防改：链式设计</li>
<li>防错：销账设计</li>
</ol>
<p>先上结果，简单的，能够满足上述需求的设计可以参考innodb mvcc，核心表字段如下</p>
<p><a href="http://cuihuan.net/wp_content/new/finance/finance_hot_account_2.png"><img src="http://cuihuan.net/wp_content/new/finance/finance_hot_account_2.png" alt="finance_hot_account_2"></a></p>
<h4 id="2-2-3-表字段解读"><a href="#2-2-3-表字段解读" class="headerlink" title="2.2.3 表字段解读"></a>2.2.3 表字段解读</h4><h5 id="2-2-3-1-幂等健设计"><a href="#2-2-3-1-幂等健设计" class="headerlink" title="2.2.3.1 幂等健设计"></a>2.2.3.1 幂等健设计</h5><p>通过三个属性<strong>资金凭证号+版本号+rollback</strong>三个字段作为uniq key来保证幂等！</p>
<p><strong>资金凭证号</strong>：来自业务方，业务方发起资金操作的唯一财务凭证，必须可追溯上游凭证和对账！<br><strong>版本号</strong>：每次获取DB最新流水n后，版本号n+1插入，保障在并发情况下，每个子账户只有唯一一个版本号：n+1条记录能够插入成功！<br><strong>rollback</strong>：回滚标识，保证每条记录<strong>能且只能销账一次</strong>！</p>
<p>对于幂等建设计此处有三条小技巧</p>
<ol>
<li><strong>上游产生</strong>：每一个幂等健如果可能的话，尽可能的上游产生，这样可以最大限度的避免自产生幂等健的重复问题。如果确实不能上游产生，例如订单ID，提现单ID，那么也尽可能的分阶段产生，例如提现时，先生成提现单ID，真正提现操作的时候，一定是带着提现单ID和信息来的，防止重复造成资损！</li>
<li><strong>业务关联</strong>：幂等健的产生可以用ice生成，但是，最好能够和业务关联，因为通过业务强关联的幂等健可以无限回溯来容灾！比如，a用户的b订单进行c操作，uniq_key = a_b_c的话，也就是在任何情况下，无论多少次回溯，重试也只会有一个唯一的a_b_c，而ice生成则可能造成自回溯的时候插入多条！</li>
<li><strong>写库保证</strong>：这条原则是高一致高并发的基本原则！因为读取a，校验a，然后插入，必然会存在读写之间a变了，或者主从延时a已经变了，读了历史a。因此，幂等一定要通过写库保证或者最底层保证</li>
</ol>
<h5 id="2-2-3-2-链式设计"><a href="#2-2-3-2-链式设计" class="headerlink" title="2.2.3.2 链式设计"></a>2.2.3.2 链式设计</h5><p>链式设计是保证操作精准不可篡改的非常有效手段！<br>通过资金的<strong>before info，after info，版本号</strong>三个要素来保证一条资金记录一旦插入成功，前后置信息固化！</p>
<p>链式设计的情况下单条修改是不可能的，多条修改需要在保证条目不变的情况下重组资金，但是，整体资金不可变</p>
<p>解决多条修改的一般方案：分布式存储，选举来判定最终正确的链，来确认是否某条链发生了过程修改，这种设计有一个很时髦的名字：<strong>区块链</strong>！而每条流水的核心信息加密后也有了一个更加时髦的名字：<strong>比特币</strong>！</p>
<h5 id="2-2-3-3-销账设计"><a href="#2-2-3-3-销账设计" class="headerlink" title="2.2.3.3 销账设计"></a>2.2.3.3 销账设计</h5><p>销账设计在账户系统中是一直存在的，现实财务系统可以<strong>红销蓝抵</strong>，线上财务系统加了链式之后，基本上就只能采用<strong>蓝抵</strong><br>通过增加rollback字段，并且严格限制0|1，保证一条账务流水只能被抵销一次！</p>
<p>具体三张表详细字段，需要脱敏，就不贴了，参考上面，其中索引，字段大小，联合索引等设计根据自身业务场景兼容即可！</p>
<h2 id="本篇小结：欲知后事如何，且听下回分解"><a href="#本篇小结：欲知后事如何，且听下回分解" class="headerlink" title="本篇小结：欲知后事如何，且听下回分解"></a>本篇小结：欲知后事如何，且听下回分解</h2><p>本篇介绍了什么是热点账户和账户的基本设计，涵盖幂等健设计，链式设计等方面，期望大家能够热点账户问题有个初步的认识！</p>
<p>下一篇重点小拽分析下热点账户由于链式设计造成的问题和八种基本解决方案</p>
]]></content>
      
        
        <tags>
            
            <tag> 财务系统 </tag>
            
            <tag> 热点账户 </tag>
            
            <tag> 安全性 </tag>
            
            <tag> 系统设计 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[财务系统设计【序】]]></title>
      <url>/2019/01/06/%E8%B4%A2%E5%8A%A1%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E3%80%90%E5%BA%8F%E3%80%91/</url>
      <content type="html"><![CDATA[<blockquote>
<p>新年伊始，组织团队小伙伴进行了一次头脑风暴，畅想了下财务系统2019的愿景，自己也思考颇多，决定针对【财务系统设计】做个专栏，落笔为记！</p>
</blockquote>
<h4 id="一、一次头脑风暴"><a href="#一、一次头脑风暴" class="headerlink" title="一、一次头脑风暴"></a>一、一次头脑风暴</h4><p>头脑风暴前，除了准备泡面，花生，矿泉水，还列了几个比较现实的问题</p>
<ul>
<li>公司：你做的事情，值多少钱？公司凭什么给你升职，涨薪？财务系统到底还能给公司带来多少收益？</li>
<li>自己：为什么要留下来？干一年财务系统，到底能给每个人带来多大成长？</li>
<li>目标：下次跳槽时，你希望自己成长成什么样子？</li>
<li>落地：规划每个人的模块方向，如何把<code>自身成长需求和业务成长</code>绑票？</li>
</ul>
<p>与我个人而言，期望通过这次头脑风暴，<strong>让团队小伙伴们能够对自己的模块有个规划，能够在业务成长的过程中实现个人技能成长，能够通过促进模块收益来提升自己薪资职级！</strong></p>
<p>无他，也希望各位看官能够思考一下</p>
<h4 id="二、财务系统设计专栏"><a href="#二、财务系统设计专栏" class="headerlink" title="二、财务系统设计专栏"></a>二、财务系统设计专栏</h4><p>头脑风暴后，小拽也一直在思考，2018年干了一年财务系统了，2019年如何搞？</p>
<p>具体的需求拆解，模块设计，架构图，暂时先不祭出来了，毕竟还需要深入的拆解和剖析！</p>
<p>但结合年初的flag，小拽决定2019年完善【<code>财务系统设计</code>】专栏^_^，期望能够通过专栏，<strong>自己能够体系化的梳理下财务系统，抽象出更通用的解决方案！</strong></p>
<p>废话不提先列下2018年亏欠的文章和目录，今年一定补上^_^！</p>
<ul>
<li>热点账户问题思考和常用解决方案</li>
<li>数据最终一致性保证</li>
<li>幂等健设计原则</li>
<li>全局ID生成思考和解决方案</li>
<li>财务系统异步和同步的思考</li>
<li>国际化账务系统思考</li>
<li>财务数仓有哪些坑？</li>
<li>通用账单分级模型设计</li>
<li>账户模型设计和思考</li>
<li>账户流水设计和思考</li>
</ul>
<h4 id="三、专栏目录"><a href="#三、专栏目录" class="headerlink" title="三、专栏目录"></a>三、专栏目录</h4><p>长远的看，小拽的财务模块设计最终会把所有文章落到各个模块中，暂时先梳理了下目录！</p>
<figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">财务系统专栏</span><br><span class="line">├── 在线系统设计和实现</span><br><span class="line">│   ├── 分账模块</span><br><span class="line">│   ├── 提现模块</span><br><span class="line">│   ├── 收银模块</span><br><span class="line">│   ├── 结算模块</span><br><span class="line">│   ├── 记账模块</span><br><span class="line">│   └── 账户模块</span><br><span class="line">├── 支撑系统设计和实现</span><br><span class="line">│   ├── MIS系统</span><br><span class="line">│   ├── openAPI</span><br><span class="line">│   ├── 任务系统</span><br><span class="line">│   ├── 财务网关</span><br><span class="line">│   ├── 数据质量中心</span><br><span class="line">│   └── 监控预警系统</span><br><span class="line">├── 数据中心设计和实现</span><br><span class="line">│   ├── <span class="params">ARCHIVE</span></span><br><span class="line">│   ├── GraphDB</span><br><span class="line">│   ├── HBASE</span><br><span class="line">│   ├── HIVE</span><br><span class="line">│   ├── KV</span><br><span class="line">│   ├── RDS</span><br><span class="line">│   └── TSDB</span><br><span class="line">└── 离线系统设计和实现</span><br><span class="line">    ├── 对账引擎</span><br><span class="line">    ├── 经营分析</span><br><span class="line">    ├── 结算引擎</span><br><span class="line">    ├── 财务报表</span><br><span class="line">    ├── 资金安全</span><br><span class="line">    └── 预算引擎</span><br></pre></td></tr></table></figure>]]></content>
      
        
        <tags>
            
            <tag> 财务系统 </tag>
            
            <tag> 系统设计 </tag>
            
            <tag> 业务系统 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[2018回顾]]></title>
      <url>/2019/01/02/2018/</url>
      <content type="html"><![CDATA[<blockquote>
<p>岁月不居，时光荏苒，本想写个2018的总结，结果2019都过2天了，三十功名已经泡汤，顺道写些2019展望吧！</p>
</blockquote>
<hr>
<h4 id="工作方面"><a href="#工作方面" class="headerlink" title="工作方面"></a>工作方面</h4><ul>
<li><p>工作方面，18年离开混了四年的狼厂母校，加入滴滴，没有了小伙伴和团队的呵护，只能独立面对，干了几件还算可以的事儿！花了四个月，从0到1的设计，开发了外卖财务在线系统；又花了四个月，搭建了财务离线系统和支撑系统；最后四个月，财务系统国际化改造！整体来说，成长很快，日子很燃，业务波动大！对于自己，无论从技术架构、业务成长、团队建设，既是机遇也是挑战。2019支撑业务发展的同时，需要加深技术的深度和体系化，增强技能外的视野^_^！</p>
</li>
<li><p>19年个人成长立个flag吧，<strong>一年多没更新的博客重新捡起来，做到每月至少一篇！总计达标20篇吧，其中至少有两篇是技能外的</strong></p>
</li>
</ul>
<hr>
<h4 id="投资方面"><a href="#投资方面" class="headerlink" title="投资方面"></a>投资方面</h4><ul>
<li><p>18年可谓过山车，年中股票整体收益高达150%，年底落到了20%多，总算没亏。教训就是，<strong>止损一定要果断！果断！果断！</strong>经济低迷的环境下，基金逐步加仓，等待周期！投资个小桶装水厂，也是亏了，经验一句话：<strong>做生意，人非常重要，一定想清楚了再干</strong>！18年看好半导体，19年目前比较看好健康体检，旅游领域。19年的核心调整自己的资产配置，按着二八原则递归！实体行业暂时先观望</p>
</li>
<li><p>19年投资方面flag不变，继续保持每周读经济周刊！</p>
</li>
</ul>
<hr>
<h4 id="生活方面"><a href="#生活方面" class="headerlink" title="生活方面"></a>生活方面</h4><ul>
<li><p>18年有些波澜不惊，在媳妇的组织下，爸妈哥嫂全家旅游了一趟，毕业后一直没有好好陪过父母，多少弥补了些遗憾。年底和媳妇儿去了趟台湾，互联网方面太落后了，吃老本而已，以后也不会再去了！年末赶上天朝洪恩，买了共有产权房，位置很喜欢，上下班方便！大事儿就这些，哈哈，整体感觉自己变懒了，很多事情都是媳妇儿在张罗维持，需要反思！2019期望，自己能够腾出更多的时间和媳妇在国内好好逛逛，毕竟三人世界很快就要替代二人世界了！</p>
</li>
<li><p>19年在生活方面立个flag，哈哈，就不在这里说了，感恩家庭</p>
</li>
</ul>
<hr>
<h4 id="兴趣方面"><a href="#兴趣方面" class="headerlink" title="兴趣方面"></a>兴趣方面</h4><ul>
<li><p>2018新get两个技能，一个是无人机，很喜欢，换一个角度看看世界，很不一样，后面也逐步学习下原理和拍摄技巧；另一个勉强算是羽毛球了，哈哈，不过现在还是苍蝇拍，也没啥提升的兴趣了，挺好的健身途径，目标保持体重！2019，期望新增一门技能：做饭，最好能考个证(<code>初步查了下新东方厨师周末班都要6000，真贵</code>)，毕竟程序员的未来都是开饭店，提前做好准备！</p>
</li>
<li><p>2019 年兴趣爱好方面立个flag，能做一桌菜！</p>
</li>
</ul>
<hr>
<p>想说的很多，但是没喝点酒，吹不起来，18年先这样子吧O(∩_∩)O</p>
<p>最后致谢，感谢老婆和家人的支持，有了你们坚实后盾，怎么走都是路！感谢工作中小伙伴，有了你们的信任和配合，稳如狗！</p>
<p><strong>2018，不管愿不愿意，已经成为过去，让我们在2019继续努力，以梦为马，不负韶华！</strong></p>
]]></content>
      
        
        <tags>
            
            <tag> 年终回顾 </tag>
            
            <tag> 2018 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[理解php单例模式]]></title>
      <url>/2017/06/28/%E7%90%86%E8%A7%A3php%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/</url>
      <content type="html"><![CDATA[<blockquote>
<p>单例作为一个最经典的设计模式之一，到底什么是单例？为什么要用单例？怎么设计单例？php中单例如何具体实现？</p>
</blockquote>
<h1 id="一、什么是单例"><a href="#一、什么是单例" class="headerlink" title="一、什么是单例"></a>一、什么是单例</h1><p>wiki百科：单例模式，也叫单子模式，是一种常用的软件设计模式。 在应用这个模式时，单例对象的类必须保证只有一个实例存在。 许多时候整个系统只需要拥有一个的全局对象，这样有利于我们协调系统整体的行为。</p>
<p>通俗的说，也就是对于<code>某一个功能只能实例化一个对象</code>。</p>
<h1 id="二、为什么用单例"><a href="#二、为什么用单例" class="headerlink" title="二、为什么用单例"></a>二、为什么用单例</h1><p>实际项目中像数<code>据库查询，日志输出，全局回调，统一校验</code>等模块。这些模块<code>功能单一</code>，但需要<code>多次访问</code>，如果能够<code>全局唯一，多次复用</code>会大大提升性能。这也就是单例存在的必要性。</p>
<p>单例模式的好处：</p>
<ul>
<li>1：减少频繁创建，节省了cpu。</li>
<li>2：静态对象公用，节省了内存。</li>
<li>3：功能解耦，代码已维护。</li>
</ul>
<h1 id="三、如何设计单例"><a href="#三、如何设计单例" class="headerlink" title="三、如何设计单例"></a>三、如何设计单例</h1><p>通过上面的描述，单例的核心是，<code>实例一次生成，全局唯一，多次调用</code>。因此在单例模式必须包含三要素：</p>
<ul>
<li>1：私有化构造函数，私有化clone。也就是不能new，不能clone。【唯一】</li>
<li>2：拥有一个静态变量，用于保存当前的类。【唯一如何保存】</li>
<li>3：提供一个公共的访问入口。【可以访问】</li>
</ul>
<h1 id="四、php实现"><a href="#四、php实现" class="headerlink" title="四、php实现"></a>四、php实现</h1><p>php 实现的单例模式<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">XiaozhuaiSingleton</span></span></span></span><br><span class="line"><span class="php">&#123;</span></span><br><span class="line"><span class="php">    <span class="comment">// 私有化构造方法</span></span></span><br><span class="line"><span class="php">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span></span><br><span class="line"><span class="php">    &#123;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="comment">// 私有化clone方法</span></span></span><br><span class="line"><span class="php">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">__clone</span><span class="params">()</span></span></span></span><br><span class="line"><span class="php">    &#123;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="comment">// 保存实例的静态对象</span></span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="keyword">static</span> $singleInstance;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line">    /**</span><br><span class="line">     * 声明静态调用方法</span><br><span class="line">     * 目的：保证该方法的调用全局唯一</span><br><span class="line">     *</span><br><span class="line">     * @return XiaozhuaiSingleton</span><br><span class="line"><span class="php">     */</span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getInstance</span><span class="params">()</span></span></span></span><br><span class="line"><span class="php">    &#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">if</span> (!<span class="keyword">self</span>::$singleInstance) &#123;</span></span><br><span class="line"><span class="php">            <span class="keyword">self</span>::$singleInstance = <span class="keyword">new</span> <span class="keyword">self</span>();</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">        <span class="keyword">return</span> <span class="keyword">self</span>::$singleInstance;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="comment">// 调用单例的方法</span></span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">singletonFunc</span><span class="params">()</span></span></span></span><br><span class="line"><span class="php">    &#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">echo</span> <span class="string">"call single ton method"</span>;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">$singleInstance = XiaozhuaiSingleton::getInstance();</span></span><br><span class="line"><span class="php">$singleInstance-&gt;singletonFunc();</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">$singleInstance2 = XiaozhuaiSingleton::getInstance();</span></span><br><span class="line"><span class="php">$singleInstance2-&gt;singletonFunc();</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="comment">// 校验是否是一个实例</span></span></span><br><span class="line"><span class="php">var_dump($singleInstance === $singleInstance2);  <span class="comment">// true ，一个对象</span></span></span><br></pre></td></tr></table></figure></p>
]]></content>
      
        
        <tags>
            
            <tag> php </tag>
            
            <tag> 单例模式 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[php进程通信]]></title>
      <url>/2017/06/21/php%E8%BF%9B%E7%A8%8B%E9%80%9A%E4%BF%A1/</url>
      <content type="html"><![CDATA[<blockquote>
<p>PHP间进程如何通信，PHP相关的服务的IPC是实现方式，IPC的思想如何用到项目中。</p>
</blockquote>
<h1 id="一、linux进程间通信"><a href="#一、linux进程间通信" class="headerlink" title="一、linux进程间通信"></a>一、linux进程间通信</h1><p>理解php间进程通信机制，先了解下linux进程间有哪些通讯机制</p>
<h2 id="1-1-历史发展"><a href="#1-1-历史发展" class="headerlink" title="1.1 历史发展"></a>1.1 历史发展</h2><p>linux ipc 按照历史来源主要有两大块</p>
<ul>
<li>AT&amp;T的system v IPc:管道，FIFO，信号</li>
<li>BSD的socket Ipc :消息队列，共享内存，信号灯。</li>
</ul>
<p><img src="https://www.ibm.com/developerworks/cn/linux/l-ipc/1.gif" alt="进程发展"></p>
<h2 id="1-2-主要方式"><a href="#1-2-主要方式" class="headerlink" title="1.2 主要方式"></a>1.2 主要方式</h2><p>总结起来主要有以下六种方式</p>
<ul>
<li>1：管道【pipe】：主要是<code>有关系的进程之间</code>的通讯，例如ls xx |grep xx。</li>
<li>2：信号【signal】：通过<code>中间进程</code>来管理进程之间的通讯，属于比较复杂的进程间通讯方式。</li>
<li><p>3：消息队列【message】：消息的链接表，进程生产和消费消费消息队列。</p>
<ul>
<li>优势：克服了信号量承载的消息少，管道只能用规定的字节流，同时受到缓冲区大小的约束的问题 （而且读写是有队列的，有一个写，就只有一个能读到，比较简单，不需要同步和互斥）</li>
<li>缺点：太过简单，处理复杂情况可能会造成饥饿现象</li>
</ul>
</li>
<li><p>4：共享内存。多个进程访问同一个内存区。<code>最快的IPC方式</code>，但是需要处理进程间的<code>同步和互斥</code>。 同时也是<code>当下使用最广泛的IPC</code>，例如nginx，框架通讯，配置中心都是该原理。</p>
</li>
<li>5：信号量【semaphore】：主要作为<code>进程间，以及进程内部线程之间</code>的通讯手段。nginx早起的channel机制就类似于信号量</li>
<li>6：套接字【socket】：<code>不同机器之间</code>的通讯手段。处于tcp-》socket-》http之间的一个协议。</li>
</ul>
<h1 id="二、php进程通讯有哪些方式"><a href="#二、php进程通讯有哪些方式" class="headerlink" title="二、php进程通讯有哪些方式"></a>二、php进程通讯有哪些方式</h1><p>最好的语言php有哪些IPC的方式</p>
<ul>
<li>pcntl扩展：主要的进程扩展，完成进程的创建，子进程的创建，也是当前使用比较广的多进程。</li>
<li>posix扩展：完成posix兼容机通用api,如获取进程id,杀死进程等。主要依赖 IEEE 1003.1 (POSIX.1) ，兼容posix</li>
<li>sysvmsg扩展：实现system v方式的进程间通信之消息队列。</li>
<li>sysvsem扩展：实现system v方式的信号量。</li>
<li>sysvshm扩展：实现system v方式的共享内存。</li>
<li>sockets扩展：实现socket通信，跨机器，跨平台。</li>
</ul>
<p>php也有一些封装好的异步进程处理框架：例如swoole,workman等</p>
<h1 id="三、与php相关的IPC"><a href="#三、与php相关的IPC" class="headerlink" title="三、与php相关的IPC"></a>三、与php相关的IPC</h1><h2 id="3-1-nginx的IPC"><a href="#3-1-nginx的IPC" class="headerlink" title="3.1 nginx的IPC"></a>3.1 nginx的IPC</h2><p>nginx的ipc主要有两种：</p>
<ul>
<li><p>早期：channel 机制：类似于信号，标示不同进程以及进程与子进程之间的套接字，同时具有继承关系。<br>缺点：过于复杂，也产生了过多的套接字，造成存储浪费。</p>
</li>
<li><p>当前主流：共享内存方式：快，写入数据少，方便。</p>
</li>
</ul>
<blockquote>
<p>具体可以参见这篇文章：写的非常好 <a href="https://rocfang.gitbooks.io/dev-notes/content/nginxzhong_de_jin_cheng_jian_tong_xin.html" target="_blank" rel="external">https://rocfang.gitbooks.io/dev-notes/content/nginxzhong_de_jin_cheng_jian_tong_xin.html</a></p>
</blockquote>
<h2 id="3-2-apache的IPC"><a href="#3-2-apache的IPC" class="headerlink" title="3.2 apache的IPC"></a>3.2 apache的IPC</h2><p>apache：<a href="https://arrow.apache.org/docs/ipc.html" target="_blank" rel="external">https://arrow.apache.org/docs/ipc.html</a></p>
<h1 id="四、实际应用中的IPC"><a href="#四、实际应用中的IPC" class="headerlink" title="四、实际应用中的IPC"></a>四、实际应用中的IPC</h1><p>在平时的项目中，类似于php和linux的IPC的思想大量存在，深入理解。</p>
<ul>
<li><p>socket方式：不同项目间通讯，跨机微服务等等，也是使用最广泛的IPC。</p>
</li>
<li><p>共享内存方式：配置中心，公共数据库，甚至git都可以看做共享内存的衍生；`共享内存就必须要注意同步和互斥。</p>
</li>
<li>cache ：是共享内存和管道结合的思想</li>
<li>项目流式架构：管道的方式，可以大量的节省空间和时间的通讯方式。</li>
</ul>
<p>【转载请注明：<a href="http://cuihuan.net/2017/06/21/php进程通信/">php进程通信</a> | <a href="http://cuihuan.net">靠谱崔小拽</a> 】</p>
]]></content>
      
        
        <tags>
            
            <tag> php </tag>
            
            <tag> ipc </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[CodeIgniter 性能优化]]></title>
      <url>/2017/06/05/CodeIgniter%20%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/</url>
      <content type="html"><![CDATA[<blockquote>
<p>背景：部署一套PHP微服务接口，需要兼顾性能，开发效率，扩展性。权衡后选择了CodeIgniter；同时优化框架的默认启动项，在qps1000+的压力下整个<code>启动时间优化到5ms</code>左右。</p>
</blockquote>
<h2 id="一、选型"><a href="#一、选型" class="headerlink" title="一、选型"></a>一、选型</h2><ul>
<li>背景：使用php作为微服务的接口，具有一定的性能要求和并发要求。</li>
<li>方案：<ul>
<li>1：选一个轻量的php框架。具有简单高效的路由，模块化即可。</li>
<li>2：在框架的基础上，自定义的优化</li>
</ul>
</li>
</ul>
<p>从以下几个角度做了简单的比较</p>
<h3 id="1-1-不同框架的性能"><a href="#1-1-不同框架的性能" class="headerlink" title="1.1 不同框架的性能"></a>1.1 不同框架的性能</h3><p><a href="https://www.ruilog.com/blog/view/b6f0e42cf705.html" target="_blank" rel="external">https://www.ruilog.com/blog/view/b6f0e42cf705.html</a><br><a href="http://cuihuan.net/wp_content/new/codeIgniter/performance.png"><img src="http://cuihuan.net/wp_content/new/codeIgniter/performance.png" alt="ci performance"></a></p>
<p>列举了很多数据，除了直接写php之外，ci和lumen的并发和性能不错，在考虑范围内。</p>
<h3 id="1-2-从流行度上看。"><a href="#1-2-从流行度上看。" class="headerlink" title="1.2 从流行度上看。"></a>1.2 从流行度上看。</h3><p>github排名前四的是laravel,symfony,ci,yii2。最火的是laravel毋庸置疑。但前四均在考虑范围内</p>
<p><a href="http://cuihuan.net/wp_content/new/codeIgniter/githup_php.png"><img src="http://cuihuan.net/wp_content/new/codeIgniter/githup_php.png" alt="ci github"></a></p>
<h3 id="1-3-从文档来看。"><a href="#1-3-从文档来看。" class="headerlink" title="1.3 从文档来看。"></a>1.3 从文档来看。</h3><p>laraval,ci,yii的中文社区都还不错。</p>
<p>综合考虑之后，在满足功能的情况下，选择性能最好，也易入手的codeIgniter作为基础框架。（<code>整个包才2.5M，删除了web文件夹后更小</code>）</p>
<h2 id="二、30ms-到10ms-粗读代码"><a href="#二、30ms-到10ms-粗读代码" class="headerlink" title="二、30ms+到10ms[粗读代码]"></a>二、30ms+到10ms[粗读代码]</h2><p>框架的基本部署，直接参考官网：<a href="https://codeigniter.org.cn/" target="_blank" rel="external">https://codeigniter.org.cn/</a></p>
<h3 id="2-1-问题描述"><a href="#2-1-问题描述" class="headerlink" title="2.1 问题描述"></a>2.1 问题描述</h3><p>配置了数据库之后，添加了一个默认的controller，一个model，默认加载时间竟然30ms+—_-。瞬间懵逼了，nginx+fpm也就1-2ms，框架竟然30ms，肯定那里配置错了，决定沿着路由追一下。</p>
<h3 id="2-2-问题追查"><a href="#2-2-问题追查" class="headerlink" title="2.2 问题追查"></a>2.2 问题追查</h3><p>沿着ci的路由顺序追查，从index入，一步一步卡时间。[<code>括号内为运行到的总计数</code>]</p>
<p>-》index.php [<code>1ms</code>]<br>-》core/CodeIgniter.php<br>-》加载常量[<code>1ms</code>]<br>-》加载common(包括log，show，error,is_https等)[1ms]load hooks [<code>2ms</code>]<br>-》加载autoload 方法<br>-》加载benchmark<br>-》实例化hooks<br>-》实例化pre_controller<br>-》实例化post_controller_constructor<br>-》实例化post_controller<br>-》实例化post_system<br>-》加载config [<code>3ms</code>]<br>-》加载扩展mbstring,iconv,hash,stardard<br>-》load 组件utf8，uri<br>-》load router [<code>4ms</code>]<br>-》load output，input，lang[<code>5ms</code>]<br>-》autoload package,cinfig,helper,language,driver,lib,model,db,cache<br>-》404 &amp;empty$…handle [<code>31ms</code>]<br>-》controller remap（测试性能写了个remap）[<code>35ms</code>]<br>-》controller 业务逻辑 [<code>35ms</code>]</p>
<p>这个ci的加载过程之后，基本一幕了然，在autoload里面耗时25ms。然后对autoload里面8个组件一个一个分析。</p>
<h3 id="2-3-问题原因"><a href="#2-3-问题原因" class="headerlink" title="2.3 问题原因"></a>2.3 问题原因</h3><p>分析完之后，处理特别简单，下面这行代码<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$autoload[<span class="string">'libraries'</span>] = <span class="keyword">array</span>(<span class="string">'database'</span>);</span><br></pre></td></tr></table></figure></p>
<p>ci 出于单例和复用角度考虑，选择<code>默认加载database</code>，也就是mysql在框架初始化的过程中默认初始化了。<br>mysql链接在并发情况下，init基本上要耗费10-30ms。直接干掉。<br>干掉之后，压测基本上在10ms左右。</p>
<h2 id="三、从10ms到5ms-细看代码"><a href="#三、从10ms到5ms-细看代码" class="headerlink" title="三、从10ms到5ms [细看代码]"></a>三、从10ms到5ms [细看代码]</h2><h3 id="3-1-优化目标"><a href="#3-1-优化目标" class="headerlink" title="3.1 优化目标"></a>3.1 优化目标</h3><p>优化了配置等之后，ci在高并发下依然有10ms左右的加载时间，需要结合自身逻辑优化下，删减掉部分不需要的功能和组件。</p>
<h3 id="3-2-代码分析"><a href="#3-2-代码分析" class="headerlink" title="3.2 代码分析"></a>3.2 代码分析</h3><p>之前在追查问题的过程中，粗读了一遍代码的流程。<br>而需要进一步优化，就需要细看每个模块函数的功能，干掉不需要的，逐步优化。</p>
<p>-》index.php </p>
<ul>
<li>作用：加载了部分全局变量，文件路径等入口</li>
<li>优化：干掉了整个web文件，调整了部分路径</li>
</ul>
<p>-》core/CodeIgniter.php</p>
<ul>
<li>作用：ci的核心文件，基本上加载了整个模块</li>
<li>优化：进入内部优化</li>
</ul>
<p>-》加载common.php</p>
<ul>
<li>作用：框架特别基本的一些函数log，show，error，is_xxx等，800行左右代码</li>
<li>优化：暂时未处理</li>
</ul>
<p>-》composer autoload func<br>-》加载benchmark </p>
<ul>
<li>作用：benchmark性能追查工具，设置了全局的开始和结束时间</li>
<li>优化：<code>直接干掉</code>，全局处理。但是性能需要卡，就在index中初始化了一个入库的timer<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义全局开始追查</span></span><br><span class="line"><span class="built_in">list</span>($msec, $sec) = explode(<span class="string">' '</span>, microtime());</span><br><span class="line"><span class="class"><span class="keyword">define</span></span>(<span class="string">'START_TIME'</span>, (float)sprintf(<span class="string">'%.0f'</span>, (floatval($msec) + floatval($sec)) * <span class="number">1000</span>));</span><br><span class="line"><span class="comment">// 定义全局uuid</span></span><br><span class="line"><span class="class"><span class="keyword">define</span></span>(<span class="string">'UUID'</span>, uniqid(<span class="string">'xxx'</span>, <span class="literal">true</span>));</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>-》实例化hooks和预变量 </p>
<ul>
<li>作用：设计特别棒，对于一些hook或者针对不同模块的预加载函数。</li>
<li>优化：<code>直接干掉</code>，7,8个hook后期用到再针对性添加</li>
</ul>
<p>-》加载config </p>
<ul>
<li>作用：对应的是ci的get_config等函数，加载了base_url,uri,cache path等 。</li>
<li>优化：<code>直接干掉</code>，全局变量占用需要自己加就行，这种不可控的干掉</li>
</ul>
<p>-》加载扩展mbstring,iconv,hash,stardard</p>
<ul>
<li>作用：一些额外的扩展。</li>
<li>优化：<code>直接干掉</code>，试了下干掉对功能不影响，ci写的太全面了，后期可以通过加载自己的lib弥补。</li>
</ul>
<p>-》load 组件utf8，uri</p>
<ul>
<li>作用：uri路由方式处理，utf8的处理。</li>
<li>优化：<code>直接干掉</code>。</li>
</ul>
<p>-》load router [<code>4ms</code>]</p>
<ul>
<li>作用：路由。</li>
<li>优化：<code>干不掉</code>。</li>
<li>额外：laravel 据说是使用COC最好的框架，看了下ci的router也不错，基本上都是遵循COC</li>
</ul>
<p>-》load output，input</p>
<ul>
<li>作用：output和浏览器交互输出的处理组件，input包括获取数据array_merge等等。</li>
<li>优化：<code>干掉</code>,需要自己写</li>
</ul>
<p>-》autoload package,cinfig,helper,language,driver,lib,model,db,cache</p>
<ul>
<li>作用：各种各样的组建了。</li>
<li>优化：全<code>不</code>加载</li>
</ul>
<p>-》404 &amp;empty$…handle </p>
<ul>
<li>作用：异常处理。</li>
<li>优化：加载</li>
</ul>
<p>-》controller remap（测试性能写了个remap）</p>
<ul>
<li>作用：指向其他controller。</li>
<li>优化：无</li>
</ul>
<p>-》controller 业务逻辑 </p>
<p>到此将整个框架过程优化完成，初始一下4-5ms感觉还不错。</p>
<h2 id="四、压测数据"><a href="#四、压测数据" class="headerlink" title="四、压测数据"></a>四、压测数据</h2><h3 id="4-1-高并发压测"><a href="#4-1-高并发压测" class="headerlink" title="4.1 高并发压测"></a>4.1 高并发压测</h3><p>2000qps+ ，均值约6ms</p>
<h3 id="4-2-长时间高负载压测"><a href="#4-2-长时间高负载压测" class="headerlink" title="4.2 长时间高负载压测"></a>4.2 长时间高负载压测</h3><p>1500qps 10min，均值约6ms</p>
<p>问题：分析了部分数据的超时分布，约千分之二超过30ms，如下图【这块需要之后优化】<br><a href="http://cuihuan.net/wp_content/new/codeIgniter/time_distribute.png"><img src="http://cuihuan.net/wp_content/new/codeIgniter/time_distribute.png" alt="time_distribute"></a></p>
<h3 id="4-3-无限发压"><a href="#4-3-无限发压" class="headerlink" title="4.3 无限发压"></a>4.3 无限发压</h3><p>nginx + php 均值：17ms<br>框架部分的均值：9ms 也基本上满足需求<br><a href="http://cuihuan.net/wp_content/new/codeIgniter/nginx_time.png"><img src="http://cuihuan.net/wp_content/new/codeIgniter/nginx_time.png" alt="nginx_time"></a></p>
<h2 id="五、汇总"><a href="#五、汇总" class="headerlink" title="五、汇总"></a>五、汇总</h2><p>ci 是一个比较优秀的轻量级MVC框架，可以用来，业能否支撑1000-2000pqs的业务接口。</p>
<p>最后来一张ci的路由图<br><a href="http://cuihuan.net/wp_content/new/codeIgniter/all.png"><img src="http://cuihuan.net/wp_content/new/codeIgniter/all.png" alt="all"></a></p>
<p><code>`</code></p>
]]></content>
      
        
        <tags>
            
            <tag> php </tag>
            
            <tag> 性能优化 </tag>
            
            <tag> codeIgniter </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[【nginx学习一】基本原理学习]]></title>
      <url>/2017/03/14/nginx_study_1/</url>
      <content type="html"><![CDATA[<blockquote>
<p>由于性能问题，需要将 apache + php5.2 升级到 nginx + php7，对于nginx的性能和热加载早有耳闻，why nginx so diao。小拽进行了初探，<code>有任何疑问或不准确的地方，欢迎直接开炮</code>！！！</p>
</blockquote>
<h2 id="一、nginx现状"><a href="#一、nginx现状" class="headerlink" title="一、nginx现状"></a>一、nginx现状</h2><p>nginx 是当前的<code>使用最广泛的webserver ,支持http正向/反向代理，支持TCP/UDP层代理</code>，来看下netcraft的数据</p>
<p><a href="http://cuihuan.net/wp_content/new/nginx1/nginx_trend_all.png"><img src="http://cuihuan.net/wp_content/new/nginx1/nginx_trend_all.png" alt="webserver_all"></a><br><a href="http://cuihuan.net/wp_content/new/nginx1/nginx_trend_top.png"><img src="http://cuihuan.net/wp_content/new/nginx1/nginx_trend_top.png" alt="webserver_top"></a></p>
<p>nginx在<code>全部网站中占比达到18%</code>，在<code>top millon busest 达到28%</code>，而且一直在增加。当下最时尚的webserver非nginx莫属</p>
<blockquote>
<p>更全数据可以参考：<a href="https://news.netcraft.com/archives/2017/01/12/january-2017-web-server-survey.html" target="_blank" rel="external">【netcraft】</a></p>
</blockquote>
<h2 id="二、nginx的特点"><a href="#二、nginx的特点" class="headerlink" title="二、nginx的特点"></a>二、nginx的特点</h2><p>深入了解nginx之前，先泛泛的了解下nginx的几个特点</p>
<ul>
<li>性能好<ul>
<li>非阻塞IO/高并发,支持文件IO</li>
<li>多worker，thread pool </li>
<li>基于rbtree的定时器</li>
<li>系统特性的持续支持</li>
</ul>
</li>
<li>功能强大<ul>
<li>webserver/cache/keepalive/pipeline等等</li>
<li>各种upstream的支持【fastcgi/http/…】</li>
<li>输出灵活【chunk/zip/…】</li>
<li>在不断的发展 http2,tcp,udp,proxy…</li>
</ul>
</li>
<li>运维的友好【这个对于开发和部署很重要】<ul>
<li>配置非常规范【个人认为：约定及规范是最好的实践】</li>
<li>热加载和热更新【后文会详细介绍，能在二进制的层面热更新】</li>
<li>日志强大【真的很强的，很多变量支撑】</li>
</ul>
</li>
<li>扩展强大</li>
</ul>
<p>下图是nginx、apache和lighttpd的一个对比。系统压力，内存占用，upstream支持等多个方面都非常不错<br><a href="http://cuihuan.net/wp_content/new/nginx1/nginx_compare.png"><img src="http://cuihuan.net/wp_content/new/nginx1/nginx_compare.png" alt="nginx对比图"></a></p>
<h2 id="三、nginx的核心机制"><a href="#三、nginx的核心机制" class="headerlink" title="三、nginx的核心机制"></a>三、nginx的核心机制</h2><h3 id="3-1-运行方式"><a href="#3-1-运行方式" class="headerlink" title="3.1 运行方式"></a>3.1 运行方式</h3><p>一句话简述nginx的运行方式：<code>master-worker多进程模式运行，单线程/非阻塞执行</code></p>
<p>如下官方图：nginx 启动后生成master，master会启动conf数量的<code>worker进程</code>，当用户的请求过来之后，由不同的worker调起<code>执行线程</code>，非阻塞的执行请求。这种运行方式相对于<code>apache的进程执行</code>相对轻量很多，支撑的并发性也会高很多。<br><a href="http://cuihuan.net/wp_content/new/nginx1/nginx_framework.png"><img src="http://cuihuan.net/wp_content/new/nginx1/nginx_framework.png" alt="nginx 基本框架"></a></p>
<h3 id="3-2-进程管理"><a href="#3-2-进程管理" class="headerlink" title="3.2 进程管理"></a>3.2 进程管理</h3><p>nginx是master-worker进程工作模式，那么nginx是如何管理master启程，怎么做到热加载的？</p>
<h4 id="3-2-1-配置热加载"><a href="#3-2-1-配置热加载" class="headerlink" title="3.2.1 配置热加载"></a>3.2.1 配置热加载</h4><p>官方图很赞，在<code>更换配置之后，master生成新的worker，直到原有的worker全部任务结束kill掉之后</code>。从现象上作证，也就是在relaod配置之后，短时间可能出现超过conf数量的进程，更新完成后，进程会完全改变。</p>
<blockquote>
<p>不更新、直接替换，这种设计思路在代码部署中也很常见，包括mysql迁移，代码更新，服务尝试，很值的学习。<br><a href="http://cuihuan.net/wp_content/new/nginx1/nginx_conf_reload.png"><img src="http://cuihuan.net/wp_content/new/nginx1/nginx_conf_reload.png" alt="nginx 配置热加载"></a></p>
</blockquote>
<h4 id="3-2-2-版本更新热加载"><a href="#3-2-2-版本更新热加载" class="headerlink" title="3.2.2 版本更新热加载"></a>3.2.2 版本更新热加载</h4><p>了解了worker的热加载之后，理解master就非常简单了，通过信号控制，同时存在两个master，逐步替代。<br><a href="http://cuihuan.net/wp_content/new/nginx1/nginx_bit_reload.png"><img src="http://cuihuan.net/wp_content/new/nginx1/nginx_bit_reload.png" alt="nginx 线程热加载"></a></p>
<p>关于replace过程中如何细节控制一致性，稳定性，信号控制，log控制等等，敬请期待小拽的进一步探索！</p>
<h3 id="3-3-处理流程和模块"><a href="#3-3-处理流程和模块" class="headerlink" title="3.3 处理流程和模块"></a>3.3 处理流程和模块</h3><p>启动进程后，请求在nginx内部是如何流转的，nginx内部包括哪些模块？</p>
<h4 id="3-3-1-worker处理过程"><a href="#3-3-1-worker处理过程" class="headerlink" title="3.3.1 worker处理过程"></a>3.3.1 worker处理过程</h4><ol>
<li>【post header】请求到达后首先读取header，log中request time初始时间便从此开始。</li>
<li>【rewrite】请求相关的配置和参数</li>
<li>【pre-access】预处理阶段，频率控制，高频绝句</li>
<li>【acess】权限控制，白名单，403，access deny ，静态文件开放等均有这个模块产生</li>
<li>【content】这个模块会调用upstream产生内容，这个阶段最重要<code>此处调起了工作线程，调用fastcgi，http，以及各种操作产生内容均在此处</code>。性能优化可能需要确认程序执行时间，对应access log中的upstream time 由此产生，记录了nginx中程序运行的全量时间，而request - upstream 就是网络传输和预处理时间。</li>
<li>【filter】内容过滤，包括gzip压缩，返回等在此处</li>
<li>【log】日志的产生</li>
<li>【重定向】<code>没有这个模块，所有的进行智能单向走，有了这个，在任何阶段都可以产生返回</code>，例如client主动阶段产生499的log，过程可能就是1-》2-》8-》7 over</li>
</ol>
<blockquote>
<p>摘自某ppt的一个图，如侵权，请尽快联系小拽<br><a href="http://cuihuan.net/wp_content/new/nginx1/nginx_flow.png"><img src="http://cuihuan.net/wp_content/new/nginx1/nginx_flow.png" alt="nginx 主要流程和模块"></a></p>
</blockquote>
<p>各个阶段的主要状态机可以参考:<a href="http://www.nginxguts.com/2011/01/phases/" target="_blank" rel="external">【跳转】</a></p>
<h3 id="3-4-请求管理"><a href="#3-4-请求管理" class="headerlink" title="3.4 请求管理"></a>3.4 请求管理</h3><p>了解了worker的工作模式和worker的内部主要模块，那么worker是如何管理请求的？</p>
<h4 id="3-4-1-任务调度"><a href="#3-4-1-任务调度" class="headerlink" title="3.4.1 任务调度"></a>3.4.1 任务调度</h4><blockquote>
<p>官方阐述：It’s well known that NGINX uses <code>an asynchronous, event‑driven approach to handling connections</code>. This means that instead of creating another dedicated process or thread for each request (like servers with a traditional architecture), it handles multiple connections and requests in one worker process. To achieve this, NGINX works with sockets in a non‑blocking mode and uses efficient methods such as epoll and kqueue.<br>核心词：<code>异步，事件驱动，链接控制</code></p>
</blockquote>
<p>解释的很清楚，<code>nginx并不是通过每个请求都创建线程，而是通过内部管理的调度分配</code>。<br>如下图：此处不翻译了，大家直接看原版<br>epoll详解：<a href="http://man7.org/linux/man-pages/man7/epoll.7.html" target="_blank" rel="external">【跳转】</a></p>
<p><a href="http://cuihuan.net/wp_content/new/nginx1/nginx_task.png"><img src="http://cuihuan.net/wp_content/new/nginx1/nginx_task.png" alt="nginx 任务基本框架"></a></p>
<h4 id="3-4-2-线程池"><a href="#3-4-2-线程池" class="headerlink" title="3.4.2 线程池"></a>3.4.2 线程池</h4><p>官方说明</p>
<blockquote>
<p>Let’s return to our poor sales assistant who delivers goods from a faraway warehouse. But he has become smarter (or maybe he became smarter after being beaten by the crowd of angry clients?) and hired a delivery service. Now when somebody asks for something from the faraway warehouse, instead of going to the warehouse himself, he just drops an order to a delivery service and they will handle the order while our sales assistant will continue serving other customers. Thus only those clients whose goods aren’t in the store are waiting for delivery, while others can be served immediately.</p>
</blockquote>
<p>小拽认为简而言之：<code>结合实际情况，除了空闲被动给，更多的通过事件驱动主动要</code>，通过这种方式在执行资源紧缺的情况下，达到一个执行资源的优化部署，如下图。<br><a href="http://cuihuan.net/wp_content/new/nginx1/nginx_task2.png"><img src="http://cuihuan.net/wp_content/new/nginx1/nginx_task2.png" alt="nginx 任务基本框架"></a><br>线程池官网详解：<a href="https://www.nginx.com/blog/thread-pools-boost-performance-9x/" target="_blank" rel="external">【跳转】</a></p>
<h4 id="3-4-3-事件调度"><a href="#3-4-3-事件调度" class="headerlink" title="3.4.3 事件调度"></a>3.4.3 事件调度</h4><p>请求的具体调度基于事件，例如网络IO,磁盘IO,定时器等均可以对事件进行阻塞，当阻塞的事件空闲时，发出调度请求，完成处理。<br>需要额外提一下，<code>nginx的定时器基于rbtree，红黑树的快速插入和查询保证了nginx事件调度的高效性</code><br>事件框架的处理模型<br><a href="http://cuihuan.net/wp_content/new/nginx1/nginx_event_.png"><img src="http://cuihuan.net/wp_content/new/nginx1/nginx_event_.png" alt="nginx 事件"></a><br><a href="http://cuihuan.net/wp_content/new/nginx1/nginx_epoll.png"><img src="http://cuihuan.net/wp_content/new/nginx1/nginx_epoll.png" alt="nginx epoll"></a></p>
<h2 id="四、简单总结"><a href="#四、简单总结" class="headerlink" title="四、简单总结"></a>四、简单总结</h2><ul>
<li>性能：nginx 工作模式是master-worker进程方式，执行请求是有更轻量线程完成。</li>
<li>热加载：nginx 替换非更新的方式是nginx热加载的本质</li>
<li>功能强大：nginx upstream是在线程层面调度，兼容多种，所以可以扩展很多功能强大</li>
<li>处理流程：主要的流程过程和模块分离清晰。</li>
<li>请求处理：通过自身的管理，线程池，异步事件驱动等当来完成任务调度</li>
</ul>
<p>再次强调：初探nginx，有疑问或不准确的地方，请直接开炮！！！</p>
<h2 id="五、参考文章"><a href="#五、参考文章" class="headerlink" title="五、参考文章"></a>五、参考文章</h2><ul>
<li>netcraft：<a href="https://news.netcraft.com/archives/2017/01/12/january-2017-web-server-survey.html" target="_blank" rel="external">https://news.netcraft.com/archives/2017/01/12/january-2017-web-server-survey.html</a></li>
<li>nginx的线程调度设计：<a href="https://www.nginx.com/blog/inside-nginx-how-we-designed-for-performance-scale/" target="_blank" rel="external">https://www.nginx.com/blog/inside-nginx-how-we-designed-for-performance-scale/</a></li>
<li>epoll详述：<a href="http://man7.org/linux/man-pages/man7/epoll.7.html" target="_blank" rel="external">http://man7.org/linux/man-pages/man7/epoll.7.html</a></li>
<li><a href="http://yaocoder.blog.51cto.com/2668309/888374" target="_blank" rel="external">http://yaocoder.blog.51cto.com/2668309/888374</a></li>
<li>线程池：<a href="https://www.nginx.com/blog/thread-pools-boost-performance-9x/" target="_blank" rel="external">https://www.nginx.com/blog/thread-pools-boost-performance-9x/</a></li>
</ul>
<p>【转载请注明：<a href="http://cuihuan.net/2017/03/14/nginx_study_1/">【【nginx学习一】基本原理学习 </a> | <a href="http://cuihuan.net">靠谱崔小拽</a> 】</p>
]]></content>
      
        
        <tags>
            
            <tag> nginx </tag>
            
            <tag> 基本原理 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[【redis学习三】简单高可用redis架构实践]]></title>
      <url>/2017/02/05/redis3/</url>
      <content type="html"><![CDATA[<blockquote>
<p>背景：支撑线上千万级别的天级查询请求，要求高可用。</p>
</blockquote>
<h1 id="一、方案调研"><a href="#一、方案调研" class="headerlink" title="一、方案调研"></a>一、方案调研</h1><h2 id="1-1-redis版本选择"><a href="#1-1-redis版本选择" class="headerlink" title="1.1 redis版本选择"></a>1.1 redis版本选择</h2><p>redis当前主流版本是redis 2.x 和 redis 3.x，3.0对集群支持比较不错，官方解释如下：</p>
<blockquote>
<p>Redis是一个开源、基于C语言、基于内存亦可持久化的高性能NoSQL数据库，同时，它还提供了多种语言的API。近日，Redis 3.0在经过6个RC版本后，其正式版终于发布了。Redis 3.0的最重要特征是对Redis集群的支持，此外，该版本相对于2.8版本在性能、稳定性等方面都有了重大提高。</p>
</blockquote>
<p>综合考虑之后扩展性和稳定性之后，选择版本 <code>redis 3.2.3-1</code>版本进行部署</p>
<h2 id="1-2-是否选择搭建集群"><a href="#1-2-是否选择搭建集群" class="headerlink" title="1.2 是否选择搭建集群"></a>1.2 是否选择搭建集群</h2><p>是否搭建集群关键要看单机是否能够满足业务需求，做了个简单的数据评估。</p>
<h3 id="数据量评估"><a href="#数据量评估" class="headerlink" title="数据量评估"></a>数据量评估</h3><ul>
<li><strong>测试</strong>：单机写入2000w业务数据，占用内存1.5g，本机126g内存</li>
<li><strong>评估</strong>：单机的稳定数据承载量：2000w <em> （126/1.56）</em> 0.6 = 96923w </li>
<li><strong>结论</strong>：9T 的数据承载量，远超当前千万级别的数据量</li>
</ul>
<h3 id="性能评估"><a href="#性能评估" class="headerlink" title="性能评估"></a>性能评估</h3><ul>
<li><strong>测试</strong>：简单压测了下<ul>
<li>写操作 1000w，80% 在20ms一下 ，98%在30ms，最大218ms，qps 5w/s，总耗时197s</li>
<li>读操作 1000w，97% 在10ms一下 ，99.99%在24ms，qps 6w/s，总耗时160s</li>
</ul>
</li>
<li><strong>评估</strong>：当前的调用量在千万每天，qps的话在百/s。 </li>
<li><strong>结论</strong>：当前单机的redis完全满足需求</li>
</ul>
<p>因此：在单机远能够满足当下业务需求的情况下，决定不采用的集群的方式来部署redis，减少技术债务风险。</p>
<h2 id="1-3-初定方案和架构图"><a href="#1-3-初定方案和架构图" class="headerlink" title="1.3 初定方案和架构图"></a>1.3 初定方案和架构图</h2><p>选定了版本和基本部署方案之后，主要考虑服务的<code>容灾和稳定性</code>，经过思考之后采用<code>采用极简的主从从结构，001实时同步数据002和003；001读写，002，003只读</code>，机构图如下</p>
<p><a href="http://cuihuan.net/wp_content/new/redis/redis_3_framework.png"><img src="http://cuihuan.net/wp_content/new/redis/redis_3_framework.png" alt="redis 框架架构"></a></p>
<h1 id="二、实现过程"><a href="#二、实现过程" class="headerlink" title="二、实现过程"></a>二、实现过程</h1><h2 id="2-1-redis安装"><a href="#2-1-redis安装" class="headerlink" title="2.1 redis安装"></a>2.1 redis安装</h2><p>此处略去，参考官方文档 <a href="https://redis.io/" target="_blank" rel="external">https://redis.io/</a></p>
<h2 id="2-2-配置读写master"><a href="#2-2-配置读写master" class="headerlink" title="2.2 配置读写master"></a>2.2 配置读写master</h2><ul>
<li>修改端口：port 【目的：简单的修改默认端口是最好的防攻击】</li>
<li>添加密码：pwd</li>
<li>关闭压缩：rdbcompression no 【硬盘最够，降低cpu的能耗更利于提升性能】</li>
<li>开启守护进程：daemonize yes 【master开启守护，增加稳定性】</li>
<li>关闭protect-mode :允许他机器访问</li>
<li>添加白名单：bind xxx</li>
<li>修改log地址，pid地址和数据存储地址：logfile pidfile 【便于维护和安全】</li>
<li>添加慢查询：slowlog-log-slower-than 500 【根据业务需求，便于优化】</li>
<li>最大内存限制：maxmemory 【考虑稳定性和性能，一般不超过最大内存的60%】</li>
</ul>
<h2 id="2-3-配置只读slave"><a href="#2-3-配置只读slave" class="headerlink" title="2.3 配置只读slave"></a>2.3 配置只读slave</h2><ul>
<li>同master</li>
<li>设置主库:slaveof ip:port</li>
<li>主库密码：masterauth masterpwd</li>
<li>只读：slave-read-only yes</li>
</ul>
<h2 id="2-4-启动测试"><a href="#2-4-启动测试" class="headerlink" title="2.4 启动测试"></a>2.4 启动测试</h2><h3 id="启动主库写入数据"><a href="#启动主库写入数据" class="headerlink" title="启动主库写入数据"></a>启动主库写入数据</h3><p><a href="http://cuihuan.net/wp_content/new/redis/redis_3_master.png"><img src="http://cuihuan.net/wp_content/new/redis/redis_3_master.png" alt="redis 写入主库"></a></p>
<h3 id="进入从库查看"><a href="#进入从库查看" class="headerlink" title="进入从库查看"></a>进入从库查看</h3><p>最初没有数据，主库写入之后，从库去到数据</p>
<p><a href="http://cuihuan.net/wp_content/new/redis/redis_3_slave.png"><img src="http://cuihuan.net/wp_content/new/redis/redis_3_slave.png" alt="redis 写入从库"></a></p>
<h3 id="查看log确认过程"><a href="#查看log确认过程" class="headerlink" title="查看log确认过程"></a>查看log确认过程</h3><p><a href="http://cuihuan.net/wp_content/new/redis/redis_3_log.png"><img src="http://cuihuan.net/wp_content/new/redis/redis_3_log.png" alt="redis log"></a></p>
<h1 id="三、架构能力评估"><a href="#三、架构能力评估" class="headerlink" title="三、架构能力评估"></a>三、架构能力评估</h1><h2 id="3-1-容灾能力"><a href="#3-1-容灾能力" class="headerlink" title="3.1 容灾能力"></a>3.1 容灾能力</h2><ul>
<li>主动容灾<ul>
<li>备份：master 全量备份，slave全量备份。</li>
<li>备份安全：本机保存，hadoop同步保存一份。</li>
<li>监控和探活：监控机分钟级探活和预警</li>
</ul>
</li>
<li>被动容灾：<ul>
<li>slave 宕机：重启之后直接从master恢复</li>
<li>master 宕机且硬盘数据为损坏：重启后数据自动恢复且和从库一致。</li>
<li>master 宕机且数据损坏：删除损坏数据，使用slave1的数据恢复，保证数据一致。</li>
<li>master 和slave 1 同时宕机：slave2 保证读正常，业务不影响，利用slave2 数据备份恢复master，启动slave 即可</li>
<li>三台全宕机：服务挂掉，从hadoop获取数据恢复服务。</li>
</ul>
</li>
</ul>
<h2 id="3-2-性能评估"><a href="#3-2-性能评估" class="headerlink" title="3.2 性能评估"></a>3.2 性能评估</h2><p>压测数据，参见方案选择，完全hold住。</p>
<h1 id="四、问题思考"><a href="#四、问题思考" class="headerlink" title="四、问题思考"></a>四、问题思考</h1><h2 id="4-1-内存清理策略"><a href="#4-1-内存清理策略" class="headerlink" title="4.1 内存清理策略"></a>4.1 内存清理策略</h2><p>暂时采用：<br>noeviction -&gt; 谁也不删，直接在写操作时返回错误。<br>之后采用：<br>volatile-lru -&gt; 根据LRU算法删除带有过期时间的key。 最少使用算法删除。<br>如果达到内存限制，手工清理，通过监控脚本监控内存情况</p>
<h2 id="4-2-伸缩性和单节点问题"><a href="#4-2-伸缩性和单节点问题" class="headerlink" title="4.2 伸缩性和单节点问题"></a>4.2 伸缩性和单节点问题</h2><p>扩展slave可以直接扩展，扩展master需要master之间数据同步，暂时是个瓶颈。对于主读业务的需求，暂时问题不大；写需求的话，暂时的想法是代码转写的方式。</p>
<h2 id="4-3-采用redis-sentinal-监听"><a href="#4-3-采用redis-sentinal-监听" class="headerlink" title="4.3 采用redis sentinal 监听"></a>4.3 采用redis sentinal 监听</h2><p>默认不错的监听，尝试了下效果不错，还在调研中，配置conf即可，完成后可以查看监听的情况<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">127.0.0.1:port&gt; INFO Sentinel</span></span><br><span class="line"><span class="comment"># Sentinel</span></span><br><span class="line"><span class="section">sentinel_masters:1</span></span><br><span class="line"><span class="section">sentinel_tilt:0</span></span><br><span class="line"><span class="section">sentinel_running_scripts:0</span></span><br><span class="line"><span class="section">sentinel_scripts_queue_length:0</span></span><br><span class="line"><span class="section">sentinel_simulate_failure_flags:0</span></span><br><span class="line"><span class="section">master0:name=redis115,status=ok,address=ip:port,slaves=2,sentinels=1</span></span><br></pre></td></tr></table></figure></p>
<h1 id="五：常用代码"><a href="#五：常用代码" class="headerlink" title="五：常用代码"></a>五：常用代码</h1><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 强制杀死redis，模仿宕机</span></span><br><span class="line">ps aux |grep redis |awk <span class="string">'&#123;print $2&#125;'</span>|xargs kill <span class="number">-9</span></span><br><span class="line"><span class="meta"># 优化模拟宕机 【根据Dual-X-raY提示-_-】</span></span><br><span class="line">redis&gt; DEBUG SEGFAULT</span><br><span class="line"></span><br><span class="line"><span class="meta"># 重启，指定conf</span></span><br><span class="line">/home/work/xxx/bin/redis-server /home/work/xxx/etc/redis.conf</span><br><span class="line"></span><br><span class="line"><span class="meta"># 压测，具体参数可以参考benchmark</span></span><br><span class="line">[cuihuan@cuihuan bin]$  ./redis-benchmark -h <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>  -p 端口 -a 密码  -c <span class="number">1000</span> -n <span class="number">10000000</span>  -d <span class="number">1024</span> -r <span class="number">100000</span> -t <span class="keyword">set</span>,<span class="keyword">get</span>,incr,del</span><br></pre></td></tr></table></figure>
<p>【转载请注明：<a href="http://cuihuan.net/2017/02/05/redis3/">【redis学习三】简单高可用redis架构实践</a> | <a href="http://cuihuan.net">靠谱崔小拽</a> 】</p>
]]></content>
      
        
        <tags>
            
            <tag> redis </tag>
            
            <tag> 高可用架构 </tag>
            
            <tag> 容灾方案 </tag>
            
            <tag> redis主从 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[php爬虫：知乎用户数据爬取和分析]]></title>
      <url>/2017/01/20/charactor/</url>
      <content type="html"><![CDATA[<blockquote>
<p>背景说明：小拽利用php的curl写的爬虫，实验性的爬取了知乎5w用户的基本信息；同时，针对爬取的数据，进行了简单的分析呈现。<a href="http://cuihuan.net:1015/demo_file/zhihu_spider/demo.html">demo 地址</a></p>
</blockquote>
<p>php的spider代码和用户dashboard的展现代码，整理后上传github，在个人博客和公众号更新代码库，程序仅供娱乐和学习交流；如果有侵犯知乎相关权益，请尽快联系本人删除。</p>
<h2 id="无图无真相"><a href="#无图无真相" class="headerlink" title="无图无真相"></a>无图无真相</h2><p>移动端分析数据截图</p>
<p><a href="http://cuihuan.net/wp-content/uploads/2016/01/wise_web_spider.png"><img src="http://cuihuan.net/wp-content/uploads/2016/01/wise_web_spider.png" alt="wise_web_spider"></a></p>
<p>pc端分析数据截图</p>
<p><a href="http://cuihuan.net/wp-content/uploads/2016/01/web_spider.png"><img src="http://cuihuan.net/wp-content/uploads/2016/01/web_spider-629x1024.png" alt="web_spider"></a></p>
<p>整个爬取，分析，展现过程大概分如下几步，小拽将分别介绍</p>
<ul>
<li>curl爬取知乎网页数据</li>
<li>正则分析知乎网页数据</li>
<li>数据数据入库和程序部署</li>
<li>数据分析和呈现</li>
</ul>
<h2 id="curl爬取网页数据"><a href="#curl爬取网页数据" class="headerlink" title="curl爬取网页数据"></a>curl爬取网页数据</h2><p>PHP的curl扩展是PHP支持的，允许你与各种服务器使用各种类型的协议进行连接和通信的库。是一个非常便捷的抓取网页的工具，同时，支持多线程扩展。</p>
<p>本程序抓取的是知乎对外提供用户访问的个人信息页面<a href="https://www.zhihu.com/people/xxx,抓取过程需要携带用户cookie才能获取页面。直接上码" target="_blank" rel="external">https://www.zhihu.com/people/xxx,抓取过程需要携带用户cookie才能获取页面。直接上码</a></p>
<ul>
<li><p>获取页面cookie</p>
  <figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// 登录知乎，打开个人中心，打开控制台，获取cookie</span><br><span class="line">document.cookie</span><br><span class="line"><span class="string">"_za=67254197-3wwb8d-43f6-94f0-fb0e2d521c31; _ga=GA1.2.2142818188.1433767929; q_c1=78ee1604225d47d08cddd8142a08288b23|1452172601000|1452172601000; _xsrf=15f0639cbe6fb607560c075269064393; cap_id="</span>N2QwMTExNGQ0YTY2NGVddlMGIyNmQ4NjdjOTU0YTM5MmQ=|<span class="string">1453444256</span>|<span class="string">49fdc6b43dc51f702b7d6575451e228f56cdaf5d"; __utmt=1; unlock_ticket="QUJDTWpmM0lsZdd2dYQUFBQVlRSlZUVTNVb1ZaNDVoQXJlblVmWGJ0WGwyaHlDdVdscXdZU1VRPT0=</span>|<span class="string">1453444421</span>|<span class="string">c47a2afde1ff334d416bafb1cc267b41014c9d5f"; __utma=51854390.21428dd18188.1433767929.1453187421.1453444257.3; __utmb=51854390.14.8.1453444425011; __utmc=51854390; __utmz=51854390.1452846679.1.dd1.utmcsr=google</span>|<span class="string">utmccn=(organic)</span>|<span class="string">utmcmd=organic</span>|<span class="string">utmctr=(not%20provided); __utmv=51854390.100-1</span>|<span class="string">2=registration_date=20150823=1^dd3=entry_date=20150823=1"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>抓取个人中心页面<br>通过curl，携带cookie，先抓取本人中心页面</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 通过用户名抓取个人中心页面并存储</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $username str :用户名 flag</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> boolean      :成功与否标志</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">spiderUser</span><span class="params">($username)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $cookie = <span class="string">"xxxx"</span> ;</span><br><span class="line">    $url_info = <span class="string">'http://www.zhihu.com/people/'</span> . $username; <span class="comment">//此处cui-xiao-zhuai代表用户ID,可以直接看url获取本人id</span></span><br><span class="line">    $ch = curl_init($url_info); <span class="comment">//初始化会话</span></span><br><span class="line">    curl_setopt($ch, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line">    curl_setopt($ch, CURLOPT_COOKIE, $cookie);  <span class="comment">//设置请求COOKIE</span></span><br><span class="line">    curl_setopt($ch, CURLOPT_USERAGENT, $_SERVER[<span class="string">'HTTP_USER_AGENT'</span>]);</span><br><span class="line">    curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);  <span class="comment">//将curl_exec()获取的信息以文件流的形式返回，而不是直接输出。</span></span><br><span class="line">    curl_setopt($ch, CURLOPT_FOLLOWLOCATION, <span class="number">1</span>);</span><br><span class="line">    $result = curl_exec($ch);</span><br><span class="line"></span><br><span class="line">     file_put_contents(<span class="string">'/home/work/zxdata_ch/php/zhihu_spider/file/'</span>.$username.<span class="string">'.html'</span>,$result);</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="正则分析网页数据"><a href="#正则分析网页数据" class="headerlink" title="正则分析网页数据"></a>正则分析网页数据</h2><h3 id="分析新链接，进一步爬取"><a href="#分析新链接，进一步爬取" class="headerlink" title="分析新链接，进一步爬取"></a>分析新链接，进一步爬取</h3><p>对于抓取过来的网页进行存储，<code>要想进行进一步的爬取，页面必须包含有可用于进一步爬取用户的链接</code>。通过对知乎页面分析发现：在个人中心页面中有关注人和部分点赞人和被关注人。<br>如下所示<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 抓取的html页面中发现了新的用户，可用于爬虫</span></span><br><span class="line">&lt;a <span class="keyword">class</span>=<span class="string">"zm-item-link-avatar avatar-link"</span> href=<span class="string">"/people/new-user"</span> data-tip=<span class="string">"p$t$new-user"</span>&gt;</span><br></pre></td></tr></table></figure></p>
<p>ok，这样子就可以通过自己-》关注人-》关注人的关注人-》。。。进行不断爬取。接下来就是通过正则匹配提取该信息</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 匹配到抓取页面的所有用户</span></span><br><span class="line">preg_match_all(<span class="string">'/\/people\/([\w-]+)\"/i'</span>, $str, $match_arr);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 去重合并入新的用户数组,用户进一步抓取</span></span><br><span class="line"><span class="keyword">self</span>::$newUserArr = array_unique(array_merge($match_arr[<span class="number">1</span>], <span class="keyword">self</span>::$newUserArr));</span><br></pre></td></tr></table></figure>
<p>到此，整个爬虫过程就可以顺利进行了。<br>如果需要大量的抓取数据，可以研究下<code>curl_multi</code>和<code>pcntl</code>进行多线程的快速抓取，此处不做赘述。</p>
<h3 id="分析用户数据，提供分析"><a href="#分析用户数据，提供分析" class="headerlink" title="分析用户数据，提供分析"></a>分析用户数据，提供分析</h3><p>通过正则可以进一步匹配出更多的该用户数据，直接上码。<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 获取用户头像</span></span><br><span class="line">preg_match('/&lt;img.+src=\<span class="string">"?([^\s]+\.(jpg|gif|bmp|bnp|png))\"</span>?.+&gt;/i', <span class="variable">$str</span>, <span class="variable">$match_img</span>);</span><br><span class="line"><span class="variable">$img_url</span> = <span class="variable">$match_img</span>[1];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 匹配用户名：</span></span><br><span class="line"><span class="comment">// &lt;span class="name"&gt;崔小拽&lt;/span&gt;</span></span><br><span class="line">preg_match('/&lt;span.+<span class="keyword">class</span>=\<span class="string">"?name\"</span>?&gt;([\x&#123;4e00&#125;-\x&#123;9fa5&#125;]+).+span&gt;/<span class="keyword">u</span>', <span class="variable">$str</span>, <span class="variable">$match_name</span>);</span><br><span class="line"><span class="variable">$user_name</span> = <span class="variable">$match_name</span>[1];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 匹配用户简介</span></span><br><span class="line"><span class="comment">// class bio span 中文</span></span><br><span class="line">preg_match('/&lt;span.+<span class="keyword">class</span>=\<span class="string">"?bio\"</span>?.+\&gt;([\x&#123;4e00&#125;-\x&#123;9fa5&#125;]+).+span&gt;/<span class="keyword">u</span>', <span class="variable">$str</span>, <span class="variable">$match_title</span>);</span><br><span class="line"><span class="variable">$user_title</span> = <span class="variable">$match_title</span>[1];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 匹配性别</span></span><br><span class="line"><span class="comment">//&lt;input type="radio" name="gender" value="1" checked="checked" class="male"/&gt; 男&amp;nbsp;&amp;nbsp;</span></span><br><span class="line"><span class="comment">// gender value1 ;结束 中文</span></span><br><span class="line">preg_match('/&lt;<span class="keyword">input</span>.+name=\<span class="string">"?gender\"</span>?.+value=\<span class="string">"?1\"</span>?.+([\x&#123;4e00&#125;-\x&#123;9fa5&#125;]+).+\;/<span class="keyword">u</span>', <span class="variable">$str</span>, <span class="variable">$match_sex</span>);</span><br><span class="line"><span class="variable">$user_sex</span> = <span class="variable">$match_sex</span>[1];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 匹配地区</span></span><br><span class="line"><span class="comment">//&lt;span class="location item" title="北京"&gt;</span></span><br><span class="line">preg_match('/&lt;span.+<span class="keyword">class</span>=\<span class="string">"?location.+\"</span>?.+\<span class="string">"([\x&#123;4e00&#125;-\x&#123;9fa5&#125;]+)\"</span>&gt;/<span class="keyword">u</span>', <span class="variable">$str</span>, <span class="variable">$match_city</span>);</span><br><span class="line"><span class="variable">$user_city</span> = <span class="variable">$match_city</span>[1];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 匹配工作</span></span><br><span class="line"><span class="comment">//&lt;span class="employment item" title="人见人骂的公司"&gt;人见人骂的公司&lt;/span&gt;</span></span><br><span class="line">preg_match('/&lt;span.+<span class="keyword">class</span>=\<span class="string">"?employment.+\"</span>?.+\<span class="string">"([\x&#123;4e00&#125;-\x&#123;9fa5&#125;]+)\"</span>&gt;/<span class="keyword">u</span>', <span class="variable">$str</span>, <span class="variable">$match_employment</span>);</span><br><span class="line"><span class="variable">$user_employ</span> = <span class="variable">$match_employment</span>[1];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 匹配职位</span></span><br><span class="line"><span class="comment">// &lt;span class="position item" title="程序猿"&gt;&lt;a href="/topic/19590046" title="程序猿" class="topic-link" data-token="19590046" data-topicid="13253"&gt;程序猿&lt;/a&gt;&lt;/span&gt;</span></span><br><span class="line">preg_match('/&lt;span.+<span class="keyword">class</span>=\<span class="string">"?position.+\"</span>?.+\<span class="string">"([\x&#123;4e00&#125;-\x&#123;9fa5&#125;]+).+\"</span>&gt;/<span class="keyword">u</span>', <span class="variable">$str</span>, <span class="variable">$match_position</span>);</span><br><span class="line"><span class="variable">$user_position</span> = <span class="variable">$match_position</span>[1];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 匹配学历</span></span><br><span class="line"><span class="comment">// &lt;span class="education item" title="研究僧"&gt;研究僧&lt;/span&gt;</span></span><br><span class="line">preg_match('/&lt;span.+<span class="keyword">class</span>=\<span class="string">"?education.+\"</span>?.+\<span class="string">"([\x&#123;4e00&#125;-\x&#123;9fa5&#125;]+)\"</span>&gt;/<span class="keyword">u</span>', <span class="variable">$str</span>, <span class="variable">$match_education</span>);</span><br><span class="line"><span class="variable">$user_education</span> = <span class="variable">$match_education</span>[1];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 工作情况</span></span><br><span class="line"><span class="comment">// &lt;span class="education-extra item" title='挨踢'&gt;挨踢&lt;/span&gt;</span></span><br><span class="line">preg_match('/&lt;span.+<span class="keyword">class</span>=\<span class="string">"?education-extra.+\"</span>?.+&gt;([\x&#123;4e00&#125;-</span><br><span class="line">\x&#123;9fa5&#125;]+)&lt;/<span class="keyword">u</span>', <span class="variable">$str</span>, <span class="variable">$match_education_extra</span>);</span><br><span class="line"><span class="variable">$user_education_extra</span> = <span class="variable">$match_education_extra</span>[1];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 匹配关注话题数量</span></span><br><span class="line"><span class="comment">// class="zg-link-litblue"&gt;&lt;strong&gt;41 个话题&lt;/strong&gt;&lt;/a&gt;</span></span><br><span class="line">preg_match('/<span class="keyword">class</span>=\<span class="string">"?zg-link-litblue\"</span>?&gt;&lt;strong&gt;(\<span class="keyword">d</span>+)\s.+strong&gt;/i', <span class="variable">$str</span>, <span class="variable">$match_topic</span>);</span><br><span class="line"><span class="variable">$user_topic</span> = <span class="variable">$match_topic</span>[1];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 关注人数</span></span><br><span class="line"><span class="comment">// &lt;span class="zg-gray-normal"&gt;关注了</span></span><br><span class="line">preg_match_all('/&lt;strong&gt;(\<span class="keyword">d</span>+)&lt;.+&lt;<span class="keyword">label</span>&gt;/i', <span class="variable">$str</span>, <span class="variable">$match_care</span>);</span><br><span class="line"><span class="variable">$user_care</span> = <span class="variable">$match_care</span>[1][0];</span><br><span class="line"><span class="variable">$user_be_careed</span> = <span class="variable">$match_care</span>[1][1];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 历史浏览量</span></span><br><span class="line"><span class="comment">// &lt;span class="zg-gray-normal"&gt;个人主页被 &lt;strong&gt;17&lt;/strong&gt; 人浏览&lt;/span&gt;</span></span><br><span class="line">preg_match('/<span class="keyword">class</span>=\<span class="string">"?zg-gray-normal\"</span>?.+&gt;(\<span class="keyword">d</span>+)&lt;.+span&gt;/i', <span class="variable">$str</span>, <span class="variable">$match_browse</span>);</span><br><span class="line"><span class="variable">$user_browse</span> = <span class="variable">$match_browse</span>[1];</span><br></pre></td></tr></table></figure></p>
<h2 id="数据入库和程序优化"><a href="#数据入库和程序优化" class="headerlink" title="数据入库和程序优化"></a>数据入库和程序优化</h2><p>在抓取的过程中，有条件的话，一定要通过redis入库，确实能提升抓取和入库效率。没有条件的话只能通过sql优化。这里来几发心德。</p>
<ul>
<li>数据库表设计索引一定要慎重。在spider爬取的过程中，建议出了用户名，左右字段都不要索引，包括主键都不要，<code>尽可能的提高入库效率</code>，试想5000w的数据，每次添加一个，建立索引需要多少消耗。等抓取完毕，需要分析数据时，批量建立索引。</li>
<li><p>数据入库和更新操作，一定要批量。 mysql 官方给出的增删改的建议和速度：<a href="http://dev.mysql.com/doc/refman/5.7/en/insert-speed.html" target="_blank" rel="external">http://dev.mysql.com/doc/refman/5.7/en/insert-speed.html</a></p>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 官方的最优批量插入</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> yourtable <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="number">2</span>), (<span class="number">5</span>,<span class="number">5</span>), ...;</span><br></pre></td></tr></table></figure>
</li>
<li><p>部署操作。程序在抓取过程中，有可能会出现异常挂掉，为了保证高效稳定，尽可能的写一个定时脚本。每隔一段时间干掉，重新跑，这样即使异常挂掉也不会浪费太多宝贵时间，毕竟，time is money。</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 干掉</span></span><br><span class="line">ps aux |grep spider |awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</span><br><span class="line">sleep 5s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新跑</span></span><br><span class="line">nohup /home/cuixiaohuan/lamp/php5/bin/php /home/cuixiaohuan/php/zhihu_spider/spider_new.php &amp;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="数据分析呈现"><a href="#数据分析呈现" class="headerlink" title="数据分析呈现"></a>数据分析呈现</h2><p>数据的呈现主要使用echarts 3.0，感觉对于移动端兼容还不错。兼容移动端的页面响应式布局主要通过几个简单的css控制，代码如下</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*兼容性和响应式div设计*/</span></span><br><span class="line">@<span class="keyword">media</span> screen and (max-width: <span class="number">480px</span>) &#123;</span><br><span class="line">    <span class="selector-tag">body</span>&#123;</span><br><span class="line">        <span class="attribute">padding</span>: <span class="number">0</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="selector-class">.adapt-div</span> &#123;</span><br><span class="line">        <span class="attribute">width</span>: <span class="number">100%</span> ;</span><br><span class="line">        <span class="attribute">float</span>: none ;</span><br><span class="line">        <span class="attribute">margin</span>: <span class="number">20px</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="selector-class">.half-div</span> &#123;</span><br><span class="line">        <span class="attribute">height</span>: <span class="number">350px</span> ;</span><br><span class="line">        <span class="attribute">margin-bottom</span>: <span class="number">10px</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="selector-class">.whole-div</span> &#123;</span><br><span class="line">        <span class="attribute">height</span>: <span class="number">350px</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;!<span class="selector-tag">--</span> 整块完整布局，半块在<span class="selector-tag">web</span>端采用<span class="selector-tag">float</span>的方式，移动端去掉<span class="selector-tag">--</span>&gt;</span><br><span class="line"><span class="selector-class">.half-div</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">48%</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">430px</span>;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">1%</span>;</span><br><span class="line">    <span class="attribute">float</span>: left</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.whole-div</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">98%</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">430px</span>;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">1%</span>;</span><br><span class="line">    <span class="attribute">float</span>: left</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="不足和待学习"><a href="#不足和待学习" class="headerlink" title="不足和待学习"></a>不足和待学习</h2><p>整个过程中涉及php,shell,js,css,html,正则等语言和部署等基础知识，但还有诸多需要改进完善，小拽特此记录，后续补充例：</p>
<ul>
<li>php 采用multicul进行多线程。</li>
<li>正则匹配进一步优化</li>
<li>部署和抓取过程采用redis提升存储</li>
<li>移动端布局的兼容性提升</li>
<li>js的模块化和sass书写css。</li>
</ul>
<p>【转载请注明：<a href="http://cuihuan.net/article/php%E7%88%AC%E8%99%AB%EF%BC%9A%E7%9F%A5%E4%B9%8E%E7%94%A8%E6%88%B7%E6%95%B0%E6%8D%AE%E7%88%AC%E5%8F%96%E5%92%8C%E5%88%86%E6%9E%90.html">php爬虫：知乎用户数据爬取和分析</a> | <a href="http://cuihuan.net">靠谱崔小拽</a> 】</p>
]]></content>
      
        
        <tags>
            
            <tag> php </tag>
            
            <tag> javascript </tag>
            
            <tag> 网页爬虫 </tag>
            
            <tag> shell </tag>
            
            <tag> css </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[【高并发简单解决方案】redis队列缓存 + 批量入库 + php离线整合]]></title>
      <url>/2017/01/20/%E3%80%90%E9%AB%98%E5%B9%B6%E5%8F%91%E7%AE%80%E5%8D%95%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E3%80%91redis%E9%98%9F%E5%88%97%E7%BC%93%E5%AD%98%20+%20mysql%20%E6%89%B9%E9%87%8F%E5%85%A5%E5%BA%93%20+%20php%E7%A6%BB%E7%BA%BF%E6%95%B4%E5%90%88/</url>
      <content type="html"><![CDATA[<blockquote>
<p>需求背景：有个<code>调用统计日志存储和统计需求</code>，要求存储到mysql中；存储数据高峰能达到日均千万，瓶颈在于<code>直接入库并发太高，可能会把mysql干垮</code>。</p>
</blockquote>
<h2 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h2><p>思考：应用网站架构的衍化过程中，应用最新的框架和工具技术固然是最优选择；但是，如果能在<code>现有的框架的基础上提出简单可依赖的解决方案</code>，未尝不是一种提升自我的尝试。</p>
<p>解决：</p>
<ul>
<li>问题一：要求日志最好入库；但是，直接入库mysql确实扛不住，批量入库没有问题，done。【批量入库和直接入库性能差异<a href="http://tech.uc.cn/?p=634" target="_blank" rel="external">参考文章</a>】</li>
<li>问题二：批量入库就需要有高并发的消息队列，决定采用redis list 仿真实现，而且方便回滚。</li>
<li>问题三：日志量毕竟大，保存最近30条足矣，决定用php写个离线统计和清理脚本。</li>
</ul>
<p>done，下面是小拽的简单实现过程</p>
<h2 id="一：设计数据库表和存储"><a href="#一：设计数据库表和存储" class="headerlink" title="一：设计数据库表和存储"></a>一：设计数据库表和存储</h2><ul>
<li>考虑到log系统对数据库的性能更多一些，稳定性和安全性没有那么高，<code>存储引擎自然是只支持select insert 没有索引的archive</code>。如果确实有update需求，也可以采用myISAM。</li>
<li>考虑到log是实时记录的所有数据，数量可能巨大，<code>主键采用bigint，自增即可</code>。</li>
<li>考虑到log系统<code>以写为主，统计采用离线计算，字段均不要出现索引</code>，因为一方面可能会影响插入数据效率，另外读时候会造成死锁，影响写数据。</li>
</ul>
<h2 id="二：redis存储数据形成消息队列"><a href="#二：redis存储数据形成消息队列" class="headerlink" title="二：redis存储数据形成消息队列"></a>二：redis存储数据形成消息队列</h2><p>由于高并发，尽可能简单，直接，上代码。<br><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"><span class="comment"><span class="markdown">/<span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown">*</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">* </span>获取到的调用日志，存入redis的队列中.</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">* </span>$Id$</span></span></span><br><span class="line"><span class="comment"><span class="markdown">*</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span>*/</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">* </span>@file saveLog.php</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">* </span>@date 2015/11/06 20:47:13</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">* </span>@author:cuihuan</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">* </span>@version $Revision$</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">* </span>@brief</span></span></span><br><span class="line"><span class="comment"><span class="markdown">*</span></span></span><br><span class="line"><span class="comment"><span class="markdown">**/</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取info</span></span><br><span class="line">$interface_info = $_GET[<span class="string">'info'</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 存入redis队列</span></span><br><span class="line">$redis = <span class="keyword">new</span> Redis();</span><br><span class="line">$redis-&gt;connect(<span class="string">'xx'</span>, <span class="number">6379</span>);</span><br><span class="line">$redis-&gt;auth(<span class="string">"password"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 加上时间戳存入队列</span></span><br><span class="line">$now_time = date(<span class="string">"Y-m-d H:i:s"</span>);</span><br><span class="line">$redis-&gt;rPush(<span class="string">"call_log"</span>, $interface_info . <span class="string">"%"</span> . $now_time);</span><br><span class="line">$redis-&gt;close();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* vim: set ts=4 sw=4 sts=4 tw=100 */</span></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="三：数据定时批量入库。"><a href="#三：数据定时批量入库。" class="headerlink" title="三：数据定时批量入库。"></a>三：数据定时批量入库。</h2><p>定时读取redis消息队列里面的数据，批量入库。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line">/**</span><br><span class="line"> * 获取redis消息队列中的脚本，拼接sql，批量入库。</span><br><span class="line"> * @update 2015-11-07 添加失败消息队列回滚机制 </span><br><span class="line"> *</span><br><span class="line"> * @Author:cuihuan</span><br><span class="line"> * 2015-11-06</span><br><span class="line"><span class="php"> * */</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="comment">// init redis</span></span></span><br><span class="line"><span class="php">$redis_xx = <span class="keyword">new</span> Redis();</span></span><br><span class="line"><span class="php">$redis_xx-&gt;connect(<span class="string">'ip'</span>, port);</span></span><br><span class="line"><span class="php">$redis_xx-&gt;auth(<span class="string">"password"</span>);</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="comment">// 获取现有消息队列的长度</span></span></span><br><span class="line"><span class="php">$count = <span class="number">0</span>;</span></span><br><span class="line"><span class="php">$max = $redis_xx-&gt;lLen(<span class="string">"call_log"</span>);</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="comment">// 获取消息队列的内容，拼接sql</span></span></span><br><span class="line"><span class="php">$insert_sql = <span class="string">"insert into fb_call_log (`interface_name`, `createtime`) values "</span>;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="comment">// 回滚数组</span></span></span><br><span class="line"><span class="php">$roll_back_arr = <span class="keyword">array</span>();</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">while</span> ($count &lt; $max) &#123;</span></span><br><span class="line"><span class="php">    $log_info = $redis_cq01-&gt;lPop(<span class="string">"call_log"</span>);</span></span><br><span class="line"><span class="php">    $roll_back_arr = $log_info;</span></span><br><span class="line"><span class="php">    <span class="keyword">if</span> ($log_info == <span class="string">'nil'</span> || !<span class="keyword">isset</span>($log_info)) &#123;</span></span><br><span class="line"><span class="php">        $insert_sql .= <span class="string">";"</span>;</span></span><br><span class="line"><span class="php">        <span class="keyword">break</span>;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="comment">// 切割出时间和info</span></span></span><br><span class="line"><span class="php">    $log_info_arr = explode(<span class="string">"%"</span>,$log_info);</span></span><br><span class="line"><span class="php">    $insert_sql .= <span class="string">" ('"</span>.$log_info_arr[<span class="number">0</span>].<span class="string">"','"</span>.$log_info_arr[<span class="number">1</span>].<span class="string">"'),"</span>;</span></span><br><span class="line"><span class="php">    $count++;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="comment">// 判定存在数据，批量入库</span></span></span><br><span class="line"><span class="php"><span class="keyword">if</span> ($count != <span class="number">0</span>) &#123;</span></span><br><span class="line"><span class="php">    $link_2004 = mysql_connect(<span class="string">'ip:port'</span>, <span class="string">'user'</span>, <span class="string">'password'</span>);</span></span><br><span class="line"><span class="php">    <span class="keyword">if</span> (!$link_2004) &#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">die</span>(<span class="string">"Could not connect:"</span> . mysql_error());</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    $crowd_db = mysql_select_db(<span class="string">'fb_log'</span>, $link_2004);</span></span><br><span class="line"><span class="php">    $insert_sql = rtrim($insert_sql,<span class="string">","</span>).<span class="string">";"</span>;</span></span><br><span class="line"><span class="php">    $res = mysql_query($insert_sql);</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="comment">// 输出入库log和入库结果;</span></span></span><br><span class="line"><span class="php">    <span class="keyword">echo</span> date(<span class="string">"Y-m-d H:i:s"</span>).<span class="string">"insert "</span>.$count.<span class="string">" log info result:"</span>;</span></span><br><span class="line"><span class="php">    <span class="keyword">echo</span> json_encode($res);</span></span><br><span class="line"><span class="php">    <span class="keyword">echo</span> <span class="string">"&lt;/br&gt;\n"</span>;</span></span><br><span class="line"><span class="php">    </span></span><br><span class="line"><span class="php">    <span class="comment">// 数据库插入失败回滚</span></span></span><br><span class="line"><span class="php">    <span class="keyword">if</span>(!$res)&#123;</span></span><br><span class="line"><span class="php">       <span class="keyword">foreach</span>($roll_back_arr <span class="keyword">as</span> $k)&#123;</span></span><br><span class="line"><span class="php">           $redis_xx-&gt;rPush(<span class="string">"call_log"</span>, $k);</span></span><br><span class="line"><span class="php">       &#125;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"> </span></span><br><span class="line"><span class="php">    <span class="comment">// 释放连接</span></span></span><br><span class="line"><span class="php">    mysql_free_result($res);</span></span><br><span class="line"><span class="php">    mysql_close($link_2004);</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="comment">// 释放redis</span></span></span><br><span class="line"><span class="php">$redis_cq01-&gt;close();</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<h2 id="四：离线天级统计和清理数据脚本"><a href="#四：离线天级统计和清理数据脚本" class="headerlink" title="四：离线天级统计和清理数据脚本"></a>四：离线天级统计和清理数据脚本</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">?php</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* static log ：每天离线统计代码日志和删除五天前的日志</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* <span class="doctag">@Author</span>:cuihuan</span></span><br><span class="line"><span class="comment">* 2015-11-06</span></span><br><span class="line"><span class="comment">* */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 离线统计</span></span><br><span class="line">$link_2004 = mysql_connect(<span class="string">'ip:port'</span>, <span class="string">'user'</span>, <span class="string">'pwd'</span>);</span><br><span class="line"><span class="keyword">if</span> (!$link_2004) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"Could not connect:"</span> . mysql_error());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$crowd_db = mysql_select_db(<span class="string">'fb_log'</span>, $link_2004);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 统计昨天的数据</span></span><br><span class="line">$day_time = date(<span class="string">"Y-m-d"</span>, time() - <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span> * <span class="number">1</span>);</span><br><span class="line">$static_sql = <span class="string">"get sql"</span>;</span><br><span class="line"></span><br><span class="line">$res = mysql_query($static_sql, $link_2004);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取结果入库略</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 清理15天之前的数据</span></span><br><span class="line">$before_15_day = date(<span class="string">"Y-m-d"</span>, time() - <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span> * <span class="number">15</span>);</span><br><span class="line">$delete_sql = <span class="string">"delete from xxx where createtime &lt; '"</span> . $before_15_day . <span class="string">"'"</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    $res = mysql_query($delete_sql);</span><br><span class="line">&#125;<span class="keyword">catch</span>(<span class="keyword">Exception</span> $e)&#123;</span><br><span class="line">    <span class="keyword">echo</span> json_encode($e).<span class="string">"\n"</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"delete result:"</span>.json_encode($res).<span class="string">"\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mysql_close($link_2004);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="五：代码部署"><a href="#五：代码部署" class="headerlink" title="五：代码部署"></a>五：代码部署</h2><p>主要是部署，批量入库脚本的调用和天级统计脚本，crontab例行运行。<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 批量入库脚本</span></span><br><span class="line">*<span class="regexp">/2 * * * * /</span>home<span class="regexp">/cuihuan/</span>xxx<span class="regexp">/lamp/</span>php5<span class="regexp">/bin/</span>php <span class="regexp">/home/</span>cuihuan<span class="regexp">/xxx/</span>batchLog.php &gt;&gt;<span class="regexp">/home/</span>cuihuan<span class="regexp">/xxx/</span>batchlog.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 天级统计脚本</span></span><br><span class="line"><span class="number">0</span> <span class="number">5</span> * * * <span class="regexp">/home/</span>cuihuan<span class="regexp">/xxx/</span>php5<span class="regexp">/bin/</span>php <span class="regexp">/home/</span>cuihuan<span class="regexp">/xxx/</span>staticLog.php &gt;&gt;<span class="regexp">/home/</span>cuihuan<span class="regexp">/xxx/</span>staticLog.log</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>总结：相对于其他复杂的方式处理高并发，这个解决方案简单有效：通过redis缓存抗压，mysql批量入库解决数据库瓶颈，离线计算解决统计数据，通过定期清理保证库的大小。</p>
</blockquote>
<p>【转载请注明：<a href="http://cuihuan.net/article/%E3%80%90%E9%AB%98%E5%B9%B6%E5%8F%91%E7%AE%80%E5%8D%95%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E3%80%91redis%E7%BC%93%E5%AD%98%E9%98%9F%E5%88%97-mysql-%E6%89%B9%E9%87%8F%E5%85%A5%E5%BA%93-php%E7%A6%BB.html">高并发简单解决方案</a> | <a href="http://cuihuan.net">靠谱崔小拽</a> 】</p>
]]></content>
      
        
        <tags>
            
            <tag> php </tag>
            
            <tag> mysql </tag>
            
            <tag> redis </tag>
            
            <tag> 高并发 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[fsck修复linux文件损坏]]></title>
      <url>/2016/08/20/fsck%E4%BF%AE%E5%A4%8Dlinux%E6%96%87%E4%BB%B6%E6%8D%9F%E5%9D%8F/</url>
      <content type="html"><![CDATA[<blockquote>
<p><code>数据一定要备份，最好多机备份，代码一定要ci</code>。</p>
</blockquote>
<h2 id="背景和损失"><a href="#背景和损失" class="headerlink" title="背景和损失"></a>背景和损失</h2><p>背景：机房事故，突然关机，硬盘年老失修，造成很多文件不可用。如图</p>
<p><a href="http://cuihuan.net/wp-content/uploads/2016/08/11441496-18D2-4576-8F5F-C2BF7B84F458.png"><img src="http://cuihuan.net/wp-content/uploads/2016/08/11441496-18D2-4576-8F5F-C2BF7B84F458-300x84.png" alt="11441496-18D2-4576-8F5F-C2BF7B84F458"></a></p>
<p>面临损失：<br>作为一名靠谱程序员，数据库单机多机备份，程序版本控制这些都是有的【如果没有，一定要加上】；但这次有一个重要影响，就是git中commit之后，没有push的文件全损坏了，损坏了，坏了，了。。。。</p>
<h2 id="分析原因"><a href="#分析原因" class="headerlink" title="分析原因"></a>分析原因</h2><p>op给出的说法是网络波动，造成机房故障，机器重启。但从结果看，文件系统乱掉了，而且乱掉的文件主要分两类：</p>
<ul>
<li>1：当时正在写入和操作的文件。例如运行的脚本，正在写的文件，samba建立网络映射的文件，git实时文件。</li>
<li>2：内存里的数据，例如memcache里的数据等等</li>
</ul>
<h2 id="处理：fsck修复。"><a href="#处理：fsck修复。" class="headerlink" title="处理：fsck修复。"></a>处理：fsck修复。</h2><p>###1：查看硬盘挂载：<br>df查看下磁盘的挂载位置。</p>
<p><a href="http://cuihuan.net/wp-content/uploads/2016/08/F60D7BE5-D89D-4C74-9927-6EE2DD6157DF.png"><img src="http://cuihuan.net/wp-content/uploads/2016/08/F60D7BE5-D89D-4C74-9927-6EE2DD6157DF-300x51.png" alt="F60D7BE5-D89D-4C74-9927-6EE2DD6157DF"></a></p>
<h3 id="2：操作挂起：不挂起可能会出现数据恢复中断。"><a href="#2：操作挂起：不挂起可能会出现数据恢复中断。" class="headerlink" title="2：操作挂起：不挂起可能会出现数据恢复中断。"></a>2：操作挂起：<code>不挂起可能会出现数据恢复中断</code>。</h3><p>报错：直接挂起会出现 dev is busy，如下图<br><a href="http://cuihuan.net/wp-content/uploads/2016/08/59423A93-F29C-4A30-AB92-17408E9E6556.png"><img src="http://cuihuan.net/wp-content/uploads/2016/08/59423A93-F29C-4A30-AB92-17408E9E6556-300x40.png" alt="59423A93-F29C-4A30-AB92-17408E9E6556"></a><br>用：umout -l /dev/sda3<br><a href="http://cuihuan.net/wp-content/uploads/2016/08/3C64703C-CF4A-47EB-9FE3-91CD7542E8FA.png"><img src="http://cuihuan.net/wp-content/uploads/2016/08/3C64703C-CF4A-47EB-9FE3-91CD7542E8FA-300x46.png" alt="3C64703C-CF4A-47EB-9FE3-91CD7542E8FA"></a><br><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#umount -l &lt;挂载点|设备&gt;</span></span><br><span class="line"></span><br><span class="line">此命令将会断开设备并关闭打开该设备的全部句柄。</span><br><span class="line">通常，您可以使用 eject &lt;挂载点<span class="string">|设备&gt;命令弹出碟片</span></span><br></pre></td></tr></table></figure></p>
<h3 id="3：fsck-扫盘"><a href="#3：fsck-扫盘" class="headerlink" title="3：fsck 扫盘"></a>3：fsck 扫盘</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fsck -f <span class="regexp">/dev/</span>sda3</span><br></pre></td></tr></table></figure>
<p>注意ext2 还会进行e2fsck 再扫一遍，此为正常操作<br><a href="http://cuihuan.net/wp-content/uploads/2016/08/C9347418-9644-4841-9A2C-3FFB1157E5D8.png"><img src="http://cuihuan.net/wp-content/uploads/2016/08/C9347418-9644-4841-9A2C-3FFB1157E5D8-300x83.png" alt="C9347418-9644-4841-9A2C-3FFB1157E5D8"></a></p>
<h3 id="4：扫盘结束后，挂载驱动盘"><a href="#4：扫盘结束后，挂载驱动盘" class="headerlink" title="4：扫盘结束后，挂载驱动盘"></a>4：扫盘结束后，挂载驱动盘</h3><h3 id="5：寻找和恢复文件"><a href="#5：寻找和恢复文件" class="headerlink" title="5：寻找和恢复文件"></a>5：寻找和恢复文件</h3><p>把.git 内的文件全部整理，导出，一个一个寻找自己需要的文件，找到了久违的文件。<br><a href="http://cuihuan.net/wp-content/uploads/2016/08/3B14EF17-2C86-411F-BF16-4FFC15637C4D.png"><img src="http://cuihuan.net/wp-content/uploads/2016/08/3B14EF17-2C86-411F-BF16-4FFC15637C4D-300x109.png" alt="3B14EF17-2C86-411F-BF16-4FFC15637C4D"></a></p>
<h2 id="后续"><a href="#后续" class="headerlink" title="后续"></a>后续</h2><p>一句话：<code>代码一定要ci，数据一定要容灾</code></p>
<p>【转载请注明：<a href="http://cuihuan.net/?p=474">fsck修复linux文件损坏</a> | <a href="http://cuihuan.net">靠谱崔小拽</a> 】</p>
]]></content>
      
        
        <tags>
            
            <tag> linux </tag>
            
            <tag> git修复 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[【page-monitor 前端自动化 下篇】 实践应用]]></title>
      <url>/2016/08/20/%E3%80%90page-monitor%20%E5%89%8D%E7%AB%AF%E8%87%AA%E5%8A%A8%E5%8C%96%20%E4%B8%8B%E7%AF%87%E3%80%91%20%E5%AE%9E%E8%B7%B5%E5%BA%94%E7%94%A8/</url>
      <content type="html"><![CDATA[<blockquote>
<p>通过page-diff的初步调研和源码分析，确定page-diff在前端自动化测试和监控方面做一些事情。本篇主要介绍下，page-diff在具体的实践中的一些应用</p>
</blockquote>
<h2 id="核心dom校验"><a href="#核心dom校验" class="headerlink" title="核心dom校验"></a>核心dom校验</h2><p>前端的快速发展，造成前端dom无论结构还是命名经常变化，每次都尽可能关注每个dom的变化，不可能也没有必要。但是<code>核心dom是相对变化较小，但是比较重要</code>，因此可以利用page-monitor 修改关注结构中的核心代码，核心架构的变化。</p>
<p>上图是未修改的代码，下图是忽略footer内部变化<br><a href="http://cuihuan.net/wp-content/uploads/2016/08/F1AE4B80-CFC6-4A94-AB24-86297DCDD759.png"><img src="http://cuihuan.net/wp-content/uploads/2016/08/F1AE4B80-CFC6-4A94-AB24-86297DCDD759.png" alt="F1AE4B80-CFC6-4A94-AB24-86297DCDD759"></a><br><a href="http://cuihuan.net/wp-content/uploads/2016/08/0141A2E8-9B5E-439A-9FEC-1147ACF982DF.png"><img src="http://cuihuan.net/wp-content/uploads/2016/08/0141A2E8-9B5E-439A-9FEC-1147ACF982DF.png" alt="0141A2E8-9B5E-439A-9FEC-1147ACF982DF"></a><br>实践中可以针对自身的核心dom进行进一步优化</p>
<h2 id="局部dom校验"><a href="#局部dom校验" class="headerlink" title="局部dom校验"></a>局部dom校验</h2><p>项目中，往往在某一时期特别关心某些板块，或者某些板块相对容易出错；因此，可以利用page-monitor 进行局部dom的细节diff。中篇中对只针对header进行对比diff做了详细介绍，此处不赘述，上图。</p>
<p><a href="http://cuihuan.net/wp-content/uploads/2016/08/FDF6B258-5A69-47D1-B1FF-4EB38D7B8677.png"><img src="http://cuihuan.net/wp-content/uploads/2016/08/FDF6B258-5A69-47D1-B1FF-4EB38D7B8677.png" alt="FDF6B258-5A69-47D1-B1FF-4EB38D7B8677"></a></p>
<h2 id="算法优化"><a href="#算法优化" class="headerlink" title="算法优化"></a>算法优化</h2><p>由于获取了完整了dom的json，因此可以通过相关阈值的设定或者算法的优化；来对比结果，进行更加优化的分级预警和分析；作者一般对非核心预警超过15%变化会做出预警，超过更高阈值会进一步的预警等等。<br>贴一个dom 细节图<br> <a href="http://cuihuan.net/wp-content/uploads/2016/08/dom.jpg"><img src="http://cuihuan.net/wp-content/uploads/2016/08/dom.jpg" alt="dom"></a></p>
<h2 id="其他分析"><a href="#其他分析" class="headerlink" title="其他分析"></a>其他分析</h2><p>小拽通过上面的举例，旨在抛砖引玉，希望page-monitor或者dom结构在前端的自动化测试有一定应用，提升产品质量。</p>
<p>最终再上一张流程图，便于分析<br><a href="http://cuihuan.net/wp-content/uploads/2016/08/page-diff-%E6%B5%81%E7%A8%8B%E5%9B%BE.png"><img src="http://cuihuan.net/wp-content/uploads/2016/08/page-diff-%E6%B5%81%E7%A8%8B%E5%9B%BE.png" alt="page-diff 流程图"></a></p>
<p>相关文章：<br><a href="http://cuihuan.net/?p=485">【page-monitor 前端自动化 上篇】 初步调研</a><br><a href="http://cuihuan.net/?p=493">【page-monitor 前端自动化 中篇】 源码分析</a></p>
]]></content>
      
        
        <tags>
            
            <tag> javascript </tag>
            
            <tag> 前端 </tag>
            
            <tag> 自动化测试 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[phpredis单例模式封装]]></title>
      <url>/2016/08/08/phpredis%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F%E5%B0%81%E8%A3%85/</url>
      <content type="html"><![CDATA[<blockquote>
<p>通过单例模式实现对phpredis连接的封装。</p>
</blockquote>
<h2 id="直接上代码"><a href="#直接上代码" class="headerlink" title="直接上代码"></a>直接上代码</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line">/**</span><br><span class="line"> * Class RedisConnManager</span><br><span class="line"> *</span><br><span class="line"> * 单例模式对redis实例的操作的进一步封装</span><br><span class="line"> * 主要目的：防止过多的连接，一个页面只能存在一个声明连接</span><br><span class="line"> * </span><br><span class="line"> * @author ：cuihuan</span><br><span class="line"><span class="php"> */</span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">RedisManager</span></span></span></span><br><span class="line"><span class="php">&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">private</span> <span class="keyword">static</span> $redisInstance;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line">    /**</span><br><span class="line">     * 私有化构造函数</span><br><span class="line">     * 原因：防止外界调用构造新的对象</span><br><span class="line"><span class="php">     */</span></span><br><span class="line"><span class="php">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line">    /**</span><br><span class="line">     * 获取redis连接的唯一出口</span><br><span class="line"><span class="php">     */</span></span><br><span class="line"><span class="php">    <span class="keyword">static</span> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getRedisConn</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">if</span>(!<span class="keyword">self</span>::$redisInstance <span class="keyword">instanceof</span> <span class="keyword">self</span>)&#123;</span></span><br><span class="line"><span class="php">            <span class="keyword">self</span>::$redisInstance = <span class="keyword">new</span> <span class="keyword">self</span>;</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">        <span class="comment">// 获取当前单例</span></span></span><br><span class="line"><span class="php">        $temp = <span class="keyword">self</span>::$redisInstance;</span></span><br><span class="line"><span class="php">        <span class="comment">// 调用私有化方法</span></span></span><br><span class="line"><span class="php">        <span class="keyword">return</span> $temp-&gt;connRedis();</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line">    /**</span><br><span class="line">     * 连接ocean 上的redis的私有化方法</span><br><span class="line">     * @return Redis</span><br><span class="line"><span class="php">     */</span></span><br><span class="line"><span class="php">    <span class="keyword">static</span> <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">connRedis</span><span class="params">()</span></span></span></span><br><span class="line"><span class="php">    &#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">try</span> &#123;</span></span><br><span class="line"><span class="php">            $redis_ocean = <span class="keyword">new</span> Redis();</span></span><br><span class="line"><span class="php">            $redis_ocean-&gt;connect(G::$conf[<span class="string">'redis-host'</span>], G::$conf[<span class="string">'redis-port'</span>]);</span></span><br><span class="line"><span class="php">            $redis_ocean-&gt;auth(G::$conf[<span class="string">'redis-pass'</span>]);</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">        &#125;<span class="keyword">catch</span> (<span class="keyword">Exception</span> $e)&#123;</span></span><br><span class="line"><span class="php">            <span class="keyword">echo</span> $e-&gt;getMessage().<span class="string">'&lt;br/&gt;'</span>;</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">        <span class="keyword">return</span> $redis_ocean;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">&#125;</span></span><br></pre></td></tr></table></figure>
<p>【转载请注明：<a href="http://cuihuan.net/?p=527">phpredis单例模式封装</a> | <a href="http://cuihuan.net">靠谱崔小拽</a> 】</p>
]]></content>
      
        
        <tags>
            
            <tag> php </tag>
            
            <tag> redis </tag>
            
            <tag> 单例模式 </tag>
            
            <tag> 设计模式 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[【page-monitor 前端自动化 中篇】 源码分析]]></title>
      <url>/2016/08/07/page_monitor_second/</url>
      <content type="html"><![CDATA[<blockquote>
<p>上篇中初探了page-monitor的一些功能和在前端自动化测试方面的可行性，本篇主要分析下page-monitor的实现方式和源码。</p>
</blockquote>
<h2 id="mode-module简介"><a href="#mode-module简介" class="headerlink" title="mode-module简介"></a>mode-module简介</h2><p>page-monitor的存在形式是node-module，依赖于node安装和运行，简单必须了解下node_modules</p>
<p><code>node-module</code>是nodejs的模块，符合commonJs规范【具体规范可以参考：<a href="http://javascript.ruanyifeng.com/nodejs/module.html】" target="_blank" rel="external">http://javascript.ruanyifeng.com/nodejs/module.html】</a></p>
<p>简单描述commonJs规范<br>1：文件即模块，作用域在文件内，不允许重复，不会污染。<br>2：<code>加载依赖出现顺序</code>，加载即运行，重复则利用缓存。</p>
<blockquote>
<p>多说一句：这是amd 和cmd(commonJs)的本质区别，由于node多运行于服务端，加载比较快，因此比较适合cmd 规范，浏览器端的模块则更适用于cmd的规范，个人理解没有广义的好坏之分</p>
</blockquote>
<p>方便看源码，贴出node_modole简单构成和主要函数module<br>node内部提供一了一个modle的构造函数，所有的模块都继承和依赖于此模块。<br><a href="http://cuihuan.net/wp-content/uploads/2016/08/F4D61DF9-40DC-4DB6-A98E-6BED90406D5A.png"><img src="http://cuihuan.net/wp-content/uploads/2016/08/F4D61DF9-40DC-4DB6-A98E-6BED90406D5A.png" alt="F4D61DF9-40DC-4DB6-A98E-6BED90406D5A"></a><br>node module的引入 require命令。<br>其他加载规则，路径设定不在此赘述。</p>
<h2 id="page-monitor文件分析"><a href="#page-monitor文件分析" class="headerlink" title="page-monitor文件分析"></a>page-monitor文件分析</h2><p>完整文件目录：<br><a href="http://cuihuan.net/wp-content/uploads/2016/08/B39BD2DF-7652-49F9-A8FB-F2F691688169.png"><img src="http://cuihuan.net/wp-content/uploads/2016/08/B39BD2DF-7652-49F9-A8FB-F2F691688169.png" alt="B39BD2DF-7652-49F9-A8FB-F2F691688169"></a>  </p>
<p>运行生成目录分析：<br><a href="http://cuihuan.net/wp-content/uploads/2016/08/dom-%E5%88%86%E5%B8%83.jpg"><img src="http://cuihuan.net/wp-content/uploads/2016/08/dom-%E5%88%86%E5%B8%83.jpg" alt="B39BD2DF-7652-49F9-A8FB-F2F691688169"></a>  </p>
<p>出了node_module及其组件代码，可用和值的分析的文件index.js 和phantomjs 下面的五个文件。</p>
<h2 id="分析index-js"><a href="#分析index-js" class="headerlink" title="分析index.js"></a>分析index.js</h2><p>代码中无非变量声明和引用，关键一句引用phantom的命令乳腺<br><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 多线程启动位置</span></span><br><span class="line">var <span class="function"><span class="keyword">proc</span> = <span class="title">spawn</span>(<span class="params">binPath, arr</span>)</span>;</span><br></pre></td></tr></table></figure></p>
<p>通过上面多线程的启动node可以达到高效和并发处理测试任务的需求，分析下arr的内容如下图：看到了 窗口大小，延时，ua，存放地址，diff变量等等</p>
<p><a href="http://cuihuan.net/wp-content/uploads/2016/08/E9B3CEA8-6B99-45CC-A52A-B8E9D90B267C.png"><img src="http://cuihuan.net/wp-content/uploads/2016/08/E9B3CEA8-6B99-45CC-A52A-B8E9D90B267C.png" alt="E9B3CEA8-6B99-45CC-A52A-B8E9D90B267C"></a></p>
<h2 id="分析获取DOM源码"><a href="#分析获取DOM源码" class="headerlink" title="分析获取DOM源码"></a>分析获取DOM源码</h2><p>获取dom的源码主要利用了web api evalution，evalution传入一个xpath的参数，返回一个xpath的对象，之后通过遍历和xpath规则生成规则化的json。<br>贴一个evalution api<br><a href="http://cuihuan.net/wp-content/uploads/2016/08/90E47065-DF3B-470E-996C-1900A2EAF354.png"><img src="http://cuihuan.net/wp-content/uploads/2016/08/90E47065-DF3B-470E-996C-1900A2EAF354.png" alt="90E47065-DF3B-470E-996C-1900A2EAF354"></a> </p>
<p>为了看懂page-monitor的代码举个栗子<br><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># evalution example:</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> headings = <span class="built_in">document</span>.evaluate(<span class="string">"/html/body//h2"</span>, <span class="built_in">document</span>, <span class="keyword">null</span>, XPathResult.ANY_TYPE, <span class="keyword">null</span>);</span><br><span class="line"><span class="comment">/* 检索body中所有H2的所欲.</span></span><br><span class="line"><span class="comment"> * 结果存在于一个node的迭代器中 */</span></span><br><span class="line"><span class="keyword">var</span> thisHeading = headings.iterateNext();</span><br><span class="line"><span class="keyword">var</span> alertText = <span class="string">"Level 2 headings in this document are:\n"</span>;</span><br><span class="line"><span class="keyword">while</span> (thisHeading) &#123;</span><br><span class="line">  alertText += thisHeading.textContent + <span class="string">"\n"</span>;</span><br><span class="line">  thisHeading = headings.iterateNext();</span><br><span class="line">&#125;</span><br><span class="line">alert(alertText); <span class="comment">// Alerts the text of all h2 elements</span></span><br></pre></td></tr></table></figure></p>
<p>通过上面函数和page-monitor中walk.js函数最后一行，可以看出page-monitor 保存了四个元素：属性[name,id等等]，节点类型，位置[后期渲染]，样式的md5加密[样式仅需要对比是否变化即可]<br>具体内容和dom结构如下：<br> <a href="http://cuihuan.net/wp-content/uploads/2016/08/30FA5132-7903-466A-B866-588311812C47.png"><img src="http://cuihuan.net/wp-content/uploads/2016/08/30FA5132-7903-466A-B866-588311812C47.png" alt="30FA5132-7903-466A-B866-588311812C47"></a><br>对应的具体dom结构<br><a href="http://cuihuan.net/wp-content/uploads/2016/08/FBEE1F3F-7A81-4AF0-8E05-7E0BED5B5291.png"><img src="http://cuihuan.net/wp-content/uploads/2016/08/FBEE1F3F-7A81-4AF0-8E05-7E0BED5B5291.png" alt="FBEE1F3F-7A81-4AF0-8E05-7E0BED5B5291"></a> </p>
<h2 id="diff-js-代码"><a href="#diff-js-代码" class="headerlink" title="diff.js 代码"></a>diff.js 代码</h2><p>diff代码主要两个作用</p>
<ul>
<li>1：获取差异</li>
<li>2：渲染差异<br>其中对比的策略：</li>
</ul>
<p>历史完全每个对比现在：获取更新和删除的内容<br>现在完全每个对比历史：获取更新和新增的内容<br>具体可以参考代码</p>
<h2 id="其他api和源码简单修改"><a href="#其他api和源码简单修改" class="headerlink" title="其他api和源码简单修改"></a>其他api和源码简单修改</h2><p>必须了解的web api 还有一个是querySeletor 也就是检索的api，参考地址<br><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Document/querySelector" target="_blank" rel="external">document.querySelector()</a><br>了解了这个api就可以做一件事情：<code>不对全局dom diff，只对特别关心的dom进行diff</code><br>实现方式：修改querySelector的根节点为Header<br>获取的dom结构如下：根节点为header<br><a href="http://cuihuan.net/wp-content/uploads/2016/08/30FA5132-7903-466A-B866-588311812C47.png"><img src="http://cuihuan.net/wp-content/uploads/2016/08/30FA5132-7903-466A-B866-588311812C47.png" alt="30FA5132-7903-466A-B866-588311812C47"></a></p>
<p>获取的页面截图如下：<br><a href="http://cuihuan.net/wp-content/uploads/2016/08/FDF6B258-5A69-47D1-B1FF-4EB38D7B8677.png"><img src="http://cuihuan.net/wp-content/uploads/2016/08/FDF6B258-5A69-47D1-B1FF-4EB38D7B8677.png" alt="FDF6B258-5A69-47D1-B1FF-4EB38D7B8677"></a></p>
<h2 id="代码流程图"><a href="#代码流程图" class="headerlink" title="代码流程图"></a>代码流程图</h2><p> <a href="http://cuihuan.net/wp-content/uploads/2016/08/page-diff-流程图.png"><img src="http://cuihuan.net/wp-content/uploads/2016/08/page-diff-%E6%B5%81%E7%A8%8B%E5%9B%BE.png" alt="page-diff 流程图"></a></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本次在调研page-monitor的基础上，对page-monitor的源码实现进行分析；同时利用相关api修改，来只对核心页面进行获取优化。下一篇将会进一步思考page-monitor的应用。</p>
<p>相关文章：<br><a href="http://cuihuan.net/?p=485">【page-monitor 前端自动化 上篇】 初步调研</a><br><a href="http://cuihuan.net/?p=508">【page-monitor 前端自动化 下篇】 实践应用</a></p>
]]></content>
      
        
        <tags>
            
            <tag> javascript </tag>
            
            <tag> 自动化测试 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[【page-monitor 前端自动化 上篇】初步调研]]></title>
      <url>/2016/08/07/%E3%80%90page-monitor%20%E5%89%8D%E7%AB%AF%E8%87%AA%E5%8A%A8%E5%8C%96%20%E4%B8%8A%E7%AF%87%E3%80%91%E5%88%9D%E6%AD%A5%E8%B0%83%E7%A0%94%20/</url>
      <content type="html"><![CDATA[<blockquote>
<p>前端自动化测试主要在于：<code>变化快，不稳定，兼容性复杂</code>；故而，想通过较低的成本维护较为通用的自动化case比较困难。本文旨在<code>通过page-monitor获取和分析dom结构，调研能否通过监控和分析核心dom，来进行前端自动化测试</code>。</p>
</blockquote>
<h2 id="一：page-monitor-介绍"><a href="#一：page-monitor-介绍" class="headerlink" title="一：page-monitor 介绍"></a>一：page-monitor 介绍</h2><p>page-monitor：通过xpath获取dom节点结构，之后可视化的渲染出页面的差异。<br>github地址：<a href="https://github.com/fouber/page-monitor" target="_blank" rel="external">https://github.com/fouber/page-monitor</a><br>基本原理：<code>利用xpath获取页面的dom结构，存储为结构化的json，对比两次的json之间的差异，利用phantom渲染页面和差异页面</code>。</p>
<p>先上个初次试用的图</p>
<p><a href="http://cuihuan.net/wp-content/uploads/2016/08/927EE33C-AD06-4EC3-9E5C-B8C3D2029AA3.png"><img src="http://cuihuan.net/wp-content/uploads/2016/08/927EE33C-AD06-4EC3-9E5C-B8C3D2029AA3-212x300.png" alt="927EE33C-AD06-4EC3-9E5C-B8C3D2029AA3"></a></p>
<h2 id="二：初次试用"><a href="#二：初次试用" class="headerlink" title="二：初次试用"></a>二：初次试用</h2><h3 id="2-1-安装"><a href="#2-1-安装" class="headerlink" title="2.1 安装"></a>2.1 安装</h3><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># page-monitor 依赖于 phantomjs</span></span><br><span class="line">npm <span class="keyword">install</span> phantomjs</span><br><span class="line">npm <span class="keyword">install</span> page-monitor</span><br></pre></td></tr></table></figure>
<p>注意：phantomJs较大，如果比较慢 可以用brew安装，并且<code>page-monitor最多兼容phantom1.98</code><br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 调整phantom为1.98 版本</span></span><br><span class="line">MacBook-Pro:~ cuixiaohuan$ brew link phantomjs198</span><br><span class="line">Linking <span class="meta-keyword">/usr/</span>local/Cellar<span class="meta-keyword">/phantomjs198/</span><span class="number">1.9</span><span class="number">.8</span>... <span class="number">2</span> symlinks created</span><br><span class="line">MacBook-Pro:~ cuixiaohuan$ phantomjs -v</span><br><span class="line"><span class="number">1.9</span><span class="number">.8</span></span><br></pre></td></tr></table></figure></p>
<p>2.2 初次运行：<br>写一个test.js 代码如下:<br><figure class="highlight qml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Monitor = <span class="built_in">require</span>(<span class="string">'page-monitor'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> <span class="built_in">url</span> = <span class="string">'http://www.baidu.com'</span>;</span><br><span class="line"><span class="keyword">var</span> monitor = <span class="keyword">new</span> Monitor(<span class="built_in">url</span>);</span><br><span class="line">monitor.capture(<span class="function"><span class="keyword">function</span>(<span class="params">code</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(monitor.log); <span class="comment">// from phantom</span></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'done, exit ['</span> + code + <span class="string">']'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>运行效果<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">MacBook-Pro:test cuixiaohuan$ node test.js</span><br><span class="line">&#123; debug:</span><br><span class="line">   [ <span class="string">'mode: 11'</span>,</span><br><span class="line">     <span class="string">'need diff'</span>,</span><br><span class="line">     <span class="string">'loading: http://www.baidu.com'</span>,</span><br><span class="line">     <span class="string">'page.viewportSize = &#123;"width":320,"height":568&#125;'</span>,</span><br><span class="line">     <span class="string">'page.settings.resourceTimeout = 20000'</span>,</span><br><span class="line">     <span class="string">'page.settings.userAgent = "Mozilla/5.0 (iPhone; CPU iPhone OS 7_0 like Mac OS X; en-us) AppleWebKit/537.51.1 (KHTML, like Gecko) Version/7.0 Mobile/11A465 Safari/9537.53"'</span>,</span><br><span class="line">     <span class="string">'loaded: http://www.baidu.com'</span>,</span><br><span class="line">     <span class="string">'delay before render: 0ms'</span>,</span><br><span class="line">     <span class="string">'walk tree'</span>,</span><br><span class="line">     <span class="string">'save capture [/Users/cuixiaohuan/Desktop/workspace/test/pagemonitor/test/www.baidu.com/Lw==/1461155680901]'</span>,</span><br><span class="line">     <span class="string">'screenshot [/Users/cuixiaohuan/Desktop/workspace/test/pagemonitor/test/www.baidu.com/Lw==/1461155680901/screenshot.jpg]'</span>,</span><br><span class="line">     <span class="string">'Unsafe JavaScript attempt to access frame with URL about:blank from frame with URL file:///Users/cuixiaohuan/Desktop/workspace/test/pagemonitor/test/node_modules/page-monitor/phantomjs/index.js. Domains, protocols and ports must match.'</span> ],</span><br><span class="line">  warning: [],</span><br><span class="line">  info: [],</span><br><span class="line">  error: [],</span><br><span class="line">  notice: [] &#125;</span><br><span class="line">done, <span class="keyword">exit</span> [<span class="number">0</span>]</span><br></pre></td></tr></table></figure></p>
<h3 id="2-2-生成对比页面"><a href="#2-2-生成对比页面" class="headerlink" title="2.2 生成对比页面"></a>2.2 生成对比页面</h3><p> test.js code</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">monitor.diff(<span class="number">1408947323420</span>, <span class="number">1408947556898</span>, <span class="function"><span class="keyword">function</span>(<span class="params">code</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(monitor.log.info); <span class="comment">// diff result</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'[DONE] exit ['</span> + code + <span class="string">']'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>运行<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MacBook-Pro:test cuixiaohuan$ <span class="keyword">node</span> <span class="title">test</span>.js</span><br><span class="line">[ '&#123;<span class="string">"diff"</span>:&#123;<span class="string">"left"</span>:<span class="string">"1461155680901"</span>,<span class="string">"right"</span>:<span class="string">"1461163758667"</span>,<span class="string">"screenshot"</span>:<span class="string">"/Users/cuixiaohuan/Desktop/workspace/test/pagemonitor/test/www.baidu.com/Lw==/diff/1461155680901-1461163758667.jpg"</span>,<span class="string">"count"</span>:&#123;<span class="string">"add"</span>:<span class="number">2</span>,<span class="string">"remove"</span>:<span class="number">2</span>,<span class="string">"style"</span>:<span class="number">0</span>,<span class="string">"text"</span>:<span class="number">9</span>&#125;&#125;&#125;' ]</span><br><span class="line">[DONE] exit [<span class="number">0</span>]</span><br></pre></td></tr></table></figure></p>
<h3 id="2-3-对比页面效果如下图"><a href="#2-3-对比页面效果如下图" class="headerlink" title="2.3 对比页面效果如下图"></a>2.3 对比页面效果如下图</h3><p><a href="http://cuihuan.net/wp-content/uploads/2016/08/927EE33C-AD06-4EC3-9E5C-B8C3D2029AA3.png"><img src="http://cuihuan.net/wp-content/uploads/2016/08/927EE33C-AD06-4EC3-9E5C-B8C3D2029AA3-212x300.png" alt="927EE33C-AD06-4EC3-9E5C-B8C3D2029AA3"></a></p>
<h3 id="2-4-目录初步分析"><a href="#2-4-目录初步分析" class="headerlink" title="2.4 目录初步分析"></a>2.4 目录初步分析</h3><p>通过目录和运行结果<br>1：每个时间利用phantom生成一张截图【保存现场】和一个dome的tree.json【对比dom】 【生成过程看下源码】<br>2：diff 调用tree.json 比较区中的区别【位置，内容生成和对比过程之后看下源码？】<br>3：利用当时保存的截图渲染生成的结果</p>
<p><a href="http://cuihuan.net/wp-content/uploads/2016/08/F2838502-FF7E-4DC8-9C7F-01687F3DB3E9.png"><img src="http://cuihuan.net/wp-content/uploads/2016/08/F2838502-FF7E-4DC8-9C7F-01687F3DB3E9-300x151.png" alt="F2838502-FF7E-4DC8-9C7F-01687F3DB3E9"></a></p>
<h2 id="三：dom-diff工具page-monitor-调研初步结论："><a href="#三：dom-diff工具page-monitor-调研初步结论：" class="headerlink" title="三：dom diff工具page monitor 调研初步结论："></a>三：dom diff工具page monitor 调研初步结论：</h2><ul>
<li>1：dom的diff 是可行的。</li>
<li>2：page monitor 现有主要功能：抽取不同时间段的页面做页面domdiff<br>使用过程中缺陷：<br>1：依赖太多，依赖node，依赖phantom，<br>2：接口太少，现在直接提供的就两个一个保存现场，一个diff。不方便dom定制和阈值定制。</li>
</ul>
<h2 id="四：应用价值思考和下一步"><a href="#四：应用价值思考和下一步" class="headerlink" title="四：应用价值思考和下一步"></a>四：应用价值思考和下一步</h2><p>如果能对dom树的处理更完善一些，应用价值还是挺高的，例如<code>核心dom的diff，局部dom的diff，时效性dom(例如：时间tag必须变化，不变化则为bug)的变更检验，兼容性dom的check等等</code></p>
<p>下一步调研：<br>看下源码中，分析dom生成tree过程，对比tree过程，展现tree过程。</p>
<p>相关文章：<br><a href="http://cuihuan.net/?p=493">【page-monitor 前端自动化 中篇】 源码分析</a><br><a href="http://cuihuan.net/?p=508">【page-monitor 前端自动化 下篇】 实践应用</a></p>
]]></content>
      
        
        <tags>
            
            <tag> javascript </tag>
            
            <tag> 自动化测试 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[【chrome 插件一】开发一个简单chrome浏览器插件]]></title>
      <url>/2016/04/26/chrome_1/</url>
      <content type="html"><![CDATA[<blockquote>
<p>chrome 之所以越来越好用，很大一部分原因归功于功能丰富的插件；对于chrome忠实用户来说，了解和开发一款适合自己的chrome插件，确实是一件很cool的事情。</p>
</blockquote>
<h2 id="了解chrome-插件"><a href="#了解chrome-插件" class="headerlink" title="了解chrome 插件"></a>了解chrome 插件</h2><p>chrome 插件个人理解：<code>就是一个html + js +css + image的一个web应用</code>；不同于普通的web应用，<code>chrome插件除了兼容普通的js，json，h5等api，还可以调用一些浏览器级别的api，例如收藏夹，历史记录等。</code></p>
<p>推荐两个网站了解和入门<br>谷歌官方API：<a href="https://developer.chrome.com/extensions/getstarted" target="_blank" rel="external">https://developer.chrome.com/extensions/getstarted</a><br>360的文档：<a href="http://open.chrome.360.cn/extension_dev/overview.html" target="_blank" rel="external">http://open.chrome.360.cn/extension_dev/overview.html</a></p>
<h2 id="开始写第一个插件"><a href="#开始写第一个插件" class="headerlink" title="开始写第一个插件"></a>开始写第一个插件</h2><h3 id="文件结构"><a href="#文件结构" class="headerlink" title="文件结构"></a>文件结构</h3><p>一个简单的demo，文件目录如下<br><a href="http://cuihuan.net/wp-content/uploads/2016/04/7A980C32-7D7B-44F6-AC5D-C0CC02F79ACA.png"><img src="http://cuihuan.net/wp-content/uploads/2016/04/7A980C32-7D7B-44F6-AC5D-C0CC02F79ACA.png" alt="7A980C32-7D7B-44F6-AC5D-C0CC02F79ACA"></a><br>和普通的web文件没有什么区别，简单介绍下</p>
<ul>
<li>html:存放html页面</li>
<li>js :存放js</li>
<li>locales ：存放了一个多语言的兼容【可无】</li>
<li>image ：放了两张图片【初期图标】</li>
<li>manifest ：核心入口文件</li>
</ul>
<h3 id="写一个manifest"><a href="#写一个manifest" class="headerlink" title="写一个manifest"></a>写一个manifest</h3><p>api参考文档 :<a href="http://open.chrome.360.cn/extension_dev/manifest.html" target="_blank" rel="external">http://open.chrome.360.cn/extension_dev/manifest.html</a></p>
<p>直接上代码：<br><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"name"</span>: <span class="string">"hijack analyse plug"</span>,</span><br><span class="line">  <span class="string">"version"</span>: <span class="string">"0.0.1"</span>,</span><br><span class="line">  <span class="string">"manifest_version"</span>: <span class="number">2</span>,</span><br><span class="line"></span><br><span class="line">  // 简单描述</span><br><span class="line">  <span class="string">"description"</span>: <span class="string">"chrome plug analyse and guard the http hijack"</span>,</span><br><span class="line">  <span class="string">"icons"</span>: &#123;</span><br><span class="line">    <span class="string">"16"</span>: <span class="string">"image/icon16.png"</span>,</span><br><span class="line">    <span class="string">"48"</span>: <span class="string">"image/icon48.png"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  // 选择默认语言</span><br><span class="line">  <span class="string">"default_locale"</span>: <span class="string">"en"</span>,</span><br><span class="line"></span><br><span class="line">  // 浏览器小图表部分</span><br><span class="line">  <span class="string">"browser_action"</span>: &#123;</span><br><span class="line">    <span class="string">"default_title"</span>: <span class="string">"反劫持"</span>,</span><br><span class="line">    <span class="string">"default_icon"</span>: <span class="string">"image/icon16.png"</span>,</span><br><span class="line">    <span class="string">"default_popup"</span>: <span class="string">"html/test.html"</span></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  // 引入一个脚本</span><br><span class="line">  <span class="string">"content_scripts"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"js"</span>: [<span class="string">"script/test.js"</span>],</span><br><span class="line">      // 在什么情况下使用该脚本</span><br><span class="line">      <span class="string">"matches"</span>: [</span><br><span class="line">        <span class="string">"http://*/*"</span>,</span><br><span class="line">        <span class="string">"https://*/*"</span></span><br><span class="line">      ],</span><br><span class="line">      // 什么情况下运行【文档加载开始】</span><br><span class="line">      <span class="string">"run_at"</span>: <span class="string">"document_start"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  // 应用协议页面</span><br><span class="line">  <span class="string">"permissions"</span>: [</span><br><span class="line">    <span class="string">"http://*/*"</span>,</span><br><span class="line">    <span class="string">"https://*/*"</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>test.js 文件<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @author: cuixiaohuan</span></span><br><span class="line"><span class="comment"> * Date: 16/4/13</span></span><br><span class="line"><span class="comment"> * Time: 下午8:41</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * just test for run by self</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'begin'</span>);</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure></p>
<p>test.html 文件<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>just for test<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h3</span>&gt;</span>test<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="运行插件"><a href="#运行插件" class="headerlink" title="运行插件"></a>运行插件</h3><p>chrome 中输入：chrome://extensions<br>选择加载已解压的插件-》选择文件根目录即可。<br>效果如下：</p>
<p><a href="http://cuihuan.net/wp-content/uploads/2016/04/475BA7E7-29F3-48AF-9990-2B73FF1B4B56.png"><img src="http://cuihuan.net/wp-content/uploads/2016/04/475BA7E7-29F3-48AF-9990-2B73FF1B4B56.png" alt="生效插件"></a><br>一个基本的插件变完成了，勾选已启用，随便打开一个网页，会看到log中输出如下</p>
<p><a href="http://cuihuan.net/wp-content/uploads/2016/04/50F1039A-71C0-463F-A60D-C95527985C7E.png"><img src="http://cuihuan.net/wp-content/uploads/2016/04/50F1039A-71C0-463F-A60D-C95527985C7E.png" alt="运行效果"></a></p>
<p>点击页面上面的小图标如下图：<br><a href="http://cuihuan.net/wp-content/uploads/2016/04/25CF59DD-0666-4A6F-ACA3-683D1FEEA346.png"><img src="http://cuihuan.net/wp-content/uploads/2016/04/25CF59DD-0666-4A6F-ACA3-683D1FEEA346.png" alt="右侧展示"></a></p>
<h2 id="优化建议"><a href="#优化建议" class="headerlink" title="优化建议"></a>优化建议</h2><p>一个小的插件已经完成，但是还有更多的api和有趣的事情可以去做。下面是360文档中给出一些优化建议，共勉。</p>
<ul>
<li>确认 Browser actions 只使用在大多数网站都有功能需求的场景下。确认 Browser actions 没有使用在少数网页才有功能的场景， 此场景请使用page actions。</li>
<li>确认你的图标尺寸尽量占满19x19的像素空间。 Browser action 的图标应该看起来比page action的图标更大更重。</li>
<li>尽量使用alpha通道并且柔滑你的图标边缘，因为很多用户使用themes，你的图标应该在在各种背景下都表现不错。不要不停的闪动你的图标，这很惹人反感。</li>
</ul>
<p>【转载请注明：<a href="http://cuihuan.net/article/postmessage%E5%A4%84%E7%90%86iframe-%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98.html">【chrome 插件一】开发一个简单chrome浏览器插件</a> | <a href="http://cuihuan.net">靠谱崔小拽</a> 】</p>
]]></content>
      
        
        <tags>
            
            <tag> javascript </tag>
            
            <tag> chrome-extension </tag>
            
            <tag> chrome </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[【chrome 插件二】添加菜单和添加消息提醒]]></title>
      <url>/2016/04/20/chrome_2/</url>
      <content type="html"><![CDATA[<blockquote>
<p>上一篇中简单的接触了chrome插件，并且草草的制作一个chrome 插件（-_-只中看，不能用）；这次主要学习，<code>browse action api制作菜单制作和调用系统提醒</code>。</p>
</blockquote>
<h2 id="browse-action"><a href="#browse-action" class="headerlink" title="browse action"></a>browse action</h2><p>browse action 包括四部分：一个图标，一个tooltip，一个badge和一个pophtml<br>先上代码和效果<br><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"browser_action"</span>: &#123;</span><br><span class="line">   <span class="string">"default_title"</span>: <span class="string">"反劫持工具"</span>,</span><br><span class="line">   <span class="string">"default_icon"</span>: <span class="string">"image/icon_19.png"</span>,</span><br><span class="line">   <span class="string">"default_popup"</span>: <span class="string">"html/popup.html"</span></span><br><span class="line"> &#125;,</span><br></pre></td></tr></table></figure></p>
<p><a href="http://cuihuan.net/wp-content/uploads/2016/04/9E62D576-098D-4B4A-8C4C-1E845D23E094.png"><img src="http://cuihuan.net/wp-content/uploads/2016/04/9E62D576-098D-4B4A-8C4C-1E845D23E094.png" alt="red"></a></p>
<h3 id="图标"><a href="#图标" class="headerlink" title="图标"></a>图标</h3><p>图标优化：<code>最好是19px，这样基本占满</code>，可以直接使用图标也可以用h5 canvas element，同时，<code>图片一定要是背景透明的</code>。</p>
<p>ps处理后页面效果如下：</p>
<p><a href="http://cuihuan.net/wp-content/uploads/2016/04/C84884DF-38DB-4402-8BEF-181795A51FAF.png"><img src="http://cuihuan.net/wp-content/uploads/2016/04/C84884DF-38DB-4402-8BEF-181795A51FAF.png" alt="title"></a></p>
<h3 id="tooltip"><a href="#tooltip" class="headerlink" title="tooltip"></a>tooltip</h3><p>直接设置default_title 效果是鼠标经过显示标题效果</p>
<h3 id="badge"><a href="#badge" class="headerlink" title="badge:"></a>badge:</h3><p>这个相当于设置图片文字和背景色：提供了两个方法：设置badge文字和颜色可以分别使用setBadgeText()andsetBadgeBackgroundColor()。</p>
<h3 id="pophtml：创建菜单"><a href="#pophtml：创建菜单" class="headerlink" title="pophtml：创建菜单"></a>pophtml：创建菜单</h3><p>上码：<code>能用代码说话的，不用文字</code><br>js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @author: cuixiaohuan</span></span><br><span class="line"><span class="comment"> * Date: 16/4/19</span></span><br><span class="line"><span class="comment"> * Time: 下午9:41</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 点击菜单的事件</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param e</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">click</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">    chrome.tabs.executeScript(<span class="literal">null</span>,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 更改背景色</span></span><br><span class="line">            code: <span class="string">"document.body.style.backgroundColor='"</span> + e.target.id + <span class="string">"'"</span></span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="built_in">window</span>.close();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 页面加载完成后，监听事件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="built_in">document</span>.addEventListener(<span class="string">'DOMContentLoaded'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> divs = <span class="built_in">document</span>.querySelectorAll(<span class="string">'div'</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; divs.length; i++) &#123;</span><br><span class="line">        divs[i].addEventListener(<span class="string">'click'</span>, click);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>html<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Set Page Color Popup<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">        body &#123;</span></span><br><span class="line"><span class="undefined">            overflow: hidden;</span></span><br><span class="line"><span class="undefined">            margin: 0px;</span></span><br><span class="line"><span class="undefined">            padding: 0px;</span></span><br><span class="line"><span class="undefined">            background: white;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="css">        <span class="selector-tag">div</span><span class="selector-pseudo">:first-child</span> &#123;</span></span><br><span class="line"><span class="undefined">            margin-top: 0px;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">        div &#123;</span></span><br><span class="line"><span class="undefined">            cursor: pointer;</span></span><br><span class="line"><span class="undefined">            text-align: center;</span></span><br><span class="line"><span class="undefined">            padding: 1px 3px;</span></span><br><span class="line"><span class="undefined">            font-family: sans-serif;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">font-size</span>: 0<span class="selector-class">.8em</span>;</span></span><br><span class="line"><span class="undefined">            width: 100px;</span></span><br><span class="line"><span class="undefined">            margin-top: 1px;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">background</span>: <span class="selector-id">#cccccc</span>;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="css">        <span class="selector-tag">div</span><span class="selector-pseudo">:hover</span> &#123;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">background</span>: <span class="selector-id">#aaaaaa</span>;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="css">        <span class="selector-id">#red</span> &#123;</span></span><br><span class="line"><span class="undefined">            border: 1px solid red;</span></span><br><span class="line"><span class="undefined">            color: red;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="css">        <span class="selector-id">#blue</span> &#123;</span></span><br><span class="line"><span class="undefined">            border: 1px solid blue;</span></span><br><span class="line"><span class="undefined">            color: blue;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="css">        <span class="selector-id">#green</span> &#123;</span></span><br><span class="line"><span class="undefined">            border: 1px solid green;</span></span><br><span class="line"><span class="undefined">            color: green;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="css">        <span class="selector-id">#yellow</span> &#123;</span></span><br><span class="line"><span class="undefined">            border: 1px solid yellow;</span></span><br><span class="line"><span class="undefined">            color: yellow;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"../script/changeBackgroud.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"red"</span>&gt;</span>红色小拽<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"blue"</span>&gt;</span>绿色小拽<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"green"</span>&gt;</span>蓝色小拽<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"yellow"</span>&gt;</span>换色小拽<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>效果图<br><a href="http://cuihuan.net/wp-content/uploads/2016/04/4AA82B9D-759E-434E-A0B5-8F2F0376F16D.png"><img src="http://cuihuan.net/wp-content/uploads/2016/04/4AA82B9D-759E-434E-A0B5-8F2F0376F16D.png" alt="blue"></a></p>
<h2 id="调用系统提醒"><a href="#调用系统提醒" class="headerlink" title="调用系统提醒"></a>调用系统提醒</h2><p>notification api 官方文档:<a href="https://developer.chrome.com/extensions/notifications" target="_blank" rel="external">https://developer.chrome.com/extensions/notifications</a><br>注意</p>
<ul>
<li>chrome32 之前的预警接口不太一样，文档中已经说明。</li>
<li>使用预警一定要加上权限统一<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"permissions"</span>: [</span><br><span class="line">  <span class="string">"notifications"</span></span><br><span class="line">],</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>调用系统提醒代码<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 用户授权</span></span><br><span class="line"><span class="keyword">if</span> (Notification.permission == <span class="string">"granted"</span>) &#123;</span><br><span class="line">    Notification.requestPermission();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 调用系统提醒</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 第一次进入页面需要授权，之后弹出提醒</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">notifyMe</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!Notification) &#123;</span><br><span class="line">        alert(<span class="string">'Desktop notifications not available in your browser. Try Chromium.'</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (Notification.permission !== <span class="string">"granted"</span>)&#123;</span><br><span class="line">        Notification.requestPermission();</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> notification = <span class="keyword">new</span> Notification(<span class="string">'小拽提醒'</span>, &#123;</span><br><span class="line">            icon: <span class="string">'http://cuihuan.net/wp-content/themes/quench-master/images/cuihuan_title.jpg'</span>,</span><br><span class="line">            body: <span class="string">"别点击，点击跳转'靠谱崔小拽'"</span></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        notification.onclick = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="built_in">window</span>.open(<span class="string">"http://cuihuan.net"</span>);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>初次进去提醒，授权<br><a href="http://cuihuan.net/wp-content/uploads/2016/04/8971AFAA-2C56-4A2F-962B-BBA0A8E0E7A4.png"><img src="http://cuihuan.net/wp-content/uploads/2016/04/8971AFAA-2C56-4A2F-962B-BBA0A8E0E7A4.png" alt="notify_allow"></a></p>
<p>提醒效果如右上角所示<br><a href="http://cuihuan.net/wp-content/uploads/2016/04/04A3AF6D-69FA-423A-8447-F5984F32762C.png"><img src="http://cuihuan.net/wp-content/uploads/2016/04/04A3AF6D-69FA-423A-8447-F5984F32762C.png" alt="notify"></a></p>
<p>通过菜单和提醒，我们基本就可以完成一个简单的闹钟提醒，每隔30分钟提醒，码农扭扭脑袋，伸伸懒腰，小心肩周炎-_-!</p>
<p>【转载请注明：<a href="http://cuihuan.net/?p=454">【chrome 插件二】弹出菜单和系统提醒学习</a> | <a href="http://cuihuan.net">靠谱崔小拽</a> 】</p>
]]></content>
      
        
        <tags>
            
            <tag> javascript </tag>
            
            <tag> chrome-extension </tag>
            
            <tag> chrome </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[中型存储架构实践探索]]></title>
      <url>/2016/04/20/%E4%B8%AD%E5%9E%8B%E5%AD%98%E5%82%A8%E6%9E%B6%E6%9E%84%E5%AE%9E%E8%B7%B5%E6%8E%A2%E7%B4%A2/</url>
      <content type="html"><![CDATA[<blockquote>
<p>最近一直在做平台优化：对于中小型的站点，<code>如何在资源有限的情况下，实现一个稳定，高效，靠谱的存储方案</code>。下图是小拽个人在时间过程使用的一个存储架构。拿出来分享交流一下，也希望得到指点改进！</p>
</blockquote>
<h2 id="先上图"><a href="#先上图" class="headerlink" title="先上图"></a>先上图</h2><p><a href="http://cuihuan.net/wp-content/uploads/2016/02/存储架构.jpg"><img src="http://cuihuan.net/wp-content/uploads/2016/02/存储架构-1024x996.jpg" alt="存储架构"></a></p>
<h2 id="首先说思想"><a href="#首先说思想" class="headerlink" title="首先说思想"></a>首先说思想</h2><p>思想就一个：<code>权衡资源和业务需求</code></p>
<blockquote>
<p>简单解释一下：对于架构的理解，个人非常认同百度架构师tandai的一句话：<code>架构设计本质上是折衷的艺术</code>，如果你有足够量的高速存储和高性能的机器，那么完全可以用足量的cache，足量的离线计算存储，来提升时效性；同样，如果你的机器不足，资源不足，那么就可以通过可接受的时间消耗来节省存储空间。</p>
</blockquote>
<p>架构基本组件：</p>
<ul>
<li>至少两台机器。【保证物理容灾】</li>
<li>三个mysql实例。【一主两从，一主不解释；一从主要用于实时备份，暂叫容灾从；一从用于离线计算，cache更新，非时效性的数据抓取，暂叫api从；】</li>
<li>ameoba 负责负载均衡和读写分离【暂时用着还可以】。</li>
<li>redis 负责缓存，预取，存储cache。【可以换成其他】</li>
<li>一个抗高并发的中间件。【暂时只加了antispam组件，高并发并未处理，可能系统负载比较平均，qpd几千万 ，但是并未出现qps峰值】</li>
</ul>
<p>that’s all，这些组件对于一个操作尚可的程序员来说，部署一整套肯定不会特别麻烦，相对于其他大型的架构来说，略显简单；但是，麻雀虽小，五脏俱全，下面从架构必备的几个角度分析一下。</p>
<h2 id="安全性（Failover）"><a href="#安全性（Failover）" class="headerlink" title="安全性（Failover）"></a>安全性（Failover）</h2><p>任何一个架构首要考虑的是数据安全和容灾。小拽的架构中做了哪些</p>
<h3 id="数据库全量备份"><a href="#数据库全量备份" class="headerlink" title="数据库全量备份"></a>数据库全量备份</h3><p>这个就是一个简单脚本，对api从库在闲暇时间【晚上3-4点】进行全量导出备份，同时scp到另一台机器一份。（之所以对api库，是因为api库主要负责非失效性的查询和计算）</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># crontab 每天3点进行数据库备份 (cuihuan)</span></span><br><span class="line"><span class="comment"># 0 3 * * * sh /home/disk6/mysql/bin/backup.sh</span></span><br><span class="line"><span class="comment"># 每天备份，保存最近30天的</span></span><br><span class="line">DATE=$(date +%Y%m%d)</span><br><span class="line"><span class="regexp">/home/</span>xxx<span class="regexp">/bin/my</span>sqldump -uroot -pxxx db &gt; <span class="regexp">/home/</span>xxx<span class="regexp">/bak_sql/</span>db_<span class="variable">$DATE</span>.sql;</span><br><span class="line">find <span class="regexp">/home/</span>xxx<span class="regexp">/bak_sql/</span> -mtime +<span class="number">30</span> -name <span class="string">'*.sql'</span> -exec rm -rf &#123;&#125; \;</span><br></pre></td></tr></table></figure>
<h3 id="数据库增量备份"><a href="#数据库增量备份" class="headerlink" title="数据库增量备份"></a>数据库增量备份</h3><p>增量备份主要从两个角度</p>
<ul>
<li>binlog中定期备份sql；</li>
<li>是采用主从库之后，从库会定时的备份主库信息，同时，对api库采用数据完全一致，对容灾库则设置只同步update 和insert；这样完备的保证了数据的安全。</li>
</ul>
<h2 id="可用性（Availabilty）"><a href="#可用性（Availabilty）" class="headerlink" title="可用性（Availabilty）"></a>可用性（Availabilty）</h2><p>数据的安全排第一，毋庸置疑；次之排平台的可用性，也毫无争议。可用性最简单的一个指标则为：<code>不卡</code>。</p>
<h3 id="cache"><a href="#cache" class="headerlink" title="cache"></a>cache</h3><p>cache是提升查询时效性最有效的一个手段，小拽在框架中主要应用了两种cache，满足不同的业务需求。（所有关于cache的使用，一定要注意时效性和一致性，时效性和一致性，时效性和一致性）</p>
<ul>
<li>普通的cache。即用户搜索或者查询之后的结果存在redis里面，下次查询使用。</li>
<li>预取的cache。即预测用户要查询的内容，放到cache里面。举几个栗子，用户首页内容一定要存cache里面；用户在看page1的时候，可以后台预测用户会看page2，提前取过来等等，这些策略和自己的实际业务紧密结合。</li>
</ul>
<p>关于时效性和一致性再多说一句：一定要注意及时更新，例如用户写操作，点击操作，都需要在后台触发cache的主动更新，否则可能造成数据一致性错误。</p>
<h3 id="分库分表"><a href="#分库分表" class="headerlink" title="分库分表"></a>分库分表</h3><p><strong>中小型的架构中，存储的瓶颈往往在于读。</strong></p>
<p>随着数据的增加，读库的成本越来越大，一个sql很可能会造成锁死整个库，一条sql 10+s也是常有的事情；因此，解决读库的瓶颈，可以大大提升系统的可用性；小拽的实践中主要应用了分库，分表。</p>
<h3 id="分库"><a href="#分库" class="headerlink" title="分库"></a>分库</h3><p>之所以要分库，是因为<code>二八原则的存在，80%的用户操作集中于20%的数据</code>。</p>
<p>举个栗子：实践过程中小拽有个月库，只存本月的数据，基本上80%+的用户操作数据，都会命中这个库。</p>
<p>分库的原则有很多，例如时间原则，业务原则，数据逻辑原则等等；总之在您的框架中，当db扛不住的时候就分库，分层级。</p>
<h3 id="分表"><a href="#分表" class="headerlink" title="分表"></a>分表</h3><p>分表的思想和分库类似，只是粒度更小，不在赘述。</p>
<h2 id="扩展性（Scabability）"><a href="#扩展性（Scabability）" class="headerlink" title="扩展性（Scabability）"></a>扩展性（Scabability）</h2><p>小拽的架构中，扩展性主要从三个方面考虑</p>
<ul>
<li>1：数据库的扩展性。如果资源允许N主N从都是可以的，基本上不会影响业务操作。</li>
<li>2：缓存的扩展。缓存基本上也是单独部署的，redis，memcache等均可以，变更成本不大。</li>
<li>3：高并发和负载均衡。这块属于大型网站需要考虑的，暂时只采用了ameaba进行负载均衡的扩展，高并发预留接口。</li>
</ul>
<h2 id="权衡（Balance）"><a href="#权衡（Balance）" class="headerlink" title="权衡（Balance）"></a>权衡（Balance）</h2><p>所有的架构和技术，最终都要落实到和业务需求权衡。</p>
<p>上面的架构最大的优势其实就是：简单，搭建起来非常容易，这就够了。</p>
<p>作为一名码农，只有在实践的过程中，不断发现系统的瓶颈，权衡现有资源和需求，解决和处理问题，才能成为一名靠谱的码农。</p>
<p>以上只是小拽在实践过程中的一点小小心的，欢迎大家到小站交流（<a href="http://cuihuan.net）。" target="_blank" rel="external">http://cuihuan.net）。</a></p>
<p>【转载请注明：<a href="http://cuihuan.net/?p=460">中型存储架构实践探索</a> | <a href="http://cuihuan.net">靠谱崔小拽</a> 】</p>
]]></content>
      
        
        <tags>
            
            <tag> mysql </tag>
            
            <tag> redis </tag>
            
            <tag> 读写分离 </tag>
            
            <tag> 主从备份 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[mysql数据导库常用操作]]></title>
      <url>/2016/03/08/mysql%E6%95%B0%E6%8D%AE%E5%AF%BC%E5%BA%93%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C/</url>
      <content type="html"><![CDATA[<blockquote>
<p>工作中经常遇到：一个数据库导入新的数据库实例中，或者一个数据库中的某些表导入新的数据库中，常用操作，总结一下。</p>
</blockquote>
<h2 id="部分数据表导入新库"><a href="#部分数据表导入新库" class="headerlink" title="部分数据表导入新库"></a>部分数据表导入新库</h2><ul>
<li><p>单表导入新库的sql为</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">CREATE</span> TABLE 新表 <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> 旧表</span><br><span class="line"><span class="keyword">create</span> table <span class="symbol">`dashboard`</span>.<span class="symbol">`xx`</span> (<span class="keyword">select</span> * <span class="keyword">from</span> dashboard_stb.xxx);</span><br></pre></td></tr></table></figure>
</li>
<li><p>多表导入新库（将所有的stability_* 导入新库）<br>多表的时候，只需选出需要的表即可。</p>
</li>
</ul>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 拼接处所有的导出sql</span><br><span class="line">mysql&gt; <span class="keyword">select</span> concat (<span class="string">'create table `dashboard`.'</span>,table_name,<span class="string">'(select * from `dashboard_stb`.'</span>,table_name,<span class="string">');'</span>) <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_name <span class="keyword">like</span> <span class="string">"stability_%"</span>;</span><br><span class="line">+--------------------------------------------------------------------------------------------------------+</span><br><span class="line">| concat ('<span class="keyword">create</span> table <span class="symbol">`dashboard`</span>.<span class="string">',table_name,'</span>(<span class="keyword">select</span> * <span class="keyword">from</span> <span class="symbol">`dashboard_stb`</span>.<span class="string">',table_name,'</span>);')      |</span><br><span class="line">+--------------------------------------------------------------------------------------------------------+</span><br><span class="line">| <span class="keyword">create</span> table <span class="symbol">`dashboard`</span>.stability_capacity(<span class="keyword">select</span> * <span class="keyword">from</span> <span class="symbol">`dashboard_stb`</span>.stability_capacity);         |</span><br><span class="line">| <span class="keyword">create</span> table <span class="symbol">`dashboard`</span>.stability_dailymaxflow(<span class="keyword">select</span> * <span class="keyword">from</span> <span class="symbol">`dashboard_stb`</span>.stability_dailymaxflow); |</span><br><span class="line">| <span class="keyword">create</span> table <span class="symbol">`dashboard`</span>.stability_indextype(<span class="keyword">select</span> * <span class="keyword">from</span> <span class="symbol">`dashboard_stb`</span>.stability_indextype);       |</span><br><span class="line">| <span class="keyword">create</span> table <span class="symbol">`dashboard`</span>.stability_ktraceagent(<span class="keyword">select</span> * <span class="keyword">from</span> <span class="symbol">`dashboard_stb`</span>.stability_ktraceagent);   </span><br><span class="line"># 此处省略N行</span><br><span class="line">+--------------------------------------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure>
<p>粘贴进去直接运行即可<br><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;  <span class="keyword">create</span> table <span class="symbol">`dashboard`</span>.stability_maccpu(<span class="keyword">select</span> * <span class="keyword">from</span> <span class="symbol">`dashboard_stb`</span>.stability_maccpu);</span><br><span class="line">Query OK, 138138 rows affected (2.16 sec)</span><br><span class="line">Records: 138138  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt;  <span class="keyword">create</span> table <span class="symbol">`dashboard`</span>.stability_macmem(<span class="keyword">select</span> * <span class="keyword">from</span> <span class="symbol">`dashboard_stb`</span>.stability_macmem);</span><br><span class="line">Query OK, 138137 rows affected (2.07 sec)</span><br><span class="line">Records: 138137  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt;  <span class="keyword">create</span> table <span class="symbol">`dashboard`</span>.stability_macssd(<span class="keyword">select</span> * <span class="keyword">from</span> <span class="symbol">`dashboard_stb`</span>.stability_macssd);</span><br><span class="line">Query OK, 138139 rows affected (2.17 sec)</span><br><span class="line">Records: 138139  Duplicates: 0  Warnings: 0</span><br><span class="line"># 此处省略N行</span><br></pre></td></tr></table></figure></p>
<h2 id="全库备份导入新库"><a href="#全库备份导入新库" class="headerlink" title="全库备份导入新库"></a>全库备份导入新库</h2><p>数据库全量导出为sql<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">mysqldump</span> <span class="selector-tag">-uxxx</span> <span class="selector-tag">-pxxx</span> <span class="selector-tag">dashboard</span> &gt; <span class="selector-tag">dashboard</span><span class="selector-class">.sql</span></span><br></pre></td></tr></table></figure></p>
<p>通过sql建立新库<br><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 建新库</span></span><br><span class="line">mysql&gt; create databases dashboard_new<span class="type"></span></span><br><span class="line"><span class="type"></span># 导入数据</span><br><span class="line">./mysql -uxxx -p --<span class="keyword">default</span>-character-<span class="keyword">set</span>=utf8 dashboard_new <span class="type"></span>&lt; dashboard.sql</span><br></pre></td></tr></table></figure></p>
<p>【转载请注明：<a href="http://cuihuan.net/article/mysql%E6%95%B0%E6%8D%AE%E5%AF%BC%E5%BA%93%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C.html">mysql 简单全量备份和快速恢复</a> | <a href="http://cuihuan.net">靠谱崔小拽</a> 】</p>
]]></content>
      
        
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[postMessage处理iframe 跨域问题]]></title>
      <url>/2016/02/29/postMessage%E5%A4%84%E7%90%86iframe%20%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98/</url>
      <content type="html"><![CDATA[<blockquote>
<p>背景：由于同源策略存在，javascript的跨域一直都是一个棘手的问题。<code>父页面无法直接获取iframe内部的跨域资源；同时，iframe内部的跨域资源也无法将信息直接传递给父页面</code>。</p>
</blockquote>
<h2 id="一：传统的解决方式。"><a href="#一：传统的解决方式。" class="headerlink" title="一：传统的解决方式。"></a>一：传统的解决方式。</h2><p>传统的iframe资源解决方式：主要通过通过中间页面代理，此处不再赘述，参考<a href="http://www.cnblogs.com/snandy/p/3900016.html" target="_blank" rel="external">中间页获取跨域iframe</a></p>
<h2 id="二：html5-postMessage的产生"><a href="#二：html5-postMessage的产生" class="headerlink" title="二：html5 postMessage的产生"></a>二：html5 postMessage的产生</h2><p>随着HTML5的发展，html5工作组提供了两个重要的接口：<code>postMessage(send) 和 onmessage</code>。这两个接口有点类似于websocket，可以实现两个跨域站点页面之间的数据传递。</p>
<p><a href="https://www.w3.org/TR/websockets/?cm_mc_uid=62901929538214344332551&amp;cm_mc_sid_50200000=1456119382" target="_blank" rel="external">postMessage API</a></p>
<p>下面是实践过程中两个小栗子：分别父页面传递信息给iframe，iframe传递信息给父页面。</p>
<h2 id="三：iframe获取父页面信息"><a href="#三：iframe获取父页面信息" class="headerlink" title="三：iframe获取父页面信息"></a>三：iframe获取父页面信息</h2><p>话不多说，直接上码：<br>参考demo：<a href="http://cuihuan.net:1015/demo_file/postmesage/demo.html">父页面传给子页面demo</a></p>
<h3 id="父页面代码"><a href="#父页面代码" class="headerlink" title="父页面代码"></a>父页面代码</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Type"</span> <span class="attr">content</span>=<span class="string">"text/html; charset=UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>崔涣 iframe postmessage 父页面<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/JavaScript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">sendIt</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">            <span class="comment">// 通过 postMessage 向子窗口发送数据</span></span></span><br><span class="line"><span class="javascript">            <span class="built_in">document</span>.getElementById(<span class="string">"otherPage"</span>).contentWindow</span></span><br><span class="line"><span class="undefined">                    .postMessage(</span></span><br><span class="line"><span class="javascript">                    <span class="built_in">document</span>.getElementById(<span class="string">"message"</span>).value,</span></span><br><span class="line"><span class="actionscript">                    <span class="string">"http://cuihuan.net:8003"</span></span></span><br><span class="line"><span class="undefined">            );</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 通过 iframe 嵌入子页面 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">"http://cuihuan.net:8003/test.html"</span> <span class="attr">id</span>=<span class="string">"otherPage"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">id</span>=<span class="string">"message"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">value</span>=<span class="string">"Send to child.com"</span> <span class="attr">onclick</span>=<span class="string">"sendIt()"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="子页面代码"><a href="#子页面代码" class="headerlink" title="子页面代码"></a>子页面代码</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span> </span><br><span class="line"> <span class="tag">&lt;<span class="name">head</span>&gt;</span> </span><br><span class="line"> <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Type"</span> <span class="attr">content</span>=<span class="string">"text/html; charset=UTF-8"</span>&gt;</span> </span><br><span class="line"> <span class="tag">&lt;<span class="name">title</span>&gt;</span>崔涣测试子页面信息<span class="tag">&lt;/<span class="name">title</span>&gt;</span> </span><br><span class="line"> <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/JavaScript"</span>&gt;</span><span class="undefined"> </span></span><br><span class="line"><span class="actionscript">	 <span class="comment">//event 参数中有 data 属性，就是父窗口发送过来的数据</span></span></span><br><span class="line"><span class="javascript">	 <span class="built_in">window</span>.addEventListener(<span class="string">"message"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"> event </span>) </span>&#123; </span></span><br><span class="line"><span class="actionscript">		 <span class="comment">// 把父窗口发送过来的数据显示在子窗口中</span></span></span><br><span class="line"><span class="javascript">	   <span class="built_in">document</span>.getElementById(<span class="string">"content"</span>).innerHTML+=event.data+<span class="string">"&lt;br/&gt;"</span>; </span></span><br><span class="line"><span class="actionscript">	 &#125;, <span class="literal">false</span> ); </span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined"> </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span> </span><br><span class="line"> <span class="tag">&lt;/<span class="name">head</span>&gt;</span> </span><br><span class="line"> <span class="tag">&lt;<span class="name">body</span>&gt;</span> </span><br><span class="line">	 this is the 8003 port for cuixiaozhuai </span><br><span class="line">	 <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"content"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span> </span><br><span class="line"> <span class="tag">&lt;/<span class="name">body</span>&gt;</span> </span><br><span class="line"> <span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>demo 效果如下图：两个跨域页面之间，父页面给子页面传递数据。<br><a href="http://cuihuan.net/wp-content/uploads/2016/02/16743333-E2AF-40E5-8DD2-0CBCE8919C66.png"><img src="http://cuihuan.net/wp-content/uploads/2016/02/16743333-E2AF-40E5-8DD2-0CBCE8919C66.png" alt="16743333-E2AF-40E5-8DD2-0CBCE8919C66"></a> </p>
<h2 id="四：iframe传递信息给父页面"><a href="#四：iframe传递信息给父页面" class="headerlink" title="四：iframe传递信息给父页面"></a>四：iframe传递信息给父页面</h2><p>参考demo：<a href="http://cuihuan.net:1015/demo_file/postmesage/son2Parent.html">跨域子页面传给父页面demo</a></p>
<h3 id="父页面代码-1"><a href="#父页面代码-1" class="headerlink" title="父页面代码"></a>父页面代码</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Type"</span> <span class="attr">content</span>=<span class="string">"text/html; charset=UTF-8"</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">title</span>&gt;</span>崔涣测试父页面<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/JavaScript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript">     <span class="comment">//event 参数中有 data 属性，就是父窗口发送过来的数据</span></span></span><br><span class="line"><span class="javascript">     <span class="built_in">window</span>.addEventListener(<span class="string">"message"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"> event </span>) </span>&#123;</span></span><br><span class="line"><span class="actionscript">         <span class="comment">// 把父窗口发送过来的数据显示在子窗口中</span></span></span><br><span class="line"><span class="javascript">       <span class="built_in">document</span>.getElementById(<span class="string">"content"</span>).innerHTML+=event.data+<span class="string">"&lt;br/&gt;"</span>;</span></span><br><span class="line"><span class="actionscript">     &#125;, <span class="literal">false</span> );</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined"> </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">"http://cuihuan.net:8003/iframeSon.html"</span> <span class="attr">id</span>=<span class="string">"otherPage"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">     this is the 1015 port for cuixiaozhuai。</span><br><span class="line">     <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"content"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="子页面代码-1"><a href="#子页面代码-1" class="headerlink" title="子页面代码"></a>子页面代码</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Type"</span> <span class="attr">content</span>=<span class="string">"text/html; charset=UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>崔小涣iframe postmessage 测试页面<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/JavaScript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">sendIt</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">            <span class="comment">// 子页面给父页面传输信息 </span></span></span><br><span class="line"><span class="undefined">            parent.postMessage(</span></span><br><span class="line"><span class="javascript">                <span class="built_in">document</span>.getElementById(<span class="string">"message"</span>).value,</span></span><br><span class="line"><span class="actionscript">                <span class="string">"http://cuihuan.net:1015"</span></span></span><br><span class="line"><span class="undefined">            );</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">this is the  port for cuixiaozhuai</span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">id</span>=<span class="string">"message"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">value</span>=<span class="string">"Send to child.com"</span> <span class="attr">onclick</span>=<span class="string">"sendIt()"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>demo 效果如下图：两个跨域页面之间，子页面传递数据给父页面传递数据。<br><a href="http://cuihuan.net/wp-content/uploads/2016/02/22433B4C-8836-4546-93DB-7A896F8B4B37.png"><img src="http://cuihuan.net/wp-content/uploads/2016/02/22433B4C-8836-4546-93DB-7A896F8B4B37.png" alt="22433B4C-8836-4546-93DB-7A896F8B4B37"></a> </p>
<h2 id="五：postmessage简单分析和安全问题"><a href="#五：postmessage简单分析和安全问题" class="headerlink" title="五：postmessage简单分析和安全问题"></a>五：postmessage简单分析和安全问题</h2><p>postmessage 传送过来的信息如下图，<br><a href="http://cuihuan.net/wp-content/uploads/2016/02/BABB5101-CD9D-448C-99EE-910334405D3D.png"><img src="http://cuihuan.net/wp-content/uploads/2016/02/BABB5101-CD9D-448C-99EE-910334405D3D.png" alt="BABB5101-CD9D-448C-99EE-910334405D3D"></a></p>
<p>几乎包含了所有应该有的信息。甚至data中可以包含object，出于安全考虑可以域的校验，数据规则的校验安全校验，如下代码<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">window</span>.addEventListener(<span class="string">'message'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">       </span><br><span class="line">       <span class="comment">//校验函数是否合法</span></span><br><span class="line">       <span class="keyword">var</span> checkMessage = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">           <span class="comment">// 只获取需要的域，并非所有都可以跨域</span></span><br><span class="line">           <span class="keyword">if</span> (event.origin != <span class="string">"need domain"</span>) &#123;</span><br><span class="line">               <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           </span><br><span class="line">           <span class="keyword">var</span> message = event.data;</span><br><span class="line">           <span class="comment">// 传输数据类型校验</span></span><br><span class="line">           <span class="keyword">if</span> (<span class="keyword">typeof</span>(message) !== <span class="string">'object'</span>) &#123;</span><br><span class="line">               <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// message 的rule中包含xxx则为xxx需要字段。</span></span><br><span class="line">           <span class="keyword">return</span> message.rule === <span class="string">"xxx"</span>;</span><br><span class="line">       &#125;;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (checkMessage()) &#123;</span><br><span class="line">           <span class="comment">// 通过校验进行相关操作</span></span><br><span class="line">           addDetailFunc(event);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;);</span><br></pre></td></tr></table></figure></p>
<p>【转载请注明：<a href="http://cuihuan.net/article/postmessage%E5%A4%84%E7%90%86iframe-%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98.html">postMessage处理iframe 跨域问题</a> | <a href="http://cuihuan.net">靠谱崔小拽</a> 】</p>
]]></content>
      
        
        <tags>
            
            <tag> javascript </tag>
            
            <tag> iframe跨域 </tag>
            
            <tag> iframe自适应高度 </tag>
            
            <tag> iframe </tag>
            
            <tag> html5 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[YII2数据库查询实践]]></title>
      <url>/2016/01/10/YII2%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9F%A5%E8%AF%A2%E5%AE%9E%E8%B7%B5/</url>
      <content type="html"><![CDATA[<blockquote>
<p>初探yii2框架，对增删改查，关联查询等数据库基本操作的简单实践。</p>
</blockquote>
<h2 id="数据库配置。"><a href="#数据库配置。" class="headerlink" title="数据库配置。"></a>数据库配置。</h2><p>/config/db.php 进行数据库配置<br>配置可以参考<a href="http://www.yiichina.com/doc/guide/2.0/start-databases" target="_blank" rel="external"> yii文档 </a><br>实践过程中有个test库-》test表-》两条记录如下<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from test;</span><br><span class="line"><span class="code">+----+</span>--------+</span><br><span class="line">| id | name   |</span><br><span class="line"><span class="code">+----+</span>--------+</span><br><span class="line">|  1 | zhuai  |</span><br><span class="line">|  2 | heng   | </span><br><span class="line"><span class="code">+----+</span>--------+</span><br><span class="line">18 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<h2 id="sql-查询方式"><a href="#sql-查询方式" class="headerlink" title="sql 查询方式"></a>sql 查询方式</h2><p>yii2 提供了原始的数据库查询方式findBySql；同时，<code>通过占位符的方式，自动进行了基本的sql注入防御</code>。上码<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 最基本的查询方式</span></span><br><span class="line">$sql = <span class="string">"select * from test where 1"</span>;</span><br><span class="line">$res = Test::findBySql($sql)-&gt;all();</span><br><span class="line">var_dump(count($res));    <span class="comment">// res-&gt;2 </span></span><br><span class="line"></span><br><span class="line"><span class="comment">// findbysql 防止sql注入方式</span></span><br><span class="line">$id = <span class="string">'1 or 1=1'</span>;</span><br><span class="line">$sql = <span class="string">"select * from test where id = "</span> . $id;</span><br><span class="line">$res = Test::findBySql($sql)-&gt;all();</span><br><span class="line">var_dump(count($res));   <span class="comment">// res-&gt; 2</span></span><br><span class="line"></span><br><span class="line">$sql = <span class="string">"select * from test where id = :id"</span>;</span><br><span class="line"><span class="comment">// 定位符会自动防止sql 注入</span></span><br><span class="line">$res = Test::findBySql($sql,<span class="keyword">array</span>(<span class="string">":id"</span>=&gt;$id))-&gt;all();</span><br><span class="line">var_dump(count($res));  <span class="comment">// res-&gt;1</span></span><br></pre></td></tr></table></figure></p>
<h2 id="activeRecord查询方式"><a href="#activeRecord查询方式" class="headerlink" title="activeRecord查询方式"></a>activeRecord查询方式</h2><p>每个框架除了原有的sql方式，都会提供相应的封装的查询方式，yii2亦然。</p>
<h3 id="创建model"><a href="#创建model" class="headerlink" title="创建model"></a>创建model</h3><p>yii的model基本方式如下，代码如下不赘述。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">models</span>;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">use</span> <span class="title">Yii</span>;</span></span><br><span class="line"><span class="php"><span class="keyword">use</span> <span class="title">yii</span>\<span class="title">db</span>\<span class="title">ActiveRecord</span>;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">Test</span> <span class="keyword">extends</span> <span class="title">ActiveRecord</span></span></span></span><br><span class="line"><span class="php">&#123;</span></span><br><span class="line"><span class="php">    <span class="comment">// 可无，对应表：默认类名和表名匹配，则无需此函数</span></span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">tableName</span><span class="params">()</span></span></span></span><br><span class="line"><span class="php">    &#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">return</span> <span class="string">'test'</span>;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="comment">// 可无，验证器：主要用于校验各个字段</span></span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">rules</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">return</span> [</span></span><br><span class="line"><span class="php">            [<span class="string">'id'</span>, <span class="string">'integer'</span>],</span></span><br><span class="line"><span class="php">            [<span class="string">'name'</span>, <span class="string">'string'</span>, <span class="string">'length'</span> =&gt; [<span class="number">0</span>, <span class="number">100</span>]],</span></span><br><span class="line"><span class="php">        ];</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>使用的时候需要引入model<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> app\models\<span class="keyword">Test</span>;</span><br></pre></td></tr></table></figure></p>
<h3 id="增加操作"><a href="#增加操作" class="headerlink" title="增加操作"></a>增加操作</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// add 操作</span></span><br><span class="line">$test = <span class="keyword">new</span> Test();</span><br><span class="line">$test-&gt;name = <span class="string">'test'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 合法性校验</span></span><br><span class="line">$test-&gt;validate();</span><br><span class="line"><span class="keyword">if</span>($test-&gt;hasErrors())&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"数据不合法"</span>;</span><br><span class="line">    <span class="keyword">die</span>;</span><br><span class="line">&#125;</span><br><span class="line">$test-&gt;save();</span><br></pre></td></tr></table></figure>
<h3 id="查询操作"><a href="#查询操作" class="headerlink" title="查询操作"></a>查询操作</h3><p>查询操作先上官方文档<br><a href="http://www.yiichina.com/doc/api/2.0/yii-db-activerecord" target="_blank" rel="external"> activeRecord doc</a><br><a href="http://www.yiichina.com/doc/api/2.0/yii-db-query#where(-detail" target="_blank" rel="external"> where doc</a><br>需要强调的是：yii查询提供了特别多丰富的库，例如代码中的批量查询处理等等，细节可以看文档。</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">// select</span></span><br><span class="line"><span class="regexp">//</span> id = <span class="number">1</span></span><br><span class="line">$res = Test::find<span class="function"><span class="params">()</span>-&gt;</span>where<span class="function"><span class="params">([<span class="string">'id'</span> =&gt; <span class="number">1</span>])</span>-&gt;</span>all();</span><br><span class="line">var_dump(count($res));  <span class="regexp">//1</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">//</span> id &gt; <span class="number">0</span></span><br><span class="line">$res = Test::find<span class="function"><span class="params">()</span>-&gt;</span>where<span class="function"><span class="params">([<span class="string">'&gt;'</span>,<span class="string">'id'</span>,<span class="number">0</span>])</span>-&gt;</span>all();</span><br><span class="line">var_dump(count($res));  <span class="regexp">//2</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">//</span> id &gt; =<span class="number">1</span> id &lt;=<span class="number">2</span></span><br><span class="line">$res = Test::find<span class="function"><span class="params">()</span>-&gt;</span>where<span class="function"><span class="params">([<span class="string">'between'</span>,<span class="string">'id'</span>,<span class="number">1</span>,<span class="number">2</span>])</span>-&gt;</span>all();</span><br><span class="line">var_dump(count($res));  <span class="regexp">//2</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">//</span> name字段like</span><br><span class="line">$res = Test::find<span class="function"><span class="params">()</span>-&gt;</span>where<span class="function"><span class="params">([<span class="string">'like'</span>, <span class="string">'name'</span>, <span class="string">'cuihuan'</span>])</span>-&gt;</span>all();</span><br><span class="line">var_dump(count($res));  <span class="regexp">//2</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">//</span> 查询的使用 obj-&gt;array</span><br><span class="line">$res = Test::find<span class="function"><span class="params">()</span>-&gt;</span>where<span class="function"><span class="params">([<span class="string">'between'</span>,<span class="string">'id'</span>,<span class="number">1</span>,<span class="number">2</span>])</span>-&gt;</span>asArray<span class="function"><span class="params">()</span>-&gt;</span>all();</span><br><span class="line">var_dump($res[<span class="number">0</span>][<span class="string">'id'</span>]);  <span class="regexp">//2</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">//</span> 批量查询,对于大内存操作的批量查询</span><br><span class="line">foreach <span class="function"><span class="params">(Test::find()-&gt;batch(<span class="number">1</span>) as $test)</span> &#123;</span></span><br><span class="line"><span class="function">    <span class="title">var_dump</span><span class="params">(count($test))</span>;</span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="删除操作"><a href="#删除操作" class="headerlink" title="删除操作"></a>删除操作</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// delete </span></span><br><span class="line"><span class="comment">// 选出来删除</span></span><br><span class="line">$res = Test::find()-&gt;where([<span class="string">'id'</span>=&gt;<span class="number">1</span>])-&gt;all();</span><br><span class="line">$res[<span class="number">0</span>]-&gt;delete();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 直接删除</span></span><br><span class="line">var_dump(Test::deleteAll(<span class="string">'id&gt;:id'</span>, <span class="keyword">array</span>(<span class="string">':id'</span> =&gt; <span class="number">2</span>)));</span><br></pre></td></tr></table></figure>
<h3 id="修改操作"><a href="#修改操作" class="headerlink" title="修改操作"></a>修改操作</h3><p>除了代码中方式，yii2直接提供update操作。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 活动记录修改</span></span><br><span class="line">$res = Test::find()-&gt;where([<span class="string">'id'</span>=&gt;<span class="number">4</span>])-&gt;one();</span><br><span class="line">$res-&gt;name = <span class="string">"update"</span>;</span><br><span class="line">$res-&gt;save();</span><br></pre></td></tr></table></figure></p>
<h3 id="关联查询操作"><a href="#关联查询操作" class="headerlink" title="关联查询操作"></a>关联查询操作</h3><p>关联查询示例中两个表:<br>一个学生表(student):id ，name;<br>一个分数表(score)：id,stu_id,score<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 相应学生的所有score</span></span><br><span class="line">$stu = Student::find()-&gt;where([<span class="string">'name'</span>=&gt;<span class="string">'xiaozhuai'</span>])-&gt;one();</span><br><span class="line">var_dump($stu-&gt;id);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 基本获取</span></span><br><span class="line">$scores_1 = $stu-&gt;hasMany(<span class="string">'app\model\Score'</span>,[<span class="string">'stu_id'</span>=&gt;$stu-&gt;id])-&gt;asArray()-&gt;all();</span><br><span class="line">$scores_2 = $stu-&gt;hasMany(Score::className(),[<span class="string">'stu_id'</span>=&gt;<span class="string">'id'</span>])-&gt;asArray()-&gt;all();</span><br><span class="line">var_dump($scores_1);</span><br><span class="line">var_dump($scores_2);</span><br></pre></td></tr></table></figure></p>
<p>两种关联查询方式；但是，在controller进行相关操作，代码显的过于混乱，在model中封装调用</p>
<p>首先在student model中封装相关关联调用函数<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">models</span>;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">use</span> <span class="title">Yii</span>;</span></span><br><span class="line"><span class="php"><span class="keyword">use</span> <span class="title">yii</span>\<span class="title">db</span>\<span class="title">ActiveRecord</span>;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">Student</span> <span class="keyword">extends</span> <span class="title">ActiveRecord</span></span></span></span><br><span class="line"><span class="php">&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">tableName</span><span class="params">()</span></span></span></span><br><span class="line"><span class="php">    &#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">return</span> <span class="string">'student'</span>;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="comment">// 获取分数信息</span></span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getScores</span><span class="params">()</span></span></span></span><br><span class="line"><span class="php">    &#123;</span></span><br><span class="line"><span class="php">        $scores = <span class="keyword">$this</span>-&gt;hasMany(Score::className(), [<span class="string">'stu_id'</span> =&gt; <span class="string">'id'</span>])-&gt;asArray()-&gt;all();</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">        <span class="keyword">return</span> $scores;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>之后直接调用，两种调用方式<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 函数封装之后调用</span></span><br><span class="line">$scores = $stu-&gt;getScores();</span><br><span class="line">var_dump($scores);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 利用__get 的自动调用的方式</span></span><br><span class="line">$scores = $stu-&gt;scores;</span><br><span class="line">var_dump($scores);</span><br></pre></td></tr></table></figure></p>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>上面在yii2的部署和使用过程中的一些基本的增删改查，关联查询等操作。但是如果想要将yii2的db操作使用好，还要看文档大法：<br><a href="http://www.yiichina.com/doc/api/2.0/yii-db-activerecord" target="_blank" rel="external"> activeRecord doc</a></p>
<p>【转载请注明：<a href="http://cuihuan.net/article/yii2%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9F%A5%E8%AF%A2%E5%AE%9E%E8%B7%B5.html">YII2数据库查询实践</a> | <a href="http://cuihuan.net">靠谱崔小拽</a> 】</p>
]]></content>
      
        
        <tags>
            
            <tag> db </tag>
            
            <tag> active record </tag>
            
            <tag> yii2 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[机器多次恶意提交攻击简单防范]]></title>
      <url>/2016/01/07/%E6%9C%BA%E5%99%A8%E5%A4%9A%E6%AC%A1%E6%81%B6%E6%84%8F%E6%8F%90%E4%BA%A4%E6%94%BB%E5%87%BB/</url>
      <content type="html"><![CDATA[<blockquote>
<p>先说背景：机器不断的发送请求或者恶意提交，会给服务器造成很大压力；针对这种攻击<code>最优的策略是判断提交次数，产生动态验证码</code>，即<code>判断ip规定时间内重复发送达到N次弹出验证码</code>。下面是小拽在实践过程中一个简单的识别ip，利用session记录和防御的过程。</p>
</blockquote>
<h2 id="识别和校验ip"><a href="#识别和校验ip" class="headerlink" title="识别和校验ip"></a>识别和校验ip</h2><p>过程如下；</p>
<ul>
<li>识别ip</li>
<li>ip属于白名单直接通过[白名单策略：内网ip+指定ip表]</li>
<li>利用session存储ip的请求时间戳</li>
<li>校验规定时间内ip的请求次数</li>
<li>采取相应的措施</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取和校验ip；同时防止短时间内多次提交</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@notice</span>        ：弹出验证码，需要替换掉echo $echo_str 即可。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> string ：返回校验成功的ip</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getAndCheckIP</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取环境ip</span></span><br><span class="line">    <span class="keyword">if</span> (getenv(<span class="string">"HTTP_CLIENT_IP"</span>) &amp;&amp; strcasecmp(getenv(<span class="string">"HTTP_CLIENT_IP"</span>), <span class="string">"unknown"</span>))</span><br><span class="line">        $ip = getenv(<span class="string">"HTTP_CLIENT_IP"</span>);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (getenv(<span class="string">"HTTP_X_FORWARDED_FOR"</span>) &amp;&amp; strcasecmp(getenv(<span class="string">"HTTP_X_FORWARDED_FOR"</span>), <span class="string">"unknown"</span>))</span><br><span class="line">        $ip = getenv(<span class="string">"HTTP_X_FORWARDED_FOR"</span>);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (getenv(<span class="string">"REMOTE_ADDR"</span>) &amp;&amp; strcasecmp(getenv(<span class="string">"REMOTE_ADDR"</span>), <span class="string">"unknown"</span>))</span><br><span class="line">        $ip = getenv(<span class="string">"REMOTE_ADDR"</span>);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">isset</span>($_SERVER[<span class="string">'REMOTE_ADDR'</span>]) &amp;&amp; $_SERVER[<span class="string">'REMOTE_ADDR'</span>] &amp;&amp; strcasecmp($_SERVER[<span class="string">'REMOTE_ADDR'</span>], <span class="string">"unknown"</span>))</span><br><span class="line">        $ip = $_SERVER[<span class="string">'REMOTE_ADDR'</span>];</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        $ip = <span class="string">"unknown"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// check 环境ip</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;isWhiteList($ip)) &#123;</span><br><span class="line">        $echo_str = <span class="string">"提交过于频繁,请稍后再试！"</span>;</span><br><span class="line">        <span class="comment">// 构建ip的时间栈数据</span></span><br><span class="line">        <span class="keyword">if</span> (!is_array($_SESSION[$ip])) &#123;</span><br><span class="line">            $_SESSION[$ip] = <span class="keyword">array</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($_SESSION[$ip][<span class="number">0</span>])) &#123;</span><br><span class="line">            $_SESSION[$ip][] = time();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// session 保存时间为6小时。清理session</span></span><br><span class="line">            $post_interval_first = time() - $_SESSION[$ip][<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">if</span> ($post_interval_first &gt; <span class="number">21600</span>) &#123;</span><br><span class="line">                $_SESSION[$ip] = <span class="keyword">array</span>();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 两次提交小于1s，禁止提交</span></span><br><span class="line">            $post_interval_pre = time() - $_SESSION[$ip][count($_SESSION[$ip]) - <span class="number">3</span>];</span><br><span class="line">            <span class="keyword">if</span> ($post_interval_pre &lt; <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">echo</span> $echo_str;</span><br><span class="line">                <span class="keyword">exit</span>;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 您在10s内已经提交了3请求，禁止提交</span></span><br><span class="line">            $post_interval_third = time() - $_SESSION[$ip][count($_SESSION[$ip]) - <span class="number">3</span>];</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">isset</span>($_SESSION[$ip][<span class="number">3</span>]) &amp;&amp; ($post_interval_third &lt; <span class="number">10</span>)) &#123;</span><br><span class="line">                <span class="keyword">echo</span> $echo_str;</span><br><span class="line">                <span class="keyword">exit</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 您在1分钟期间已经提交了5请求，禁止提交</span></span><br><span class="line">            $post_interval_fifth = time() - $_SESSION[$ip][count($_SESSION[$ip]) - <span class="number">3</span>];</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">isset</span>($_SESSION[$ip][<span class="number">5</span>]) &amp;&amp; ($post_interval_fifth &lt; <span class="number">60</span>)) &#123;</span><br><span class="line">                <span class="keyword">echo</span> $echo_str;</span><br><span class="line">                <span class="keyword">exit</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 6小时内提交10次，禁止提交</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">isset</span>($_SESSION[$ip][<span class="number">10</span>])) &#123;</span><br><span class="line">                <span class="keyword">echo</span> $echo_str;</span><br><span class="line">                <span class="keyword">exit</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $_SESSION[$ip][] = time();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ($ip);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="白名单策略"><a href="#白名单策略" class="headerlink" title="白名单策略"></a>白名单策略</h2><p>白名单策略采用：内网ip放行和特定ip放行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 检验是否存在于白名单中</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $ip    ：校验的ip</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> bool  ：校验结果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isWhiteList</span><span class="params">($ip)</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 内网ip默认全部存在于白名单中</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span>(!filter_var($ip, FILTER_VALIDATE_IP, FILTER_FLAG_NO_PRIV_RANGE | FILTER_FLAG_NO_RES_RANGE))&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 是否在写死的whitelist 里面</span></span><br><span class="line">    <span class="keyword">return</span> in_array($ip,<span class="keyword">$this</span>-&gt;_WHTTE_LIST);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="防攻击策略"><a href="#防攻击策略" class="headerlink" title="防攻击策略"></a>防攻击策略</h2><p>小拽采用的比较简单的策略，如上面代码，实际过程中可以结合业务需求。</p>
<ul>
<li>1s内禁止重复提交</li>
<li>5s内提交上限3次</li>
<li>60s内提交上限5次</li>
<li>6小时内提交上限10次</li>
</ul>
<p>【转载请注明：<a href="http://cuihuan.net/article/%E6%9C%BA%E5%99%A8%E5%A4%9A%E6%AC%A1%E6%81%B6%E6%84%8F%E6%8F%90%E4%BA%A4%E6%94%BB%E5%87%BB%E7%AE%80%E5%8D%95%E9%98%B2%E8%8C%83.html">机器多次恶意提交攻击简单防范</a> | <a href="http://cuihuan.net">靠谱崔小拽</a> 】</p>
]]></content>
      
        
        <tags>
            
            <tag> php </tag>
            
            <tag> ip </tag>
            
            <tag> 恶意攻击 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[检验mysql主从备份，读写分离]]></title>
      <url>/2016/01/03/%E6%A3%80%E9%AA%8Cmysql%E4%B8%BB%E4%BB%8E%E5%A4%87%E4%BB%BD%EF%BC%8C%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/</url>
      <content type="html"><![CDATA[<blockquote>
<p>先说背景：mysql的主从部署，读写分离，负载均衡之后；需要简单测试和校验一下，在实践中写了个简单的php脚本和校验过程，mark一下，方便再次部署校验。</p>
</blockquote>
<h2 id="数据库部署和实践"><a href="#数据库部署和实践" class="headerlink" title="数据库部署和实践"></a>数据库部署和实践</h2><p>数据库在实践中，<code>往往需要进行多机主从备份保证安全</code>，这个毋庸置疑；<code>进行读写分离和负载均衡可以极大的提升mysql的读写性能</code>。作者在实践中采用阿里的ameoba进行了读写分离和负载均衡操作。细节步骤参考小拽文章:<a href="http://www.baidu.com" target="_blank" rel="external"> mysql主从备份，读写分离和负载均衡实践 </a></p>
<p>那么问题来了，部署完了，校验也需慎重，下面是简单的校验过程。</p>
<h2 id="php简单读写库脚本"><a href="#php简单读写库脚本" class="headerlink" title="php简单读写库脚本"></a>php简单读写库脚本</h2><p>上码：能用代码说的，最好不用文字说话！<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line">/**</span><br><span class="line"> * 进行读写分离的校验</span><br><span class="line"> * @notice ：需要关闭主从备份的情况下进行</span><br><span class="line"> * 原理：打开主从，写主库，从库获取数据，校验主从备份；关闭主从写ameoba,校验读写分离和负载</span><br><span class="line"> *</span><br><span class="line"> * @author: cuixiaohuan</span><br><span class="line"> * Date: 15/12/29</span><br><span class="line"> * Time: 下午9:10</span><br><span class="line"><span class="php"> */</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">ReadAndWriteTest</span> </span>&#123;</span></span><br><span class="line"><span class="php">   </span></span><br><span class="line"><span class="php">    <span class="comment">// ameoba 设定端口,校验读写时，放主库配置</span></span></span><br><span class="line"><span class="php">    <span class="keyword">const</span> IP   =<span class="string">"ip:port"</span>;</span></span><br><span class="line"><span class="php">    <span class="keyword">const</span> PWD  =<span class="string">"pwd"</span>;</span></span><br><span class="line"><span class="php">    <span class="keyword">const</span> USER =<span class="string">"user"</span>;</span></span><br><span class="line"><span class="php">    <span class="keyword">const</span> DB   =<span class="string">"db"</span>;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="php">        error_reporting(E_ALL ^ E_DEPRECATED);</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">        <span class="keyword">$this</span>-&gt;initDb();</span></span><br><span class="line"><span class="php">        <span class="keyword">$this</span>-&gt;_writeTest();</span></span><br><span class="line"><span class="php">        <span class="keyword">$this</span>-&gt;_selectTest();</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"></span></span><br><span class="line">    /**</span><br><span class="line">     * 进行10次读操作</span><br><span class="line"><span class="php">     */</span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">_selectTest</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; <span class="number">10</span>; $i++) &#123;</span></span><br><span class="line"><span class="php">            $read_sql = <span class="string">'select * from test limit 10'</span>;</span></span><br><span class="line"><span class="php">            $g_result = mysql_query($read_sql);</span></span><br><span class="line"><span class="php">            var_dump($g_result);</span></span><br><span class="line"><span class="php">            mysql_free_result($g_result);</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line">    /**</span><br><span class="line">     * 进行10次写操作</span><br><span class="line"><span class="php">     */</span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">_writeTest</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; <span class="number">10</span>; $i++) &#123;</span></span><br><span class="line"><span class="php">            $id        = uniqid();</span></span><br><span class="line"><span class="php">            $content   = <span class="string">"pingce"</span> . uniqid();</span></span><br><span class="line"><span class="php">            $write_sql = <span class="string">'INSERT INTO `test`(`test`, `test1`) VALUES ("'</span> . $id . <span class="string">'","'</span> . $content . <span class="string">'")'</span>;</span></span><br><span class="line"><span class="php">            $g_result = mysql_query($write_sql);</span></span><br><span class="line"><span class="php">            var_dump($g_result);</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line">    /**</span><br><span class="line">     * 初始化数据库连接信息 info</span><br><span class="line"><span class="php">     */</span></span><br><span class="line"><span class="php">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">initDb</span><span class="params">()</span></span></span></span><br><span class="line"><span class="php">    &#123;</span></span><br><span class="line"><span class="php">        $crowd_conn = mysql_pconnect(<span class="keyword">self</span>::IP, <span class="keyword">self</span>::USER, <span class="keyword">self</span>::PWD);</span></span><br><span class="line"><span class="php">        <span class="keyword">if</span> (!$crowd_conn) &#123;</span></span><br><span class="line"><span class="php">            <span class="keyword">die</span>(<span class="string">"Could not connect:"</span> . mysql_error());</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">        $crowd_db = mysql_select_db(<span class="keyword">self</span>::DB, $crowd_conn);</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">$rw = <span class="keyword">new</span> ReadAndWriteTest();</span></span><br></pre></td></tr></table></figure></p>
<h2 id="主从备份校验"><a href="#主从备份校验" class="headerlink" title="主从备份校验"></a>主从备份校验</h2><ul>
<li>开启slave</li>
<li>调整数据库信息为mysql，主库信息，运行脚本。</li>
<li>查看从库的log，有如下写入操作，说明实时主从备份成功。<figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">151231 </span><span class="number">15</span>:<span class="number">36</span>:<span class="number">21</span> <span class="number">4</span> Query start slave</span><br><span class="line"><span class="symbol">14 </span>Connect <span class="keyword">Out</span> pingce@<span class="number">10.95.112.120</span>:<span class="number">3666</span></span><br><span class="line"><span class="symbol">15 </span>Query BEGIN</span><br><span class="line"><span class="symbol">15 </span>Query INSERT INTO `test`(`test`, `test1`) VALUES (<span class="string">"5684d957e5c85"</span>,<span class="string">"pingce5684d957e5cf2"</span>)</span><br><span class="line"><span class="symbol">15 </span>Query COMMIT /* implicit, from Xid_log_event */</span><br><span class="line"><span class="symbol">15 </span>Query BEGIN</span><br><span class="line"><span class="symbol">15 </span>Query INSERT INTO `test`(`test`, `test1`) VALUES (<span class="string">"5684d957e7937"</span>,<span class="string">"pingce5684d957e7982"</span>)</span><br><span class="line"><span class="symbol">15 </span>Query COMMIT /* implicit, from Xid_log_event */</span><br><span class="line"><span class="symbol">15 </span>Query BEGIN</span><br><span class="line"><span class="symbol">15 </span>Query INSERT INTO `test`(`test`, `test1`) VALUES (<span class="string">"5684d957e8e96"</span>,<span class="string">"pingce5684d957e8ee4"</span>)</span><br><span class="line"><span class="symbol">15 </span>Query COMMIT /* implicit, from Xid_log_event */</span><br><span class="line"><span class="symbol">15 </span>Query BEGIN</span><br><span class="line"><span class="symbol">15 </span>Query INSERT INTO `test`(`test`, `test1`) VALUES (<span class="string">"5684d957ea2c2"</span>,<span class="string">"pingce5684d957ea2eb"</span>)</span><br><span class="line"><span class="symbol">15 </span>Query COMMIT /* implicit, from Xid_log_event */</span><br><span class="line"><span class="symbol">15 </span>Query BEGIN</span><br><span class="line"><span class="symbol">15 </span>Query INSERT INTO `test`(`test`, `test1`) VALUES (<span class="string">"5684d957eb565"</span>,<span class="string">"pingce5684d957eb5b3"</span>)</span><br><span class="line"><span class="symbol">15 </span>Query COMMIT /* implicit, from Xid_log_event */</span><br><span class="line"><span class="symbol">15 </span>Query BEGIN</span><br><span class="line"><span class="symbol">15 </span>Query INSERT INTO `test`(`test`, `test1`) VALUES (<span class="string">"5684d957ec7ee"</span>,<span class="string">"pingce5684d957ec83e"</span>)</span><br><span class="line"><span class="symbol">15 </span>Query COMMIT /* implicit, from Xid_log_event */</span><br><span class="line"><span class="symbol">15 </span>Query BEGIN</span><br><span class="line"><span class="symbol">15 </span>Query INSERT INTO `test`(`test`, `test1`) VALUES (<span class="string">"5684d957eda2f"</span>,<span class="string">"pingce5684d957eda78"</span>)</span><br><span class="line"><span class="symbol">15 </span>Query COMMIT /* implicit, from Xid_log_event */</span><br><span class="line"><span class="symbol">15 </span>Query BEGIN</span><br><span class="line"><span class="symbol">15 </span>Query INSERT INTO `test`(`test`, `test1`) VALUES (<span class="string">"5684d957eeca4"</span>,<span class="string">"pingce5684d957eecf0"</span>)</span><br><span class="line"><span class="symbol">15 </span>Query COMMIT /* implicit, from Xid_log_event */</span><br><span class="line"><span class="symbol">15 </span>Query BEGIN</span><br><span class="line"><span class="symbol">15 </span>Query INSERT INTO `test`(`test`, `test1`) VALUES (<span class="string">"5684d957eff16"</span>,<span class="string">"pingce5684d957eff61"</span>)</span><br><span class="line"><span class="symbol">15 </span>Query COMMIT /* implicit, from Xid_log_event */</span><br><span class="line"><span class="symbol">15 </span>Query BEGIN</span><br><span class="line"><span class="symbol">15 </span>Query INSERT INTO `test`(`test`, `test1`) VALUES (<span class="string">"5684d957f121e"</span>,<span class="string">"pingce5684d957f126d"</span>)</span><br><span class="line"><span class="symbol">15 </span>Query COMMIT /* implicit, from Xid_log_event */</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="检验读写分离"><a href="#检验读写分离" class="headerlink" title="检验读写分离"></a>检验读写分离</h2><ul>
<li><p>读写分离，首先需要关闭从机器上的slave。原因：存在主从的话，无法通过log查看出读写分离操作。</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="literal">stop</span> <span class="literal">slave</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.08</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行脚本：如下信息标示，运行成功。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[cuixiaohuan TestScript]$ /home/work/lamp/php5/bin/php ReadAndWriteTest.php</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>(<span class="string">`test`</span>, <span class="string">`test1`</span>) <span class="keyword">VALUES</span> (<span class="string">"5684d957e5c85"</span>,<span class="string">"pingce5684d957e5cf2"</span>)<span class="built_in">bool</span>(<span class="literal">true</span>)</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>(<span class="string">`test`</span>, <span class="string">`test1`</span>) <span class="keyword">VALUES</span> (<span class="string">"5684d957e7937"</span>,<span class="string">"pingce5684d957e7982"</span>)<span class="built_in">bool</span>(<span class="literal">true</span>)</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>(<span class="string">`test`</span>, <span class="string">`test1`</span>) <span class="keyword">VALUES</span> (<span class="string">"5684d957e8e96"</span>,<span class="string">"pingce5684d957e8ee4"</span>)<span class="built_in">bool</span>(<span class="literal">true</span>)</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>(<span class="string">`test`</span>, <span class="string">`test1`</span>) <span class="keyword">VALUES</span> (<span class="string">"5684d957ea2c2"</span>,<span class="string">"pingce5684d957ea2eb"</span>)<span class="built_in">bool</span>(<span class="literal">true</span>)</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>(<span class="string">`test`</span>, <span class="string">`test1`</span>) <span class="keyword">VALUES</span> (<span class="string">"5684d957eb565"</span>,<span class="string">"pingce5684d957eb5b3"</span>)<span class="built_in">bool</span>(<span class="literal">true</span>)</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>(<span class="string">`test`</span>, <span class="string">`test1`</span>) <span class="keyword">VALUES</span> (<span class="string">"5684d957ec7ee"</span>,<span class="string">"pingce5684d957ec83e"</span>)<span class="built_in">bool</span>(<span class="literal">true</span>)</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>(<span class="string">`test`</span>, <span class="string">`test1`</span>) <span class="keyword">VALUES</span> (<span class="string">"5684d957eda2f"</span>,<span class="string">"pingce5684d957eda78"</span>)<span class="built_in">bool</span>(<span class="literal">true</span>)</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>(<span class="string">`test`</span>, <span class="string">`test1`</span>) <span class="keyword">VALUES</span> (<span class="string">"5684d957eeca4"</span>,<span class="string">"pingce5684d957eecf0"</span>)<span class="built_in">bool</span>(<span class="literal">true</span>)</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>(<span class="string">`test`</span>, <span class="string">`test1`</span>) <span class="keyword">VALUES</span> (<span class="string">"5684d957eff16"</span>,<span class="string">"pingce5684d957eff61"</span>)<span class="built_in">bool</span>(<span class="literal">true</span>)</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>(<span class="string">`test`</span>, <span class="string">`test1`</span>) <span class="keyword">VALUES</span> (<span class="string">"5684d957f121e"</span>,<span class="string">"pingce5684d957f126d"</span>)<span class="built_in">bool</span>(<span class="literal">true</span>)</span><br><span class="line"><span class="keyword">resource</span>(<span class="number">5</span>) <span class="keyword">of</span> <span class="keyword">type</span> (mysql <span class="keyword">result</span>)</span><br><span class="line"><span class="keyword">resource</span>(<span class="number">6</span>) <span class="keyword">of</span> <span class="keyword">type</span> (mysql <span class="keyword">result</span>)</span><br><span class="line"><span class="keyword">resource</span>(<span class="number">7</span>) <span class="keyword">of</span> <span class="keyword">type</span> (mysql <span class="keyword">result</span>)</span><br><span class="line"><span class="keyword">resource</span>(<span class="number">8</span>) <span class="keyword">of</span> <span class="keyword">type</span> (mysql <span class="keyword">result</span>)</span><br><span class="line"><span class="keyword">resource</span>(<span class="number">9</span>) <span class="keyword">of</span> <span class="keyword">type</span> (mysql <span class="keyword">result</span>)</span><br><span class="line"><span class="keyword">resource</span>(<span class="number">10</span>) <span class="keyword">of</span> <span class="keyword">type</span> (mysql <span class="keyword">result</span>)</span><br><span class="line"><span class="keyword">resource</span>(<span class="number">11</span>) <span class="keyword">of</span> <span class="keyword">type</span> (mysql <span class="keyword">result</span>)</span><br><span class="line"><span class="keyword">resource</span>(<span class="number">12</span>) <span class="keyword">of</span> <span class="keyword">type</span> (mysql <span class="keyword">result</span>)</span><br><span class="line"><span class="keyword">resource</span>(<span class="number">13</span>) <span class="keyword">of</span> <span class="keyword">type</span> (mysql <span class="keyword">result</span>)</span><br><span class="line"><span class="keyword">resource</span>(<span class="number">14</span>) <span class="keyword">of</span> <span class="keyword">type</span> (mysql <span class="keyword">result</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>查询读写库的log</p>
<blockquote>
<p>解释：之所以主库放一个读写库，是因为有些要求超高一致性的数据，备份可能会有延迟；所以，主库承担读写操作，和高负载。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#读写机器log：  进行了10次写和 四次读</span></span><br><span class="line">151231 15:29:27 19 Query <span class="keyword">set</span> <span class="keyword">names</span> gbk^@</span><br><span class="line"><span class="number">19</span> <span class="keyword">Query</span> <span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>(<span class="string">`test`</span>, <span class="string">`test1`</span>) <span class="keyword">VALUES</span> (<span class="string">"5684d957e5c85"</span>,<span class="string">"pingce5684d957e5cf2"</span>)</span><br><span class="line"><span class="number">19</span> <span class="keyword">Query</span> <span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>(<span class="string">`test`</span>, <span class="string">`test1`</span>) <span class="keyword">VALUES</span> (<span class="string">"5684d957e7937"</span>,<span class="string">"pingce5684d957e7982"</span>)</span><br><span class="line"><span class="number">19</span> <span class="keyword">Query</span> <span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>(<span class="string">`test`</span>, <span class="string">`test1`</span>) <span class="keyword">VALUES</span> (<span class="string">"5684d957e8e96"</span>,<span class="string">"pingce5684d957e8ee4"</span>)</span><br><span class="line"><span class="number">19</span> <span class="keyword">Query</span> <span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>(<span class="string">`test`</span>, <span class="string">`test1`</span>) <span class="keyword">VALUES</span> (<span class="string">"5684d957ea2c2"</span>,<span class="string">"pingce5684d957ea2eb"</span>)</span><br><span class="line"><span class="number">19</span> <span class="keyword">Query</span> <span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>(<span class="string">`test`</span>, <span class="string">`test1`</span>) <span class="keyword">VALUES</span> (<span class="string">"5684d957eb565"</span>,<span class="string">"pingce5684d957eb5b3"</span>)</span><br><span class="line"><span class="number">19</span> <span class="keyword">Query</span> <span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>(<span class="string">`test`</span>, <span class="string">`test1`</span>) <span class="keyword">VALUES</span> (<span class="string">"5684d957ec7ee"</span>,<span class="string">"pingce5684d957ec83e"</span>)</span><br><span class="line"><span class="number">19</span> <span class="keyword">Query</span> <span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>(<span class="string">`test`</span>, <span class="string">`test1`</span>) <span class="keyword">VALUES</span> (<span class="string">"5684d957eda2f"</span>,<span class="string">"pingce5684d957eda78"</span>)</span><br><span class="line"><span class="number">19</span> <span class="keyword">Query</span> <span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>(<span class="string">`test`</span>, <span class="string">`test1`</span>) <span class="keyword">VALUES</span> (<span class="string">"5684d957eeca4"</span>,<span class="string">"pingce5684d957eecf0"</span>)</span><br><span class="line"><span class="number">19</span> <span class="keyword">Query</span> <span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>(<span class="string">`test`</span>, <span class="string">`test1`</span>) <span class="keyword">VALUES</span> (<span class="string">"5684d957eff16"</span>,<span class="string">"pingce5684d957eff61"</span>)</span><br><span class="line"><span class="number">19</span> <span class="keyword">Query</span> <span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>(<span class="string">`test`</span>, <span class="string">`test1`</span>) <span class="keyword">VALUES</span> (<span class="string">"5684d957f121e"</span>,<span class="string">"pingce5684d957f126d"</span>)</span><br><span class="line"><span class="number">19</span> <span class="keyword">Query</span> <span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">test</span> <span class="keyword">limit</span> <span class="number">10</span></span><br><span class="line"><span class="number">151231</span> <span class="number">15</span>:<span class="number">29</span>:<span class="number">28</span> <span class="number">19</span> <span class="keyword">Query</span> <span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">test</span> <span class="keyword">limit</span> <span class="number">10</span></span><br><span class="line"><span class="number">19</span> <span class="keyword">Query</span> <span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">test</span> <span class="keyword">limit</span> <span class="number">10</span></span><br><span class="line"><span class="number">19</span> <span class="keyword">Query</span> <span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">test</span> <span class="keyword">limit</span> <span class="number">10</span></span><br><span class="line"><span class="number">19</span> <span class="keyword">Query</span> <span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">test</span> <span class="keyword">limit</span> <span class="number">10</span></span><br></pre></td></tr></table></figure>
</blockquote>
</li>
<li><p>查看读库的log</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只进行了读操作，校正了数据库的读写分离操作。</span></span><br><span class="line">151231 15:29:20 4 Query <span class="keyword">stop</span> <span class="keyword">slave</span></span><br><span class="line"><span class="number">151231</span> <span class="number">15</span>:<span class="number">29</span>:<span class="number">27</span> <span class="number">3</span> <span class="keyword">Query</span> <span class="keyword">set</span> <span class="keyword">names</span> gbk^@</span><br><span class="line"><span class="number">3</span> <span class="keyword">Query</span> <span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">test</span> <span class="keyword">limit</span> <span class="number">10</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">Query</span> <span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">test</span> <span class="keyword">limit</span> <span class="number">10</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">Query</span> <span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">test</span> <span class="keyword">limit</span> <span class="number">10</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">Query</span> <span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">test</span> <span class="keyword">limit</span> <span class="number">10</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">Query</span> <span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">test</span> <span class="keyword">limit</span> <span class="number">10</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">Query</span> <span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">test</span> <span class="keyword">limit</span> <span class="number">10</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>一句话：打开slave，校验主从备份；关闭slave，校验读写分离。</p>
<p>【转载请注明：<a href="http://cuihuan.net/article/%E6%A3%80%E9%AA%8Cmysql%E4%B8%BB%E4%BB%8E%E5%A4%87%E4%BB%BD%EF%BC%8C%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB.html"> 检验mysql主从备份，读写分离 </a> | <a href="http://cuihuan.net">靠谱崔小拽</a> 】</p>
]]></content>
      
        
        <tags>
            
            <tag> mysql </tag>
            
            <tag> 读写分离 </tag>
            
            <tag> 主从备份 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[php反射调用private方法实践]]></title>
      <url>/2015/12/20/php%E5%8F%8D%E5%B0%84%E8%B0%83%E7%94%A8private%E6%96%B9%E6%B3%95%E5%AE%9E%E8%B7%B5/</url>
      <content type="html"><![CDATA[<blockquote>
<p>问题背景：单测中有个普遍性的问题，<code>被侧类中的private方法无法直接调用</code>。小拽在处理过程中通过<code>反射改变方法权限，进行单测</code>，分享一下，直接上代码。</p>
</blockquote>
<h2 id="简单被测试类"><a href="#简单被测试类" class="headerlink" title="简单被测试类"></a>简单被测试类</h2><p>生成一个简单的被测试类，只有个private方法。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line">/**</span><br><span class="line"> * 崔小涣单测的基本模板。</span><br><span class="line"> *</span><br><span class="line"> * @author cuihuan</span><br><span class="line"> * @date 2015/11/12 22:15:31</span><br><span class="line"> * @version $Revision:1.0$</span><br><span class="line"><span class="php"> **/</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span> </span>&#123;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line">    /**</span><br><span class="line">     * 私有方法</span><br><span class="line">     *</span><br><span class="line">     * @param $params</span><br><span class="line">     * @return bool</span><br><span class="line"><span class="php">     */</span></span><br><span class="line"><span class="php">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">privateFunc</span><span class="params">($params)</span></span>&#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">if</span>(!<span class="keyword">isset</span>($params))&#123;</span></span><br><span class="line"><span class="php">            <span class="keyword">return</span> <span class="keyword">false</span>;</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">        <span class="keyword">echo</span> <span class="string">"test success"</span>;</span></span><br><span class="line"><span class="php">        <span class="keyword">return</span> $params;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="单测代码"><a href="#单测代码" class="headerlink" title="单测代码"></a>单测代码</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line">/***************************************************************************</span><br><span class="line"> *</span><br><span class="line"> * $Id: MyClassTest T,v 1.0 PsCaseTest cuihuan Exp$</span><br><span class="line"> *</span><br><span class="line"><span class="php"> **************************************************************************/</span></span><br><span class="line"><span class="php"></span></span><br><span class="line">/**</span><br><span class="line"> * 崔小涣单测的基本模板。 </span><br><span class="line"> * </span><br><span class="line"> * @author cuihuan</span><br><span class="line"> * @date 2015/11/12 22:09:31</span><br><span class="line"> * @version $Revision:1.0$</span><br><span class="line"><span class="php"> **/</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">require_once</span> (<span class="string">'./MyClass.php'</span>);</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">MyClassTest</span> <span class="keyword">extends</span> <span class="title">PHPUnit_Framework_TestCase</span> </span>&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">const</span> CLASS_NAME = <span class="string">'MyClass'</span>;</span></span><br><span class="line"><span class="php">    <span class="keyword">const</span> FAIL       = <span class="string">'fail'</span>;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="keyword">protected</span> $objMyClass;</span></span><br><span class="line"><span class="php">    </span></span><br><span class="line">    /**</span><br><span class="line">     * @brief setup: Sets up the fixture, for example, opens a network connection.</span><br><span class="line">     *</span><br><span class="line">     * 可以看做phpunit的构造函数</span><br><span class="line"><span class="php">     */</span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setup</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="php">        date_default_timezone_set(<span class="string">'PRC'</span>);</span></span><br><span class="line"><span class="php">        <span class="keyword">$this</span>-&gt;objMyClass = <span class="keyword">new</span> MyClass();</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line">    /**</span><br><span class="line">     * 利用反射，对类中的private 和 protect 方法进行单元测试</span><br><span class="line">     *</span><br><span class="line">     * @param $strMethodName  string  ：反射函数名</span><br><span class="line">     * @return ReflectionMethod obj   ：回调对象</span><br><span class="line"><span class="php">     */</span></span><br><span class="line"><span class="php">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getPrivateMethod</span><span class="params">($strMethodName)</span> </span>&#123;</span></span><br><span class="line"><span class="php">        $objReflectClass = <span class="keyword">new</span> ReflectionClass(<span class="keyword">self</span>::CLASS_NAME);</span></span><br><span class="line"><span class="php">        $method          = $objReflectClass-&gt;getMethod($strMethodName);</span></span><br><span class="line"><span class="php">        $method-&gt;setAccessible(<span class="keyword">true</span>);</span></span><br><span class="line"><span class="php">        <span class="keyword">return</span> $method;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"></span></span><br><span class="line">    /**</span><br><span class="line">     * @brief :测试private函数的调用</span><br><span class="line"><span class="php">     */</span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testPrivateFunc</span><span class="params">()</span></span></span></span><br><span class="line"><span class="php">    &#123;</span></span><br><span class="line"><span class="php">        $testCase = <span class="string">'just a test string'</span>;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">        <span class="comment">// 反射该类</span></span></span><br><span class="line"><span class="php">        $testFunc = <span class="keyword">self</span>::getPrivateMethod(<span class="string">'privateFunc'</span>);</span></span><br><span class="line"><span class="php">        $res = $testFunc-&gt;invokeArgs(<span class="keyword">$this</span>-&gt;objMyClass, <span class="keyword">array</span>($testCase));</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">        <span class="keyword">$this</span>-&gt;assertEquals($testCase, $res);</span></span><br><span class="line"><span class="php">        <span class="keyword">$this</span>-&gt;expectOutputRegex(<span class="string">'/success/i'</span>);</span></span><br><span class="line"><span class="php">        </span></span><br><span class="line"><span class="php">        <span class="comment">// 捕获没有参数异常测试</span></span></span><br><span class="line"><span class="php">        <span class="keyword">try</span> &#123;</span></span><br><span class="line"><span class="php">             $testFunc-&gt;invokeArgs(<span class="keyword">$this</span>-&gt;transfer2Pscase, <span class="keyword">array</span>());</span></span><br><span class="line"><span class="php">        &#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $expected) &#123;</span></span><br><span class="line"><span class="php">            <span class="keyword">$this</span>-&gt;assertNotNull($expected);</span></span><br><span class="line"><span class="php">            <span class="keyword">return</span> <span class="keyword">true</span>;</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">        <span class="keyword">$this</span>-&gt;fail(<span class="keyword">self</span>::FAIL);</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">    </span></span><br><span class="line"><span class="php">&#125;</span></span><br></pre></td></tr></table></figure>
<p>##运行结果<br><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cuihuan:test cuixiaohuan$ phpunit MyClassTest.php </span><br><span class="line">PHPUnit 4.8.6 by Sebastian Bergmann and contributors.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">Time:</span> 103 ms, Memory: 11.75Mb</span><br><span class="line"></span><br><span class="line">OK (1 test, 3 assertions)</span><br></pre></td></tr></table></figure></p>
<h2 id="关键代码分析"><a href="#关键代码分析" class="headerlink" title="关键代码分析"></a>关键代码分析</h2><p>封装了一个，被测类方法的反射调用；同时，<code>返回方法之前处理方法的接入权限为true</code>，便可以访问private的函数方法。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 利用反射，对类中的private 和 protect 方法进行单元测试</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $strMethodName  string  ：反射函数名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> ReflectionMethod obj   ：回调对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getPrivateMethod</span><span class="params">($strMethodName)</span> </span>&#123;</span><br><span class="line">    $objReflectClass = <span class="keyword">new</span> ReflectionClass(<span class="keyword">self</span>::CLASS_NAME);</span><br><span class="line">    $method          = $objReflectClass-&gt;getMethod($strMethodName);</span><br><span class="line">    $method-&gt;setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">return</span> $method;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>【转载请注明：<a href="http://cuihuan.net/article/phpunit%E5%8D%95%E6%B5%8B%E4%B8%AD%E8%B0%83%E7%94%A8private%E6%96%B9%E6%B3%95%E5%A4%84%E7%90%86.html">phpunit单测中调用private方法处理</a> | <a href="http://cuihuan.net">靠谱崔小拽</a> 】</p>
]]></content>
      
        
        <tags>
            
            <tag> php </tag>
            
            <tag> 单元测试 </tag>
            
            <tag> phpunit </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[mysql 简单全量备份和快速恢复]]></title>
      <url>/2015/12/11/mysql%20%E7%AE%80%E5%8D%95%E5%85%A8%E9%87%8F%E5%A4%87%E4%BB%BD%E5%92%8C%E5%BF%AB%E9%80%9F%E6%81%A2%E5%A4%8D/</url>
      <content type="html"><![CDATA[<blockquote>
<p>一个简单的mysql全量备份脚本，备份最近15天的数据。</p>
</blockquote>
<h2 id="备份"><a href="#备份" class="headerlink" title="备份"></a>备份</h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#每天备份mysql数据库(保存最近15天的数据脚本)</span></span><br><span class="line">DATE=$(date +%Y%m%d)</span><br><span class="line"><span class="regexp">/home/</span>cuixiaohuan<span class="regexp">/lamp/my</span>sql5<span class="regexp">/bin/my</span>sqldump -uuser -ppassword need_db &gt; <span class="regexp">/home/</span>cuixiaohuan<span class="regexp">/bak_sql/my</span>sql_dbxx_<span class="variable">$DATE</span>.sql;</span><br><span class="line">find <span class="regexp">/home/</span>cuixiaohuan<span class="regexp">/bak_sql/</span> -mtime +<span class="number">15</span> -name <span class="string">'*.sql'</span> -exec rm -rf &#123;&#125; \;</span><br></pre></td></tr></table></figure>
<h2 id="恢复"><a href="#恢复" class="headerlink" title="恢复"></a>恢复</h2><p>mysql 数据导入<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">databases</span> need_db;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">databases</span> need_db;</span><br></pre></td></tr></table></figure></p>
<p>导入数据：必须设定编码进行恢复<br><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./mysql -uroot -p --<span class="keyword">default</span>-character-<span class="keyword">set</span>=utf8 need_db &lt; xx.sql</span><br></pre></td></tr></table></figure></p>
<p>【转载请注明：<a href="http://cuihuan.net/article/mysql-%E7%AE%80%E5%8D%95%E5%85%A8%E9%87%8F%E5%A4%87%E4%BB%BD%E5%92%8C%E5%BF%AB%E9%80%9F%E6%81%A2%E5%A4%8D.html">mysql 简单全量备份和快速恢复</a> | <a href="http://cuihuan.net">靠谱崔小拽</a> 】</p>
]]></content>
      
        
        <tags>
            
            <tag> 备份 </tag>
            
            <tag> mysql </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[linux 查找清理大文件]]></title>
      <url>/2015/12/08/linux%20%E6%9F%A5%E6%89%BE%E6%B8%85%E7%90%86%E5%A4%A7%E6%96%87%E4%BB%B6/</url>
      <content type="html"><![CDATA[<blockquote>
<p>linux 经常硬盘空间不足，往往是由于一些大文件造成；之前寻找大文件总是很头疼，速度特别慢。<br>经学弟介绍使用：<code>du -sh * |grep G</code> 查找和清理速度不错，分享一下清理过程。</p>
</blockquote>
<h2 id="查看系统存储状态"><a href="#查看系统存储状态" class="headerlink" title="查看系统存储状态"></a>查看系统存储状态</h2><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[cuihuan:~ cuixiaohuan]$ df -h</span><br><span class="line"><span class="symbol">Filesystem</span> <span class="symbol">Size</span> <span class="symbol">Used</span> <span class="symbol">Avail</span> <span class="symbol">Use</span><span class="comment">% Mounted on</span></span><br><span class="line">/dev/sda2 <span class="number">8.2</span><span class="symbol">G</span> <span class="number">6.7</span><span class="symbol">G</span> <span class="number">1.6</span><span class="symbol">G</span> <span class="number">82</span><span class="comment">% /</span></span><br><span class="line">/dev/sda3 <span class="number">1.4</span><span class="symbol">T</span> <span class="number">1.3</span><span class="symbol">T</span> <span class="number">50</span><span class="symbol">G</span> <span class="number">97</span><span class="comment">% /home</span></span><br></pre></td></tr></table></figure>
<p>1.5T的硬盘占用了97%，确实不够用了，必须着手清理一下</p>
<h2 id="查找大文件"><a href="#查找大文件" class="headerlink" title="查找大文件"></a>查找大文件</h2><p>主要使用查找命令：<code>du -sh * |grep G</code><br>从根文件开始查找<br><figure class="highlight erlang-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[cuihuan:~]$ du -sh * | grep G</span><br><span class="line">。。。</span><br><span class="line"><span class="number">73</span>G mongodb</span><br><span class="line"><span class="number">103</span>G mxm</span><br><span class="line"><span class="number">2.1</span>G online</span><br><span class="line"><span class="number">613</span>G thirdparty [binggo!!!]</span><br><span class="line">。。。</span><br></pre></td></tr></table></figure></p>
<p>bingo 613g，看来这个主要矛盾了，进一步分析该文件</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[cuihuan:~ mysql5]$ du -<span class="keyword">sh</span> *</span><br><span class="line">116M bin</span><br><span class="line">904K <span class="keyword">include</span></span><br><span class="line">13M lib</span><br><span class="line">17M libexec</span><br><span class="line">458G <span class="keyword">log</span> [-__]</span><br><span class="line">8.0K my.cnf</span><br><span class="line">76M mysql-<span class="keyword">test</span></span><br><span class="line">13M share</span><br><span class="line">2.9M sql-bench</span><br><span class="line">4.0K <span class="keyword">test</span></span><br><span class="line">4.0K tmp</span><br><span class="line">101G <span class="keyword">var</span> [-_-]</span><br><span class="line">[cuihuan:~ mysql5]$ <span class="keyword">cd</span> <span class="built_in">log</span></span><br><span class="line">[cuihuan:~ <span class="keyword">log</span>]$ <span class="keyword">ls</span> -lh</span><br><span class="line"><span class="keyword">total</span> 458G</span><br><span class="line">-rw-rw---- 1 work work 870K <span class="keyword">Dec</span> 2 17:42 mysql.<span class="keyword">err</span></span><br><span class="line">-rw-rw---- 1 work work 3.9K Mar 24 2015 mysql.<span class="keyword">err</span>-old</span><br><span class="line">-rw-rw---- 1 work work 446G <span class="keyword">Dec</span> 3 15:19 mysql.<span class="keyword">log</span> 【-__】</span><br><span class="line">-rw-rw---- 1 work work 11G <span class="keyword">Dec</span> 3 15:10 slow.<span class="built_in">log</span></span><br></pre></td></tr></table></figure>
<p>经过分析看到mysql.log的日志占了446G,着手清理下。【mysql log 好的保存方式是：天级导出，清理n天之前的log，此处不再赘述】</p>
<h2 id="清理之后效果"><a href="#清理之后效果" class="headerlink" title="清理之后效果"></a>清理之后效果</h2><p>清理 mysql.log 和var  之后<br>清理了大约<code>500g</code>的空间<br><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[cuihuan:~ var]$ df -h   </span><br><span class="line"><span class="symbol">Filesystem</span> <span class="symbol">Size</span> <span class="symbol">Used</span> <span class="symbol">Avail</span> <span class="symbol">Use</span><span class="comment">% Mounted on</span></span><br><span class="line">/dev/sda2 <span class="number">8.2</span><span class="symbol">G</span> <span class="number">6.7</span><span class="symbol">G</span> <span class="number">1.6</span><span class="symbol">G</span> <span class="number">82</span><span class="comment">% /</span></span><br><span class="line">/dev/sda3 <span class="number">1.4</span><span class="symbol">T</span> <span class="number">757</span><span class="symbol">G</span> <span class="number">584</span><span class="symbol">G</span> <span class="number">57</span><span class="comment">% /home</span></span><br></pre></td></tr></table></figure></p>
<p>【转载请注明：<a href="http://cuihuan.net/article/linux-%E6%9F%A5%E6%89%BE%E6%B8%85%E7%90%86%E5%A4%A7%E6%96%87%E4%BB%B6.html">linux 查找清理大文件</a> | <a href="http://cuihuan.net">靠谱崔小拽</a> 】</p>
]]></content>
      
        
        <tags>
            
            <tag> linux </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[echarts动态获取数据实例]]></title>
      <url>/2015/12/06/echarts%E5%8A%A8%E6%80%81%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE%E5%AE%9E%E4%BE%8B/</url>
      <content type="html"><![CDATA[<blockquote>
<p>echarts动态获取数据库的实时数据的简单实例。实例演示： <a href="http://cuihuan.net:1015/demo_file/echarts_realtime_demo/demo.html"> 跳转demo </a></p>
</blockquote>
<h2 id="引入echarts-文件。"><a href="#引入echarts-文件。" class="headerlink" title="引入echarts 文件。"></a>引入echarts 文件。</h2><p>引入echarts的文件方式有多种，比较推荐模块化的引入方式。<br>小拽的简单demo是直接引入文件，提供一个下载地址 ：<a href="http://cuihuan.net:1015/component/echarts/build/echarts-all.js"> 点击下载 </a></p>
<h2 id="html-部分代码"><a href="#html-部分代码" class="headerlink" title="html 部分代码"></a>html 部分代码</h2><p>一块div 用于echart的展现。<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="keyword">div</span> <span class="built_in">id</span>=<span class="string">"echart_show"</span> style=<span class="string">"height:500px"</span>&gt;这里是一个布局展现&lt;/<span class="keyword">div</span>&gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="js-部分代码"><a href="#js-部分代码" class="headerlink" title="js 部分代码"></a>js 部分代码</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 绘制反馈量图形</span></span><br><span class="line">    <span class="keyword">var</span> init_echarts = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> refreshChart = <span class="function"><span class="keyword">function</span> (<span class="params">show_data</span>) </span>&#123;</span><br><span class="line">            my_demo_chart = echarts.init(<span class="built_in">document</span>.getElementById(<span class="string">'echart_show'</span>));</span><br><span class="line">            my_demo_chart.showLoading(&#123;</span><br><span class="line">                text: <span class="string">'加载中...'</span>,</span><br><span class="line">                effect: <span class="string">'whirling'</span></span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> echarts_all_option = &#123;</span><br><span class="line">                title: &#123;</span><br><span class="line">                    text: <span class="string">'动态数据'</span>,</span><br><span class="line">                    subtext: <span class="string">'纯属虚构'</span></span><br><span class="line">                &#125;,</span><br><span class="line">                tooltip: &#123;</span><br><span class="line">                    trigger: <span class="string">'axis'</span></span><br><span class="line">                &#125;,</span><br><span class="line">                legend: &#123;</span><br><span class="line">                    data: [<span class="string">'最新成交价'</span>, <span class="string">'预购队列'</span>]</span><br><span class="line">                &#125;,</span><br><span class="line">                toolbox: &#123;</span><br><span class="line">                    show: <span class="literal">true</span>,</span><br><span class="line">                    feature: &#123;</span><br><span class="line">                        mark: &#123;<span class="attr">show</span>: <span class="literal">true</span>&#125;,</span><br><span class="line">                        dataView: &#123;<span class="attr">show</span>: <span class="literal">true</span>, <span class="attr">readOnly</span>: <span class="literal">false</span>&#125;,</span><br><span class="line">                        magicType: &#123;<span class="attr">show</span>: <span class="literal">true</span>, <span class="attr">type</span>: [<span class="string">'line'</span>, <span class="string">'bar'</span>]&#125;,</span><br><span class="line">                        restore: &#123;<span class="attr">show</span>: <span class="literal">true</span>&#125;,</span><br><span class="line">                        saveAsImage: &#123;<span class="attr">show</span>: <span class="literal">true</span>&#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                dataZoom: &#123;</span><br><span class="line">                    show: <span class="literal">false</span>,</span><br><span class="line">                    start: <span class="number">0</span>,</span><br><span class="line">                    end: <span class="number">100</span></span><br><span class="line">                &#125;,</span><br><span class="line">                xAxis: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        type: <span class="string">'category'</span>,</span><br><span class="line">                        boundaryGap: <span class="literal">true</span>,</span><br><span class="line">                        data: (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                            <span class="keyword">var</span> now = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">                            <span class="keyword">var</span> res = [];</span><br><span class="line">                            <span class="keyword">var</span> len = <span class="number">10</span>;</span><br><span class="line">                            <span class="keyword">while</span> (len--) &#123;</span><br><span class="line">                                res.unshift(now.toLocaleTimeString().replace(<span class="regexp">/^\D*/</span>, <span class="string">''</span>));</span><br><span class="line">                                now = <span class="keyword">new</span> <span class="built_in">Date</span>(now - <span class="number">2000</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">return</span> res;</span><br><span class="line">                        &#125;)()</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        type: <span class="string">'category'</span>,</span><br><span class="line">                        boundaryGap: <span class="literal">true</span>,</span><br><span class="line">                        data: (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                            <span class="keyword">var</span> res = [];</span><br><span class="line">                            <span class="keyword">var</span> len = <span class="number">10</span>;</span><br><span class="line">                            <span class="keyword">while</span> (len--) &#123;</span><br><span class="line">                                res.push(len + <span class="number">1</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">return</span> res;</span><br><span class="line">                        &#125;)()</span><br><span class="line">                    &#125;</span><br><span class="line">                ],</span><br><span class="line">                yAxis: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        type: <span class="string">'value'</span>,</span><br><span class="line">                        scale: <span class="literal">true</span>,</span><br><span class="line">                        name: <span class="string">'价格'</span>,</span><br><span class="line">                        boundaryGap: [<span class="number">0.2</span>, <span class="number">0.2</span>]</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        type: <span class="string">'value'</span>,</span><br><span class="line">                        scale: <span class="literal">true</span>,</span><br><span class="line">                        name: <span class="string">'预购量'</span>,</span><br><span class="line">                        boundaryGap: [<span class="number">0.2</span>, <span class="number">0.2</span>]</span><br><span class="line">                    &#125;</span><br><span class="line">                ],</span><br><span class="line">                series: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        name: <span class="string">'预购队列'</span>,</span><br><span class="line">                        type: <span class="string">'bar'</span>,</span><br><span class="line">                        xAxisIndex: <span class="number">1</span>,</span><br><span class="line">                        yAxisIndex: <span class="number">1</span>,</span><br><span class="line">                        <span class="comment">// 获取到数据库的数据</span></span><br><span class="line">                        data: show_data[<span class="number">0</span>]</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        name: <span class="string">'最新成交价'</span>,</span><br><span class="line">                        type: <span class="string">'line'</span>,</span><br><span class="line">                        <span class="comment">// 实时获取的数据</span></span><br><span class="line">                        data:show_data[<span class="number">1</span>]</span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            my_demo_chart.hideLoading();</span><br><span class="line">            my_demo_chart.setOption(echarts_all_option);</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取原始数据</span></span><br><span class="line">        $.ajax(&#123;</span><br><span class="line">            url: <span class="string">"http://cuihuan.net:1015/demo_file/echarts_realtime_demo/get_data.php"</span>,</span><br><span class="line">            data: &#123;<span class="attr">type</span>: <span class="string">"2"</span>&#125;,</span><br><span class="line">            success: <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">                <span class="comment">// 根据数据库取到结果拼接现在结果</span></span><br><span class="line">                refreshChart(<span class="built_in">eval</span>(data));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 开启实时获取数据更新</span></span><br><span class="line">    $(<span class="string">"#getData"</span>).on(<span class="string">"click"</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> timeTicket;</span><br><span class="line">        <span class="keyword">var</span> lastData = <span class="number">11</span>;</span><br><span class="line">        <span class="keyword">var</span> axisData;</span><br><span class="line">        clearInterval(timeTicket);</span><br><span class="line">        timeTicket = setInterval(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="comment">// 获取实时更新数据</span></span><br><span class="line">            $.ajax(&#123;</span><br><span class="line">                url: <span class="string">"http://cuihuan.net:1015/demo_file/echarts_realtime_demo/get_data.php"</span>,</span><br><span class="line">                data: &#123;<span class="attr">type</span>: <span class="string">"new"</span>&#125;,</span><br><span class="line">                success: <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">                    <span class="comment">// 根据条件转换成相应的api 转化为echart 需要的数据</span></span><br><span class="line">                    <span class="comment">// todo 更新数据采用随机更新的方式</span></span><br><span class="line">                    lastData += <span class="built_in">Math</span>.random() * ((<span class="built_in">Math</span>.round(<span class="built_in">Math</span>.random() * <span class="number">10</span>) % <span class="number">2</span>) == <span class="number">0</span> ? <span class="number">1</span> : <span class="number">-1</span>);</span><br><span class="line">                    lastData = lastData.toFixed(<span class="number">1</span>) - <span class="number">0</span>;</span><br><span class="line">                    axisData = (<span class="keyword">new</span> <span class="built_in">Date</span>()).toLocaleTimeString().replace(<span class="regexp">/^\D*/</span>, <span class="string">''</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 动态数据接口 addData</span></span><br><span class="line">                    my_demo_chart.addData([</span><br><span class="line">                        [</span><br><span class="line">                            <span class="number">0</span>,        <span class="comment">// 系列索引</span></span><br><span class="line">                            <span class="built_in">Math</span>.round(<span class="built_in">Math</span>.random() * <span class="number">1000</span>), <span class="comment">// 新增数据</span></span><br><span class="line">                            <span class="literal">true</span>,     <span class="comment">// 新增数据是否从队列头部插入</span></span><br><span class="line">                            <span class="literal">false</span>     <span class="comment">// 是否增加队列长度，false则自定删除原有数据，队头插入删队尾，队尾插入删队头</span></span><br><span class="line">                        ],</span><br><span class="line">                        [</span><br><span class="line">                            <span class="number">1</span>,        <span class="comment">// 系列索引</span></span><br><span class="line">                            lastData, <span class="comment">// 新增数据</span></span><br><span class="line">                            <span class="literal">false</span>,    <span class="comment">// 新增数据是否从队列头部插入</span></span><br><span class="line">                            <span class="literal">false</span>,    <span class="comment">// 是否增加队列长度，false则自定删除原有数据，队头插入删队尾，队尾插入删队头</span></span><br><span class="line">                            axisData  <span class="comment">// 坐标轴标签</span></span><br><span class="line">                        ]</span><br><span class="line">                    ]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">        &#125;, <span class="number">2100</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 关闭更新操作</span></span><br><span class="line">        $(<span class="string">"#stopData"</span>).on(<span class="string">"click"</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            clearInterval(timeTicket);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 默认加载</span></span><br><span class="line">    <span class="keyword">var</span> default_load = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        init_echarts();</span><br><span class="line">    &#125;)();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="php-部分代码"><a href="#php-部分代码" class="headerlink" title="php 部分代码"></a>php 部分代码</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 连接数据库获取数据</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * User: cuixiaohuan</span></span><br><span class="line"><span class="comment"> * Date: 15/12/4</span></span><br><span class="line"><span class="comment"> * Time: 下午6:47</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取请求的类型</span></span><br><span class="line">$type = $_GET[<span class="string">'type'</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 连接服务器</span></span><br><span class="line">$link = mysql_connect(<span class="string">'ip:port'</span>, <span class="string">'user'</span>, <span class="string">'password'</span>);</span><br><span class="line"><span class="keyword">if</span> (!$link) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"Could not connect:"</span> . mysql_error());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取test库数据</span></span><br><span class="line">$crowd_db = mysql_select_db(<span class="string">'test'</span>, $link);</span><br><span class="line">$day_time = date(<span class="string">"Y-m-d"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据传输过来的数据获取数据</span></span><br><span class="line">$static_sql = <span class="string">"select v from test where id = "</span> . $type . <span class="string">" limit 10"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取数据之后返回</span></span><br><span class="line">$res = mysql_query($static_sql, $link_2004);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($res) &#123;</span><br><span class="line">    <span class="comment">// 将结果进行入库操作</span></span><br><span class="line">    $row = mysql_fetch_row($res);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>($row[<span class="number">0</span>])&#123;</span><br><span class="line">        <span class="keyword">echo</span> $row[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    mysql_free_result($res);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="简单说明"><a href="#简单说明" class="headerlink" title="简单说明"></a>简单说明</h2><p>小拽的demo中，根据echarts的api，绘制出了原有的图形展示；之后，对js设置了个定时任务，实时的去获取数据库中可能新入库的数据，接口通过php简单调用数据库实现。</p>
<p><a href="http://cuihuan.net"> 小拽个人小站 </a></p>
]]></content>
      
        
        <tags>
            
            <tag> javascript </tag>
            
            <tag> 前端 </tag>
            
            <tag> 动态获取数据 </tag>
            
            <tag> pho </tag>
            
            <tag> echarts </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[【wordpress优化】压缩和使用静态缓存]]></title>
      <url>/2015/12/06/%E3%80%90wordpress%E4%BC%98%E5%8C%96%E3%80%91%E5%8E%8B%E7%BC%A9%E5%92%8C%E4%BD%BF%E7%94%A8%E9%9D%99%E6%80%81%E7%BC%93%E5%AD%98/</url>
      <content type="html"><![CDATA[<blockquote>
<p>先说背景：wordpress个人网站，整体性能挺不错；但是，由于采用php动态获取数据，构成页面的方式，势必会影响页面加载速度。对于一些最常用的页面[例如首页]等等，完全可以采用生成伪静态页面缓存的方式加载。</p>
</blockquote>
<blockquote>
<p>针对现有的缓存方式调研了一下：本文使用<code>wp super cache</code>进行了优化，提升加载速度200%以上。</p>
</blockquote>
<h2 id="无图无真想，先看效果"><a href="#无图无真想，先看效果" class="headerlink" title="无图无真想，先看效果"></a>无图无真想，先看效果</h2><p>针对相同页面在chrome下做了个加载时间，大小的对比，如下图</p>
<p>优化前数据：23ms感知页面；3.62s加载完成；页面大小：419k；请求个数：25个；<br><a href="http://cuihuan.net/wp-content/uploads/2015/12/E6B50C39-73D4-4397-9A79-794C58FC8A6A.png"><img src="http://cuihuan.net/wp-content/uploads/2015/12/E6B50C39-73D4-4397-9A79-794C58FC8A6A-1024x490.png" alt="原始加载时间"></a></p>
<p>优化后数据：106ms感知页面；<code>1.81s</code>加载完成；页面大小<code>13.9k</code>；请求个数24个；<br><img src="http://cuihuan.net/wp-content/uploads/2015/12/1FDB64C3-369A-47E4-8CF7-FE2E7676FC4C1-1024x482.png" alt="原始加载时间"></p>
<p>效果不错，后文做个详细分析。</p>
<h2 id="了解-wp-super-cache"><a href="#了解-wp-super-cache" class="headerlink" title="了解 wp super cache"></a>了解 wp super cache</h2><p><a href="http://z9.io/wp-super-cache/" target="_blank" rel="external"> wp super cache </a> 是wordpress的一种缓存优化插件，本质是利用缓存机制提升页面加载速度。<br><strong>实现原理:</strong> php最终在前端展现时需要转换为html，然后获取响应的数据；wp super cache 则提前将php文件转换为的html伪静态文件进行存储，一旦发生请求，直接返回生成的页面；减少了数据库取数据，转换等过程，来增加加载速度。<br><strong>优 点:</strong> 增加了加载速度。<br><strong>缺 点:</strong> 增加了存储成本，而且要不断的更新，如果用户量大，个人感觉存储和离线成本增加会挺多。</p>
<h2 id="安装-wp-super-cache"><a href="#安装-wp-super-cache" class="headerlink" title="安装 wp super cache"></a>安装 wp super cache</h2><p>官网下载地址：<a href="http://z9.io/wp-super-cache/" target="_blank" rel="external"> http://z9.io/wp-super-cache/ </a><br>【无法翻墙可参考小拽博文：<a href="http://cuihuan.net/article/%E4%B8%8D%E7%BF%BB%E5%A2%99%EF%BC%8C%E4%B8%8B%E8%BD%BDwordpress%E5%AE%98%E6%96%B9%E6%8F%92%E4%BB%B6%E5%B0%8F%E6%8A%80%E5%B7%A7.html"> 不翻墙，下载wordpress官方主题和插件小技巧 </a>】</p>
<p>注意：安装wp super cache 需要设定固定连接 如下图<br>推荐采用【自定义结果】：<a href="http://cuihuan.net/article/%postname%.html">http://cuihuan.net/article/%postname%.html</a><br>原因在于其他包含字母或者日期不太容易表意，也不利于阅读和seo等等。<br><a href="http://cuihuan.net/wp-content/uploads/2015/12/BEA1E968-7B4D-4CED-AC56-8E3F4A5A6F2C.png"><img src="http://cuihuan.net/wp-content/uploads/2015/12/BEA1E968-7B4D-4CED-AC56-8E3F4A5A6F2C-1024x546.png" alt="修改链接格式"></a></p>
<p>如果最初采用的是<a href="http://xxx/?p=xxx的方式，需要对服务器进行相关设置，否则会一直出现404。解决和设置办法，在另一篇文章中，此处不赘述（[wp" target="_blank" rel="external">http://xxx/?p=xxx的方式，需要对服务器进行相关设置，否则会一直出现404。解决和设置办法，在另一篇文章中，此处不赘述（[wp</a> super cache 安装和问题解决](<a href="http://cuihuan.net/article/wp%20super%20cache%20%E5%AE%89%E8%A3%85%E5%92%8C%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3.html)）。">http://cuihuan.net/article/wp%20super%20cache%20%E5%AE%89%E8%A3%85%E5%92%8C%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3.html)）。</a></p>
<p>安装成功后，后台设置中会出现wp super cache</p>
<h2 id="配置-wp-super-cache"><a href="#配置-wp-super-cache" class="headerlink" title="配置 wp super cache"></a>配置 wp super cache</h2><p>安装成功后的简单个人推荐设置。</p>
<p>通用-》启用cache：开启<br>高级-》启用缓存：开启<br>高级-》模式选择：推荐mode_rewrite 这个需要apache或者nginx进行相关设置，这个速度最快；如果不想设置，可以选择php缓存模式。<br>高级-》压缩页面：必选。<br>高级-》页面更新清除，评论更新清楚：推荐。作用是更新文章，评论之后触发缓存更新。<br>高级-》移动支持：推荐。<br>其他一些设置根据个人需求增加。</p>
<p>配置，更新之后，进入网站cache目录下会出现缓存的html文件和gzip的压缩文件（前提是设置了giz压缩）。</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@cuixiaohuan cuihuan.<span class="keyword">net</span>]# <span class="keyword">pwd</span></span><br><span class="line">xxx/wp-content/cache/supercache/cuihuan.<span class="keyword">net</span></span><br><span class="line">[root@cuixiaohuan cuihuan.<span class="keyword">net</span>]# <span class="keyword">ls</span> -lh</span><br><span class="line"><span class="keyword">total</span> 52K</span><br><span class="line">-rw-r--r-- 1 apache apache 40K <span class="keyword">Dec</span> 5 11:33 index.html</span><br><span class="line">-rw-r--r-- 1 apache apache 9.5K <span class="keyword">Dec</span> 5 11:33 index.html.gz</span><br></pre></td></tr></table></figure>
<h2 id="效果分析"><a href="#效果分析" class="headerlink" title="效果分析"></a>效果分析</h2><p>优化前数据：23ms感知页面；3.62s加载完成；页面大小：419k；请求个数：25个；<br>优化后数据：106ms感知页面；<code>1.81s</code>加载完成；页面大小<code>13.9k</code>；请求个数24个；</p>
<p>感知页面变慢：原因在于，原始php页面相对较小，传输也相对较快，传输基本框架之后，才进行页面dom绘制，js渲染，数据获取和再次渲染，所以感知时间原始的快。但是对于750ms以下的对于用户几乎都是无感知。</p>
<p>加载完成变快：最主要达到的效果，节省最多的时间在于数据库获取数据的时间。</p>
<p>页面大小变小：<code>这块小的有点出乎意外</code>，小是应该的，但是小这么多就有点🐂了；之后分析了下页面，可能和文章异步获取，存储的html只获取了部分页面的文章，同时，对jquery等等组件肯定是利用缓存，不计入数据大小了。</p>
<p>请求数目变化不大。</p>
<blockquote>
<p>整体效果：加载快了，页面小了。</p>
</blockquote>
<p>【转载请注明：<a href="http://cuihuan.net/article/%E3%80%90wordpress%E4%BC%98%E5%8C%96%E3%80%91wp-super-cache-%E9%9D%99%E6%80%81%E7%BC%93%E5%AD%98.html">【wordpress优化】压缩和使用静态缓存 </a> | <a href="http://cuihuan.net"> 靠谱崔小拽 </a>】</p>
]]></content>
      
        
        <tags>
            
            <tag> php </tag>
            
            <tag> 缓存 </tag>
            
            <tag> wordpress </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[crontab 误删除恢复]]></title>
      <url>/2015/12/03/crontab%20%E8%AF%AF%E5%88%A0%E9%99%A4%E6%81%A2%E5%A4%8D/</url>
      <content type="html"><![CDATA[<blockquote>
<p>操作过程中：crontab被全部干掉了，利用log恢复过程记录。</p>
</blockquote>
<h2 id="事故原因分析："><a href="#事故原因分析：" class="headerlink" title="事故原因分析："></a>事故原因分析：</h2><p>回忆自己操作过程中，未进行crontab的清空，网上查了下原因，并且复现了下。可能原因如下：</p>
<p><strong>如果在SSH远程终端中敲下“crontab”命令之后，远程连接被一些原因（比如 糟糕的网络，程序异常）意外终止了，那么Crontab计划任务就会被操作系统所清空。听起来很不可思议，但是经过在虚拟机上的多次测试，它确确实实的发生了。测试方式为 用SecureCRT开一个SSH窗口，然后敲下命令“crontab”，接着在“任务管理器”中直接杀掉SecureCRT进程，再通过另外一个SSH窗口执行“crontab -l”，就会发现，所有的计划任务都不存在了。在今天事故发生的时间点上，就有人在服务器上遇到了这样的情况。</strong></p>
<h2 id="恢复操作"><a href="#恢复操作" class="headerlink" title="恢复操作"></a>恢复操作</h2><ul>
<li><p>获取完整日志和cmd日志。<br>从日志中恢复出一份最近几天的完整crontab 运行日志和cmd日志，并存储，用于之后完善和核准例行时间。</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cat</span> /var/<span class="built_in">log</span>/cron | <span class="keyword">grep</span> -i <span class="string">"`which cron`"</span> &gt; ./all_temp</span><br><span class="line"><span class="keyword">cat</span>  ./all_temp | <span class="keyword">grep</span> -v <span class="comment">"&lt;command&gt;” &gt; ./cmd_temp</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>获取所有crontab指令。<br>从日志中恢复一份去重的crontab log。【相当于所有的crontab命令】</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk -F'(' '/crond/&#123;a[<span class="variable">$3</span>]=<span class="variable">$0&#125;</span>END&#123;<span class="keyword">for</span>(i <span class="keyword">in</span> a)<span class="keyword">print</span> a[i]&#125;' /<span class="keyword">var</span>/<span class="keyword">log</span>/cron* &gt;crontab.txt</span><br></pre></td></tr></table></figure>
</li>
<li><p>手工恢复：<br>从crontab.txt 中找出每一条指令，然后在cmd_temp 中匹配运行次数，重新编辑crontab 添加</p>
</li>
</ul>
<h2 id="反思工作"><a href="#反思工作" class="headerlink" title="反思工作"></a>反思工作</h2><p>防止类似事件再次发生，写个简单shell脚本，每天对crontab进行备份，备份最近15天的数据。过期清楚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 每天对crontab 进行备份 ，同时删除最近15天的数据</span></span><br><span class="line">DATE=$(date +%Y%m%d)</span><br><span class="line"></span><br><span class="line">crontab -l &gt; /home/work/bak/crontab_<span class="variable">$DATE</span>.bak</span><br><span class="line">find /home/work/bak/ -mtime +15 -name <span class="string">'*.bak'</span> -<span class="built_in">exec</span> rm -rf &#123;&#125; \;</span><br></pre></td></tr></table></figure></p>
<p><a href="http://cuihuan.net/?p=282"> 本人小站原文链接 </a></p>
]]></content>
      
        
        <tags>
            
            <tag> crontab </tag>
            
            <tag> linux </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[jsonp + php 跨域实例]]></title>
      <url>/2015/12/02/jsonp%20+%20php%20%E8%B7%A8%E5%9F%9F%E5%AE%9E%E4%BE%8B/</url>
      <content type="html"><![CDATA[<blockquote>
<p>由于跨域的存在，使资源交互在不同域名间变的复杂和安全。对于跨域数据传输，当数据长度较小(<strong>get的长度内</strong>)，jsonp是一种较好的解决方案。</p>
</blockquote>
<blockquote>
<p>分享一个自己在jsonp使用过程中的demo。<br>关于跨域可以参考：<a href="http://www.cnblogs.com/rainman/archive/2011/02/20/1959325.html" target="_blank" rel="external">跨域总结与解决办法</a></p>
</blockquote>
<h2 id="jsonp的js端调用"><a href="#jsonp的js端调用" class="headerlink" title="jsonp的js端调用"></a>jsonp的js端调用</h2><p>主要功能：通过jsonp向服务器，调用相应接口，获应数据；根据获取数据结果做出相应回调。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * jsonp demo</span><br><span class="line"> * 通过回调函数，进行获取之后的事件加载</span><br><span class="line"> *</span><br><span class="line"> * @author:cuihuan</span><br><span class="line"> * @private</span><br><span class="line"> */</span><br><span class="line">_jsonpDemo:<span class="function"><span class="keyword">function</span><span class="params">(callback)</span></span>&#123;</span><br><span class="line">    $.ajax(&#123;</span><br><span class="line">        url: <span class="string">"http://your_site_url"</span>,</span><br><span class="line">        <span class="built_in">type</span>: <span class="string">'GET'</span>,</span><br><span class="line">        dataType: <span class="string">'JSONP'</span>,</span><br><span class="line">        success: <span class="function"><span class="keyword">function</span> <span class="params">(data)</span></span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (data &amp;&amp; data.<span class="built_in">status</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (data.<span class="built_in">status</span> == <span class="string">"0"</span>) &#123;</span><br><span class="line">                    // failure solve</span><br><span class="line">                    ...</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (data.<span class="built_in">status</span> == <span class="number">500</span>) &#123;</span><br><span class="line">                    // server <span class="built_in">error</span> <span class="built_in">log</span></span><br><span class="line">                    _sendInternalLog(data.info);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (data.<span class="built_in">status</span> == <span class="number">1</span>) &#123;</span><br><span class="line">                    //success solve </span><br><span class="line">                    ...</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                // callback func</span><br><span class="line">               (callback &amp;&amp; typeof(callback) === <span class="string">"function"</span> ) &amp;&amp; callback(); </span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="built_in">error</span>: <span class="function"><span class="keyword">function</span> <span class="params">()</span></span> &#123;</span><br><span class="line">            _sendFailLog();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="jsonp-服务器端-php"><a href="#jsonp-服务器端-php" class="headerlink" title="jsonp 服务器端 (php)"></a>jsonp 服务器端 (php)</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 接口返回相应数据</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * status: 0 标示失败，1标示成功,500发生错误</span></span><br><span class="line"><span class="comment"> * return: jsonp </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">actionGetJsonPInfo</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        $data = getNeedData()</span><br><span class="line">        <span class="keyword">if</span> ($data[<span class="string">'status'</span>] == <span class="string">"success"</span>) &#123;</span><br><span class="line">            $res = <span class="keyword">array</span>(<span class="string">"status"</span> =&gt; <span class="string">"1"</span>, <span class="string">'info'</span> =&gt; $data[<span class="string">'info'</span>]);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            $res = <span class="keyword">array</span>(<span class="string">"status"</span> =&gt; <span class="string">"0"</span>, <span class="string">'info'</span> =&gt; <span class="string">'0'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">catch</span> (<span class="keyword">Exception</span> $e)&#123;</span><br><span class="line">        $res = <span class="keyword">array</span>(<span class="string">"status"</span> =&gt; <span class="string">"500"</span>, <span class="string">'info'</span>=&gt; $e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// jsonp 通过get请求的返回数据形式</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span> ($_GET[<span class="string">'callback'</span>])) &#123;</span><br><span class="line">        header(<span class="string">"Content-Type: application/json"</span>);</span><br><span class="line">        <span class="keyword">echo</span> $_GET[<span class="string">'callback'</span>].<span class="string">"("</span>.json_encode($res).<span class="string">")"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>目前来说，数据量小的跨域传输，jsonp是一种很好的解决方案。</li>
<li>jsonp在data中可以自动识别，res.status，res.info等状态位，比较方便。</li>
<li>php端的接受代码最好不要采用 Access-Control-Allow-Origin:* 风险太大。</li>
</ul>
<p><a href="http://cuihuan.net/?p=278"> 本人小站原文 </a></p>
]]></content>
      
        
        <tags>
            
            <tag> javascript </tag>
            
            <tag> cors </tag>
            
            <tag> 跨域 </tag>
            
            <tag> jsonp </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[php 操作不同数据库]]></title>
      <url>/2015/11/30/php%20%E6%93%8D%E4%BD%9C%E4%B8%8D%E5%90%8C%E6%95%B0%E6%8D%AE%E5%BA%93/</url>
      <content type="html"><![CDATA[<blockquote>
<p>php脚本经常，处理处理不同机器上，不同数据库之间数据；而且脚本特别容易写错，抽取了个工作中最常用到的多库同步，特此记忆！</p>
</blockquote>
<h2 id="上代码"><a href="#上代码" class="headerlink" title="上代码"></a>上代码</h2><p>举个php操作不同数据库，进行数据同步的栗子。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 同步库1的数据到库2</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>  ：cuihuan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>    ：2015-10-11</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">synchDbDiff</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 连接库1</span></span><br><span class="line">    $crowd_conn_1 = mysql_connect(<span class="string">'ip_1:port_1'</span>, <span class="string">'name_1'</span>, <span class="string">'pw_1'</span>);</span><br><span class="line">    <span class="keyword">if</span> (!$crowd_conn_1) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Could not connect:"</span> . mysql_error());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mysql_select_db(<span class="string">'test_data'</span>, $crowd_conn_1);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 连接库2</span></span><br><span class="line">    $crowd_conn_2 = mysql_connect(<span class="string">'ip_2:port_2'</span>, <span class="string">'name_2'</span>, <span class="string">'pw_2'</span>);</span><br><span class="line">    <span class="keyword">if</span> (!$crowd_conn_1) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Could not connect:"</span> . mysql_error());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mysql_select_db(<span class="string">'test_data'</span>, $crowd_conn_2);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取未同步的数据</span></span><br><span class="line">    $get_data_sql = <span class="string">"SELECT `id`, `text` FROM `fb_conversation` WHERE `flag` = 1"</span>;</span><br><span class="line">    $c_result = mysql_query($get_data_sql, $crowd_conn_1);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;check_res($c_result);</span><br><span class="line">    <span class="keyword">if</span> ($c_result) &#123;</span><br><span class="line">        <span class="keyword">while</span> ($row = mysql_fetch_array($c_result, MYSQL_NUM)) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 更新同步</span></span><br><span class="line">            $new_data_sql = <span class="string">"update from fb_conversation set text ="</span> . $row[<span class="number">1</span>] . <span class="string">"  where id = "</span> . $row[<span class="number">0</span>];</span><br><span class="line">            $res = mysql_query($new_data_sql, $crowd_conn_2);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;check_res($c_result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><a href="http://cuihuan.net/?p=275"> 个人小站原文链接 </a></p>
]]></content>
      
        
        <tags>
            
            <tag> php </tag>
            
            <tag> mysql </tag>
            
            <tag> 数据库同步 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[php 处理unicode解码]]></title>
      <url>/2015/11/28/php%20%E5%A4%84%E7%90%86unicode%E8%A7%A3%E7%A0%81/</url>
      <content type="html"><![CDATA[<blockquote>
<p>备忘：这个算是解码比较靠谱的，亲测。参考自stackoverflow，mark 分享</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// change unicode to unt-8</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">replace_unicode_escape_sequence</span><span class="params">($match)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mb_convert_encoding(pack(<span class="string">'H*'</span>, $match[<span class="number">1</span>]), <span class="string">'UTF-8'</span>, <span class="string">'UCS-2BE'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">unicode_decode</span><span class="params">($str)</span> </span>&#123;</span><br><span class="line"> <span class="keyword">return</span> preg_replace_callback(<span class="string">'/u([0-9a-f]&#123;4&#125;)/i'</span>, <span class="string">'replace_unicode_escape_sequence'</span>, $str); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$str = unicode_decode(<span class="string">'&#123;"u5173u952eu8bcd":[&#123;"","key":"u767eu5ea6"&#125;]&#125;'</span>);</span><br></pre></td></tr></table></figure>
<p>问题：使用过程中，遇到一个问题：就是当多次调用改函数的时候，出现错误。原因在于函数名方式调用问题。</p>
<p>如果编码是 \u5173\u952e\u8bcd 正则改为/\u([0-9a-f]{4})/i 即可<br><a href="http://cuihuan.net/?p=194"> 个人小站原文链接 </a></p>
]]></content>
      
        
        <tags>
            
            <tag> php </tag>
            
            <tag> unicode </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[phpUnit 安装，实例和简单部署]]></title>
      <url>/2015/11/28/phpUnit%20%E5%AE%89%E8%A3%85%EF%BC%8C%E5%AE%9E%E4%BE%8B%E5%92%8C%E7%AE%80%E5%8D%95%E9%83%A8%E7%BD%B2/</url>
      <content type="html"><![CDATA[<blockquote>
<p>背景：一个小脚本，保证稳定为主；所以试用了下phpunit，快捷方便</p>
</blockquote>
<h3 id="phpunit-的安装"><a href="#phpunit-的安装" class="headerlink" title="phpunit 的安装"></a>phpunit 的安装</h3><p>phpunit是一个轻量级的php单元测试框架，通过pear安装<br>安装过程<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https:<span class="comment">//phar.phpunit.de/phpunit.phar</span></span><br><span class="line">chmod +x phpunit.phar</span><br><span class="line">sudo mv phpunit<span class="selector-class">.phar</span> /usr/local/bin/phpunit</span><br><span class="line">phpunit --version</span><br></pre></td></tr></table></figure></p>
<p>成功之后显示如下:<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">cuihuan:</span>~ cuixiaohuan$ phpunit --version</span><br><span class="line">PHPUnit <span class="number">4</span>.<span class="number">8</span>.<span class="number">6</span> <span class="keyword">by </span><span class="keyword">Sebastian </span><span class="keyword">Bergmann </span><span class="keyword">and </span>contributors.</span><br></pre></td></tr></table></figure></p>
<h3 id="简单试用"><a href="#简单试用" class="headerlink" title="简单试用"></a>简单试用</h3><p>测试类集成框架</p>
<p><strong>class PsCaseTest extends PHPUnit_Framework_TestCase{}</strong></p>
<p>其中phpunit<br>默认首先执行 setup<br>默认最后执行 teardown</p>
<p>举个栗子：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line">/***************************************************************************</span><br><span class="line"> *</span><br><span class="line"> * $Id: PsCaseTest,v 1.0 PsCaseTest cuihuan Exp$</span><br><span class="line"> *</span><br><span class="line"><span class="php"> **************************************************************************/</span></span><br><span class="line"><span class="php"></span></span><br><span class="line">/**</span><br><span class="line"> * @file PsCaseTest.php</span><br><span class="line"> * @author cuihuan</span><br><span class="line"> * @date 2015/09/11 10:09:31</span><br><span class="line"> * @version $Revision:1.0$</span><br><span class="line"> * @brief  pscase接口单元测试</span><br><span class="line"> *</span><br><span class="line"><span class="php"> **/</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">require_once</span> dirname(<span class="keyword">__FILE__</span>) . (<span class="string">'/PsCase.php'</span>);</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">PsCaseTest</span> <span class="keyword">extends</span> <span class="title">PHPUnit_Framework_TestCase</span></span></span></span><br><span class="line"><span class="php">&#123;</span></span><br><span class="line">    /**</span><br><span class="line">     * @var object pscase类</span><br><span class="line"><span class="php">     */</span></span><br><span class="line"><span class="php">    <span class="keyword">protected</span> $pscase;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line">    /**</span><br><span class="line">     * @brief setup: Sets up the fixture, for example, opens a network connection.</span><br><span class="line">     *</span><br><span class="line">     * This method is called before a test is executed.  </span><br><span class="line"><span class="php">     */</span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setup</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">$this</span>-&gt;pscase = <span class="keyword">new</span> PsCase();</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line">    /**</span><br><span class="line">     * @brief teardown: Tears down the fixture, for example, closes a network connection.</span><br><span class="line">     * </span><br><span class="line">     * This method is called after a test is executed.</span><br><span class="line"><span class="php">     */</span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">teardown</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"></span></span><br><span class="line">    /**</span><br><span class="line">     * @brief : 测试config文件的获取</span><br><span class="line">     *</span><br><span class="line"><span class="php">     */</span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testGetConfig</span><span class="params">()</span></span></span></span><br><span class="line"><span class="php">    &#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">$this</span>-&gt;assertEquals(<span class="keyword">true</span>,<span class="keyword">$this</span>-&gt;pscase-&gt;debugText(<span class="string">"11"</span>));</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h3><p>运行方式：phpunit  —bootstrap [源文件] 测试文件<br>具体如下：<br><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cuihuande:newcode cuixiaohuan$ phpunit --bootstrap ./PsCase.php ./PsCaseTest.php</span><br><span class="line"></span><br><span class="line">32015<span class="string">-09</span><span class="string">-11</span> 02:09:36:11&lt;br&gt;</span><br><span class="line">5</span><br><span class="line"></span><br><span class="line"><span class="keyword">Time:</span> 116 ms, Memory: 11.75Mb</span><br><span class="line"></span><br><span class="line">OK (1 test, 1 assertion)  【表示运行成功】</span><br></pre></td></tr></table></figure></p>
<h3 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h3><p>部署就不不赘述了，写个shell脚本，crontab天极运行，加个报警邮件，简单的单元测试ok，从此再也不用担心错误和回归测试了。</p>
<p><a href="http://cuihuan.net/?p=260"> 个人小站原文链接 </a></p>
]]></content>
      
        
        <tags>
            
            <tag> php </tag>
            
            <tag> 单元测试 </tag>
            
            <tag> phpunit </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[【redis学习二】多php版本下phpredis扩展安装]]></title>
      <url>/2015/11/28/%E3%80%90redis%E5%AD%A6%E4%B9%A0%E4%BA%8C%E3%80%91%E5%A4%9Aphp%E7%89%88%E6%9C%AC%E4%B8%8Bphpredis%E6%89%A9%E5%B1%95%E5%AE%89%E8%A3%85/</url>
      <content type="html"><![CDATA[<blockquote>
<p>背景：安装完redis之后，需要安装phpredis扩展，才能让php操作redis；本机有多个php版本，安装过程中遇到的坑分享一下。</p>
</blockquote>
<p>##一 下载<br>git上下载redis的扩展包<br>    git clone <a href="https://github.com/nicolasff/phpredis" target="_blank" rel="external">https://github.com/nicolasff/phpredis</a></p>
<p>##二 挂载和configure<br>   在shell中输入 phpize 【注意：多个php版本的时候需要指定】<br>     ./configure<br>【phpize是用来扩展php扩展模块的，通过phpize可以建立php的外挂模块】</p>
<p>注意：（phpize 如果包含多个php，必须指定位置）<br>    cuihuan:phpredis cuixiaohuan$ ../php/bin/phpize<br>    Configuring for:<br>    PHP Api Version:         20121113<br>    Zend Module Api No:      20121212<br>    Zend Extension Api No:   220121212<br>    Cannot find autoconf. Please check your autoconf installation and the<br>    $PHP_AUTOCONF environment variable. Then, rerun this script.</p>
<p>报错的话需要安装：brew install autoconf  [phpize 报错] 否则没有phpize<br>    [work@cuixiaozhuai phpredis]$ ../php/bin/phpize<br>    Configuring for:<br>    PHP Api Version:         20041225<br>    Zend Module Api No:      20060613<br>    Zend Extension Api No:   220060519<br>    [work@cuixiaozhuai phpredis]$  ./configure –with-php-config=/home/work/thirdparty/php5/bin/php-config </p>
<p>当存在多个版本的php的时候，需要指定配置文件<br>     ./configure –with-php-config=/home/work/thirdparty/php5/bin/php-config </p>
<p>##三 编译和安装<br> make  之后最好make test<br>   make install<br>    cuihuan:phpredis cuixiaohuan$ make<br>    。。。<br>    Build complete.<br>    Don’t forget to run ‘make test’.</p>
<pre><code>cuihuan:phpredis cuixiaohuan$ make test
cuihuan:phpredis cuixiaohuan$ make install
</code></pre><p>##四 问题修复<br>【已修复，但是原因可能不太准确】<br>make编译报错<br>    .libs/redis_cluster.o(.data.rel.local+0x0): In function <code>ht_free_seed&#39;:
    /home/work/thirdparty/php5/php5/phpredis/redis_cluster.c:226:     multiple definition of</code>arginfo_scan’<br>    .libs/redis.o(.data.rel.local+0xe0):/home/work/thirdparty/php5/php5/p hpredis/redis.c:452: first defined here<br>    /usr/bin/ld: Warning: size of symbol <code>arginfo_scan&#39; changed from 160 in .libs/redis.o to 200 in .libs/redis_cluster.o
    .libs/redis_cluster.o(.data.rel.local+0xe0): In function</code>create_cluster_context’:<br>    /home/work/thirdparty/php5/php5/phpredis/redis_cluster.c:276:     multiple definition of `arginfo_kscan’<br>    .libs/redis.o(.data.rel.local+0x0):/home/work/thirdparty/php5/php5/phpredis/redis.c:364: first defined here<br>    collect2: ld returned 1 exit status<br>    make: *** [redis.la] Error 1</p>
<p>最初以为是php多个版本生成install问题，采用./configure 指定php版本，指定php位置。<br>但是效果还是有问题。<br>最终通过修改redis_cluester.c 中，注释掉了这两个重复的<br>      40 </p>
<pre><code>41 /* Argument info for HSCAN, SSCAN, HSCAN */

42 /*ZEND_BEGIN_ARG_INFO_EX(arginfo_kscan, 0, 0, 2)

43     ZEND_ARG_INFO(0, str_key)

44     ZEND_ARG_INFO(1, i_iterator)

45     ZEND_ARG_INFO(0, str_pattern)

46     ZEND_ARG_INFO(0, i_count)

47 ZEND_END_ARG_INFO();

48 */

49 

50 /* Argument infor for SCAN */

51 /*

52 ZEND_BEGIN_ARG_INFO_EX(arginfo_scan, 0, 0, 2)

53     ZEND_ARG_INFO(1, i_iterator)

54     ZEND_ARG_INFO(0, str_node)

55     ZEND_ARG_INFO(0, str_pattern)

56     ZEND_ARG_INFO(0, i_count)

57 ZEND_END_ARG_INFO();

58 */
</code></pre><p>##五 简单测试</p>
<pre><code>&lt;?php
    $redis = new Redis();
    $conn = $redis-&gt;connect(&apos;127.0.0.1&apos;,6379);

    echo &quot;redis pass and status show&lt;/br&gt;&quot;;
    var_dump($redis-&gt;ping());

    $redis-&gt;set(&apos;test_key&apos;,&apos;test_value&apos;);
    echo &quot;test set val=&quot;.$redis-&gt;get(&apos;test_key&apos;).&quot;&lt;/br&gt;&quot;;

    $redis-&gt;setnx(&apos;unique_key&apos;,&quot;unique_val&quot;);
    $redis-&gt;setnx(&apos;unique_key&apos;,&quot;unique_val_2&quot;);

    echo $redis-&gt;get(&quot;unique_key&quot;);

    sleep(60);
    echo &apos;is exist&apos;.$redis-&gt;exists(&apos;test_60s&apos;);
    echo &apos;not has value&apos;.$redis-&gt;get(&apos;test_60s&apos;);
    $redis-&gt;delete(&apos;test_key&apos;,&apos;test_60s&apos;);
</code></pre><p><a href="http://cuihuan.net/?p=248"> 个人小站原文链接 </a></p>
]]></content>
      
        
        <tags>
            
            <tag> php </tag>
            
            <tag> redis </tag>
            
            <tag> phpredis </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[【redis学习一】基本概念和基本操作]]></title>
      <url>/2015/11/28/%E3%80%90redis%E5%AD%A6%E4%B9%A0%E4%B8%80%E3%80%91%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%E5%92%8C%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C/</url>
      <content type="html"><![CDATA[<h2 id="redis-基础"><a href="#redis-基础" class="headerlink" title="redis 基础"></a>redis 基础</h2><p><strong>官网地址</strong>：<a href="http://redis.io/" target="_blank" rel="external"> http://redis.io/ </a></p>
<p><strong>基本介绍</strong>：redis 是一个ansi c编写，支持网络的，基于内存的可持久化的日执行，kv数据库；10年期redis有vmare主持开发。</p>
<p>支持数据类型：redis支持strings,hashes list set sorted等结构。</p>
<p>持久化：存储于内存或虚拟内存中，有两种持久化的方式：</p>
<ul>
<li>：截图，内存数据不断写入硬盘【性能较高】</li>
<li>：log：记录每次更新的日志。【稳定性好】</li>
</ul>
<p>支持主从同步，性能非常优秀。<br>提供多种语言的api  基本上知道的都有。</p>
<p>使用场景：(个人觉的可以有的使用场景)<br>1：权限【权限每次都要入库校验，放在前端不靠谱，放在cache最合适】<br>2：缓存【例如批量操作数据，可以先缓存】<br>3：预取【例如topN数据,另外可能用到的数据，提前取出来，加快页面加载】<br>4：构建消息队列【可以根据redis的数据结构list，构造；数据批量入库，加快页面相应等方面不错】。<br>5：计数器【类似于批量入库的原理，可以计数，redis原子性的，可以精确支持】<br>6：其他场景还在不断探索中。</p>
<h2 id="安装和基本操作"><a href="#安装和基本操作" class="headerlink" title="安装和基本操作"></a>安装和基本操作</h2><p>安装参考：<a href="http://www.runoob.com/redis/redis-install.html" target="_blank" rel="external"> http://www.runoob.com/redis/redis-install.html </a></p>
<p>基本操作：<a href="http://redisdoc.com/" target="_blank" rel="external"> 官方文档地址 </a></p>
<p>启动：./redis-server<br>关闭：redis-cli shutdown<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[cuihuan bin]$ ./redis-cli shutdown</span><br><span class="line">[cuihuan bin]$ ./redis-server    </span><br><span class="line">[<span class="number">325</span>] <span class="number">24</span> Sep <span class="number">18</span>:<span class="number">49</span>:<span class="number">06.632</span> # Warning: no config file specified, using the default config. In order to specify a config file use ./redis-server /path/to/redis.conf</span><br><span class="line">                <span class="symbol">_</span>.<span class="symbol">_</span>                                                 </span><br><span class="line">           <span class="symbol">_</span>.-``<span class="symbol">__</span> ''-.<span class="symbol">_</span>                                            </span><br><span class="line">      <span class="symbol">_</span>.-``    `.  `<span class="symbol">_</span>.  ''-.<span class="symbol">_</span>           Redis <span class="number">2.6</span>.10 (<span class="number">00000000</span>/<span class="number">0</span>) <span class="number">64</span> bit</span><br><span class="line">  .-`` .-```.  ```\/    <span class="symbol">_</span>.,<span class="symbol">_</span> ''-.<span class="symbol">_</span>                                  </span><br><span class="line"> (    '      ,       .-`  | `,    )     Running <span class="keyword">in</span> stand alone mode</span><br><span class="line"> |`-.<span class="symbol">_</span>`-...-` <span class="symbol">__</span>...-.``-.<span class="symbol">_</span>|'` <span class="symbol">_</span>.-'|     Port: <span class="number">6379</span></span><br><span class="line"> |    `-.<span class="symbol">_</span>   `.<span class="symbol">_</span>    /     <span class="symbol">_</span>.-'    |     PID: <span class="number">325</span></span><br><span class="line">  `-.<span class="symbol">_</span>    `-.<span class="symbol">_</span>  `-./  <span class="symbol">_</span>.-'    <span class="symbol">_</span>.-'                                  </span><br><span class="line"> |`-.<span class="symbol">_</span>`-.<span class="symbol">_</span>    `-.<span class="symbol">__</span>.-'    <span class="symbol">_</span>.-'<span class="symbol">_</span>.-'|                                 </span><br><span class="line"> |    `-.<span class="symbol">_</span>`-.<span class="symbol">_</span>        <span class="symbol">_</span>.-'<span class="symbol">_</span>.-'    |           http://redis.io       </span><br><span class="line">  `-.<span class="symbol">_</span>    `-.<span class="symbol">_</span>`-.<span class="symbol">__</span>.-'<span class="symbol">_</span>.-'    <span class="symbol">_</span>.-'                                  </span><br><span class="line"> |`-.<span class="symbol">_</span>`-.<span class="symbol">_</span>    `-.<span class="symbol">__</span>.-'    <span class="symbol">_</span>.-'<span class="symbol">_</span>.-'|                                 </span><br><span class="line"> |    `-.<span class="symbol">_</span>`-.<span class="symbol">_</span>        <span class="symbol">_</span>.-'<span class="symbol">_</span>.-'    |                                 </span><br><span class="line">  `-.<span class="symbol">_</span>    `-.<span class="symbol">_</span>`-.<span class="symbol">__</span>.-'<span class="symbol">_</span>.-'    <span class="symbol">_</span>.-'                                  </span><br><span class="line">      `-.<span class="symbol">_</span>    `-.<span class="symbol">__</span>.-'    <span class="symbol">_</span>.-'                                      </span><br><span class="line">          `-.<span class="symbol">_</span>        <span class="symbol">_</span>.-'                                          </span><br><span class="line">              `-.<span class="symbol">__</span>.-'                                              </span><br><span class="line"></span><br><span class="line">[<span class="number">325</span>] <span class="number">24</span> Sep <span class="number">18</span>:<span class="number">49</span>:<span class="number">06.633</span> # Server started, Redis version <span class="number">2.6</span>.10</span><br><span class="line">[<span class="number">325</span>] <span class="number">24</span> Sep <span class="number">18</span>:<span class="number">49</span>:<span class="number">06.633</span> # WARNING overcommit_memory <span class="built_in">is</span> set to <span class="number">0</span>! Background <span class="built_in">save</span> may fail under low memory condition. To <span class="built_in">fix</span> this issue add 'vm.overcommit_memory = <span class="number">1</span>' to /etc/sysctl.conf <span class="keyword">and</span> <span class="keyword">then</span> reboot <span class="keyword">or</span> run the command 'sysctl vm.overcommit_memory=<span class="number">1</span>' <span class="keyword">for</span> this to take effect.</span><br><span class="line">[<span class="number">325</span>] <span class="number">24</span> Sep <span class="number">18</span>:<span class="number">49</span>:<span class="number">06.673</span> * DB loaded from disk: <span class="number">0.039</span> seconds</span><br><span class="line">[<span class="number">325</span>] <span class="number">24</span> Sep <span class="number">18</span>:<span class="number">49</span>:<span class="number">06.673</span> * The server <span class="built_in">is</span> now ready to accept connections on port <span class="number">6379</span></span><br></pre></td></tr></table></figure></p>
<p>安装成功的标志 redis-cli 可以成功进入   </p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[cuihuan bin]$ ./redis-<span class="keyword">cli</span></span><br><span class="line">redis <span class="number">127.0</span><span class="meta">.0</span><span class="meta">.1</span>:<span class="number">6379</span>&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：使用过程中如果是保密性高的数据，可以设置登录密码，增加安全想；但如果是简单数据，则可以不设置，优点就是速度稍快。</p>
</blockquote>
<p>redis 基本配置：<br>daemonize: yes 标示在后台运行<br>bind：绑定请求的地址<br>port：端口号，默认6379<br>timeout:默认客户端连接超时  多长时间不操作关闭(默认永久，此处改为3600)</p>
<p>loglevel: log等级<br>databases：默认连接数据库的个数 【此处为8】<br>slaveof 主从库</p>
<p>masterauth :密码验证<br>requirepass:是否需要密码</p>
<p>maxclients :最大客户机个数 设置为10000<br>maxmemory:最大内存个数 6625156  [机器内存32G,分配大约6g]</p>
<p>最基本的操作<br>set name xxx<br>get name xxx<br>del name xxx<br>exists name xxx</p>
<p>举个栗子<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># <span class="selector-tag">get</span> <span class="selector-tag">val</span></span><br><span class="line"><span class="selector-tag">redis</span> 127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">get</span> <span class="selector-tag">name</span></span><br><span class="line">"<span class="selector-tag">cuixiaohuan</span>"</span><br><span class="line"></span><br><span class="line"># <span class="selector-tag">set</span> <span class="selector-tag">val</span> </span><br><span class="line"><span class="selector-tag">redis</span> 127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">set</span> <span class="selector-tag">name</span> <span class="selector-tag">cuixiaohuan_2</span> </span><br><span class="line"><span class="selector-tag">OK</span></span><br><span class="line"><span class="selector-tag">redis</span> 127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">get</span> <span class="selector-tag">name</span></span><br><span class="line">"<span class="selector-tag">cuixiaohuan_2</span>"</span><br><span class="line"></span><br><span class="line"># <span class="selector-tag">check</span> <span class="selector-tag">exists</span>; <span class="selector-tag">if</span> <span class="selector-tag">exists</span> <span class="selector-tag">return</span> 1</span><br><span class="line"><span class="selector-tag">redis</span> 127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">exists</span> <span class="selector-tag">name</span></span><br><span class="line">(<span class="selector-tag">integer</span>) 1</span><br><span class="line"></span><br><span class="line"># <span class="selector-tag">del</span> <span class="selector-tag">val</span></span><br><span class="line"><span class="selector-tag">redis</span> 127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">del</span> <span class="selector-tag">name</span></span><br><span class="line">(<span class="selector-tag">integer</span>) 1</span><br><span class="line"><span class="selector-tag">redis</span> 127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">get</span> <span class="selector-tag">name</span></span><br><span class="line">(<span class="selector-tag">nil</span>)</span><br></pre></td></tr></table></figure></p>
<p>其他常用操作：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># <span class="selector-tag">ping</span> <span class="selector-pseudo">:check</span> <span class="selector-tag">connect</span></span><br><span class="line"><span class="selector-tag">redis</span> 127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">ping</span></span><br><span class="line"><span class="selector-tag">PONG</span></span><br><span class="line"></span><br><span class="line"># <span class="selector-tag">dbsize</span> <span class="selector-pseudo">:check</span> <span class="selector-tag">size</span></span><br><span class="line"><span class="selector-tag">redis</span> 127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">dbsize</span></span><br><span class="line">(<span class="selector-tag">integer</span>) 1</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#flush</span> <span class="selector-pseudo">:clear</span> <span class="selector-tag">db</span></span><br><span class="line"><span class="selector-tag">redis</span> 127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">dbsize</span></span><br><span class="line">(<span class="selector-tag">integer</span>) 1</span><br><span class="line"><span class="selector-tag">redis</span> 127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">flushdb</span></span><br><span class="line"><span class="selector-tag">OK</span></span><br><span class="line"><span class="selector-tag">redis</span> 127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">dbsize</span></span><br><span class="line">(<span class="selector-tag">integer</span>) 0</span><br></pre></td></tr></table></figure></p>
<p><a href="http://cuihuan.net/?p=266"> 个人小站原文链接 </a></p>
]]></content>
      
        
        <tags>
            
            <tag> redis </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[canvas 生成和合并图片]]></title>
      <url>/2015/11/23/canvas_combine_pic/</url>
      <content type="html"><![CDATA[<blockquote>
<p>先说背景：工作中遇到一个问题，file组件上传图片，file是可以上传n张图片；但是，后台逻辑历史原因，只能展现一张。因此：考虑到成本，决定在前端<strong>将多张图片合并成一张给后端</strong>。</p>
</blockquote>
<h3 id="先上代码"><a href="#先上代码" class="headerlink" title="先上代码"></a>先上代码</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">_mergeImage2Canvas:<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 获取file上传和展现的图片。一般file上传之后，有个小图标展现。</span></span><br><span class="line">    <span class="keyword">var</span> imgs = $(<span class="string">".img_files"</span>);</span><br><span class="line">    <span class="keyword">if</span> (!imgs) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建原始图像</span></span><br><span class="line">    <span class="comment">// 原因：file上传之后，展现往往是个缩略图，无法取到真正大小</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; imgs.length; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> fbwImg   = <span class="built_in">document</span>.createElement(<span class="string">"img"</span>);</span><br><span class="line">        <span class="keyword">var</span> fbwImgID = <span class="string">"temp_img_id"</span> + i;</span><br><span class="line">        $(<span class="string">"#"</span> + fbwImgID).remove();</span><br><span class="line">        fbwImg.src   = imgs[i].src;</span><br><span class="line">        fbwImg.className     = <span class="string">"temp-img-class"</span>;</span><br><span class="line">        <span class="comment">// 不显示，仅供调用</span></span><br><span class="line">        fbwImg.style.display = <span class="string">"none"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 临时区域扩展</span></span><br><span class="line">        $(<span class="string">"#temp_section"</span>).append(fbwImg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 合并原始图片，生成一个新的base64 图片</span></span><br><span class="line">    <span class="keyword">var</span> getOriginImgBase64 = <span class="function"><span class="keyword">function</span> (<span class="params">oriImgs</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!oriImgs) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 获取canvas的宽高</span></span><br><span class="line">        <span class="comment">// 原因：canvas需要首先指定宽高，所以需要提前获取最终的宽高</span></span><br><span class="line">        <span class="keyword">var</span> maxWidth = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">var</span> height = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; oriImgs.length; i++) &#123;</span><br><span class="line">            <span class="keyword">var</span> img = oriImgs[i];</span><br><span class="line">            <span class="keyword">if</span> (img.width &gt; maxWidth) &#123;</span><br><span class="line">                maxWidth = img.width;</span><br><span class="line">            &#125;</span><br><span class="line">            height += img.height;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设定canvas</span></span><br><span class="line">        <span class="keyword">var</span> canvas    = <span class="built_in">document</span>.createElement(<span class="string">"canvas"</span>);</span><br><span class="line">        canvas.width  = maxWidth + <span class="number">10</span>;</span><br><span class="line">        canvas.height = height + <span class="number">10</span>;</span><br><span class="line">        <span class="keyword">var</span> ctx       = canvas.getContext(<span class="string">"2d"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 留5margin</span></span><br><span class="line">        <span class="keyword">var</span> dheight = <span class="number">5</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; oriImgs.length; j++) &#123;</span><br><span class="line">            <span class="keyword">var</span> img     = oriImgs[j];</span><br><span class="line">            <span class="keyword">var</span> cheight = img.height;</span><br><span class="line">            <span class="keyword">var</span> cwidth  = img.width;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 留5 margin</span></span><br><span class="line">            ctx.drawImage(img, <span class="number">5</span>, dheight, cwidth, cheight);</span><br><span class="line"></span><br><span class="line">            dheight = dheight + cheight + <span class="number">5</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生成的base64 放在需要的一个全局变量中。</span></span><br><span class="line">        fbw_img_data = canvas.toDataURL(<span class="string">'image/png'</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 清理</span></span><br><span class="line">        $(<span class="string">".temp_img_class"</span>).remove();</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 之所以使用timer，考虑到dom树如果没有加载完成，会取到高度有误差</span></span><br><span class="line">    <span class="keyword">var</span> imgTimer = <span class="literal">null</span>;</span><br><span class="line">    imgTimer = setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        getOriginImgBase64($(<span class="string">".temp_img_class"</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (imgTimer) &#123;</span><br><span class="line">            clearTimeout(imgTimer);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="number">300</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="合成效果"><a href="#合成效果" class="headerlink" title="合成效果"></a>合成效果</h3><p>图片一：小站logo</p>
<p><a href="http://cuihuan.net/wp-content/uploads/2015/11/cuihuan_title-1.jpg"><img src="http://cuihuan.net/wp-content/uploads/2015/11/cuihuan_title-1.jpg" alt="cuihuan_title (1)"></a> </p>
<p>图片二：小图标：<br><a href="http://cuihuan.net/wp-content/uploads/2015/11/del.png"><img src="http://cuihuan.net/wp-content/uploads/2015/11/del.png" alt="del"></a></p>
<p>合成效果：</p>
<p> <a href="http://cuihuan.net/wp-content/uploads/2015/11/下载.png"><img src="http://cuihuan.net/wp-content/uploads/2015/11/下载.png" alt="下载"></a></p>
<h3 id="原理简介"><a href="#原理简介" class="headerlink" title="原理简介"></a>原理简介</h3><p>主要是通过canvas 获取多个图片的base64编码，之后通过drawImage 函数合并和toDataUrl的方式合成。</p>
<h3 id="问题思考"><a href="#问题思考" class="headerlink" title="问题思考"></a>问题思考</h3><ul>
<li>问题一：必须支持canvas，否则还需要后台统一跑脚本处理。</li>
<li>问题二：性能消耗过大。append img 和base64代码对dom的消耗都挺大，尤其是在移动端，很容易造成崩溃。解决办法：设定最大宽度，将图片等比缩放，这样子就少了向dom扩展元素这部分的损耗。</li>
<li>问题三：base64 在传输上性能消耗也挺大，没有file原生的好。</li>
</ul>
<p>因此：出了必须前端搞定，最好的方式，还是在后台跑脚本运行合并。</p>
<p><a href="http://cuihuan.net/?p=253"> 个人小站原文链接 </a></p>
]]></content>
      
        
        <tags>
            
            <tag> 合成图片 </tag>
            
            <tag> canvas </tag>
            
            <tag> javascript </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Nginx实践一：centos apache更换为nginx]]></title>
      <url>/2015/11/18/Nginx%E5%AE%9E%E8%B7%B5%E4%B8%80%EF%BC%9Acentos%20apache%E6%9B%B4%E6%8D%A2%E4%B8%BAnginx/</url>
      <content type="html"><![CDATA[<blockquote>
<p>背景介绍： 阿里云，512M内存（最屌丝配置），搭建lamp 环境，除去 mysql分配了100M左右（这个不能再少了），http竟然占用了200多M，太庞大，决定换为较轻量级，高并发的nginx。</p>
</blockquote>
<h3 id="背景数据"><a href="#背景数据" class="headerlink" title="背景数据"></a>背景数据</h3><p>如下图所示：系统也就500M ,出了mysql占用的100M, httpd 占了1/2 还多（经常达到十几个进程），剩余50M，有时更少不能忍，经常造成数据库崩掉，写了个自动重启脚本，但觉的不是治本之策</p>
<pre><code># 统计apache 进程个数
ps aux|grep httpd | wc –l
</code></pre><p><a href="http://cuihuan.net/wp-content/uploads/2015/11/8C2E5AE4-0A5E-479E-8C20-1CFF0C35F6D7.png"><img src="http://cuihuan.net/wp-content/uploads/2015/11/8C2E5AE4-0A5E-479E-8C20-1CFF0C35F6D7-1024x621.png" alt="ngnix 服务器占用"></a></p>
<h3 id="解决策略"><a href="#解决策略" class="headerlink" title="解决策略"></a>解决策略</h3><ul>
<li>1：针对Apache进行优化。包括优化worker运行方式等等。可以参考<a href="https://linux.cn/article-5294-2.html" target="_blank" rel="external"> apache优化 </a></li>
<li>2 :更换轻量级服务器。采用nginx 或者lighthttpd等更轻量的服务器。传说中Nginx大法负载均衡和高并发略胜一筹，决定实践一把。</li>
</ul>
<h3 id="apache替换为nginx"><a href="#apache替换为nginx" class="headerlink" title="apache替换为nginx"></a>apache替换为nginx</h3><ul>
<li><p>1： 停掉apache<br>  sudo service httpd stop</p>
<p>注意：以防万一，最好不好提前卸掉。</p>
</li>
<li><p>2：安装nginx<br>  yum install nginx</p>
</li>
<li><p>3：启动nginx<br>  sudo nginx</p>
<p>安装成功之后，启动成功如下图 <a href="http://cuihuan.net/wp-content/uploads/2015/11/CB5A50FB-8B68-4F21-A6F4-BDC7AF6C93B2.png"><img src="http://cuihuan.net/wp-content/uploads/2015/11/CB5A50FB-8B68-4F21-A6F4-BDC7AF6C93B2-1024x302.png" alt="CB5A50FB-8B68-4F21-A6F4-BDC7AF6C93B2"></a></p>
</li>
<li>4：简单配置nginx<br>主要是简单修改下log【方便追查问题】 和 web_root 对应文件【快速启用网站】</li>
<li><p>5：重启nginx<br>  [root@iZ25xlozdf2Z nginx]# nginx -s quit<br>  [root@iZ25xlozdf2Z nginx]# nginx</p>
<p>如下图，配置web目录成功！ <a href="http://cuihuan.net/wp-content/uploads/2015/11/BAEF603F-CA9C-436E-B870-3E70C11542D0.png"><img src="http://cuihuan.net/wp-content/uploads/2015/11/BAEF603F-CA9C-436E-B870-3E70C11542D0.png" alt="BAEF603F-CA9C-436E-B870-3E70C11542D0"></a></p>
</li>
<li><p>6：添加php 支持<br>安装php-fpm<br>  yum install php-fpm</p>
<p>nginx.conf设置<br>  location ~ .php$ {</p>
<pre><code>root /var/www/html;
fastcgi_pass 127.0.0.1:9000;
fastcgi_index index.php;
fastcgi_param SCRIPT_FILENAME         /var/www/html$fastcgi_script_name;
include fastcgi_params;
</code></pre><p>  }</p>
</li>
<li><p>7：重新启动服务，网站回复。<br><a href="http://cuihuan.net/wp-content/uploads/2015/11/A8D2AD14-7AB9-4421-AF40-B1BE0A5355C3.png"><img src="http://cuihuan.net/wp-content/uploads/2015/11/A8D2AD14-7AB9-4421-AF40-B1BE0A5355C3-1024x718.png" alt="A8D2AD14-7AB9-4421-AF40-B1BE0A5355C3"></a></p>
</li>
<li>8：耗存简单对比 如下图：基本上节省了200M，虽然这个可能是运行初期数据；但是，还是确实轻了不少，每个服务占存基本上1/4，线程也少了不少。内存占用方面表现，感觉尚可，接下就看性能了 <a href="http://cuihuan.net/wp-content/uploads/2015/11/E773D2EE-2F51-4113-AAE1-939CD88DCAEE.png"><img src="http://cuihuan.net/wp-content/uploads/2015/11/E773D2EE-2F51-4113-AAE1-939CD88DCAEE-1024x667.png" alt="E773D2EE-2F51-4113-AAE1-939CD88DCAEE"></a></li>
</ul>
<h3 id="后续"><a href="#后续" class="headerlink" title="后续"></a>后续</h3><p>初次接触nginx，整体感觉还不错。后续，进行基本的防攻击，多端口设置，和性能配置。</p>
<p><a href="http://cuihuan.net/?p=225"> 个人小站原文链接 </a></p>
]]></content>
      
        
        <tags>
            
            <tag> php </tag>
            
            <tag> nginx </tag>
            
            <tag> apache </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Nginx实践二：nginx端口配置，域名重定向设置]]></title>
      <url>/2015/11/18/Nginx%E5%AE%9E%E8%B7%B5%E4%BA%8C%EF%BC%9Anginx%E7%AB%AF%E5%8F%A3%E9%85%8D%E7%BD%AE%EF%BC%8C%E5%9F%9F%E5%90%8D%E9%87%8D%E5%AE%9A%E5%90%91%E8%AE%BE%E7%BD%AE/</url>
      <content type="html"><![CDATA[<blockquote>
<p>nginx替换apache之后，需要进行两个基本设置，一是：域名绑定和重定向，防止盗链，死链，参考文章<a href="http://cuihuan.net/?p=154"> apache 防盗链 </a>；二是：设置多个端口，一个端口显然无法满足需求。</p>
</blockquote>
<h3 id="域名防盗链设置"><a href="#域名防盗链设置" class="headerlink" title="域名防盗链设置"></a>域名防盗链设置</h3><p>域名防盗链主要通过，设定服务器域名，非域名重定向到现有域名（相对于之前的黑名单，我太单纯了，流量可以重定向利用一下）。</p>
<p>配置nginx.conf</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># default 默认只能server_name 访问</span></span><br><span class="line"><span class="attribute">listen</span> <span class="number">80</span> default ;</span><br><span class="line"><span class="attribute">server_name</span> cuihuan.net;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重定向</span></span><br><span class="line"><span class="attribute">if</span> (<span class="variable">$host</span> != <span class="string">"cuihuan.net"</span>) &#123;</span><br><span class="line">    <span class="attribute">rewrite</span><span class="regexp"> ^/(.*)$</span> http://cuihuan.net/<span class="variable">$1</span> <span class="literal">permanent</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>解释：首先80端口默认只能域名访问 ，默认的域名cuihuan.net。 对于所有非cuihuan.net 的过来的数据直接引流的cuihuan.net。如下图【这个战斗力为五的渣渣还挂在我的页面】</p>
<p><img src="http://cuihuan.net/wp-content/uploads/2015/11/4BF263AE-6ACD-4634-9000-795C0FB5F323-1024x851.png" alt="4BF263AE-6ACD-4634-9000-795C0FB5F323"></p>
<p>进行了转码后还可以避免搜索引擎抓的域名出现死链。</p>
<p><a href="http://cuihuan.net/wp-content/uploads/2015/11/18AC69FB-9C9D-4CE6-8D9A-8F3BFC40D75C.png"><img src="http://cuihuan.net/wp-content/uploads/2015/11/18AC69FB-9C9D-4CE6-8D9A-8F3BFC40D75C-1024x467.png" alt="18AC69FB-9C9D-4CE6-8D9A-8F3BFC40D75C"></a></p>
<h3 id="配置多端口："><a href="#配置多端口：" class="headerlink" title="配置多端口："></a>配置多端口：</h3><p> 这个就简单了，直接把上面配置好的server copy一个挂上其他web服务或者phpadmin等等<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8002</span> default ;</span><br><span class="line">    <span class="attribute">server_name</span> cuihuan.net;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$host</span> != <span class="string">"cuihuan.net"</span>) &#123;</span><br><span class="line">        <span class="attribute">rewrite</span><span class="regexp"> ^/(.*)$</span> http://cuihuan.net/<span class="variable">$1</span> <span class="literal">permanent</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">root</span> /var/www/weixin;</span><br><span class="line">        <span class="attribute">index</span> index.php;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> <span class="regexp">~ \.php$</span> &#123;</span><br><span class="line">        <span class="attribute">root</span> /var/www/weixin;</span><br><span class="line">        <span class="attribute">fastcgi_pass</span> <span class="number">127.0.0.1:9000</span>;</span><br><span class="line">        <span class="attribute">fastcgi_index</span> index.php;</span><br><span class="line">        <span class="attribute">fastcgi_param</span> SCRIPT_FILENAME /var/www/weixin<span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">        <span class="attribute">include</span> fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment"># set nginx stutus</span></span><br><span class="line">   <span class="attribute">location</span> /NginxStatus&#123;</span><br><span class="line">        <span class="attribute">stub_status</span> <span class="literal">on</span>;</span><br><span class="line">        <span class="attribute">access_log</span> <span class="literal">on</span>;</span><br><span class="line">        <span class="attribute">auth_basic</span> <span class="string">"NginxStatus"</span>;</span><br><span class="line">        <span class="attribute">auth_basic_user_file</span> conf/htpasswd;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">#set deny all file</span></span><br><span class="line">    <span class="attribute">error_page</span> <span class="number">404</span> /<span class="number">404</span>.html;</span><br><span class="line">    <span class="attribute">location</span> = /var/www/wordpress/40x.html &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">error_page</span> <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span> /50x.html;</span><br><span class="line">    <span class="attribute">location</span> = /home/www/wordpress/50x.html &#123;</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>对于nginx搭建小网站来说，这个是基本的配置。个人感觉相对于之前<a href="http://cuihuan.net/?p=154"> apache 防盗链配置 </a>来说难易差不多。</p>
</blockquote>
<p> <a href="http://cuihuan.net/?p=225"> 相关文章：Nginx实践一：centos apache更换为nginx </a></p>
<p><a href="http://cuihuan.net/?p=241"> 个人小站原文链接 </a></p>
]]></content>
      
        
        <tags>
            
            <tag> nginx </tag>
            
            <tag> apache </tag>
            
            <tag> 服务器 </tag>
            
        </tags>
        
    </entry>
    
  
  
</search>
