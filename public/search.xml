<?xml version="1.0" encoding="utf-8"?>
<search> 
  
    
    <entry>
      <title><![CDATA[热点账户问题和常用解决方案【上】]]></title>
      <url>/2019/02/13/%E7%83%AD%E7%82%B9%E8%B4%A6%E6%88%B7%E9%97%AE%E9%A2%98%E5%92%8C%E5%B8%B8%E7%94%A8%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E3%80%90%E4%B8%8A%E3%80%91/</url>
      <content type="html"><![CDATA[<blockquote>
<p><strong>热点账户问题</strong>由来已久，也一直是账户系统设计中的一个难点和瓶颈！小拽将通过上中下三篇文章，介绍下热点账户的产生，解决方案和延伸应用！本篇重点介绍下什么是热点账户，通用财务账户系统如何设计！</p>
</blockquote>
<h2 id="一、热点账户问题"><a href="#一、热点账户问题" class="headerlink" title="一、热点账户问题"></a>一、热点账户问题</h2><h3 id="1-1-什么是热点账户"><a href="#1-1-什么是热点账户" class="headerlink" title="1.1 什么是热点账户"></a>1.1 什么是热点账户</h3><p><strong>热点账户</strong>：顾名思义，就是会被高频操作的账户！相较于普通的账户，热点账户相对数量不多，但操作频率极高！</p>
<p>热点账户从产生角度又可分两大类：</p>
<ul>
<li>富二代型：从产生之初就是热点账户，非常稳定。例如<strong>财务中公司的账户</strong>，每一笔资金操作都要经过公司出金账户，自然而然操作就会灰常频繁，此类账户还包括：<strong>大V账户</strong>，<strong>大KA账户</strong>等，此类账户所引起的问题是本文重点要解决的</li>
<li>暴发户型：本是普通账户，由于热点问题变为热点帐户。例如<strong>微博出轨女猪脚账户</strong>，<strong>诺贝尔奖获得者</strong>等等，由于热点事件造成的短时间热点！此类热点账户防不胜防，超出本文的攻击范围，暂不讨论。</li>
</ul>
<h3 id="1-2-热点账户问题"><a href="#1-2-热点账户问题" class="headerlink" title="1.2 热点账户问题"></a>1.2 热点账户问题</h3><p>热点账户在实际场景中是必然存在的，常常会成为用户系统的瓶颈！同时，热点账户问题也是高并发问题的延展，由于热点的不规则性，如何在高并发情况下，削峰填谷，弹性抗压！</p>
<h3 id="1-3-热点账户通用解决方案的价值"><a href="#1-3-热点账户通用解决方案的价值" class="headerlink" title="1.3 热点账户通用解决方案的价值"></a>1.3 热点账户通用解决方案的价值</h3><p>热点账户除了是账户体系的一个通用问题，他的解决方案也可以同步迁移到其他高并发，高一致性，分布不均匀等其他问题的解决上，例如微博热点问题，支付宝双11弹性变更，高频抢购问题等等。期望通过学习热点账户的八种解决方案，能够举一反三，应用于不同场景！</p>
<h2 id="二、如何设计一个财务账户"><a href="#二、如何设计一个财务账户" class="headerlink" title="二、如何设计一个财务账户"></a>二、如何设计一个财务账户</h2><p>在解决热点账户问题之前，先来看下如何设计一个简单的财务账户，来保障记账的安全！</p>
<h3 id="2-1-业务场景分析"><a href="#2-1-业务场景分析" class="headerlink" title="2.1 业务场景分析"></a>2.1 业务场景分析</h3><p>财务账户需要<strong>准确</strong>记录用户的资金变动过程和结果！因此设计一个简单财务账户至少要能包括两个部分：<strong>账户余额</strong>和<strong>账户流水</strong></p>
<p>便于理解，来张传统的账本，流水和余额一目了然<br><img src="/img/bVboaNB" alt="clipboard.png"></p>
<p><strong>账户流水</strong>：账户流水也就是通俗意义上的帐或者账单！针对某个账户，每一笔资金的变更都需要记录下来，并且保障<strong>准确，不可更改</strong>！同时如图所示，流水中需要包含单据产生的原因，来源，变更额等等</p>
<p><strong>账户余额</strong>：账户余额记录用户某个场景账户的当前资金额度！在复杂的业务场景中往往需要拆分出不同的子账户和账户模型。例如，未结算子账户，可提现子账户，冻结子账户，授信账户等等。</p>
<p>从业务场景上一个账户系统核心需要准确记录余额和流水，同时，必须保障记录的<strong>准确，完备，不可变更</strong>!</p>
<h3 id="2-2-技术层面拆解"><a href="#2-2-技术层面拆解" class="headerlink" title="2.2 技术层面拆解"></a>2.2 技术层面拆解</h3><h4 id="2-2-1-基本表方案"><a href="#2-2-1-基本表方案" class="headerlink" title="2.2.1 基本表方案"></a>2.2.1 基本表方案</h4><p>通过业务场景初步分析，基本的账户系统，需要三张基本表<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">账户基本信息：账户信息表</div><div class="line">子账户余额信息：账户余额表</div><div class="line">账户流水信息：账户流水表</div><div class="line"></div><div class="line">三张表基本关系</div><div class="line">账户信息表 <span class="number">1</span><span class="symbol">:N</span> 账户余额表</div><div class="line">账户余额表 <span class="number">1</span><span class="symbol">:N</span> 账户流水表</div><div class="line"></div><div class="line"><span class="comment">## 具体账户和用户的关联可以参考三户模型</span></div></pre></td></tr></table></figure></p>
<h4 id="2-2-2-表字段设计"><a href="#2-2-2-表字段设计" class="headerlink" title="2.2.2 表字段设计"></a>2.2.2 表字段设计</h4><p>从技术层面设计具体表细节关键要解决以下几个问题</p>
<ol>
<li>防重：幂等健设计</li>
<li>防改：链式设计</li>
<li>防错：销账设计</li>
</ol>
<p>简单的满足上面要求的账户设计参考innodb mvcc的设计，核心表字段如下</p>
<p><a href="http://cuihuan.net/wp_content/new/finance/finance_hot_account_1.png"><img src="http://cuihuan.net/wp_content/new/finance/finance_hot_account_1.png" alt="finance_hot_account_1"></a></p>
<h4 id="2-2-3-表字段解读"><a href="#2-2-3-表字段解读" class="headerlink" title="2.2.3 表字段解读"></a>2.2.3 表字段解读</h4><h5 id="2-2-3-1-幂等健设计"><a href="#2-2-3-1-幂等健设计" class="headerlink" title="2.2.3.1 幂等健设计"></a>2.2.3.1 幂等健设计</h5><p>通过<strong>资金凭证号+版本号+rollback</strong>三个字段作为uniq key来保证幂等</p>
<p><strong>资金凭证号</strong>：来自业务方，业务方发起资金操作的唯一财务凭证，必须可追溯上游凭证和对账！<br><strong>版本号</strong>：每次获取DB最新流水n后，版本号n+1插入，保障在并发情况下，每个子账户只有唯一一个版本号：n+1条记录能够插入成功！<br><strong>rollback</strong>：回滚标识，保证每条记录<strong>能且只能销账一次</strong>！</p>
<p>对于幂等建设计此处有三条小技巧</p>
<ol>
<li><strong>上游产生</strong>：每一个幂等健如果可能的话，尽可能的上游产生，这样可以最大限度的避免自产生幂等健的重复问题。如果确实不能上游产生，例如订单ID，提现单ID，那么也尽可能的分阶段产生，例如提现时，先生成提现单ID，真正提现操作的时候，一定是带着提现单ID和信息来的，防止重复造成资损！</li>
<li><strong>业务关联</strong>：幂等健的产生可以用ice生成，但是，最好能够和业务关联，因为通过业务强关联的幂等健可以无限回溯来容灾！比如，a用户的b订单进行c操作，uniq_key = a_b_c的话，也就是在任何情况下，无论多少次回溯，重试也只会有一个唯一的a_b_c，而ice生成则可能造成自回溯的时候插入多条！</li>
<li><strong>写库保证</strong>：这条原则是高一致高并发的基本原则！因为读取a，校验a，然后插入，必然会存在读写之间a变了，或者主从延时a已经变了，读了历史a。因此，幂等一定要通过写库保证或者最底层保证</li>
</ol>
<h5 id="2-2-3-2-链式设计"><a href="#2-2-3-2-链式设计" class="headerlink" title="2.2.3.2 链式设计"></a>2.2.3.2 链式设计</h5><p>链式设计是保证操作精准不可篡改的非常有效手段，但不是绝对完美的方式！</p>
<p>通过资金的<strong>before info，after info，版本号</strong>三个要素来保证一条资金记录一旦插入成功，前后置信息固化！</p>
<p>链式设计的情况下单条修改是不可能的，多条修改需要在保证条目不变的情况下重组资金，但是，整体资金不可变</p>
<p>解决多条修改的方式：分布式存储，通过选举来判定最终正确的链，来确认是否某条链发生了过程修改，这种设计有一个很时髦的名字：<strong>区块链</strong>！而每条流水的核心信息加密后也有了一个更加时髦的名字：<strong>比特币</strong>！</p>
<h5 id="2-2-3-3-销账设计"><a href="#2-2-3-3-销账设计" class="headerlink" title="2.2.3.3 销账设计"></a>2.2.3.3 销账设计</h5><p>销账设计在账户系统中是一直存在的，现实财务系统可以<strong>红销蓝抵</strong>，线上财务系统加了链式之后，基本上就只能采用<strong>蓝抵</strong></p>
<p>通过增加rollback字段，并且严格限制0|1，保证一条账务流水只能被抵销一次！</p>
<p>具体三张表详细字段，需要脱敏，就不贴了，参考上面，其中索引，字段大小，联合索引等设计根据自身业务场景兼容即可！</p>
<h2 id="小结：欲知后事如何，且听下回分解"><a href="#小结：欲知后事如何，且听下回分解" class="headerlink" title="小结：欲知后事如何，且听下回分解"></a>小结：欲知后事如何，且听下回分解</h2><p>本部分简单介绍了什么是热点账户和账户的基本设计，涵盖幂等健设计，链式设计等等！<br>下一篇重点分析下热点账户在链式设计下的问题，产生原因和八种基本解决方案</p>
]]></content>
      
        
        <tags>
            
            <tag> 财务系统 </tag>
            
            <tag> 系统设计 </tag>
            
            <tag> 热点账户 </tag>
            
            <tag> 安全性 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[财务系统设计【序】]]></title>
      <url>/2019/01/06/%E8%B4%A2%E5%8A%A1%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E3%80%90%E5%BA%8F%E3%80%91/</url>
      <content type="html"><![CDATA[<blockquote>
<p>新年伊始，组织团队小伙伴进行了一次头脑风暴，畅想了下财务系统2019的愿景，自己也思考颇多，决定针对【财务系统设计】做个专栏，落笔为记！</p>
</blockquote>
<h4 id="一、一次头脑风暴"><a href="#一、一次头脑风暴" class="headerlink" title="一、一次头脑风暴"></a>一、一次头脑风暴</h4><p>头脑风暴前，除了准备泡面，花生，矿泉水，还列了几个比较现实的问题</p>
<ul>
<li>公司：你做的事情，值多少钱？公司凭什么给你升职，涨薪？财务系统到底还能给公司带来多少收益？</li>
<li>自己：为什么要留下来？干一年财务系统，到底能给每个人带来多大成长？</li>
<li>目标：下次跳槽时，你希望自己成长成什么样子？</li>
<li>落地：规划每个人的模块方向，如何把<code>自身成长需求和业务成长</code>绑票？</li>
</ul>
<p>与我个人而言，期望通过这次头脑风暴，<strong>让团队小伙伴们能够对自己的模块有个规划，能够在业务成长的过程中实现个人技能成长，能够通过促进模块收益来提升自己薪资职级！</strong></p>
<p>无他，也希望各位看官能够思考一下</p>
<h4 id="二、财务系统设计专栏"><a href="#二、财务系统设计专栏" class="headerlink" title="二、财务系统设计专栏"></a>二、财务系统设计专栏</h4><p>头脑风暴后，小拽也一直在思考，2018年干了一年财务系统了，2019年如何搞？</p>
<p>具体的需求拆解，模块设计，架构图，暂时先不祭出来了，毕竟还需要深入的拆解和剖析！</p>
<p>但结合年初的flag，小拽决定2019年完善【<code>财务系统设计</code>】专栏^_^，期望能够通过专栏，<strong>自己能够体系化的梳理下财务系统，抽象出更通用的解决方案！</strong></p>
<p>废话不提先列下2018年亏欠的文章和目录，今年一定补上^_^！</p>
<ul>
<li>热点账户问题思考和常用解决方案</li>
<li>数据最终一致性保证</li>
<li>幂等健设计原则</li>
<li>全局ID生成思考和解决方案</li>
<li>财务系统异步和同步的思考</li>
<li>国际化账务系统思考</li>
<li>财务数仓有哪些坑？</li>
<li>通用账单分级模型设计</li>
<li>账户模型设计和思考</li>
<li>账户流水设计和思考</li>
</ul>
<h4 id="三、专栏目录"><a href="#三、专栏目录" class="headerlink" title="三、专栏目录"></a>三、专栏目录</h4><p>长远的看，小拽的财务模块设计最终会把所有文章落到各个模块中，暂时先梳理了下目录！</p>
<figure class="highlight nsis"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">财务系统专栏</div><div class="line">├── 在线系统设计和实现</div><div class="line">│   ├── 分账模块</div><div class="line">│   ├── 提现模块</div><div class="line">│   ├── 收银模块</div><div class="line">│   ├── 结算模块</div><div class="line">│   ├── 记账模块</div><div class="line">│   └── 账户模块</div><div class="line">├── 支撑系统设计和实现</div><div class="line">│   ├── MIS系统</div><div class="line">│   ├── openAPI</div><div class="line">│   ├── 任务系统</div><div class="line">│   ├── 财务网关</div><div class="line">│   ├── 数据质量中心</div><div class="line">│   └── 监控预警系统</div><div class="line">├── 数据中心设计和实现</div><div class="line">│   ├── <span class="params">ARCHIVE</span></div><div class="line">│   ├── GraphDB</div><div class="line">│   ├── HBASE</div><div class="line">│   ├── HIVE</div><div class="line">│   ├── KV</div><div class="line">│   ├── RDS</div><div class="line">│   └── TSDB</div><div class="line">└── 离线系统设计和实现</div><div class="line">    ├── 对账引擎</div><div class="line">    ├── 经营分析</div><div class="line">    ├── 结算引擎</div><div class="line">    ├── 财务报表</div><div class="line">    ├── 资金安全</div><div class="line">    └── 预算引擎</div></pre></td></tr></table></figure>]]></content>
      
        
        <tags>
            
            <tag> 财务系统 </tag>
            
            <tag> 系统设计 </tag>
            
            <tag> 业务系统 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[2018回顾]]></title>
      <url>/2019/01/02/2018/</url>
      <content type="html"><![CDATA[<blockquote>
<p>岁月不居，时光荏苒，本想写个2018的总结，结果2019都过2天了，三十功名已经泡汤，顺道写些2019展望吧！</p>
</blockquote>
<hr>
<h4 id="工作方面"><a href="#工作方面" class="headerlink" title="工作方面"></a>工作方面</h4><ul>
<li><p>工作方面，18年离开混了四年的狼厂母校，加入滴滴，没有了小伙伴和团队的呵护，只能独立面对，干了几件还算可以的事儿！花了四个月，从0到1的设计，开发了外卖财务在线系统；又花了四个月，搭建了财务离线系统和支撑系统；最后四个月，财务系统国际化改造！整体来说，成长很快，日子很燃，业务波动大！对于自己，无论从技术架构、业务成长、团队建设，既是机遇也是挑战。2019支撑业务发展的同时，需要加深技术的深度和体系化，增强技能外的视野^_^！</p>
</li>
<li><p>19年个人成长立个flag吧，<strong>一年多没更新的博客重新捡起来，做到每月至少一篇！总计达标20篇吧，其中至少有两篇是技能外的</strong></p>
</li>
</ul>
<hr>
<h4 id="投资方面"><a href="#投资方面" class="headerlink" title="投资方面"></a>投资方面</h4><ul>
<li><p>18年可谓过山车，年中股票整体收益高达150%，年底落到了20%多，总算没亏。教训就是，<strong>止损一定要果断！果断！果断！</strong>经济低迷的环境下，基金逐步加仓，等待周期！投资个小桶装水厂，也是亏了，经验一句话：<strong>做生意，人非常重要，一定想清楚了再干</strong>！18年看好半导体，19年目前比较看好健康体检，旅游领域。19年的核心调整自己的资产配置，按着二八原则递归！实体行业暂时先观望</p>
</li>
<li><p>19年投资方面flag不变，继续保持每周读经济周刊！</p>
</li>
</ul>
<hr>
<h4 id="生活方面"><a href="#生活方面" class="headerlink" title="生活方面"></a>生活方面</h4><ul>
<li><p>18年有些波澜不惊，在媳妇的组织下，爸妈哥嫂全家旅游了一趟，毕业后一直没有好好陪过父母，多少弥补了些遗憾。年底和媳妇儿去了趟台湾，互联网方面太落后了，吃老本而已，以后也不会再去了！年末赶上天朝洪恩，买了共有产权房，位置很喜欢，上下班方便！大事儿就这些，哈哈，整体感觉自己变懒了，很多事情都是媳妇儿在张罗维持，需要反思！2019期望，自己能够腾出更多的时间和媳妇在国内好好逛逛，毕竟三人世界很快就要替代二人世界了！</p>
</li>
<li><p>19年在生活方面立个flag，哈哈，就不在这里说了，感恩家庭</p>
</li>
</ul>
<hr>
<h4 id="兴趣方面"><a href="#兴趣方面" class="headerlink" title="兴趣方面"></a>兴趣方面</h4><ul>
<li><p>2018新get两个技能，一个是无人机，很喜欢，换一个角度看看世界，很不一样，后面也逐步学习下原理和拍摄技巧；另一个勉强算是羽毛球了，哈哈，不过现在还是苍蝇拍，也没啥提升的兴趣了，挺好的健身途径，目标保持体重！2019，期望新增一门技能：做饭，最好能考个证(<code>初步查了下新东方厨师周末班都要6000，真贵</code>)，毕竟程序员的未来都是开饭店，提前做好准备！</p>
</li>
<li><p>2019 年兴趣爱好方面立个flag，能做一桌菜！</p>
</li>
</ul>
<hr>
<p>想说的很多，但是没喝点酒，吹不起来，18年先这样子吧O(∩_∩)O</p>
<p>最后致谢，感谢老婆和家人的支持，有了你们坚实后盾，怎么走都是路！感谢工作中小伙伴，有了你们的信任和配合，稳如狗！</p>
<p><strong>2018，不管愿不愿意，已经成为过去，让我们在2019继续努力，以梦为马，不负韶华！</strong></p>
]]></content>
      
        
        <tags>
            
            <tag> 年终回顾 </tag>
            
            <tag> 2018 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[理解php单例模式]]></title>
      <url>/2017/06/28/%E7%90%86%E8%A7%A3php%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/</url>
      <content type="html"><![CDATA[<blockquote>
<p>单例作为一个最经典的设计模式之一，到底什么是单例？为什么要用单例？怎么设计单例？php中单例如何具体实现？</p>
</blockquote>
<h1 id="一、什么是单例"><a href="#一、什么是单例" class="headerlink" title="一、什么是单例"></a>一、什么是单例</h1><p>wiki百科：单例模式，也叫单子模式，是一种常用的软件设计模式。 在应用这个模式时，单例对象的类必须保证只有一个实例存在。 许多时候整个系统只需要拥有一个的全局对象，这样有利于我们协调系统整体的行为。</p>
<p>通俗的说，也就是对于<code>某一个功能只能实例化一个对象</code>。</p>
<h1 id="二、为什么用单例"><a href="#二、为什么用单例" class="headerlink" title="二、为什么用单例"></a>二、为什么用单例</h1><p>实际项目中像数<code>据库查询，日志输出，全局回调，统一校验</code>等模块。这些模块<code>功能单一</code>，但需要<code>多次访问</code>，如果能够<code>全局唯一，多次复用</code>会大大提升性能。这也就是单例存在的必要性。</p>
<p>单例模式的好处：</p>
<ul>
<li>1：减少频繁创建，节省了cpu。</li>
<li>2：静态对象公用，节省了内存。</li>
<li>3：功能解耦，代码已维护。</li>
</ul>
<h1 id="三、如何设计单例"><a href="#三、如何设计单例" class="headerlink" title="三、如何设计单例"></a>三、如何设计单例</h1><p>通过上面的描述，单例的核心是，<code>实例一次生成，全局唯一，多次调用</code>。因此在单例模式必须包含三要素：</p>
<ul>
<li>1：私有化构造函数，私有化clone。也就是不能new，不能clone。【唯一】</li>
<li>2：拥有一个静态变量，用于保存当前的类。【唯一如何保存】</li>
<li>3：提供一个公共的访问入口。【可以访问】</li>
</ul>
<h1 id="四、php实现"><a href="#四、php实现" class="headerlink" title="四、php实现"></a>四、php实现</h1><p>php 实现的单例模式<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?php</span></span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">XiaozhuaiSingleton</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// 私有化构造方法</span></div><div class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 私有化clone方法</span></div><div class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">__clone</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">// 保存实例的静态对象</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> $singleInstance;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 声明静态调用方法</div><div class="line">     * 目的：保证该方法的调用全局唯一</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> XiaozhuaiSingleton</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getInstance</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (!<span class="keyword">self</span>::$singleInstance) &#123;</div><div class="line">            <span class="keyword">self</span>::$singleInstance = <span class="keyword">new</span> <span class="keyword">self</span>();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">self</span>::$singleInstance;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">// 调用单例的方法</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">singletonFunc</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">echo</span> <span class="string">"call single ton method"</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">$singleInstance = XiaozhuaiSingleton::getInstance();</div><div class="line">$singleInstance-&gt;singletonFunc();</div><div class="line"></div><div class="line">$singleInstance2 = XiaozhuaiSingleton::getInstance();</div><div class="line">$singleInstance2-&gt;singletonFunc();</div><div class="line"></div><div class="line"><span class="comment">// 校验是否是一个实例</span></div><div class="line">var_dump($singleInstance === $singleInstance2);  <span class="comment">// true ，一个对象</span></div></pre></td></tr></table></figure></p>
]]></content>
      
        
        <tags>
            
            <tag> php </tag>
            
            <tag> 单例模式 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[php进程通信]]></title>
      <url>/2017/06/21/php%E8%BF%9B%E7%A8%8B%E9%80%9A%E4%BF%A1/</url>
      <content type="html"><![CDATA[<blockquote>
<p>PHP间进程如何通信，PHP相关的服务的IPC是实现方式，IPC的思想如何用到项目中。</p>
</blockquote>
<h1 id="一、linux进程间通信"><a href="#一、linux进程间通信" class="headerlink" title="一、linux进程间通信"></a>一、linux进程间通信</h1><p>理解php间进程通信机制，先了解下linux进程间有哪些通讯机制</p>
<h2 id="1-1-历史发展"><a href="#1-1-历史发展" class="headerlink" title="1.1 历史发展"></a>1.1 历史发展</h2><p>linux ipc 按照历史来源主要有两大块</p>
<ul>
<li>AT&amp;T的system v IPc:管道，FIFO，信号</li>
<li>BSD的socket Ipc :消息队列，共享内存，信号灯。</li>
</ul>
<p><img src="https://www.ibm.com/developerworks/cn/linux/l-ipc/1.gif" alt="进程发展"></p>
<h2 id="1-2-主要方式"><a href="#1-2-主要方式" class="headerlink" title="1.2 主要方式"></a>1.2 主要方式</h2><p>总结起来主要有以下六种方式</p>
<ul>
<li>1：管道【pipe】：主要是<code>有关系的进程之间</code>的通讯，例如ls xx |grep xx。</li>
<li>2：信号【signal】：通过<code>中间进程</code>来管理进程之间的通讯，属于比较复杂的进程间通讯方式。</li>
<li><p>3：消息队列【message】：消息的链接表，进程生产和消费消费消息队列。</p>
<ul>
<li>优势：克服了信号量承载的消息少，管道只能用规定的字节流，同时受到缓冲区大小的约束的问题 （而且读写是有队列的，有一个写，就只有一个能读到，比较简单，不需要同步和互斥）</li>
<li>缺点：太过简单，处理复杂情况可能会造成饥饿现象</li>
</ul>
</li>
<li><p>4：共享内存。多个进程访问同一个内存区。<code>最快的IPC方式</code>，但是需要处理进程间的<code>同步和互斥</code>。 同时也是<code>当下使用最广泛的IPC</code>，例如nginx，框架通讯，配置中心都是该原理。</p>
</li>
<li>5：信号量【semaphore】：主要作为<code>进程间，以及进程内部线程之间</code>的通讯手段。nginx早起的channel机制就类似于信号量</li>
<li>6：套接字【socket】：<code>不同机器之间</code>的通讯手段。处于tcp-》socket-》http之间的一个协议。</li>
</ul>
<h1 id="二、php进程通讯有哪些方式"><a href="#二、php进程通讯有哪些方式" class="headerlink" title="二、php进程通讯有哪些方式"></a>二、php进程通讯有哪些方式</h1><p>最好的语言php有哪些IPC的方式</p>
<ul>
<li>pcntl扩展：主要的进程扩展，完成进程的创建，子进程的创建，也是当前使用比较广的多进程。</li>
<li>posix扩展：完成posix兼容机通用api,如获取进程id,杀死进程等。主要依赖 IEEE 1003.1 (POSIX.1) ，兼容posix</li>
<li>sysvmsg扩展：实现system v方式的进程间通信之消息队列。</li>
<li>sysvsem扩展：实现system v方式的信号量。</li>
<li>sysvshm扩展：实现system v方式的共享内存。</li>
<li>sockets扩展：实现socket通信，跨机器，跨平台。</li>
</ul>
<p>php也有一些封装好的异步进程处理框架：例如swoole,workman等</p>
<h1 id="三、与php相关的IPC"><a href="#三、与php相关的IPC" class="headerlink" title="三、与php相关的IPC"></a>三、与php相关的IPC</h1><h2 id="3-1-nginx的IPC"><a href="#3-1-nginx的IPC" class="headerlink" title="3.1 nginx的IPC"></a>3.1 nginx的IPC</h2><p>nginx的ipc主要有两种：</p>
<ul>
<li><p>早期：channel 机制：类似于信号，标示不同进程以及进程与子进程之间的套接字，同时具有继承关系。<br>缺点：过于复杂，也产生了过多的套接字，造成存储浪费。</p>
</li>
<li><p>当前主流：共享内存方式：快，写入数据少，方便。</p>
</li>
</ul>
<blockquote>
<p>具体可以参见这篇文章：写的非常好 <a href="https://rocfang.gitbooks.io/dev-notes/content/nginxzhong_de_jin_cheng_jian_tong_xin.html" target="_blank" rel="external">https://rocfang.gitbooks.io/dev-notes/content/nginxzhong_de_jin_cheng_jian_tong_xin.html</a></p>
</blockquote>
<h2 id="3-2-apache的IPC"><a href="#3-2-apache的IPC" class="headerlink" title="3.2 apache的IPC"></a>3.2 apache的IPC</h2><p>apache：<a href="https://arrow.apache.org/docs/ipc.html" target="_blank" rel="external">https://arrow.apache.org/docs/ipc.html</a></p>
<h1 id="四、实际应用中的IPC"><a href="#四、实际应用中的IPC" class="headerlink" title="四、实际应用中的IPC"></a>四、实际应用中的IPC</h1><p>在平时的项目中，类似于php和linux的IPC的思想大量存在，深入理解。</p>
<ul>
<li><p>socket方式：不同项目间通讯，跨机微服务等等，也是使用最广泛的IPC。</p>
</li>
<li><p>共享内存方式：配置中心，公共数据库，甚至git都可以看做共享内存的衍生；`共享内存就必须要注意同步和互斥。</p>
</li>
<li>cache ：是共享内存和管道结合的思想</li>
<li>项目流式架构：管道的方式，可以大量的节省空间和时间的通讯方式。</li>
</ul>
<p>【转载请注明：<a href="http://cuihuan.net/2017/06/21/php进程通信/">php进程通信</a> | <a href="http://cuihuan.net">靠谱崔小拽</a> 】</p>
]]></content>
      
        
        <tags>
            
            <tag> php </tag>
            
            <tag> ipc </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[CodeIgniter 性能优化]]></title>
      <url>/2017/06/05/CodeIgniter%20%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/</url>
      <content type="html"><![CDATA[<blockquote>
<p>背景：部署一套PHP微服务接口，需要兼顾性能，开发效率，扩展性。权衡后选择了CodeIgniter；同时优化框架的默认启动项，在qps1000+的压力下整个<code>启动时间优化到5ms</code>左右。</p>
</blockquote>
<h2 id="一、选型"><a href="#一、选型" class="headerlink" title="一、选型"></a>一、选型</h2><ul>
<li>背景：使用php作为微服务的接口，具有一定的性能要求和并发要求。</li>
<li>方案：<ul>
<li>1：选一个轻量的php框架。具有简单高效的路由，模块化即可。</li>
<li>2：在框架的基础上，自定义的优化</li>
</ul>
</li>
</ul>
<p>从以下几个角度做了简单的比较</p>
<h3 id="1-1-不同框架的性能"><a href="#1-1-不同框架的性能" class="headerlink" title="1.1 不同框架的性能"></a>1.1 不同框架的性能</h3><p><a href="https://www.ruilog.com/blog/view/b6f0e42cf705.html" target="_blank" rel="external">https://www.ruilog.com/blog/view/b6f0e42cf705.html</a><br><a href="http://cuihuan.net/wp_content/new/codeIgniter/performance.png"><img src="http://cuihuan.net/wp_content/new/codeIgniter/performance.png" alt="ci performance"></a></p>
<p>列举了很多数据，除了直接写php之外，ci和lumen的并发和性能不错，在考虑范围内。</p>
<h3 id="1-2-从流行度上看。"><a href="#1-2-从流行度上看。" class="headerlink" title="1.2 从流行度上看。"></a>1.2 从流行度上看。</h3><p>github排名前四的是laravel,symfony,ci,yii2。最火的是laravel毋庸置疑。但前四均在考虑范围内</p>
<p><a href="http://cuihuan.net/wp_content/new/codeIgniter/githup_php.png"><img src="http://cuihuan.net/wp_content/new/codeIgniter/githup_php.png" alt="ci github"></a></p>
<h3 id="1-3-从文档来看。"><a href="#1-3-从文档来看。" class="headerlink" title="1.3 从文档来看。"></a>1.3 从文档来看。</h3><p>laraval,ci,yii的中文社区都还不错。</p>
<p>综合考虑之后，在满足功能的情况下，选择性能最好，也易入手的codeIgniter作为基础框架。（<code>整个包才2.5M，删除了web文件夹后更小</code>）</p>
<h2 id="二、30ms-到10ms-粗读代码"><a href="#二、30ms-到10ms-粗读代码" class="headerlink" title="二、30ms+到10ms[粗读代码]"></a>二、30ms+到10ms[粗读代码]</h2><p>框架的基本部署，直接参考官网：<a href="https://codeigniter.org.cn/" target="_blank" rel="external">https://codeigniter.org.cn/</a></p>
<h3 id="2-1-问题描述"><a href="#2-1-问题描述" class="headerlink" title="2.1 问题描述"></a>2.1 问题描述</h3><p>配置了数据库之后，添加了一个默认的controller，一个model，默认加载时间竟然30ms+—_-。瞬间懵逼了，nginx+fpm也就1-2ms，框架竟然30ms，肯定那里配置错了，决定沿着路由追一下。</p>
<h3 id="2-2-问题追查"><a href="#2-2-问题追查" class="headerlink" title="2.2 问题追查"></a>2.2 问题追查</h3><p>沿着ci的路由顺序追查，从index入，一步一步卡时间。[<code>括号内为运行到的总计数</code>]</p>
<p>-》index.php [<code>1ms</code>]<br>-》core/CodeIgniter.php<br>-》加载常量[<code>1ms</code>]<br>-》加载common(包括log，show，error,is_https等)[1ms]load hooks [<code>2ms</code>]<br>-》加载autoload 方法<br>-》加载benchmark<br>-》实例化hooks<br>-》实例化pre_controller<br>-》实例化post_controller_constructor<br>-》实例化post_controller<br>-》实例化post_system<br>-》加载config [<code>3ms</code>]<br>-》加载扩展mbstring,iconv,hash,stardard<br>-》load 组件utf8，uri<br>-》load router [<code>4ms</code>]<br>-》load output，input，lang[<code>5ms</code>]<br>-》autoload package,cinfig,helper,language,driver,lib,model,db,cache<br>-》404 &amp;empty$…handle [<code>31ms</code>]<br>-》controller remap（测试性能写了个remap）[<code>35ms</code>]<br>-》controller 业务逻辑 [<code>35ms</code>]</p>
<p>这个ci的加载过程之后，基本一幕了然，在autoload里面耗时25ms。然后对autoload里面8个组件一个一个分析。</p>
<h3 id="2-3-问题原因"><a href="#2-3-问题原因" class="headerlink" title="2.3 问题原因"></a>2.3 问题原因</h3><p>分析完之后，处理特别简单，下面这行代码<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$autoload[<span class="string">'libraries'</span>] = <span class="keyword">array</span>(<span class="string">'database'</span>);</div></pre></td></tr></table></figure></p>
<p>ci 出于单例和复用角度考虑，选择<code>默认加载database</code>，也就是mysql在框架初始化的过程中默认初始化了。<br>mysql链接在并发情况下，init基本上要耗费10-30ms。直接干掉。<br>干掉之后，压测基本上在10ms左右。</p>
<h2 id="三、从10ms到5ms-细看代码"><a href="#三、从10ms到5ms-细看代码" class="headerlink" title="三、从10ms到5ms [细看代码]"></a>三、从10ms到5ms [细看代码]</h2><h3 id="3-1-优化目标"><a href="#3-1-优化目标" class="headerlink" title="3.1 优化目标"></a>3.1 优化目标</h3><p>优化了配置等之后，ci在高并发下依然有10ms左右的加载时间，需要结合自身逻辑优化下，删减掉部分不需要的功能和组件。</p>
<h3 id="3-2-代码分析"><a href="#3-2-代码分析" class="headerlink" title="3.2 代码分析"></a>3.2 代码分析</h3><p>之前在追查问题的过程中，粗读了一遍代码的流程。<br>而需要进一步优化，就需要细看每个模块函数的功能，干掉不需要的，逐步优化。</p>
<p>-》index.php </p>
<ul>
<li>作用：加载了部分全局变量，文件路径等入口</li>
<li>优化：干掉了整个web文件，调整了部分路径</li>
</ul>
<p>-》core/CodeIgniter.php</p>
<ul>
<li>作用：ci的核心文件，基本上加载了整个模块</li>
<li>优化：进入内部优化</li>
</ul>
<p>-》加载common.php</p>
<ul>
<li>作用：框架特别基本的一些函数log，show，error，is_xxx等，800行左右代码</li>
<li>优化：暂时未处理</li>
</ul>
<p>-》composer autoload func<br>-》加载benchmark </p>
<ul>
<li>作用：benchmark性能追查工具，设置了全局的开始和结束时间</li>
<li>优化：<code>直接干掉</code>，全局处理。但是性能需要卡，就在index中初始化了一个入库的timer<figure class="highlight lasso"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 定义全局开始追查</span></div><div class="line"><span class="built_in">list</span>($msec, $sec) = explode(<span class="string">' '</span>, microtime());</div><div class="line"><span class="class"><span class="keyword">define</span></span>(<span class="string">'START_TIME'</span>, (float)sprintf(<span class="string">'%.0f'</span>, (floatval($msec) + floatval($sec)) * <span class="number">1000</span>));</div><div class="line"><span class="comment">// 定义全局uuid</span></div><div class="line"><span class="class"><span class="keyword">define</span></span>(<span class="string">'UUID'</span>, uniqid(<span class="string">'xxx'</span>, <span class="literal">true</span>));</div></pre></td></tr></table></figure>
</li>
</ul>
<p>-》实例化hooks和预变量 </p>
<ul>
<li>作用：设计特别棒，对于一些hook或者针对不同模块的预加载函数。</li>
<li>优化：<code>直接干掉</code>，7,8个hook后期用到再针对性添加</li>
</ul>
<p>-》加载config </p>
<ul>
<li>作用：对应的是ci的get_config等函数，加载了base_url,uri,cache path等 。</li>
<li>优化：<code>直接干掉</code>，全局变量占用需要自己加就行，这种不可控的干掉</li>
</ul>
<p>-》加载扩展mbstring,iconv,hash,stardard</p>
<ul>
<li>作用：一些额外的扩展。</li>
<li>优化：<code>直接干掉</code>，试了下干掉对功能不影响，ci写的太全面了，后期可以通过加载自己的lib弥补。</li>
</ul>
<p>-》load 组件utf8，uri</p>
<ul>
<li>作用：uri路由方式处理，utf8的处理。</li>
<li>优化：<code>直接干掉</code>。</li>
</ul>
<p>-》load router [<code>4ms</code>]</p>
<ul>
<li>作用：路由。</li>
<li>优化：<code>干不掉</code>。</li>
<li>额外：laravel 据说是使用COC最好的框架，看了下ci的router也不错，基本上都是遵循COC</li>
</ul>
<p>-》load output，input</p>
<ul>
<li>作用：output和浏览器交互输出的处理组件，input包括获取数据array_merge等等。</li>
<li>优化：<code>干掉</code>,需要自己写</li>
</ul>
<p>-》autoload package,cinfig,helper,language,driver,lib,model,db,cache</p>
<ul>
<li>作用：各种各样的组建了。</li>
<li>优化：全<code>不</code>加载</li>
</ul>
<p>-》404 &amp;empty$…handle </p>
<ul>
<li>作用：异常处理。</li>
<li>优化：加载</li>
</ul>
<p>-》controller remap（测试性能写了个remap）</p>
<ul>
<li>作用：指向其他controller。</li>
<li>优化：无</li>
</ul>
<p>-》controller 业务逻辑 </p>
<p>到此将整个框架过程优化完成，初始一下4-5ms感觉还不错。</p>
<h2 id="四、压测数据"><a href="#四、压测数据" class="headerlink" title="四、压测数据"></a>四、压测数据</h2><h3 id="4-1-高并发压测"><a href="#4-1-高并发压测" class="headerlink" title="4.1 高并发压测"></a>4.1 高并发压测</h3><p>2000qps+ ，均值约6ms</p>
<h3 id="4-2-长时间高负载压测"><a href="#4-2-长时间高负载压测" class="headerlink" title="4.2 长时间高负载压测"></a>4.2 长时间高负载压测</h3><p>1500qps 10min，均值约6ms</p>
<p>问题：分析了部分数据的超时分布，约千分之二超过30ms，如下图【这块需要之后优化】<br><a href="http://cuihuan.net/wp_content/new/codeIgniter/time_distribute.png"><img src="http://cuihuan.net/wp_content/new/codeIgniter/time_distribute.png" alt="time_distribute"></a></p>
<h3 id="4-3-无限发压"><a href="#4-3-无限发压" class="headerlink" title="4.3 无限发压"></a>4.3 无限发压</h3><p>nginx + php 均值：17ms<br>框架部分的均值：9ms 也基本上满足需求<br><a href="http://cuihuan.net/wp_content/new/codeIgniter/nginx_time.png"><img src="http://cuihuan.net/wp_content/new/codeIgniter/nginx_time.png" alt="nginx_time"></a></p>
<h2 id="五、汇总"><a href="#五、汇总" class="headerlink" title="五、汇总"></a>五、汇总</h2><p>ci 是一个比较优秀的轻量级MVC框架，可以用来，业能否支撑1000-2000pqs的业务接口。</p>
<p>最后来一张ci的路由图<br><a href="http://cuihuan.net/wp_content/new/codeIgniter/all.png"><img src="http://cuihuan.net/wp_content/new/codeIgniter/all.png" alt="all"></a></p>
<p>```</p>
]]></content>
      
        
        <tags>
            
            <tag> php </tag>
            
            <tag> 性能优化 </tag>
            
            <tag> codeIgniter </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[【nginx学习一】基本原理学习]]></title>
      <url>/2017/03/14/nginx_study_1/</url>
      <content type="html"><![CDATA[<blockquote>
<p>由于性能问题，需要将 apache + php5.2 升级到 nginx + php7，对于nginx的性能和热加载早有耳闻，why nginx so diao。小拽进行了初探，<code>有任何疑问或不准确的地方，欢迎直接开炮</code>！！！</p>
</blockquote>
<h2 id="一、nginx现状"><a href="#一、nginx现状" class="headerlink" title="一、nginx现状"></a>一、nginx现状</h2><p>nginx 是当前的<code>使用最广泛的webserver ,支持http正向/反向代理，支持TCP/UDP层代理</code>，来看下netcraft的数据</p>
<p><a href="http://cuihuan.net/wp_content/new/nginx1/nginx_trend_all.png"><img src="http://cuihuan.net/wp_content/new/nginx1/nginx_trend_all.png" alt="webserver_all"></a><br><a href="http://cuihuan.net/wp_content/new/nginx1/nginx_trend_top.png"><img src="http://cuihuan.net/wp_content/new/nginx1/nginx_trend_top.png" alt="webserver_top"></a></p>
<p>nginx在<code>全部网站中占比达到18%</code>，在<code>top millon busest 达到28%</code>，而且一直在增加。当下最时尚的webserver非nginx莫属</p>
<blockquote>
<p>更全数据可以参考：<a href="https://news.netcraft.com/archives/2017/01/12/january-2017-web-server-survey.html" target="_blank" rel="external">【netcraft】</a></p>
</blockquote>
<h2 id="二、nginx的特点"><a href="#二、nginx的特点" class="headerlink" title="二、nginx的特点"></a>二、nginx的特点</h2><p>深入了解nginx之前，先泛泛的了解下nginx的几个特点</p>
<ul>
<li>性能好<ul>
<li>非阻塞IO/高并发,支持文件IO</li>
<li>多worker，thread pool </li>
<li>基于rbtree的定时器</li>
<li>系统特性的持续支持</li>
</ul>
</li>
<li>功能强大<ul>
<li>webserver/cache/keepalive/pipeline等等</li>
<li>各种upstream的支持【fastcgi/http/…】</li>
<li>输出灵活【chunk/zip/…】</li>
<li>在不断的发展 http2,tcp,udp,proxy…</li>
</ul>
</li>
<li>运维的友好【这个对于开发和部署很重要】<ul>
<li>配置非常规范【个人认为：约定及规范是最好的实践】</li>
<li>热加载和热更新【后文会详细介绍，能在二进制的层面热更新】</li>
<li>日志强大【真的很强的，很多变量支撑】</li>
</ul>
</li>
<li>扩展强大</li>
</ul>
<p>下图是nginx、apache和lighttpd的一个对比。系统压力，内存占用，upstream支持等多个方面都非常不错<br><a href="http://cuihuan.net/wp_content/new/nginx1/nginx_compare.png"><img src="http://cuihuan.net/wp_content/new/nginx1/nginx_compare.png" alt="nginx对比图"></a></p>
<h2 id="三、nginx的核心机制"><a href="#三、nginx的核心机制" class="headerlink" title="三、nginx的核心机制"></a>三、nginx的核心机制</h2><h3 id="3-1-运行方式"><a href="#3-1-运行方式" class="headerlink" title="3.1 运行方式"></a>3.1 运行方式</h3><p>一句话简述nginx的运行方式：<code>master-worker多进程模式运行，单线程/非阻塞执行</code></p>
<p>如下官方图：nginx 启动后生成master，master会启动conf数量的<code>worker进程</code>，当用户的请求过来之后，由不同的worker调起<code>执行线程</code>，非阻塞的执行请求。这种运行方式相对于<code>apache的进程执行</code>相对轻量很多，支撑的并发性也会高很多。<br><a href="http://cuihuan.net/wp_content/new/nginx1/nginx_framework.png"><img src="http://cuihuan.net/wp_content/new/nginx1/nginx_framework.png" alt="nginx 基本框架"></a></p>
<h3 id="3-2-进程管理"><a href="#3-2-进程管理" class="headerlink" title="3.2 进程管理"></a>3.2 进程管理</h3><p>nginx是master-worker进程工作模式，那么nginx是如何管理master启程，怎么做到热加载的？</p>
<h4 id="3-2-1-配置热加载"><a href="#3-2-1-配置热加载" class="headerlink" title="3.2.1 配置热加载"></a>3.2.1 配置热加载</h4><p>官方图很赞，在<code>更换配置之后，master生成新的worker，直到原有的worker全部任务结束kill掉之后</code>。从现象上作证，也就是在relaod配置之后，短时间可能出现超过conf数量的进程，更新完成后，进程会完全改变。</p>
<blockquote>
<p>不更新、直接替换，这种设计思路在代码部署中也很常见，包括mysql迁移，代码更新，服务尝试，很值的学习。<br><a href="http://cuihuan.net/wp_content/new/nginx1/nginx_conf_reload.png"><img src="http://cuihuan.net/wp_content/new/nginx1/nginx_conf_reload.png" alt="nginx 配置热加载"></a></p>
</blockquote>
<h4 id="3-2-2-版本更新热加载"><a href="#3-2-2-版本更新热加载" class="headerlink" title="3.2.2 版本更新热加载"></a>3.2.2 版本更新热加载</h4><p>了解了worker的热加载之后，理解master就非常简单了，通过信号控制，同时存在两个master，逐步替代。<br><a href="http://cuihuan.net/wp_content/new/nginx1/nginx_bit_reload.png"><img src="http://cuihuan.net/wp_content/new/nginx1/nginx_bit_reload.png" alt="nginx 线程热加载"></a></p>
<p>关于replace过程中如何细节控制一致性，稳定性，信号控制，log控制等等，敬请期待小拽的进一步探索！</p>
<h3 id="3-3-处理流程和模块"><a href="#3-3-处理流程和模块" class="headerlink" title="3.3 处理流程和模块"></a>3.3 处理流程和模块</h3><p>启动进程后，请求在nginx内部是如何流转的，nginx内部包括哪些模块？</p>
<h4 id="3-3-1-worker处理过程"><a href="#3-3-1-worker处理过程" class="headerlink" title="3.3.1 worker处理过程"></a>3.3.1 worker处理过程</h4><ol>
<li>【post header】请求到达后首先读取header，log中request time初始时间便从此开始。</li>
<li>【rewrite】请求相关的配置和参数</li>
<li>【pre-access】预处理阶段，频率控制，高频绝句</li>
<li>【acess】权限控制，白名单，403，access deny ，静态文件开放等均有这个模块产生</li>
<li>【content】这个模块会调用upstream产生内容，这个阶段最重要<code>此处调起了工作线程，调用fastcgi，http，以及各种操作产生内容均在此处</code>。性能优化可能需要确认程序执行时间，对应access log中的upstream time 由此产生，记录了nginx中程序运行的全量时间，而request - upstream 就是网络传输和预处理时间。</li>
<li>【filter】内容过滤，包括gzip压缩，返回等在此处</li>
<li>【log】日志的产生</li>
<li>【重定向】<code>没有这个模块，所有的进行智能单向走，有了这个，在任何阶段都可以产生返回</code>，例如client主动阶段产生499的log，过程可能就是1-》2-》8-》7 over</li>
</ol>
<blockquote>
<p>摘自某ppt的一个图，如侵权，请尽快联系小拽<br><a href="http://cuihuan.net/wp_content/new/nginx1/nginx_flow.png"><img src="http://cuihuan.net/wp_content/new/nginx1/nginx_flow.png" alt="nginx 主要流程和模块"></a></p>
</blockquote>
<p>各个阶段的主要状态机可以参考:<a href="http://www.nginxguts.com/2011/01/phases/" target="_blank" rel="external">【跳转】</a></p>
<h3 id="3-4-请求管理"><a href="#3-4-请求管理" class="headerlink" title="3.4 请求管理"></a>3.4 请求管理</h3><p>了解了worker的工作模式和worker的内部主要模块，那么worker是如何管理请求的？</p>
<h4 id="3-4-1-任务调度"><a href="#3-4-1-任务调度" class="headerlink" title="3.4.1 任务调度"></a>3.4.1 任务调度</h4><blockquote>
<p>官方阐述：It’s well known that NGINX uses <code>an asynchronous, event‑driven approach to handling connections</code>. This means that instead of creating another dedicated process or thread for each request (like servers with a traditional architecture), it handles multiple connections and requests in one worker process. To achieve this, NGINX works with sockets in a non‑blocking mode and uses efficient methods such as epoll and kqueue.<br>核心词：<code>异步，事件驱动，链接控制</code></p>
</blockquote>
<p>解释的很清楚，<code>nginx并不是通过每个请求都创建线程，而是通过内部管理的调度分配</code>。<br>如下图：此处不翻译了，大家直接看原版<br>epoll详解：<a href="http://man7.org/linux/man-pages/man7/epoll.7.html" target="_blank" rel="external">【跳转】</a></p>
<p><a href="http://cuihuan.net/wp_content/new/nginx1/nginx_task.png"><img src="http://cuihuan.net/wp_content/new/nginx1/nginx_task.png" alt="nginx 任务基本框架"></a></p>
<h4 id="3-4-2-线程池"><a href="#3-4-2-线程池" class="headerlink" title="3.4.2 线程池"></a>3.4.2 线程池</h4><p>官方说明</p>
<blockquote>
<p>Let’s return to our poor sales assistant who delivers goods from a faraway warehouse. But he has become smarter (or maybe he became smarter after being beaten by the crowd of angry clients?) and hired a delivery service. Now when somebody asks for something from the faraway warehouse, instead of going to the warehouse himself, he just drops an order to a delivery service and they will handle the order while our sales assistant will continue serving other customers. Thus only those clients whose goods aren’t in the store are waiting for delivery, while others can be served immediately.</p>
</blockquote>
<p>小拽认为简而言之：<code>结合实际情况，除了空闲被动给，更多的通过事件驱动主动要</code>，通过这种方式在执行资源紧缺的情况下，达到一个执行资源的优化部署，如下图。<br><a href="http://cuihuan.net/wp_content/new/nginx1/nginx_task2.png"><img src="http://cuihuan.net/wp_content/new/nginx1/nginx_task2.png" alt="nginx 任务基本框架"></a><br>线程池官网详解：<a href="https://www.nginx.com/blog/thread-pools-boost-performance-9x/" target="_blank" rel="external">【跳转】</a></p>
<h4 id="3-4-3-事件调度"><a href="#3-4-3-事件调度" class="headerlink" title="3.4.3 事件调度"></a>3.4.3 事件调度</h4><p>请求的具体调度基于事件，例如网络IO,磁盘IO,定时器等均可以对事件进行阻塞，当阻塞的事件空闲时，发出调度请求，完成处理。<br>需要额外提一下，<code>nginx的定时器基于rbtree，红黑树的快速插入和查询保证了nginx事件调度的高效性</code><br>事件框架的处理模型<br><a href="http://cuihuan.net/wp_content/new/nginx1/nginx_event_.png"><img src="http://cuihuan.net/wp_content/new/nginx1/nginx_event_.png" alt="nginx 事件"></a><br><a href="http://cuihuan.net/wp_content/new/nginx1/nginx_epoll.png"><img src="http://cuihuan.net/wp_content/new/nginx1/nginx_epoll.png" alt="nginx epoll"></a></p>
<h2 id="四、简单总结"><a href="#四、简单总结" class="headerlink" title="四、简单总结"></a>四、简单总结</h2><ul>
<li>性能：nginx 工作模式是master-worker进程方式，执行请求是有更轻量线程完成。</li>
<li>热加载：nginx 替换非更新的方式是nginx热加载的本质</li>
<li>功能强大：nginx upstream是在线程层面调度，兼容多种，所以可以扩展很多功能强大</li>
<li>处理流程：主要的流程过程和模块分离清晰。</li>
<li>请求处理：通过自身的管理，线程池，异步事件驱动等当来完成任务调度</li>
</ul>
<p>再次强调：初探nginx，有疑问或不准确的地方，请直接开炮！！！</p>
<h2 id="五、参考文章"><a href="#五、参考文章" class="headerlink" title="五、参考文章"></a>五、参考文章</h2><ul>
<li>netcraft：<a href="https://news.netcraft.com/archives/2017/01/12/january-2017-web-server-survey.html" target="_blank" rel="external">https://news.netcraft.com/archives/2017/01/12/january-2017-web-server-survey.html</a></li>
<li>nginx的线程调度设计：<a href="https://www.nginx.com/blog/inside-nginx-how-we-designed-for-performance-scale/" target="_blank" rel="external">https://www.nginx.com/blog/inside-nginx-how-we-designed-for-performance-scale/</a></li>
<li>epoll详述：<a href="http://man7.org/linux/man-pages/man7/epoll.7.html" target="_blank" rel="external">http://man7.org/linux/man-pages/man7/epoll.7.html</a></li>
<li><a href="http://yaocoder.blog.51cto.com/2668309/888374" target="_blank" rel="external">http://yaocoder.blog.51cto.com/2668309/888374</a></li>
<li>线程池：<a href="https://www.nginx.com/blog/thread-pools-boost-performance-9x/" target="_blank" rel="external">https://www.nginx.com/blog/thread-pools-boost-performance-9x/</a></li>
</ul>
<p>【转载请注明：<a href="http://cuihuan.net/2017/03/14/nginx_study_1/">【【nginx学习一】基本原理学习 </a> | <a href="http://cuihuan.net">靠谱崔小拽</a> 】</p>
]]></content>
      
        
        <tags>
            
            <tag> nginx </tag>
            
            <tag> 基本原理 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[【redis学习三】简单高可用redis架构实践]]></title>
      <url>/2017/02/05/redis3/</url>
      <content type="html"><![CDATA[<blockquote>
<p>背景：支撑线上千万级别的天级查询请求，要求高可用。</p>
</blockquote>
<h1 id="一、方案调研"><a href="#一、方案调研" class="headerlink" title="一、方案调研"></a>一、方案调研</h1><h2 id="1-1-redis版本选择"><a href="#1-1-redis版本选择" class="headerlink" title="1.1 redis版本选择"></a>1.1 redis版本选择</h2><p>redis当前主流版本是redis 2.x 和 redis 3.x，3.0对集群支持比较不错，官方解释如下：</p>
<blockquote>
<p>Redis是一个开源、基于C语言、基于内存亦可持久化的高性能NoSQL数据库，同时，它还提供了多种语言的API。近日，Redis 3.0在经过6个RC版本后，其正式版终于发布了。Redis 3.0的最重要特征是对Redis集群的支持，此外，该版本相对于2.8版本在性能、稳定性等方面都有了重大提高。</p>
</blockquote>
<p>综合考虑之后扩展性和稳定性之后，选择版本 <code>redis 3.2.3-1</code>版本进行部署</p>
<h2 id="1-2-是否选择搭建集群"><a href="#1-2-是否选择搭建集群" class="headerlink" title="1.2 是否选择搭建集群"></a>1.2 是否选择搭建集群</h2><p>是否搭建集群关键要看单机是否能够满足业务需求，做了个简单的数据评估。</p>
<h3 id="数据量评估"><a href="#数据量评估" class="headerlink" title="数据量评估"></a>数据量评估</h3><ul>
<li><strong>测试</strong>：单机写入2000w业务数据，占用内存1.5g，本机126g内存</li>
<li><strong>评估</strong>：单机的稳定数据承载量：2000w <em> （126/1.56）</em> 0.6 = 96923w </li>
<li><strong>结论</strong>：9T 的数据承载量，远超当前千万级别的数据量</li>
</ul>
<h3 id="性能评估"><a href="#性能评估" class="headerlink" title="性能评估"></a>性能评估</h3><ul>
<li><strong>测试</strong>：简单压测了下<ul>
<li>写操作 1000w，80% 在20ms一下 ，98%在30ms，最大218ms，qps 5w/s，总耗时197s</li>
<li>读操作 1000w，97% 在10ms一下 ，99.99%在24ms，qps 6w/s，总耗时160s</li>
</ul>
</li>
<li><strong>评估</strong>：当前的调用量在千万每天，qps的话在百/s。 </li>
<li><strong>结论</strong>：当前单机的redis完全满足需求</li>
</ul>
<p>因此：在单机远能够满足当下业务需求的情况下，决定不采用的集群的方式来部署redis，减少技术债务风险。</p>
<h2 id="1-3-初定方案和架构图"><a href="#1-3-初定方案和架构图" class="headerlink" title="1.3 初定方案和架构图"></a>1.3 初定方案和架构图</h2><p>选定了版本和基本部署方案之后，主要考虑服务的<code>容灾和稳定性</code>，经过思考之后采用<code>采用极简的主从从结构，001实时同步数据002和003；001读写，002，003只读</code>，机构图如下</p>
<p><a href="http://cuihuan.net/wp_content/new/redis/redis_3_framework.png"><img src="http://cuihuan.net/wp_content/new/redis/redis_3_framework.png" alt="redis 框架架构"></a></p>
<h1 id="二、实现过程"><a href="#二、实现过程" class="headerlink" title="二、实现过程"></a>二、实现过程</h1><h2 id="2-1-redis安装"><a href="#2-1-redis安装" class="headerlink" title="2.1 redis安装"></a>2.1 redis安装</h2><p>此处略去，参考官方文档 <a href="https://redis.io/" target="_blank" rel="external">https://redis.io/</a></p>
<h2 id="2-2-配置读写master"><a href="#2-2-配置读写master" class="headerlink" title="2.2 配置读写master"></a>2.2 配置读写master</h2><ul>
<li>修改端口：port 【目的：简单的修改默认端口是最好的防攻击】</li>
<li>添加密码：pwd</li>
<li>关闭压缩：rdbcompression no 【硬盘最够，降低cpu的能耗更利于提升性能】</li>
<li>开启守护进程：daemonize yes 【master开启守护，增加稳定性】</li>
<li>关闭protect-mode :允许他机器访问</li>
<li>添加白名单：bind xxx</li>
<li>修改log地址，pid地址和数据存储地址：logfile pidfile 【便于维护和安全】</li>
<li>添加慢查询：slowlog-log-slower-than 500 【根据业务需求，便于优化】</li>
<li>最大内存限制：maxmemory 【考虑稳定性和性能，一般不超过最大内存的60%】</li>
</ul>
<h2 id="2-3-配置只读slave"><a href="#2-3-配置只读slave" class="headerlink" title="2.3 配置只读slave"></a>2.3 配置只读slave</h2><ul>
<li>同master</li>
<li>设置主库:slaveof ip:port</li>
<li>主库密码：masterauth masterpwd</li>
<li>只读：slave-read-only yes</li>
</ul>
<h2 id="2-4-启动测试"><a href="#2-4-启动测试" class="headerlink" title="2.4 启动测试"></a>2.4 启动测试</h2><h3 id="启动主库写入数据"><a href="#启动主库写入数据" class="headerlink" title="启动主库写入数据"></a>启动主库写入数据</h3><p><a href="http://cuihuan.net/wp_content/new/redis/redis_3_master.png"><img src="http://cuihuan.net/wp_content/new/redis/redis_3_master.png" alt="redis 写入主库"></a></p>
<h3 id="进入从库查看"><a href="#进入从库查看" class="headerlink" title="进入从库查看"></a>进入从库查看</h3><p>最初没有数据，主库写入之后，从库去到数据</p>
<p><a href="http://cuihuan.net/wp_content/new/redis/redis_3_slave.png"><img src="http://cuihuan.net/wp_content/new/redis/redis_3_slave.png" alt="redis 写入从库"></a></p>
<h3 id="查看log确认过程"><a href="#查看log确认过程" class="headerlink" title="查看log确认过程"></a>查看log确认过程</h3><p><a href="http://cuihuan.net/wp_content/new/redis/redis_3_log.png"><img src="http://cuihuan.net/wp_content/new/redis/redis_3_log.png" alt="redis log"></a></p>
<h1 id="三、架构能力评估"><a href="#三、架构能力评估" class="headerlink" title="三、架构能力评估"></a>三、架构能力评估</h1><h2 id="3-1-容灾能力"><a href="#3-1-容灾能力" class="headerlink" title="3.1 容灾能力"></a>3.1 容灾能力</h2><ul>
<li>主动容灾<ul>
<li>备份：master 全量备份，slave全量备份。</li>
<li>备份安全：本机保存，hadoop同步保存一份。</li>
<li>监控和探活：监控机分钟级探活和预警</li>
</ul>
</li>
<li>被动容灾：<ul>
<li>slave 宕机：重启之后直接从master恢复</li>
<li>master 宕机且硬盘数据为损坏：重启后数据自动恢复且和从库一致。</li>
<li>master 宕机且数据损坏：删除损坏数据，使用slave1的数据恢复，保证数据一致。</li>
<li>master 和slave 1 同时宕机：slave2 保证读正常，业务不影响，利用slave2 数据备份恢复master，启动slave 即可</li>
<li>三台全宕机：服务挂掉，从hadoop获取数据恢复服务。</li>
</ul>
</li>
</ul>
<h2 id="3-2-性能评估"><a href="#3-2-性能评估" class="headerlink" title="3.2 性能评估"></a>3.2 性能评估</h2><p>压测数据，参见方案选择，完全hold住。</p>
<h1 id="四、问题思考"><a href="#四、问题思考" class="headerlink" title="四、问题思考"></a>四、问题思考</h1><h2 id="4-1-内存清理策略"><a href="#4-1-内存清理策略" class="headerlink" title="4.1 内存清理策略"></a>4.1 内存清理策略</h2><p>暂时采用：<br>noeviction -&gt; 谁也不删，直接在写操作时返回错误。<br>之后采用：<br>volatile-lru -&gt; 根据LRU算法删除带有过期时间的key。 最少使用算法删除。<br>如果达到内存限制，手工清理，通过监控脚本监控内存情况</p>
<h2 id="4-2-伸缩性和单节点问题"><a href="#4-2-伸缩性和单节点问题" class="headerlink" title="4.2 伸缩性和单节点问题"></a>4.2 伸缩性和单节点问题</h2><p>扩展slave可以直接扩展，扩展master需要master之间数据同步，暂时是个瓶颈。对于主读业务的需求，暂时问题不大；写需求的话，暂时的想法是代码转写的方式。</p>
<h2 id="4-3-采用redis-sentinal-监听"><a href="#4-3-采用redis-sentinal-监听" class="headerlink" title="4.3 采用redis sentinal 监听"></a>4.3 采用redis sentinal 监听</h2><p>默认不错的监听，尝试了下效果不错，还在调研中，配置conf即可，完成后可以查看监听的情况<br><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:port&gt; INFO Sentinel</div><div class="line"><span class="meta"># Sentinel</span></div><div class="line"><span class="symbol">sentinel_masters:</span><span class="number">1</span></div><div class="line"><span class="symbol">sentinel_tilt:</span><span class="number">0</span></div><div class="line"><span class="symbol">sentinel_running_scripts:</span><span class="number">0</span></div><div class="line"><span class="symbol">sentinel_scripts_queue_length:</span><span class="number">0</span></div><div class="line"><span class="symbol">sentinel_simulate_failure_flags:</span><span class="number">0</span></div><div class="line"><span class="symbol">master0:</span>name=redis115,status=ok,address=ip:port,slaves=<span class="number">2</span>,sentinels=<span class="number">1</span></div></pre></td></tr></table></figure></p>
<h1 id="五：常用代码"><a href="#五：常用代码" class="headerlink" title="五：常用代码"></a>五：常用代码</h1><figure class="highlight vala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta"># 强制杀死redis，模仿宕机</span></div><div class="line">ps aux |grep redis |awk <span class="string">'&#123;print $2&#125;'</span>|xargs kill <span class="number">-9</span></div><div class="line"><span class="meta"># 优化模拟宕机 【根据Dual-X-raY提示-_-】</span></div><div class="line">redis&gt; DEBUG SEGFAULT</div><div class="line"></div><div class="line"><span class="meta"># 重启，指定conf</span></div><div class="line">/home/work/xxx/bin/redis-server /home/work/xxx/etc/redis.conf</div><div class="line"></div><div class="line"><span class="meta"># 压测，具体参数可以参考benchmark</span></div><div class="line">[cuihuan@cuihuan bin]$  ./redis-benchmark -h <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>  -p 端口 -a 密码  -c <span class="number">1000</span> -n <span class="number">10000000</span>  -d <span class="number">1024</span> -r <span class="number">100000</span> -t <span class="keyword">set</span>,<span class="keyword">get</span>,incr,del</div></pre></td></tr></table></figure>
<p>【转载请注明：<a href="http://cuihuan.net/2017/02/05/redis3/">【redis学习三】简单高可用redis架构实践</a> | <a href="http://cuihuan.net">靠谱崔小拽</a> 】</p>
]]></content>
      
        
        <tags>
            
            <tag> redis </tag>
            
            <tag> 高可用架构 </tag>
            
            <tag> 容灾方案 </tag>
            
            <tag> redis主从 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[【高并发简单解决方案】redis队列缓存 + 批量入库 + php离线整合]]></title>
      <url>/2017/01/20/%E3%80%90%E9%AB%98%E5%B9%B6%E5%8F%91%E7%AE%80%E5%8D%95%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E3%80%91redis%E9%98%9F%E5%88%97%E7%BC%93%E5%AD%98%20+%20mysql%20%E6%89%B9%E9%87%8F%E5%85%A5%E5%BA%93%20+%20php%E7%A6%BB%E7%BA%BF%E6%95%B4%E5%90%88/</url>
      <content type="html"><![CDATA[<blockquote>
<p>需求背景：有个<code>调用统计日志存储和统计需求</code>，要求存储到mysql中；存储数据高峰能达到日均千万，瓶颈在于<code>直接入库并发太高，可能会把mysql干垮</code>。</p>
</blockquote>
<h2 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h2><p>思考：应用网站架构的衍化过程中，应用最新的框架和工具技术固然是最优选择；但是，如果能在<code>现有的框架的基础上提出简单可依赖的解决方案</code>，未尝不是一种提升自我的尝试。</p>
<p>解决：</p>
<ul>
<li>问题一：要求日志最好入库；但是，直接入库mysql确实扛不住，批量入库没有问题，done。【批量入库和直接入库性能差异<a href="http://tech.uc.cn/?p=634" target="_blank" rel="external">参考文章</a>】</li>
<li>问题二：批量入库就需要有高并发的消息队列，决定采用redis list 仿真实现，而且方便回滚。</li>
<li>问题三：日志量毕竟大，保存最近30条足矣，决定用php写个离线统计和清理脚本。</li>
</ul>
<p>done，下面是小拽的简单实现过程</p>
<h2 id="一：设计数据库表和存储"><a href="#一：设计数据库表和存储" class="headerlink" title="一：设计数据库表和存储"></a>一：设计数据库表和存储</h2><ul>
<li>考虑到log系统对数据库的性能更多一些，稳定性和安全性没有那么高，<code>存储引擎自然是只支持select insert 没有索引的archive</code>。如果确实有update需求，也可以采用myISAM。</li>
<li>考虑到log是实时记录的所有数据，数量可能巨大，<code>主键采用bigint，自增即可</code>。</li>
<li>考虑到log系统<code>以写为主，统计采用离线计算，字段均不要出现索引</code>，因为一方面可能会影响插入数据效率，另外读时候会造成死锁，影响写数据。</li>
</ul>
<h2 id="二：redis存储数据形成消息队列"><a href="#二：redis存储数据形成消息队列" class="headerlink" title="二：redis存储数据形成消息队列"></a>二：redis存储数据形成消息队列</h2><p>由于高并发，尽可能简单，直接，上代码。<br><figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line"><span class="comment"><span class="markdown">/<span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></span></span></div><div class="line"><span class="bullet">*</span></div><div class="line"><span class="bullet">* </span>获取到的调用日志，存入redis的队列中.</div><div class="line"><span class="bullet">* </span>$Id$</div><div class="line"><span class="bullet">*</span></div><div class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span>*/</div><div class="line"></div><div class="line"><span class="comment"><span class="markdown">/**</span></span></div><div class="line"><span class="bullet">* </span>@file saveLog.php</div><div class="line"><span class="bullet">* </span>@date 2015/11/06 20:47:13</div><div class="line"><span class="bullet">* </span>@author:cuihuan</div><div class="line"><span class="bullet">* </span>@version $Revision$</div><div class="line"><span class="bullet">* </span>@brief</div><div class="line"><span class="bullet">*</span></div><div class="line">**/</div><div class="line"></div><div class="line"><span class="comment">// 获取info</span></div><div class="line">$interface_info = $_GET[<span class="string">'info'</span>];</div><div class="line"></div><div class="line"><span class="comment">// 存入redis队列</span></div><div class="line">$redis = <span class="keyword">new</span> Redis();</div><div class="line">$redis-&gt;connect(<span class="string">'xx'</span>, <span class="number">6379</span>);</div><div class="line">$redis-&gt;auth(<span class="string">"password"</span>);</div><div class="line"></div><div class="line"><span class="comment">// 加上时间戳存入队列</span></div><div class="line">$now_time = date(<span class="string">"Y-m-d H:i:s"</span>);</div><div class="line">$redis-&gt;rPush(<span class="string">"call_log"</span>, $interface_info . <span class="string">"%"</span> . $now_time);</div><div class="line">$redis-&gt;close();</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/* vim: set ts=4 sw=4 sts=4 tw=100 */</span></div><div class="line">?&gt;</div></pre></td></tr></table></figure></p>
<h2 id="三：数据定时批量入库。"><a href="#三：数据定时批量入库。" class="headerlink" title="三：数据定时批量入库。"></a>三：数据定时批量入库。</h2><p>定时读取redis消息队列里面的数据，批量入库。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?php</span></span></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 获取redis消息队列中的脚本，拼接sql，批量入库。</div><div class="line"> * <span class="doctag">@update</span> 2015-11-07 添加失败消息队列回滚机制 </div><div class="line"> *</div><div class="line"> * <span class="doctag">@Author</span>:cuihuan</div><div class="line"> * 2015-11-06</div><div class="line"> * */</div><div class="line"></div><div class="line"><span class="comment">// init redis</span></div><div class="line">$redis_xx = <span class="keyword">new</span> Redis();</div><div class="line">$redis_xx-&gt;connect(<span class="string">'ip'</span>, port);</div><div class="line">$redis_xx-&gt;auth(<span class="string">"password"</span>);</div><div class="line"></div><div class="line"><span class="comment">// 获取现有消息队列的长度</span></div><div class="line">$count = <span class="number">0</span>;</div><div class="line">$max = $redis_xx-&gt;lLen(<span class="string">"call_log"</span>);</div><div class="line"></div><div class="line"><span class="comment">// 获取消息队列的内容，拼接sql</span></div><div class="line">$insert_sql = <span class="string">"insert into fb_call_log (`interface_name`, `createtime`) values "</span>;</div><div class="line"></div><div class="line"><span class="comment">// 回滚数组</span></div><div class="line">$roll_back_arr = <span class="keyword">array</span>();</div><div class="line"></div><div class="line"><span class="keyword">while</span> ($count &lt; $max) &#123;</div><div class="line">    $log_info = $redis_cq01-&gt;lPop(<span class="string">"call_log"</span>);</div><div class="line">    $roll_back_arr = $log_info;</div><div class="line">    <span class="keyword">if</span> ($log_info == <span class="string">'nil'</span> || !<span class="keyword">isset</span>($log_info)) &#123;</div><div class="line">        $insert_sql .= <span class="string">";"</span>;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 切割出时间和info</span></div><div class="line">    $log_info_arr = explode(<span class="string">"%"</span>,$log_info);</div><div class="line">    $insert_sql .= <span class="string">" ('"</span>.$log_info_arr[<span class="number">0</span>].<span class="string">"','"</span>.$log_info_arr[<span class="number">1</span>].<span class="string">"'),"</span>;</div><div class="line">    $count++;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 判定存在数据，批量入库</span></div><div class="line"><span class="keyword">if</span> ($count != <span class="number">0</span>) &#123;</div><div class="line">    $link_2004 = mysql_connect(<span class="string">'ip:port'</span>, <span class="string">'user'</span>, <span class="string">'password'</span>);</div><div class="line">    <span class="keyword">if</span> (!$link_2004) &#123;</div><div class="line">        <span class="keyword">die</span>(<span class="string">"Could not connect:"</span> . mysql_error());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $crowd_db = mysql_select_db(<span class="string">'fb_log'</span>, $link_2004);</div><div class="line">    $insert_sql = rtrim($insert_sql,<span class="string">","</span>).<span class="string">";"</span>;</div><div class="line">    $res = mysql_query($insert_sql);</div><div class="line"></div><div class="line">    <span class="comment">// 输出入库log和入库结果;</span></div><div class="line">    <span class="keyword">echo</span> date(<span class="string">"Y-m-d H:i:s"</span>).<span class="string">"insert "</span>.$count.<span class="string">" log info result:"</span>;</div><div class="line">    <span class="keyword">echo</span> json_encode($res);</div><div class="line">    <span class="keyword">echo</span> <span class="string">"&lt;/br&gt;\n"</span>;</div><div class="line">    </div><div class="line">    <span class="comment">// 数据库插入失败回滚</span></div><div class="line">    <span class="keyword">if</span>(!$res)&#123;</div><div class="line">       <span class="keyword">foreach</span>($roll_back_arr <span class="keyword">as</span> $k)&#123;</div><div class="line">           $redis_xx-&gt;rPush(<span class="string">"call_log"</span>, $k);</div><div class="line">       &#125;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="comment">// 释放连接</span></div><div class="line">    mysql_free_result($res);</div><div class="line">    mysql_close($link_2004);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 释放redis</span></div><div class="line">$redis_cq01-&gt;close();</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<h2 id="四：离线天级统计和清理数据脚本"><a href="#四：离线天级统计和清理数据脚本" class="headerlink" title="四：离线天级统计和清理数据脚本"></a>四：离线天级统计和清理数据脚本</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">?php</div><div class="line"><span class="comment">/**</span></div><div class="line">* static log ：每天离线统计代码日志和删除五天前的日志</div><div class="line">*</div><div class="line">* <span class="doctag">@Author</span>:cuihuan</div><div class="line">* 2015-11-06</div><div class="line">* */</div><div class="line"></div><div class="line"><span class="comment">// 离线统计</span></div><div class="line">$link_2004 = mysql_connect(<span class="string">'ip:port'</span>, <span class="string">'user'</span>, <span class="string">'pwd'</span>);</div><div class="line"><span class="keyword">if</span> (!$link_2004) &#123;</div><div class="line">    <span class="keyword">die</span>(<span class="string">"Could not connect:"</span> . mysql_error());</div><div class="line">&#125;</div><div class="line"></div><div class="line">$crowd_db = mysql_select_db(<span class="string">'fb_log'</span>, $link_2004);</div><div class="line"></div><div class="line"><span class="comment">// 统计昨天的数据</span></div><div class="line">$day_time = date(<span class="string">"Y-m-d"</span>, time() - <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span> * <span class="number">1</span>);</div><div class="line">$static_sql = <span class="string">"get sql"</span>;</div><div class="line"></div><div class="line">$res = mysql_query($static_sql, $link_2004);</div><div class="line"></div><div class="line"><span class="comment">// 获取结果入库略</span></div><div class="line"></div><div class="line"><span class="comment">// 清理15天之前的数据</span></div><div class="line">$before_15_day = date(<span class="string">"Y-m-d"</span>, time() - <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span> * <span class="number">15</span>);</div><div class="line">$delete_sql = <span class="string">"delete from xxx where createtime &lt; '"</span> . $before_15_day . <span class="string">"'"</span>;</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    $res = mysql_query($delete_sql);</div><div class="line">&#125;<span class="keyword">catch</span>(<span class="keyword">Exception</span> $e)&#123;</div><div class="line">    <span class="keyword">echo</span> json_encode($e).<span class="string">"\n"</span>;</div><div class="line">    <span class="keyword">echo</span> <span class="string">"delete result:"</span>.json_encode($res).<span class="string">"\n"</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">mysql_close($link_2004);</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<h2 id="五：代码部署"><a href="#五：代码部署" class="headerlink" title="五：代码部署"></a>五：代码部署</h2><p>主要是部署，批量入库脚本的调用和天级统计脚本，crontab例行运行。<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 批量入库脚本</span></div><div class="line">*<span class="regexp">/2 * * * * /</span>home<span class="regexp">/cuihuan/</span>xxx<span class="regexp">/lamp/</span>php5<span class="regexp">/bin/</span>php <span class="regexp">/home/</span>cuihuan<span class="regexp">/xxx/</span>batchLog.php &gt;&gt;<span class="regexp">/home/</span>cuihuan<span class="regexp">/xxx/</span>batchlog.log</div><div class="line"></div><div class="line"><span class="comment"># 天级统计脚本</span></div><div class="line"><span class="number">0</span> <span class="number">5</span> * * * <span class="regexp">/home/</span>cuihuan<span class="regexp">/xxx/</span>php5<span class="regexp">/bin/</span>php <span class="regexp">/home/</span>cuihuan<span class="regexp">/xxx/</span>staticLog.php &gt;&gt;<span class="regexp">/home/</span>cuihuan<span class="regexp">/xxx/</span>staticLog.log</div></pre></td></tr></table></figure></p>
<blockquote>
<p>总结：相对于其他复杂的方式处理高并发，这个解决方案简单有效：通过redis缓存抗压，mysql批量入库解决数据库瓶颈，离线计算解决统计数据，通过定期清理保证库的大小。</p>
</blockquote>
<p>【转载请注明：<a href="http://cuihuan.net/article/%E3%80%90%E9%AB%98%E5%B9%B6%E5%8F%91%E7%AE%80%E5%8D%95%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E3%80%91redis%E7%BC%93%E5%AD%98%E9%98%9F%E5%88%97-mysql-%E6%89%B9%E9%87%8F%E5%85%A5%E5%BA%93-php%E7%A6%BB.html">高并发简单解决方案</a> | <a href="http://cuihuan.net">靠谱崔小拽</a> 】</p>
]]></content>
      
        
        <tags>
            
            <tag> php </tag>
            
            <tag> mysql </tag>
            
            <tag> redis </tag>
            
            <tag> 高并发 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[php爬虫：知乎用户数据爬取和分析]]></title>
      <url>/2017/01/20/charactor/</url>
      <content type="html"><![CDATA[<blockquote>
<p>背景说明：小拽利用php的curl写的爬虫，实验性的爬取了知乎5w用户的基本信息；同时，针对爬取的数据，进行了简单的分析呈现。<a href="http://cuihuan.net:1015/demo_file/zhihu_spider/demo.html">demo 地址</a></p>
</blockquote>
<p>php的spider代码和用户dashboard的展现代码，整理后上传github，在个人博客和公众号更新代码库，程序仅供娱乐和学习交流；如果有侵犯知乎相关权益，请尽快联系本人删除。</p>
<h2 id="无图无真相"><a href="#无图无真相" class="headerlink" title="无图无真相"></a>无图无真相</h2><p>移动端分析数据截图</p>
<p><a href="http://cuihuan.net/wp-content/uploads/2016/01/wise_web_spider.png"><img src="http://cuihuan.net/wp-content/uploads/2016/01/wise_web_spider.png" alt="wise_web_spider"></a></p>
<p>pc端分析数据截图</p>
<p><a href="http://cuihuan.net/wp-content/uploads/2016/01/web_spider.png"><img src="http://cuihuan.net/wp-content/uploads/2016/01/web_spider-629x1024.png" alt="web_spider"></a></p>
<p>整个爬取，分析，展现过程大概分如下几步，小拽将分别介绍</p>
<ul>
<li>curl爬取知乎网页数据</li>
<li>正则分析知乎网页数据</li>
<li>数据数据入库和程序部署</li>
<li>数据分析和呈现</li>
</ul>
<h2 id="curl爬取网页数据"><a href="#curl爬取网页数据" class="headerlink" title="curl爬取网页数据"></a>curl爬取网页数据</h2><p>PHP的curl扩展是PHP支持的，允许你与各种服务器使用各种类型的协议进行连接和通信的库。是一个非常便捷的抓取网页的工具，同时，支持多线程扩展。</p>
<p>本程序抓取的是知乎对外提供用户访问的个人信息页面<a href="https://www.zhihu.com/people/xxx,抓取过程需要携带用户cookie才能获取页面。直接上码" target="_blank" rel="external">https://www.zhihu.com/people/xxx,抓取过程需要携带用户cookie才能获取页面。直接上码</a></p>
<ul>
<li><p>获取页面cookie</p>
  <figure class="highlight gherkin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">// 登录知乎，打开个人中心，打开控制台，获取cookie</div><div class="line">document.cookie</div><div class="line"><span class="string">"_za=67254197-3wwb8d-43f6-94f0-fb0e2d521c31; _ga=GA1.2.2142818188.1433767929; q_c1=78ee1604225d47d08cddd8142a08288b23|1452172601000|1452172601000; _xsrf=15f0639cbe6fb607560c075269064393; cap_id="</span>N2QwMTExNGQ0YTY2NGVddlMGIyNmQ4NjdjOTU0YTM5MmQ=|<span class="string">1453444256</span>|<span class="string">49fdc6b43dc51f702b7d6575451e228f56cdaf5d"; __utmt=1; unlock_ticket="QUJDTWpmM0lsZdd2dYQUFBQVlRSlZUVTNVb1ZaNDVoQXJlblVmWGJ0WGwyaHlDdVdscXdZU1VRPT0=</span>|<span class="string">1453444421</span>|<span class="string">c47a2afde1ff334d416bafb1cc267b41014c9d5f"; __utma=51854390.21428dd18188.1433767929.1453187421.1453444257.3; __utmb=51854390.14.8.1453444425011; __utmc=51854390; __utmz=51854390.1452846679.1.dd1.utmcsr=google</span>|<span class="string">utmccn=(organic)</span>|<span class="string">utmcmd=organic</span>|<span class="string">utmctr=(not%20provided); __utmv=51854390.100-1</span>|<span class="string">2=registration_date=20150823=1^dd3=entry_date=20150823=1"</span></div></pre></td></tr></table></figure>
</li>
<li><p>抓取个人中心页面<br>通过curl，携带cookie，先抓取本人中心页面</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 通过用户名抓取个人中心页面并存储</div><div class="line"> * </div><div class="line"> * <span class="doctag">@param</span> $username str :用户名 flag</div><div class="line"> * <span class="doctag">@return</span> boolean      :成功与否标志</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">spiderUser</span><span class="params">($username)</span></span></div><div class="line">&#123;</div><div class="line">    $cookie = <span class="string">"xxxx"</span> ;</div><div class="line">    $url_info = <span class="string">'http://www.zhihu.com/people/'</span> . $username; <span class="comment">//此处cui-xiao-zhuai代表用户ID,可以直接看url获取本人id</span></div><div class="line">    $ch = curl_init($url_info); <span class="comment">//初始化会话</span></div><div class="line">    curl_setopt($ch, CURLOPT_HEADER, <span class="number">0</span>);</div><div class="line">    curl_setopt($ch, CURLOPT_COOKIE, $cookie);  <span class="comment">//设置请求COOKIE</span></div><div class="line">    curl_setopt($ch, CURLOPT_USERAGENT, $_SERVER[<span class="string">'HTTP_USER_AGENT'</span>]);</div><div class="line">    curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);  <span class="comment">//将curl_exec()获取的信息以文件流的形式返回，而不是直接输出。</span></div><div class="line">    curl_setopt($ch, CURLOPT_FOLLOWLOCATION, <span class="number">1</span>);</div><div class="line">    $result = curl_exec($ch);</div><div class="line"></div><div class="line">     file_put_contents(<span class="string">'/home/work/zxdata_ch/php/zhihu_spider/file/'</span>.$username.<span class="string">'.html'</span>,$result);</div><div class="line">     <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="正则分析网页数据"><a href="#正则分析网页数据" class="headerlink" title="正则分析网页数据"></a>正则分析网页数据</h2><h3 id="分析新链接，进一步爬取"><a href="#分析新链接，进一步爬取" class="headerlink" title="分析新链接，进一步爬取"></a>分析新链接，进一步爬取</h3><p>对于抓取过来的网页进行存储，<code>要想进行进一步的爬取，页面必须包含有可用于进一步爬取用户的链接</code>。通过对知乎页面分析发现：在个人中心页面中有关注人和部分点赞人和被关注人。<br>如下所示<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 抓取的html页面中发现了新的用户，可用于爬虫</span></div><div class="line">&lt;a <span class="keyword">class</span>=<span class="string">"zm-item-link-avatar avatar-link"</span> href=<span class="string">"/people/new-user"</span> data-tip=<span class="string">"p$t$new-user"</span>&gt;</div></pre></td></tr></table></figure></p>
<p>ok，这样子就可以通过自己-》关注人-》关注人的关注人-》。。。进行不断爬取。接下来就是通过正则匹配提取该信息</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 匹配到抓取页面的所有用户</span></div><div class="line">preg_match_all(<span class="string">'/\/people\/([\w-]+)\"/i'</span>, $str, $match_arr);</div><div class="line"></div><div class="line"><span class="comment">// 去重合并入新的用户数组,用户进一步抓取</span></div><div class="line"><span class="keyword">self</span>::$newUserArr = array_unique(array_merge($match_arr[<span class="number">1</span>], <span class="keyword">self</span>::$newUserArr));</div></pre></td></tr></table></figure>
<p>到此，整个爬虫过程就可以顺利进行了。<br>如果需要大量的抓取数据，可以研究下<code>curl_multi</code>和<code>pcntl</code>进行多线程的快速抓取，此处不做赘述。</p>
<h3 id="分析用户数据，提供分析"><a href="#分析用户数据，提供分析" class="headerlink" title="分析用户数据，提供分析"></a>分析用户数据，提供分析</h3><p>通过正则可以进一步匹配出更多的该用户数据，直接上码。<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">// 获取用户头像</span></div><div class="line">preg_match('/&lt;img.+src=\<span class="string">"?([^\s]+\.(jpg|gif|bmp|bnp|png))\"</span>?.+&gt;/i', <span class="variable">$str</span>, <span class="variable">$match_img</span>);</div><div class="line"><span class="variable">$img_url</span> = <span class="variable">$match_img</span>[1];</div><div class="line"></div><div class="line"><span class="comment">// 匹配用户名：</span></div><div class="line"><span class="comment">// &lt;span class="name"&gt;崔小拽&lt;/span&gt;</span></div><div class="line">preg_match('/&lt;span.+<span class="keyword">class</span>=\<span class="string">"?name\"</span>?&gt;([\x&#123;4e00&#125;-\x&#123;9fa5&#125;]+).+span&gt;/<span class="keyword">u</span>', <span class="variable">$str</span>, <span class="variable">$match_name</span>);</div><div class="line"><span class="variable">$user_name</span> = <span class="variable">$match_name</span>[1];</div><div class="line"></div><div class="line"><span class="comment">// 匹配用户简介</span></div><div class="line"><span class="comment">// class bio span 中文</span></div><div class="line">preg_match('/&lt;span.+<span class="keyword">class</span>=\<span class="string">"?bio\"</span>?.+\&gt;([\x&#123;4e00&#125;-\x&#123;9fa5&#125;]+).+span&gt;/<span class="keyword">u</span>', <span class="variable">$str</span>, <span class="variable">$match_title</span>);</div><div class="line"><span class="variable">$user_title</span> = <span class="variable">$match_title</span>[1];</div><div class="line"></div><div class="line"><span class="comment">// 匹配性别</span></div><div class="line"><span class="comment">//&lt;input type="radio" name="gender" value="1" checked="checked" class="male"/&gt; 男&amp;nbsp;&amp;nbsp;</span></div><div class="line"><span class="comment">// gender value1 ;结束 中文</span></div><div class="line">preg_match('/&lt;<span class="keyword">input</span>.+name=\<span class="string">"?gender\"</span>?.+value=\<span class="string">"?1\"</span>?.+([\x&#123;4e00&#125;-\x&#123;9fa5&#125;]+).+\;/<span class="keyword">u</span>', <span class="variable">$str</span>, <span class="variable">$match_sex</span>);</div><div class="line"><span class="variable">$user_sex</span> = <span class="variable">$match_sex</span>[1];</div><div class="line"></div><div class="line"><span class="comment">// 匹配地区</span></div><div class="line"><span class="comment">//&lt;span class="location item" title="北京"&gt;</span></div><div class="line">preg_match('/&lt;span.+<span class="keyword">class</span>=\<span class="string">"?location.+\"</span>?.+\<span class="string">"([\x&#123;4e00&#125;-\x&#123;9fa5&#125;]+)\"</span>&gt;/<span class="keyword">u</span>', <span class="variable">$str</span>, <span class="variable">$match_city</span>);</div><div class="line"><span class="variable">$user_city</span> = <span class="variable">$match_city</span>[1];</div><div class="line"></div><div class="line"><span class="comment">// 匹配工作</span></div><div class="line"><span class="comment">//&lt;span class="employment item" title="人见人骂的公司"&gt;人见人骂的公司&lt;/span&gt;</span></div><div class="line">preg_match('/&lt;span.+<span class="keyword">class</span>=\<span class="string">"?employment.+\"</span>?.+\<span class="string">"([\x&#123;4e00&#125;-\x&#123;9fa5&#125;]+)\"</span>&gt;/<span class="keyword">u</span>', <span class="variable">$str</span>, <span class="variable">$match_employment</span>);</div><div class="line"><span class="variable">$user_employ</span> = <span class="variable">$match_employment</span>[1];</div><div class="line"></div><div class="line"><span class="comment">// 匹配职位</span></div><div class="line"><span class="comment">// &lt;span class="position item" title="程序猿"&gt;&lt;a href="/topic/19590046" title="程序猿" class="topic-link" data-token="19590046" data-topicid="13253"&gt;程序猿&lt;/a&gt;&lt;/span&gt;</span></div><div class="line">preg_match('/&lt;span.+<span class="keyword">class</span>=\<span class="string">"?position.+\"</span>?.+\<span class="string">"([\x&#123;4e00&#125;-\x&#123;9fa5&#125;]+).+\"</span>&gt;/<span class="keyword">u</span>', <span class="variable">$str</span>, <span class="variable">$match_position</span>);</div><div class="line"><span class="variable">$user_position</span> = <span class="variable">$match_position</span>[1];</div><div class="line"></div><div class="line"><span class="comment">// 匹配学历</span></div><div class="line"><span class="comment">// &lt;span class="education item" title="研究僧"&gt;研究僧&lt;/span&gt;</span></div><div class="line">preg_match('/&lt;span.+<span class="keyword">class</span>=\<span class="string">"?education.+\"</span>?.+\<span class="string">"([\x&#123;4e00&#125;-\x&#123;9fa5&#125;]+)\"</span>&gt;/<span class="keyword">u</span>', <span class="variable">$str</span>, <span class="variable">$match_education</span>);</div><div class="line"><span class="variable">$user_education</span> = <span class="variable">$match_education</span>[1];</div><div class="line"></div><div class="line"><span class="comment">// 工作情况</span></div><div class="line"><span class="comment">// &lt;span class="education-extra item" title='挨踢'&gt;挨踢&lt;/span&gt;</span></div><div class="line">preg_match('/&lt;span.+<span class="keyword">class</span>=\<span class="string">"?education-extra.+\"</span>?.+&gt;([\x&#123;4e00&#125;-</div><div class="line">\x&#123;9fa5&#125;]+)&lt;/<span class="keyword">u</span>', <span class="variable">$str</span>, <span class="variable">$match_education_extra</span>);</div><div class="line"><span class="variable">$user_education_extra</span> = <span class="variable">$match_education_extra</span>[1];</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// 匹配关注话题数量</span></div><div class="line"><span class="comment">// class="zg-link-litblue"&gt;&lt;strong&gt;41 个话题&lt;/strong&gt;&lt;/a&gt;</span></div><div class="line">preg_match('/<span class="keyword">class</span>=\<span class="string">"?zg-link-litblue\"</span>?&gt;&lt;strong&gt;(\<span class="keyword">d</span>+)\s.+strong&gt;/i', <span class="variable">$str</span>, <span class="variable">$match_topic</span>);</div><div class="line"><span class="variable">$user_topic</span> = <span class="variable">$match_topic</span>[1];</div><div class="line"></div><div class="line"><span class="comment">// 关注人数</span></div><div class="line"><span class="comment">// &lt;span class="zg-gray-normal"&gt;关注了</span></div><div class="line">preg_match_all('/&lt;strong&gt;(\<span class="keyword">d</span>+)&lt;.+&lt;<span class="keyword">label</span>&gt;/i', <span class="variable">$str</span>, <span class="variable">$match_care</span>);</div><div class="line"><span class="variable">$user_care</span> = <span class="variable">$match_care</span>[1][0];</div><div class="line"><span class="variable">$user_be_careed</span> = <span class="variable">$match_care</span>[1][1];</div><div class="line"></div><div class="line"><span class="comment">// 历史浏览量</span></div><div class="line"><span class="comment">// &lt;span class="zg-gray-normal"&gt;个人主页被 &lt;strong&gt;17&lt;/strong&gt; 人浏览&lt;/span&gt;</span></div><div class="line">preg_match('/<span class="keyword">class</span>=\<span class="string">"?zg-gray-normal\"</span>?.+&gt;(\<span class="keyword">d</span>+)&lt;.+span&gt;/i', <span class="variable">$str</span>, <span class="variable">$match_browse</span>);</div><div class="line"><span class="variable">$user_browse</span> = <span class="variable">$match_browse</span>[1];</div></pre></td></tr></table></figure></p>
<h2 id="数据入库和程序优化"><a href="#数据入库和程序优化" class="headerlink" title="数据入库和程序优化"></a>数据入库和程序优化</h2><p>在抓取的过程中，有条件的话，一定要通过redis入库，确实能提升抓取和入库效率。没有条件的话只能通过sql优化。这里来几发心德。</p>
<ul>
<li>数据库表设计索引一定要慎重。在spider爬取的过程中，建议出了用户名，左右字段都不要索引，包括主键都不要，<code>尽可能的提高入库效率</code>，试想5000w的数据，每次添加一个，建立索引需要多少消耗。等抓取完毕，需要分析数据时，批量建立索引。</li>
<li><p>数据入库和更新操作，一定要批量。 mysql 官方给出的增删改的建议和速度：<a href="http://dev.mysql.com/doc/refman/5.7/en/insert-speed.html" target="_blank" rel="external">http://dev.mysql.com/doc/refman/5.7/en/insert-speed.html</a></p>
  <figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># 官方的最优批量插入</div><div class="line">INSERT INTO yourtable VALUES (<span class="number">1</span>,<span class="number">2</span>), (<span class="number">5</span>,<span class="number">5</span>), ...;</div></pre></td></tr></table></figure>
</li>
<li><p>部署操作。程序在抓取过程中，有可能会出现异常挂掉，为了保证高效稳定，尽可能的写一个定时脚本。每隔一段时间干掉，重新跑，这样即使异常挂掉也不会浪费太多宝贵时间，毕竟，time is money。</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"></div><div class="line"><span class="comment"># 干掉</span></div><div class="line">ps aux |grep spider |awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">sleep 5s</div><div class="line"></div><div class="line"><span class="comment"># 重新跑</span></div><div class="line">nohup /home/cuixiaohuan/lamp/php5/bin/php /home/cuixiaohuan/php/zhihu_spider/spider_new.php &amp;</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="数据分析呈现"><a href="#数据分析呈现" class="headerlink" title="数据分析呈现"></a>数据分析呈现</h2><p>数据的呈现主要使用echarts 3.0，感觉对于移动端兼容还不错。兼容移动端的页面响应式布局主要通过几个简单的css控制，代码如下</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*兼容性和响应式div设计*/</span></div><div class="line">@<span class="keyword">media</span> screen and (max-width: <span class="number">480px</span>) &#123;</div><div class="line">    <span class="selector-tag">body</span>&#123;</div><div class="line">        <span class="attribute">padding</span>: <span class="number">0</span> ;</div><div class="line">    &#125;</div><div class="line">    <span class="selector-class">.adapt-div</span> &#123;</div><div class="line">        <span class="attribute">width</span>: <span class="number">100%</span> ;</div><div class="line">        <span class="attribute">float</span>: none ;</div><div class="line">        <span class="attribute">margin</span>: <span class="number">20px</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="selector-class">.half-div</span> &#123;</div><div class="line">        <span class="attribute">height</span>: <span class="number">350px</span> ;</div><div class="line">        <span class="attribute">margin-bottom</span>: <span class="number">10px</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="selector-class">.whole-div</span> &#123;</div><div class="line">        <span class="attribute">height</span>: <span class="number">350px</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">&lt;!<span class="selector-tag">--</span> 整块完整布局，半块在<span class="selector-tag">web</span>端采用<span class="selector-tag">float</span>的方式，移动端去掉<span class="selector-tag">--</span>&gt;</div><div class="line"><span class="selector-class">.half-div</span> &#123;</div><div class="line">    <span class="attribute">width</span>: <span class="number">48%</span>;</div><div class="line">    <span class="attribute">height</span>: <span class="number">430px</span>;</div><div class="line">    <span class="attribute">margin</span>: <span class="number">1%</span>;</div><div class="line">    <span class="attribute">float</span>: left</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="selector-class">.whole-div</span> &#123;</div><div class="line">    <span class="attribute">width</span>: <span class="number">98%</span>;</div><div class="line">    <span class="attribute">height</span>: <span class="number">430px</span>;</div><div class="line">    <span class="attribute">margin</span>: <span class="number">1%</span>;</div><div class="line">    <span class="attribute">float</span>: left</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="不足和待学习"><a href="#不足和待学习" class="headerlink" title="不足和待学习"></a>不足和待学习</h2><p>整个过程中涉及php,shell,js,css,html,正则等语言和部署等基础知识，但还有诸多需要改进完善，小拽特此记录，后续补充例：</p>
<ul>
<li>php 采用multicul进行多线程。</li>
<li>正则匹配进一步优化</li>
<li>部署和抓取过程采用redis提升存储</li>
<li>移动端布局的兼容性提升</li>
<li>js的模块化和sass书写css。</li>
</ul>
<p>【转载请注明：<a href="http://cuihuan.net/article/php%E7%88%AC%E8%99%AB%EF%BC%9A%E7%9F%A5%E4%B9%8E%E7%94%A8%E6%88%B7%E6%95%B0%E6%8D%AE%E7%88%AC%E5%8F%96%E5%92%8C%E5%88%86%E6%9E%90.html">php爬虫：知乎用户数据爬取和分析</a> | <a href="http://cuihuan.net">靠谱崔小拽</a> 】</p>
]]></content>
      
        
        <tags>
            
            <tag> php </tag>
            
            <tag> javascript </tag>
            
            <tag> 网页爬虫 </tag>
            
            <tag> shell </tag>
            
            <tag> css </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[fsck修复linux文件损坏]]></title>
      <url>/2016/08/20/fsck%E4%BF%AE%E5%A4%8Dlinux%E6%96%87%E4%BB%B6%E6%8D%9F%E5%9D%8F/</url>
      <content type="html"><![CDATA[<blockquote>
<p><code>数据一定要备份，最好多机备份，代码一定要ci</code>。</p>
</blockquote>
<h2 id="背景和损失"><a href="#背景和损失" class="headerlink" title="背景和损失"></a>背景和损失</h2><p>背景：机房事故，突然关机，硬盘年老失修，造成很多文件不可用。如图</p>
<p><a href="http://cuihuan.net/wp-content/uploads/2016/08/11441496-18D2-4576-8F5F-C2BF7B84F458.png"><img src="http://cuihuan.net/wp-content/uploads/2016/08/11441496-18D2-4576-8F5F-C2BF7B84F458-300x84.png" alt="11441496-18D2-4576-8F5F-C2BF7B84F458"></a></p>
<p>面临损失：<br>作为一名靠谱程序员，数据库单机多机备份，程序版本控制这些都是有的【如果没有，一定要加上】；但这次有一个重要影响，就是git中commit之后，没有push的文件全损坏了，损坏了，坏了，了。。。。</p>
<h2 id="分析原因"><a href="#分析原因" class="headerlink" title="分析原因"></a>分析原因</h2><p>op给出的说法是网络波动，造成机房故障，机器重启。但从结果看，文件系统乱掉了，而且乱掉的文件主要分两类：</p>
<ul>
<li>1：当时正在写入和操作的文件。例如运行的脚本，正在写的文件，samba建立网络映射的文件，git实时文件。</li>
<li>2：内存里的数据，例如memcache里的数据等等</li>
</ul>
<h2 id="处理：fsck修复。"><a href="#处理：fsck修复。" class="headerlink" title="处理：fsck修复。"></a>处理：fsck修复。</h2><p>###1：查看硬盘挂载：<br>df查看下磁盘的挂载位置。</p>
<p><a href="http://cuihuan.net/wp-content/uploads/2016/08/F60D7BE5-D89D-4C74-9927-6EE2DD6157DF.png"><img src="http://cuihuan.net/wp-content/uploads/2016/08/F60D7BE5-D89D-4C74-9927-6EE2DD6157DF-300x51.png" alt="F60D7BE5-D89D-4C74-9927-6EE2DD6157DF"></a></p>
<h3 id="2：操作挂起：不挂起可能会出现数据恢复中断。"><a href="#2：操作挂起：不挂起可能会出现数据恢复中断。" class="headerlink" title="2：操作挂起：不挂起可能会出现数据恢复中断。"></a>2：操作挂起：<code>不挂起可能会出现数据恢复中断</code>。</h3><p>报错：直接挂起会出现 dev is busy，如下图<br><a href="http://cuihuan.net/wp-content/uploads/2016/08/59423A93-F29C-4A30-AB92-17408E9E6556.png"><img src="http://cuihuan.net/wp-content/uploads/2016/08/59423A93-F29C-4A30-AB92-17408E9E6556-300x40.png" alt="59423A93-F29C-4A30-AB92-17408E9E6556"></a><br>用：umout -l /dev/sda3<br><a href="http://cuihuan.net/wp-content/uploads/2016/08/3C64703C-CF4A-47EB-9FE3-91CD7542E8FA.png"><img src="http://cuihuan.net/wp-content/uploads/2016/08/3C64703C-CF4A-47EB-9FE3-91CD7542E8FA-300x46.png" alt="3C64703C-CF4A-47EB-9FE3-91CD7542E8FA"></a><br><figure class="highlight 1c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#umount -l &lt;挂载点|设备&gt;</span></div><div class="line"></div><div class="line">此命令将会断开设备并关闭打开该设备的全部句柄。</div><div class="line">通常，您可以使用 eject &lt;挂载点<span class="string">|设备&gt;命令弹出碟片</span></div></pre></td></tr></table></figure></p>
<h3 id="3：fsck-扫盘"><a href="#3：fsck-扫盘" class="headerlink" title="3：fsck 扫盘"></a>3：fsck 扫盘</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">fsck -f <span class="regexp">/dev/</span>sda3</div></pre></td></tr></table></figure>
<p>注意ext2 还会进行e2fsck 再扫一遍，此为正常操作<br><a href="http://cuihuan.net/wp-content/uploads/2016/08/C9347418-9644-4841-9A2C-3FFB1157E5D8.png"><img src="http://cuihuan.net/wp-content/uploads/2016/08/C9347418-9644-4841-9A2C-3FFB1157E5D8-300x83.png" alt="C9347418-9644-4841-9A2C-3FFB1157E5D8"></a></p>
<h3 id="4：扫盘结束后，挂载驱动盘"><a href="#4：扫盘结束后，挂载驱动盘" class="headerlink" title="4：扫盘结束后，挂载驱动盘"></a>4：扫盘结束后，挂载驱动盘</h3><h3 id="5：寻找和恢复文件"><a href="#5：寻找和恢复文件" class="headerlink" title="5：寻找和恢复文件"></a>5：寻找和恢复文件</h3><p>把.git 内的文件全部整理，导出，一个一个寻找自己需要的文件，找到了久违的文件。<br><a href="http://cuihuan.net/wp-content/uploads/2016/08/3B14EF17-2C86-411F-BF16-4FFC15637C4D.png"><img src="http://cuihuan.net/wp-content/uploads/2016/08/3B14EF17-2C86-411F-BF16-4FFC15637C4D-300x109.png" alt="3B14EF17-2C86-411F-BF16-4FFC15637C4D"></a></p>
<h2 id="后续"><a href="#后续" class="headerlink" title="后续"></a>后续</h2><p>一句话：<code>代码一定要ci，数据一定要容灾</code></p>
<p>【转载请注明：<a href="http://cuihuan.net/?p=474">fsck修复linux文件损坏</a> | <a href="http://cuihuan.net">靠谱崔小拽</a> 】</p>
]]></content>
      
        
        <tags>
            
            <tag> linux </tag>
            
            <tag> git修复 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[【page-monitor 前端自动化 下篇】 实践应用]]></title>
      <url>/2016/08/20/%E3%80%90page-monitor%20%E5%89%8D%E7%AB%AF%E8%87%AA%E5%8A%A8%E5%8C%96%20%E4%B8%8B%E7%AF%87%E3%80%91%20%E5%AE%9E%E8%B7%B5%E5%BA%94%E7%94%A8/</url>
      <content type="html"><![CDATA[<blockquote>
<p>通过page-diff的初步调研和源码分析，确定page-diff在前端自动化测试和监控方面做一些事情。本篇主要介绍下，page-diff在具体的实践中的一些应用</p>
</blockquote>
<h2 id="核心dom校验"><a href="#核心dom校验" class="headerlink" title="核心dom校验"></a>核心dom校验</h2><p>前端的快速发展，造成前端dom无论结构还是命名经常变化，每次都尽可能关注每个dom的变化，不可能也没有必要。但是<code>核心dom是相对变化较小，但是比较重要</code>，因此可以利用page-monitor 修改关注结构中的核心代码，核心架构的变化。</p>
<p>上图是未修改的代码，下图是忽略footer内部变化<br><a href="http://cuihuan.net/wp-content/uploads/2016/08/F1AE4B80-CFC6-4A94-AB24-86297DCDD759.png"><img src="http://cuihuan.net/wp-content/uploads/2016/08/F1AE4B80-CFC6-4A94-AB24-86297DCDD759.png" alt="F1AE4B80-CFC6-4A94-AB24-86297DCDD759"></a><br><a href="http://cuihuan.net/wp-content/uploads/2016/08/0141A2E8-9B5E-439A-9FEC-1147ACF982DF.png"><img src="http://cuihuan.net/wp-content/uploads/2016/08/0141A2E8-9B5E-439A-9FEC-1147ACF982DF.png" alt="0141A2E8-9B5E-439A-9FEC-1147ACF982DF"></a><br>实践中可以针对自身的核心dom进行进一步优化</p>
<h2 id="局部dom校验"><a href="#局部dom校验" class="headerlink" title="局部dom校验"></a>局部dom校验</h2><p>项目中，往往在某一时期特别关心某些板块，或者某些板块相对容易出错；因此，可以利用page-monitor 进行局部dom的细节diff。中篇中对只针对header进行对比diff做了详细介绍，此处不赘述，上图。</p>
<p><a href="http://cuihuan.net/wp-content/uploads/2016/08/FDF6B258-5A69-47D1-B1FF-4EB38D7B8677.png"><img src="http://cuihuan.net/wp-content/uploads/2016/08/FDF6B258-5A69-47D1-B1FF-4EB38D7B8677.png" alt="FDF6B258-5A69-47D1-B1FF-4EB38D7B8677"></a></p>
<h2 id="算法优化"><a href="#算法优化" class="headerlink" title="算法优化"></a>算法优化</h2><p>由于获取了完整了dom的json，因此可以通过相关阈值的设定或者算法的优化；来对比结果，进行更加优化的分级预警和分析；作者一般对非核心预警超过15%变化会做出预警，超过更高阈值会进一步的预警等等。<br>贴一个dom 细节图<br> <a href="http://cuihuan.net/wp-content/uploads/2016/08/dom.jpg"><img src="http://cuihuan.net/wp-content/uploads/2016/08/dom.jpg" alt="dom"></a></p>
<h2 id="其他分析"><a href="#其他分析" class="headerlink" title="其他分析"></a>其他分析</h2><p>小拽通过上面的举例，旨在抛砖引玉，希望page-monitor或者dom结构在前端的自动化测试有一定应用，提升产品质量。</p>
<p>最终再上一张流程图，便于分析<br><a href="http://cuihuan.net/wp-content/uploads/2016/08/page-diff-%E6%B5%81%E7%A8%8B%E5%9B%BE.png"><img src="http://cuihuan.net/wp-content/uploads/2016/08/page-diff-%E6%B5%81%E7%A8%8B%E5%9B%BE.png" alt="page-diff 流程图"></a></p>
<p>相关文章：<br><a href="http://cuihuan.net/?p=485">【page-monitor 前端自动化 上篇】 初步调研</a><br><a href="http://cuihuan.net/?p=493">【page-monitor 前端自动化 中篇】 源码分析</a></p>
]]></content>
      
        
        <tags>
            
            <tag> javascript </tag>
            
            <tag> 前端 </tag>
            
            <tag> 自动化测试 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[phpredis单例模式封装]]></title>
      <url>/2016/08/08/phpredis%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F%E5%B0%81%E8%A3%85/</url>
      <content type="html"><![CDATA[<blockquote>
<p>通过单例模式实现对phpredis连接的封装。</p>
</blockquote>
<h2 id="直接上代码"><a href="#直接上代码" class="headerlink" title="直接上代码"></a>直接上代码</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?php</span></span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Class RedisConnManager</div><div class="line"> *</div><div class="line"> * 单例模式对redis实例的操作的进一步封装</div><div class="line"> * 主要目的：防止过多的连接，一个页面只能存在一个声明连接</div><div class="line"> * </div><div class="line"> * <span class="doctag">@author</span> ：cuihuan</div><div class="line"> */</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RedisManager</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> $redisInstance;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 私有化构造函数</div><div class="line">     * 原因：防止外界调用构造新的对象</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;&#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 获取redis连接的唯一出口</div><div class="line">     */</div><div class="line">    <span class="keyword">static</span> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getRedisConn</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">if</span>(!<span class="keyword">self</span>::$redisInstance <span class="keyword">instanceof</span> <span class="keyword">self</span>)&#123;</div><div class="line">            <span class="keyword">self</span>::$redisInstance = <span class="keyword">new</span> <span class="keyword">self</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line">        <span class="comment">// 获取当前单例</span></div><div class="line">        $temp = <span class="keyword">self</span>::$redisInstance;</div><div class="line">        <span class="comment">// 调用私有化方法</span></div><div class="line">        <span class="keyword">return</span> $temp-&gt;connRedis();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 连接ocean 上的redis的私有化方法</div><div class="line">     * <span class="doctag">@return</span> Redis</div><div class="line">     */</div><div class="line">    <span class="keyword">static</span> <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">connRedis</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            $redis_ocean = <span class="keyword">new</span> Redis();</div><div class="line">            $redis_ocean-&gt;connect(G::$conf[<span class="string">'redis-host'</span>], G::$conf[<span class="string">'redis-port'</span>]);</div><div class="line">            $redis_ocean-&gt;auth(G::$conf[<span class="string">'redis-pass'</span>]);</div><div class="line"></div><div class="line">        &#125;<span class="keyword">catch</span> (<span class="keyword">Exception</span> $e)&#123;</div><div class="line">            <span class="keyword">echo</span> $e-&gt;getMessage().<span class="string">'&lt;br/&gt;'</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> $redis_ocean;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>【转载请注明：<a href="http://cuihuan.net/?p=527">phpredis单例模式封装</a> | <a href="http://cuihuan.net">靠谱崔小拽</a> 】</p>
]]></content>
      
        
        <tags>
            
            <tag> php </tag>
            
            <tag> redis </tag>
            
            <tag> 单例模式 </tag>
            
            <tag> 设计模式 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[【page-monitor 前端自动化 中篇】 源码分析]]></title>
      <url>/2016/08/07/page_monitor_second/</url>
      <content type="html"><![CDATA[<blockquote>
<p>上篇中初探了page-monitor的一些功能和在前端自动化测试方面的可行性，本篇主要分析下page-monitor的实现方式和源码。</p>
</blockquote>
<h2 id="mode-module简介"><a href="#mode-module简介" class="headerlink" title="mode-module简介"></a>mode-module简介</h2><p>page-monitor的存在形式是node-module，依赖于node安装和运行，简单必须了解下node_modules</p>
<p><code>node-module</code>是nodejs的模块，符合commonJs规范【具体规范可以参考：<a href="http://javascript.ruanyifeng.com/nodejs/module.html】" target="_blank" rel="external">http://javascript.ruanyifeng.com/nodejs/module.html】</a></p>
<p>简单描述commonJs规范<br>1：文件即模块，作用域在文件内，不允许重复，不会污染。<br>2：<code>加载依赖出现顺序</code>，加载即运行，重复则利用缓存。</p>
<blockquote>
<p>多说一句：这是amd 和cmd(commonJs)的本质区别，由于node多运行于服务端，加载比较快，因此比较适合cmd 规范，浏览器端的模块则更适用于cmd的规范，个人理解没有广义的好坏之分</p>
</blockquote>
<p>方便看源码，贴出node_modole简单构成和主要函数module<br>node内部提供一了一个modle的构造函数，所有的模块都继承和依赖于此模块。<br><a href="http://cuihuan.net/wp-content/uploads/2016/08/F4D61DF9-40DC-4DB6-A98E-6BED90406D5A.png"><img src="http://cuihuan.net/wp-content/uploads/2016/08/F4D61DF9-40DC-4DB6-A98E-6BED90406D5A.png" alt="F4D61DF9-40DC-4DB6-A98E-6BED90406D5A"></a><br>node module的引入 require命令。<br>其他加载规则，路径设定不在此赘述。</p>
<h2 id="page-monitor文件分析"><a href="#page-monitor文件分析" class="headerlink" title="page-monitor文件分析"></a>page-monitor文件分析</h2><p>完整文件目录：<br><a href="http://cuihuan.net/wp-content/uploads/2016/08/B39BD2DF-7652-49F9-A8FB-F2F691688169.png"><img src="http://cuihuan.net/wp-content/uploads/2016/08/B39BD2DF-7652-49F9-A8FB-F2F691688169.png" alt="B39BD2DF-7652-49F9-A8FB-F2F691688169"></a>  </p>
<p>运行生成目录分析：<br><a href="http://cuihuan.net/wp-content/uploads/2016/08/dom-%E5%88%86%E5%B8%83.jpg"><img src="http://cuihuan.net/wp-content/uploads/2016/08/dom-%E5%88%86%E5%B8%83.jpg" alt="B39BD2DF-7652-49F9-A8FB-F2F691688169"></a>  </p>
<p>出了node_module及其组件代码，可用和值的分析的文件index.js 和phantomjs 下面的五个文件。</p>
<h2 id="分析index-js"><a href="#分析index-js" class="headerlink" title="分析index.js"></a>分析index.js</h2><p>代码中无非变量声明和引用，关键一句引用phantom的命令乳腺<br><figure class="highlight gauss"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 多线程启动位置</span></div><div class="line">var <span class="function"><span class="keyword">proc</span> = <span class="title">spawn</span><span class="params">(binPath, arr)</span></span>;</div></pre></td></tr></table></figure></p>
<p>通过上面多线程的启动node可以达到高效和并发处理测试任务的需求，分析下arr的内容如下图：看到了 窗口大小，延时，ua，存放地址，diff变量等等</p>
<p><a href="http://cuihuan.net/wp-content/uploads/2016/08/E9B3CEA8-6B99-45CC-A52A-B8E9D90B267C.png"><img src="http://cuihuan.net/wp-content/uploads/2016/08/E9B3CEA8-6B99-45CC-A52A-B8E9D90B267C.png" alt="E9B3CEA8-6B99-45CC-A52A-B8E9D90B267C"></a></p>
<h2 id="分析获取DOM源码"><a href="#分析获取DOM源码" class="headerlink" title="分析获取DOM源码"></a>分析获取DOM源码</h2><p>获取dom的源码主要利用了web api evalution，evalution传入一个xpath的参数，返回一个xpath的对象，之后通过遍历和xpath规则生成规则化的json。<br>贴一个evalution api<br><a href="http://cuihuan.net/wp-content/uploads/2016/08/90E47065-DF3B-470E-996C-1900A2EAF354.png"><img src="http://cuihuan.net/wp-content/uploads/2016/08/90E47065-DF3B-470E-996C-1900A2EAF354.png" alt="90E47065-DF3B-470E-996C-1900A2EAF354"></a> </p>
<p>为了看懂page-monitor的代码举个栗子<br><figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"># evalution example:</div><div class="line"></div><div class="line"><span class="keyword">var</span> headings = <span class="built_in">document</span>.evaluate(<span class="string">"/html/body//h2"</span>, <span class="built_in">document</span>, <span class="keyword">null</span>, XPathResult.ANY_TYPE, <span class="keyword">null</span>);</div><div class="line"><span class="comment">/* 检索body中所有H2的所欲.</span></div><div class="line"> * 结果存在于一个node的迭代器中 */</div><div class="line"><span class="keyword">var</span> thisHeading = headings.iterateNext();</div><div class="line"><span class="keyword">var</span> alertText = <span class="string">"Level 2 headings in this document are:\n"</span>;</div><div class="line"><span class="keyword">while</span> (thisHeading) &#123;</div><div class="line">  alertText += thisHeading.textContent + <span class="string">"\n"</span>;</div><div class="line">  thisHeading = headings.iterateNext();</div><div class="line">&#125;</div><div class="line">alert(alertText); <span class="comment">// Alerts the text of all h2 elements</span></div></pre></td></tr></table></figure></p>
<p>通过上面函数和page-monitor中walk.js函数最后一行，可以看出page-monitor 保存了四个元素：属性[name,id等等]，节点类型，位置[后期渲染]，样式的md5加密[样式仅需要对比是否变化即可]<br>具体内容和dom结构如下：<br> <a href="http://cuihuan.net/wp-content/uploads/2016/08/30FA5132-7903-466A-B866-588311812C47.png"><img src="http://cuihuan.net/wp-content/uploads/2016/08/30FA5132-7903-466A-B866-588311812C47.png" alt="30FA5132-7903-466A-B866-588311812C47"></a><br>对应的具体dom结构<br><a href="http://cuihuan.net/wp-content/uploads/2016/08/FBEE1F3F-7A81-4AF0-8E05-7E0BED5B5291.png"><img src="http://cuihuan.net/wp-content/uploads/2016/08/FBEE1F3F-7A81-4AF0-8E05-7E0BED5B5291.png" alt="FBEE1F3F-7A81-4AF0-8E05-7E0BED5B5291"></a> </p>
<h2 id="diff-js-代码"><a href="#diff-js-代码" class="headerlink" title="diff.js 代码"></a>diff.js 代码</h2><p>diff代码主要两个作用</p>
<ul>
<li>1：获取差异</li>
<li>2：渲染差异<br>其中对比的策略：</li>
</ul>
<p>历史完全每个对比现在：获取更新和删除的内容<br>现在完全每个对比历史：获取更新和新增的内容<br>具体可以参考代码</p>
<h2 id="其他api和源码简单修改"><a href="#其他api和源码简单修改" class="headerlink" title="其他api和源码简单修改"></a>其他api和源码简单修改</h2><p>必须了解的web api 还有一个是querySeletor 也就是检索的api，参考地址<br><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Document/querySelector" target="_blank" rel="external">document.querySelector()</a><br>了解了这个api就可以做一件事情：<code>不对全局dom diff，只对特别关心的dom进行diff</code><br>实现方式：修改querySelector的根节点为Header<br>获取的dom结构如下：根节点为header<br><a href="http://cuihuan.net/wp-content/uploads/2016/08/30FA5132-7903-466A-B866-588311812C47.png"><img src="http://cuihuan.net/wp-content/uploads/2016/08/30FA5132-7903-466A-B866-588311812C47.png" alt="30FA5132-7903-466A-B866-588311812C47"></a></p>
<p>获取的页面截图如下：<br><a href="http://cuihuan.net/wp-content/uploads/2016/08/FDF6B258-5A69-47D1-B1FF-4EB38D7B8677.png"><img src="http://cuihuan.net/wp-content/uploads/2016/08/FDF6B258-5A69-47D1-B1FF-4EB38D7B8677.png" alt="FDF6B258-5A69-47D1-B1FF-4EB38D7B8677"></a></p>
<h2 id="代码流程图"><a href="#代码流程图" class="headerlink" title="代码流程图"></a>代码流程图</h2><p> <a href="http://cuihuan.net/wp-content/uploads/2016/08/page-diff-流程图.png"><img src="http://cuihuan.net/wp-content/uploads/2016/08/page-diff-%E6%B5%81%E7%A8%8B%E5%9B%BE.png" alt="page-diff 流程图"></a></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本次在调研page-monitor的基础上，对page-monitor的源码实现进行分析；同时利用相关api修改，来只对核心页面进行获取优化。下一篇将会进一步思考page-monitor的应用。</p>
<p>相关文章：<br><a href="http://cuihuan.net/?p=485">【page-monitor 前端自动化 上篇】 初步调研</a><br><a href="http://cuihuan.net/?p=508">【page-monitor 前端自动化 下篇】 实践应用</a></p>
]]></content>
      
        
        <tags>
            
            <tag> javascript </tag>
            
            <tag> 自动化测试 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[【page-monitor 前端自动化 上篇】初步调研]]></title>
      <url>/2016/08/07/%E3%80%90page-monitor%20%E5%89%8D%E7%AB%AF%E8%87%AA%E5%8A%A8%E5%8C%96%20%E4%B8%8A%E7%AF%87%E3%80%91%E5%88%9D%E6%AD%A5%E8%B0%83%E7%A0%94%20/</url>
      <content type="html"><![CDATA[<blockquote>
<p>前端自动化测试主要在于：<code>变化快，不稳定，兼容性复杂</code>；故而，想通过较低的成本维护较为通用的自动化case比较困难。本文旨在<code>通过page-monitor获取和分析dom结构，调研能否通过监控和分析核心dom，来进行前端自动化测试</code>。</p>
</blockquote>
<h2 id="一：page-monitor-介绍"><a href="#一：page-monitor-介绍" class="headerlink" title="一：page-monitor 介绍"></a>一：page-monitor 介绍</h2><p>page-monitor：通过xpath获取dom节点结构，之后可视化的渲染出页面的差异。<br>github地址：<a href="https://github.com/fouber/page-monitor" target="_blank" rel="external">https://github.com/fouber/page-monitor</a><br>基本原理：<code>利用xpath获取页面的dom结构，存储为结构化的json，对比两次的json之间的差异，利用phantom渲染页面和差异页面</code>。</p>
<p>先上个初次试用的图</p>
<p><a href="http://cuihuan.net/wp-content/uploads/2016/08/927EE33C-AD06-4EC3-9E5C-B8C3D2029AA3.png"><img src="http://cuihuan.net/wp-content/uploads/2016/08/927EE33C-AD06-4EC3-9E5C-B8C3D2029AA3-212x300.png" alt="927EE33C-AD06-4EC3-9E5C-B8C3D2029AA3"></a></p>
<h2 id="二：初次试用"><a href="#二：初次试用" class="headerlink" title="二：初次试用"></a>二：初次试用</h2><h3 id="2-1-安装"><a href="#2-1-安装" class="headerlink" title="2.1 安装"></a>2.1 安装</h3><figure class="highlight cmake"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># page-monitor 依赖于 phantomjs</span></div><div class="line">npm <span class="keyword">install</span> phantomjs</div><div class="line">npm <span class="keyword">install</span> page-monitor</div></pre></td></tr></table></figure>
<p>注意：phantomJs较大，如果比较慢 可以用brew安装，并且<code>page-monitor最多兼容phantom1.98</code><br><figure class="highlight dts"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta"># 调整phantom为1.98 版本</span></div><div class="line">MacBook-Pro:~ cuixiaohuan$ brew link phantomjs198</div><div class="line">Linking <span class="meta-keyword">/usr/</span>local/Cellar<span class="meta-keyword">/phantomjs198/</span><span class="number">1.9</span><span class="number">.8</span>... <span class="number">2</span> symlinks created</div><div class="line">MacBook-Pro:~ cuixiaohuan$ phantomjs -v</div><div class="line"><span class="number">1.9</span><span class="number">.8</span></div></pre></td></tr></table></figure></p>
<p>2.2 初次运行：<br>写一个test.js 代码如下:<br><figure class="highlight qml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">var</span> Monitor = <span class="built_in">require</span>(<span class="string">'page-monitor'</span>);</div><div class="line"></div><div class="line"><span class="built_in">var</span> <span class="built_in">url</span> = <span class="string">'http://www.baidu.com'</span>;</div><div class="line"><span class="built_in">var</span> monitor = <span class="keyword">new</span> Monitor(<span class="built_in">url</span>);</div><div class="line">monitor.capture(<span class="function"><span class="keyword">function</span>(<span class="params">code</span>)</span>&#123;</div><div class="line">        <span class="built_in">console</span>.log(monitor.log); <span class="comment">// from phantom</span></div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'done, exit ['</span> + code + <span class="string">']'</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>运行效果<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">MacBook-Pro:test cuixiaohuan$ node test.js</div><div class="line">&#123; debug:</div><div class="line">   [ <span class="string">'mode: 11'</span>,</div><div class="line">     <span class="string">'need diff'</span>,</div><div class="line">     <span class="string">'loading: http://www.baidu.com'</span>,</div><div class="line">     <span class="string">'page.viewportSize = &#123;"width":320,"height":568&#125;'</span>,</div><div class="line">     <span class="string">'page.settings.resourceTimeout = 20000'</span>,</div><div class="line">     <span class="string">'page.settings.userAgent = "Mozilla/5.0 (iPhone; CPU iPhone OS 7_0 like Mac OS X; en-us) AppleWebKit/537.51.1 (KHTML, like Gecko) Version/7.0 Mobile/11A465 Safari/9537.53"'</span>,</div><div class="line">     <span class="string">'loaded: http://www.baidu.com'</span>,</div><div class="line">     <span class="string">'delay before render: 0ms'</span>,</div><div class="line">     <span class="string">'walk tree'</span>,</div><div class="line">     <span class="string">'save capture [/Users/cuixiaohuan/Desktop/workspace/test/pagemonitor/test/www.baidu.com/Lw==/1461155680901]'</span>,</div><div class="line">     <span class="string">'screenshot [/Users/cuixiaohuan/Desktop/workspace/test/pagemonitor/test/www.baidu.com/Lw==/1461155680901/screenshot.jpg]'</span>,</div><div class="line">     <span class="string">'Unsafe JavaScript attempt to access frame with URL about:blank from frame with URL file:///Users/cuixiaohuan/Desktop/workspace/test/pagemonitor/test/node_modules/page-monitor/phantomjs/index.js. Domains, protocols and ports must match.'</span> ],</div><div class="line">  warning: [],</div><div class="line">  info: [],</div><div class="line">  error: [],</div><div class="line">  notice: [] &#125;</div><div class="line">done, <span class="keyword">exit</span> [<span class="number">0</span>]</div></pre></td></tr></table></figure></p>
<h3 id="2-2-生成对比页面"><a href="#2-2-生成对比页面" class="headerlink" title="2.2 生成对比页面"></a>2.2 生成对比页面</h3><p> test.js code</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">monitor.diff(<span class="number">1408947323420</span>, <span class="number">1408947556898</span>, <span class="function"><span class="keyword">function</span>(<span class="params">code</span>)</span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(monitor.log.info); <span class="comment">// diff result</span></div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'[DONE] exit ['</span> + code + <span class="string">']'</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>运行<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">MacBook-Pro:test cuixiaohuan$ <span class="keyword">node</span> <span class="title">test</span>.js</div><div class="line">[ '&#123;<span class="string">"diff"</span>:&#123;<span class="string">"left"</span>:<span class="string">"1461155680901"</span>,<span class="string">"right"</span>:<span class="string">"1461163758667"</span>,<span class="string">"screenshot"</span>:<span class="string">"/Users/cuixiaohuan/Desktop/workspace/test/pagemonitor/test/www.baidu.com/Lw==/diff/1461155680901-1461163758667.jpg"</span>,<span class="string">"count"</span>:&#123;<span class="string">"add"</span>:<span class="number">2</span>,<span class="string">"remove"</span>:<span class="number">2</span>,<span class="string">"style"</span>:<span class="number">0</span>,<span class="string">"text"</span>:<span class="number">9</span>&#125;&#125;&#125;' ]</div><div class="line">[DONE] exit [<span class="number">0</span>]</div></pre></td></tr></table></figure></p>
<h3 id="2-3-对比页面效果如下图"><a href="#2-3-对比页面效果如下图" class="headerlink" title="2.3 对比页面效果如下图"></a>2.3 对比页面效果如下图</h3><p><a href="http://cuihuan.net/wp-content/uploads/2016/08/927EE33C-AD06-4EC3-9E5C-B8C3D2029AA3.png"><img src="http://cuihuan.net/wp-content/uploads/2016/08/927EE33C-AD06-4EC3-9E5C-B8C3D2029AA3-212x300.png" alt="927EE33C-AD06-4EC3-9E5C-B8C3D2029AA3"></a></p>
<h3 id="2-4-目录初步分析"><a href="#2-4-目录初步分析" class="headerlink" title="2.4 目录初步分析"></a>2.4 目录初步分析</h3><p>通过目录和运行结果<br>1：每个时间利用phantom生成一张截图【保存现场】和一个dome的tree.json【对比dom】 【生成过程看下源码】<br>2：diff 调用tree.json 比较区中的区别【位置，内容生成和对比过程之后看下源码？】<br>3：利用当时保存的截图渲染生成的结果</p>
<p><a href="http://cuihuan.net/wp-content/uploads/2016/08/F2838502-FF7E-4DC8-9C7F-01687F3DB3E9.png"><img src="http://cuihuan.net/wp-content/uploads/2016/08/F2838502-FF7E-4DC8-9C7F-01687F3DB3E9-300x151.png" alt="F2838502-FF7E-4DC8-9C7F-01687F3DB3E9"></a></p>
<h2 id="三：dom-diff工具page-monitor-调研初步结论："><a href="#三：dom-diff工具page-monitor-调研初步结论：" class="headerlink" title="三：dom diff工具page monitor 调研初步结论："></a>三：dom diff工具page monitor 调研初步结论：</h2><ul>
<li>1：dom的diff 是可行的。</li>
<li>2：page monitor 现有主要功能：抽取不同时间段的页面做页面domdiff<br>使用过程中缺陷：<br>1：依赖太多，依赖node，依赖phantom，<br>2：接口太少，现在直接提供的就两个一个保存现场，一个diff。不方便dom定制和阈值定制。</li>
</ul>
<h2 id="四：应用价值思考和下一步"><a href="#四：应用价值思考和下一步" class="headerlink" title="四：应用价值思考和下一步"></a>四：应用价值思考和下一步</h2><p>如果能对dom树的处理更完善一些，应用价值还是挺高的，例如<code>核心dom的diff，局部dom的diff，时效性dom(例如：时间tag必须变化，不变化则为bug)的变更检验，兼容性dom的check等等</code></p>
<p>下一步调研：<br>看下源码中，分析dom生成tree过程，对比tree过程，展现tree过程。</p>
<p>相关文章：<br><a href="http://cuihuan.net/?p=493">【page-monitor 前端自动化 中篇】 源码分析</a><br><a href="http://cuihuan.net/?p=508">【page-monitor 前端自动化 下篇】 实践应用</a></p>
]]></content>
      
        
        <tags>
            
            <tag> javascript </tag>
            
            <tag> 自动化测试 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[【chrome 插件一】开发一个简单chrome浏览器插件]]></title>
      <url>/2016/04/26/chrome_1/</url>
      <content type="html"><![CDATA[<blockquote>
<p>chrome 之所以越来越好用，很大一部分原因归功于功能丰富的插件；对于chrome忠实用户来说，了解和开发一款适合自己的chrome插件，确实是一件很cool的事情。</p>
</blockquote>
<h2 id="了解chrome-插件"><a href="#了解chrome-插件" class="headerlink" title="了解chrome 插件"></a>了解chrome 插件</h2><p>chrome 插件个人理解：<code>就是一个html + js +css + image的一个web应用</code>；不同于普通的web应用，<code>chrome插件除了兼容普通的js，json，h5等api，还可以调用一些浏览器级别的api，例如收藏夹，历史记录等。</code></p>
<p>推荐两个网站了解和入门<br>谷歌官方API：<a href="https://developer.chrome.com/extensions/getstarted" target="_blank" rel="external">https://developer.chrome.com/extensions/getstarted</a><br>360的文档：<a href="http://open.chrome.360.cn/extension_dev/overview.html" target="_blank" rel="external">http://open.chrome.360.cn/extension_dev/overview.html</a></p>
<h2 id="开始写第一个插件"><a href="#开始写第一个插件" class="headerlink" title="开始写第一个插件"></a>开始写第一个插件</h2><h3 id="文件结构"><a href="#文件结构" class="headerlink" title="文件结构"></a>文件结构</h3><p>一个简单的demo，文件目录如下<br><a href="http://cuihuan.net/wp-content/uploads/2016/04/7A980C32-7D7B-44F6-AC5D-C0CC02F79ACA.png"><img src="http://cuihuan.net/wp-content/uploads/2016/04/7A980C32-7D7B-44F6-AC5D-C0CC02F79ACA.png" alt="7A980C32-7D7B-44F6-AC5D-C0CC02F79ACA"></a><br>和普通的web文件没有什么区别，简单介绍下</p>
<ul>
<li>html:存放html页面</li>
<li>js :存放js</li>
<li>locales ：存放了一个多语言的兼容【可无】</li>
<li>image ：放了两张图片【初期图标】</li>
<li>manifest ：核心入口文件</li>
</ul>
<h3 id="写一个manifest"><a href="#写一个manifest" class="headerlink" title="写一个manifest"></a>写一个manifest</h3><p>api参考文档 :<a href="http://open.chrome.360.cn/extension_dev/manifest.html" target="_blank" rel="external">http://open.chrome.360.cn/extension_dev/manifest.html</a></p>
<p>直接上代码：<br><figure class="highlight clojure"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="string">"name"</span>: <span class="string">"hijack analyse plug"</span>,</div><div class="line">  <span class="string">"version"</span>: <span class="string">"0.0.1"</span>,</div><div class="line">  <span class="string">"manifest_version"</span>: <span class="number">2</span>,</div><div class="line"></div><div class="line">  // 简单描述</div><div class="line">  <span class="string">"description"</span>: <span class="string">"chrome plug analyse and guard the http hijack"</span>,</div><div class="line">  <span class="string">"icons"</span>: &#123;</div><div class="line">    <span class="string">"16"</span>: <span class="string">"image/icon16.png"</span>,</div><div class="line">    <span class="string">"48"</span>: <span class="string">"image/icon48.png"</span></div><div class="line">  &#125;,</div><div class="line">  // 选择默认语言</div><div class="line">  <span class="string">"default_locale"</span>: <span class="string">"en"</span>,</div><div class="line"></div><div class="line">  // 浏览器小图表部分</div><div class="line">  <span class="string">"browser_action"</span>: &#123;</div><div class="line">    <span class="string">"default_title"</span>: <span class="string">"反劫持"</span>,</div><div class="line">    <span class="string">"default_icon"</span>: <span class="string">"image/icon16.png"</span>,</div><div class="line">    <span class="string">"default_popup"</span>: <span class="string">"html/test.html"</span></div><div class="line">  &#125;,</div><div class="line"></div><div class="line">  // 引入一个脚本</div><div class="line">  <span class="string">"content_scripts"</span>: [</div><div class="line">    &#123;</div><div class="line">      <span class="string">"js"</span>: [<span class="string">"script/test.js"</span>],</div><div class="line">      // 在什么情况下使用该脚本</div><div class="line">      <span class="string">"matches"</span>: [</div><div class="line">        <span class="string">"http://*/*"</span>,</div><div class="line">        <span class="string">"https://*/*"</span></div><div class="line">      ],</div><div class="line">      // 什么情况下运行【文档加载开始】</div><div class="line">      <span class="string">"run_at"</span>: <span class="string">"document_start"</span></div><div class="line">    &#125;</div><div class="line">  ],</div><div class="line">  // 应用协议页面</div><div class="line">  <span class="string">"permissions"</span>: [</div><div class="line">    <span class="string">"http://*/*"</span>,</div><div class="line">    <span class="string">"https://*/*"</span></div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>test.js 文件<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * @author: cuixiaohuan</div><div class="line"> * Date: 16/4/13</div><div class="line"> * Time: 下午8:41</div><div class="line"> */</div><div class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * just test for run by self</div><div class="line">     */</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'begin'</span>);</div><div class="line">&#125;)();</div></pre></td></tr></table></figure></p>
<p>test.html 文件<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">head</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>just for test<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">h3</span>&gt;</span>test<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h3 id="运行插件"><a href="#运行插件" class="headerlink" title="运行插件"></a>运行插件</h3><p>chrome 中输入：chrome://extensions<br>选择加载已解压的插件-》选择文件根目录即可。<br>效果如下：</p>
<p><a href="http://cuihuan.net/wp-content/uploads/2016/04/475BA7E7-29F3-48AF-9990-2B73FF1B4B56.png"><img src="http://cuihuan.net/wp-content/uploads/2016/04/475BA7E7-29F3-48AF-9990-2B73FF1B4B56.png" alt="生效插件"></a><br>一个基本的插件变完成了，勾选已启用，随便打开一个网页，会看到log中输出如下</p>
<p><a href="http://cuihuan.net/wp-content/uploads/2016/04/50F1039A-71C0-463F-A60D-C95527985C7E.png"><img src="http://cuihuan.net/wp-content/uploads/2016/04/50F1039A-71C0-463F-A60D-C95527985C7E.png" alt="运行效果"></a></p>
<p>点击页面上面的小图标如下图：<br><a href="http://cuihuan.net/wp-content/uploads/2016/04/25CF59DD-0666-4A6F-ACA3-683D1FEEA346.png"><img src="http://cuihuan.net/wp-content/uploads/2016/04/25CF59DD-0666-4A6F-ACA3-683D1FEEA346.png" alt="右侧展示"></a></p>
<h2 id="优化建议"><a href="#优化建议" class="headerlink" title="优化建议"></a>优化建议</h2><p>一个小的插件已经完成，但是还有更多的api和有趣的事情可以去做。下面是360文档中给出一些优化建议，共勉。</p>
<ul>
<li>确认 Browser actions 只使用在大多数网站都有功能需求的场景下。确认 Browser actions 没有使用在少数网页才有功能的场景， 此场景请使用page actions。</li>
<li>确认你的图标尺寸尽量占满19x19的像素空间。 Browser action 的图标应该看起来比page action的图标更大更重。</li>
<li>尽量使用alpha通道并且柔滑你的图标边缘，因为很多用户使用themes，你的图标应该在在各种背景下都表现不错。不要不停的闪动你的图标，这很惹人反感。</li>
</ul>
<p>【转载请注明：<a href="http://cuihuan.net/article/postmessage%E5%A4%84%E7%90%86iframe-%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98.html">【chrome 插件一】开发一个简单chrome浏览器插件</a> | <a href="http://cuihuan.net">靠谱崔小拽</a> 】</p>
]]></content>
      
        
        <tags>
            
            <tag> javascript </tag>
            
            <tag> chrome-extension </tag>
            
            <tag> chrome </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[中型存储架构实践探索]]></title>
      <url>/2016/04/20/%E4%B8%AD%E5%9E%8B%E5%AD%98%E5%82%A8%E6%9E%B6%E6%9E%84%E5%AE%9E%E8%B7%B5%E6%8E%A2%E7%B4%A2/</url>
      <content type="html"><![CDATA[<blockquote>
<p>最近一直在做平台优化：对于中小型的站点，<code>如何在资源有限的情况下，实现一个稳定，高效，靠谱的存储方案</code>。下图是小拽个人在时间过程使用的一个存储架构。拿出来分享交流一下，也希望得到指点改进！</p>
</blockquote>
<h2 id="先上图"><a href="#先上图" class="headerlink" title="先上图"></a>先上图</h2><p><a href="http://cuihuan.net/wp-content/uploads/2016/02/存储架构.jpg"><img src="http://cuihuan.net/wp-content/uploads/2016/02/存储架构-1024x996.jpg" alt="存储架构"></a></p>
<h2 id="首先说思想"><a href="#首先说思想" class="headerlink" title="首先说思想"></a>首先说思想</h2><p>思想就一个：<code>权衡资源和业务需求</code></p>
<blockquote>
<p>简单解释一下：对于架构的理解，个人非常认同百度架构师tandai的一句话：<code>架构设计本质上是折衷的艺术</code>，如果你有足够量的高速存储和高性能的机器，那么完全可以用足量的cache，足量的离线计算存储，来提升时效性；同样，如果你的机器不足，资源不足，那么就可以通过可接受的时间消耗来节省存储空间。</p>
</blockquote>
<p>架构基本组件：</p>
<ul>
<li>至少两台机器。【保证物理容灾】</li>
<li>三个mysql实例。【一主两从，一主不解释；一从主要用于实时备份，暂叫容灾从；一从用于离线计算，cache更新，非时效性的数据抓取，暂叫api从；】</li>
<li>ameoba 负责负载均衡和读写分离【暂时用着还可以】。</li>
<li>redis 负责缓存，预取，存储cache。【可以换成其他】</li>
<li>一个抗高并发的中间件。【暂时只加了antispam组件，高并发并未处理，可能系统负载比较平均，qpd几千万 ，但是并未出现qps峰值】</li>
</ul>
<p>that’s all，这些组件对于一个操作尚可的程序员来说，部署一整套肯定不会特别麻烦，相对于其他大型的架构来说，略显简单；但是，麻雀虽小，五脏俱全，下面从架构必备的几个角度分析一下。</p>
<h2 id="安全性（Failover）"><a href="#安全性（Failover）" class="headerlink" title="安全性（Failover）"></a>安全性（Failover）</h2><p>任何一个架构首要考虑的是数据安全和容灾。小拽的架构中做了哪些</p>
<h3 id="数据库全量备份"><a href="#数据库全量备份" class="headerlink" title="数据库全量备份"></a>数据库全量备份</h3><p>这个就是一个简单脚本，对api从库在闲暇时间【晚上3-4点】进行全量导出备份，同时scp到另一台机器一份。（之所以对api库，是因为api库主要负责非失效性的查询和计算）</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># crontab 每天3点进行数据库备份 (cuihuan)</span></div><div class="line"><span class="comment"># 0 3 * * * sh /home/disk6/mysql/bin/backup.sh</span></div><div class="line"><span class="comment"># 每天备份，保存最近30天的</span></div><div class="line">DATE=$(date +%Y%m%d)</div><div class="line"><span class="regexp">/home/</span>xxx<span class="regexp">/bin/my</span>sqldump -uroot -pxxx db &gt; <span class="regexp">/home/</span>xxx<span class="regexp">/bak_sql/</span>db_<span class="variable">$DATE</span>.sql;</div><div class="line">find <span class="regexp">/home/</span>xxx<span class="regexp">/bak_sql/</span> -mtime +<span class="number">30</span> -name <span class="string">'*.sql'</span> -exec rm -rf &#123;&#125; \;</div></pre></td></tr></table></figure>
<h3 id="数据库增量备份"><a href="#数据库增量备份" class="headerlink" title="数据库增量备份"></a>数据库增量备份</h3><p>增量备份主要从两个角度</p>
<ul>
<li>binlog中定期备份sql；</li>
<li>是采用主从库之后，从库会定时的备份主库信息，同时，对api库采用数据完全一致，对容灾库则设置只同步update 和insert；这样完备的保证了数据的安全。</li>
</ul>
<h2 id="可用性（Availabilty）"><a href="#可用性（Availabilty）" class="headerlink" title="可用性（Availabilty）"></a>可用性（Availabilty）</h2><p>数据的安全排第一，毋庸置疑；次之排平台的可用性，也毫无争议。可用性最简单的一个指标则为：<code>不卡</code>。</p>
<h3 id="cache"><a href="#cache" class="headerlink" title="cache"></a>cache</h3><p>cache是提升查询时效性最有效的一个手段，小拽在框架中主要应用了两种cache，满足不同的业务需求。（所有关于cache的使用，一定要注意时效性和一致性，时效性和一致性，时效性和一致性）</p>
<ul>
<li>普通的cache。即用户搜索或者查询之后的结果存在redis里面，下次查询使用。</li>
<li>预取的cache。即预测用户要查询的内容，放到cache里面。举几个栗子，用户首页内容一定要存cache里面；用户在看page1的时候，可以后台预测用户会看page2，提前取过来等等，这些策略和自己的实际业务紧密结合。</li>
</ul>
<p>关于时效性和一致性再多说一句：一定要注意及时更新，例如用户写操作，点击操作，都需要在后台触发cache的主动更新，否则可能造成数据一致性错误。</p>
<h3 id="分库分表"><a href="#分库分表" class="headerlink" title="分库分表"></a>分库分表</h3><p><strong>中小型的架构中，存储的瓶颈往往在于读。</strong></p>
<p>随着数据的增加，读库的成本越来越大，一个sql很可能会造成锁死整个库，一条sql 10+s也是常有的事情；因此，解决读库的瓶颈，可以大大提升系统的可用性；小拽的实践中主要应用了分库，分表。</p>
<h3 id="分库"><a href="#分库" class="headerlink" title="分库"></a>分库</h3><p>之所以要分库，是因为<code>二八原则的存在，80%的用户操作集中于20%的数据</code>。</p>
<p>举个栗子：实践过程中小拽有个月库，只存本月的数据，基本上80%+的用户操作数据，都会命中这个库。</p>
<p>分库的原则有很多，例如时间原则，业务原则，数据逻辑原则等等；总之在您的框架中，当db扛不住的时候就分库，分层级。</p>
<h3 id="分表"><a href="#分表" class="headerlink" title="分表"></a>分表</h3><p>分表的思想和分库类似，只是粒度更小，不在赘述。</p>
<h2 id="扩展性（Scabability）"><a href="#扩展性（Scabability）" class="headerlink" title="扩展性（Scabability）"></a>扩展性（Scabability）</h2><p>小拽的架构中，扩展性主要从三个方面考虑</p>
<ul>
<li>1：数据库的扩展性。如果资源允许N主N从都是可以的，基本上不会影响业务操作。</li>
<li>2：缓存的扩展。缓存基本上也是单独部署的，redis，memcache等均可以，变更成本不大。</li>
<li>3：高并发和负载均衡。这块属于大型网站需要考虑的，暂时只采用了ameaba进行负载均衡的扩展，高并发预留接口。</li>
</ul>
<h2 id="权衡（Balance）"><a href="#权衡（Balance）" class="headerlink" title="权衡（Balance）"></a>权衡（Balance）</h2><p>所有的架构和技术，最终都要落实到和业务需求权衡。</p>
<p>上面的架构最大的优势其实就是：简单，搭建起来非常容易，这就够了。</p>
<p>作为一名码农，只有在实践的过程中，不断发现系统的瓶颈，权衡现有资源和需求，解决和处理问题，才能成为一名靠谱的码农。</p>
<p>以上只是小拽在实践过程中的一点小小心的，欢迎大家到小站交流（<a href="http://cuihuan.net）。" target="_blank" rel="external">http://cuihuan.net）。</a></p>
<p>【转载请注明：<a href="http://cuihuan.net/?p=460">中型存储架构实践探索</a> | <a href="http://cuihuan.net">靠谱崔小拽</a> 】</p>
]]></content>
      
        
        <tags>
            
            <tag> mysql </tag>
            
            <tag> redis </tag>
            
            <tag> 读写分离 </tag>
            
            <tag> 主从备份 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[【chrome 插件二】添加菜单和添加消息提醒]]></title>
      <url>/2016/04/20/chrome_2/</url>
      <content type="html"><![CDATA[<blockquote>
<p>上一篇中简单的接触了chrome插件，并且草草的制作一个chrome 插件（-_-只中看，不能用）；这次主要学习，<code>browse action api制作菜单制作和调用系统提醒</code>。</p>
</blockquote>
<h2 id="browse-action"><a href="#browse-action" class="headerlink" title="browse action"></a>browse action</h2><p>browse action 包括四部分：一个图标，一个tooltip，一个badge和一个pophtml<br>先上代码和效果<br><figure class="highlight xquery"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="string">"browser_action"</span>: &#123;</div><div class="line">   <span class="string">"default_title"</span>: <span class="string">"反劫持工具"</span>,</div><div class="line">   <span class="string">"default_icon"</span>: <span class="string">"image/icon_19.png"</span>,</div><div class="line">   <span class="string">"default_popup"</span>: <span class="string">"html/popup.html"</span></div><div class="line"> &#125;,</div></pre></td></tr></table></figure></p>
<p><a href="http://cuihuan.net/wp-content/uploads/2016/04/9E62D576-098D-4B4A-8C4C-1E845D23E094.png"><img src="http://cuihuan.net/wp-content/uploads/2016/04/9E62D576-098D-4B4A-8C4C-1E845D23E094.png" alt="red"></a></p>
<h3 id="图标"><a href="#图标" class="headerlink" title="图标"></a>图标</h3><p>图标优化：<code>最好是19px，这样基本占满</code>，可以直接使用图标也可以用h5 canvas element，同时，<code>图片一定要是背景透明的</code>。</p>
<p>ps处理后页面效果如下：</p>
<p><a href="http://cuihuan.net/wp-content/uploads/2016/04/C84884DF-38DB-4402-8BEF-181795A51FAF.png"><img src="http://cuihuan.net/wp-content/uploads/2016/04/C84884DF-38DB-4402-8BEF-181795A51FAF.png" alt="title"></a></p>
<h3 id="tooltip"><a href="#tooltip" class="headerlink" title="tooltip"></a>tooltip</h3><p>直接设置default_title 效果是鼠标经过显示标题效果</p>
<h3 id="badge"><a href="#badge" class="headerlink" title="badge:"></a>badge:</h3><p>这个相当于设置图片文字和背景色：提供了两个方法：设置badge文字和颜色可以分别使用setBadgeText()andsetBadgeBackgroundColor()。</p>
<h3 id="pophtml：创建菜单"><a href="#pophtml：创建菜单" class="headerlink" title="pophtml：创建菜单"></a>pophtml：创建菜单</h3><p>上码：<code>能用代码说话的，不用文字</code><br>js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * @author: cuixiaohuan</div><div class="line"> * Date: 16/4/19</div><div class="line"> * Time: 下午9:41</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 点击菜单的事件</div><div class="line"> *</div><div class="line"> * @param e</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">click</span>(<span class="params">e</span>) </span>&#123;</div><div class="line">    chrome.tabs.executeScript(<span class="literal">null</span>,</div><div class="line">        &#123;</div><div class="line">            <span class="comment">// 更改背景色</span></div><div class="line">            code: <span class="string">"document.body.style.backgroundColor='"</span> + e.target.id + <span class="string">"'"</span></div><div class="line">        &#125;</div><div class="line">    );</div><div class="line"></div><div class="line">    <span class="built_in">window</span>.close();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 页面加载完成后，监听事件</div><div class="line"> */</div><div class="line"><span class="built_in">document</span>.addEventListener(<span class="string">'DOMContentLoaded'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> divs = <span class="built_in">document</span>.querySelectorAll(<span class="string">'div'</span>);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; divs.length; i++) &#123;</div><div class="line">        divs[i].addEventListener(<span class="string">'click'</span>, click);</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>html<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;!doctype html&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Set Page Color Popup<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="css"></span></div><div class="line">        <span class="selector-tag">body</span> &#123;</div><div class="line">            <span class="attribute">overflow</span>: hidden;</div><div class="line">            <span class="attribute">margin</span>: <span class="number">0px</span>;</div><div class="line">            <span class="attribute">padding</span>: <span class="number">0px</span>;</div><div class="line">            <span class="attribute">background</span>: white;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="selector-tag">div</span><span class="selector-pseudo">:first-child</span> &#123;</div><div class="line">            <span class="attribute">margin-top</span>: <span class="number">0px</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="selector-tag">div</span> &#123;</div><div class="line">            <span class="attribute">cursor</span>: pointer;</div><div class="line">            <span class="attribute">text-align</span>: center;</div><div class="line">            <span class="attribute">padding</span>: <span class="number">1px</span> <span class="number">3px</span>;</div><div class="line">            <span class="attribute">font-family</span>: sans-serif;</div><div class="line">            <span class="attribute">font-size</span>: <span class="number">0.8em</span>;</div><div class="line">            <span class="attribute">width</span>: <span class="number">100px</span>;</div><div class="line">            <span class="attribute">margin-top</span>: <span class="number">1px</span>;</div><div class="line">            <span class="attribute">background</span>: <span class="number">#cccccc</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="selector-tag">div</span><span class="selector-pseudo">:hover</span> &#123;</div><div class="line">            <span class="attribute">background</span>: <span class="number">#aaaaaa</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="selector-id">#red</span> &#123;</div><div class="line">            <span class="attribute">border</span>: <span class="number">1px</span> solid red;</div><div class="line">            <span class="attribute">color</span>: red;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="selector-id">#blue</span> &#123;</div><div class="line">            <span class="attribute">border</span>: <span class="number">1px</span> solid blue;</div><div class="line">            <span class="attribute">color</span>: blue;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="selector-id">#green</span> &#123;</div><div class="line">            <span class="attribute">border</span>: <span class="number">1px</span> solid green;</div><div class="line">            <span class="attribute">color</span>: green;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="selector-id">#yellow</span> &#123;</div><div class="line">            <span class="attribute">border</span>: <span class="number">1px</span> solid yellow;</div><div class="line">            <span class="attribute">color</span>: yellow;</div><div class="line">        &#125;</div><div class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"../script/changeBackgroud.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"red"</span>&gt;</span>红色小拽<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"blue"</span>&gt;</span>绿色小拽<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"green"</span>&gt;</span>蓝色小拽<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"yellow"</span>&gt;</span>换色小拽<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>效果图<br><a href="http://cuihuan.net/wp-content/uploads/2016/04/4AA82B9D-759E-434E-A0B5-8F2F0376F16D.png"><img src="http://cuihuan.net/wp-content/uploads/2016/04/4AA82B9D-759E-434E-A0B5-8F2F0376F16D.png" alt="blue"></a></p>
<h2 id="调用系统提醒"><a href="#调用系统提醒" class="headerlink" title="调用系统提醒"></a>调用系统提醒</h2><p>notification api 官方文档:<a href="https://developer.chrome.com/extensions/notifications" target="_blank" rel="external">https://developer.chrome.com/extensions/notifications</a><br>注意</p>
<ul>
<li>chrome32 之前的预警接口不太一样，文档中已经说明。</li>
<li>使用预警一定要加上权限统一<figure class="highlight prolog"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="string">"permissions"</span>: [</div><div class="line">  <span class="string">"notifications"</span></div><div class="line">],</div></pre></td></tr></table></figure>
</li>
</ul>
<p>调用系统提醒代码<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">// 用户授权</span></div><div class="line"><span class="keyword">if</span> (Notification.permission == <span class="string">"granted"</span>) &#123;</div><div class="line">    Notification.requestPermission();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 调用系统提醒</div><div class="line"> * </div><div class="line"> * 第一次进入页面需要授权，之后弹出提醒</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">notifyMe</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!Notification) &#123;</div><div class="line">        alert(<span class="string">'Desktop notifications not available in your browser. Try Chromium.'</span>);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (Notification.permission !== <span class="string">"granted"</span>)&#123;</div><div class="line">        Notification.requestPermission();</div><div class="line"></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">var</span> notification = <span class="keyword">new</span> Notification(<span class="string">'小拽提醒'</span>, &#123;</div><div class="line">            <span class="attr">icon</span>: <span class="string">'http://cuihuan.net/wp-content/themes/quench-master/images/cuihuan_title.jpg'</span>,</div><div class="line">            <span class="attr">body</span>: <span class="string">"别点击，点击跳转'靠谱崔小拽'"</span></div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        notification.onclick = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">            <span class="built_in">window</span>.open(<span class="string">"http://cuihuan.net"</span>);</div><div class="line">        &#125;;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>初次进去提醒，授权<br><a href="http://cuihuan.net/wp-content/uploads/2016/04/8971AFAA-2C56-4A2F-962B-BBA0A8E0E7A4.png"><img src="http://cuihuan.net/wp-content/uploads/2016/04/8971AFAA-2C56-4A2F-962B-BBA0A8E0E7A4.png" alt="notify_allow"></a></p>
<p>提醒效果如右上角所示<br><a href="http://cuihuan.net/wp-content/uploads/2016/04/04A3AF6D-69FA-423A-8447-F5984F32762C.png"><img src="http://cuihuan.net/wp-content/uploads/2016/04/04A3AF6D-69FA-423A-8447-F5984F32762C.png" alt="notify"></a></p>
<p>通过菜单和提醒，我们基本就可以完成一个简单的闹钟提醒，每隔30分钟提醒，码农扭扭脑袋，伸伸懒腰，小心肩周炎-_-!</p>
<p>【转载请注明：<a href="http://cuihuan.net/?p=454">【chrome 插件二】弹出菜单和系统提醒学习</a> | <a href="http://cuihuan.net">靠谱崔小拽</a> 】</p>
]]></content>
      
        
        <tags>
            
            <tag> javascript </tag>
            
            <tag> chrome-extension </tag>
            
            <tag> chrome </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[mysql数据导库常用操作]]></title>
      <url>/2016/03/08/mysql%E6%95%B0%E6%8D%AE%E5%AF%BC%E5%BA%93%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C/</url>
      <content type="html"><![CDATA[<blockquote>
<p>工作中经常遇到：一个数据库导入新的数据库实例中，或者一个数据库中的某些表导入新的数据库中，常用操作，总结一下。</p>
</blockquote>
<h2 id="部分数据表导入新库"><a href="#部分数据表导入新库" class="headerlink" title="部分数据表导入新库"></a>部分数据表导入新库</h2><ul>
<li><p>单表导入新库的sql为</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># CREATE TABLE 新表 SELECT * FROM 旧表</div><div class="line">create table `dashboard`.`xx` (select * <span class="keyword">from</span> dashboard_stb.xxx);</div></pre></td></tr></table></figure>
</li>
<li><p>多表导入新库（将所有的stability_* 导入新库）<br>多表的时候，只需选出需要的表即可。</p>
</li>
</ul>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"># 拼接处所有的导出sql</div><div class="line">mysql&gt; select concat (<span class="string">'create table `dashboard`.'</span>,table_name,<span class="string">'(select * from `dashboard_stb`.'</span>,table_name,<span class="string">');'</span>) <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_name like <span class="string">"stability_%"</span>;</div><div class="line">+--------------------------------------------------------------------------------------------------------+</div><div class="line">| concat (<span class="string">'create table `dashboard`.'</span>,table_name,<span class="string">'(select * from `dashboard_stb`.'</span>,table_name,<span class="string">');'</span>)      |</div><div class="line">+--------------------------------------------------------------------------------------------------------+</div><div class="line">| create table `dashboard`.stability_capacity(select * <span class="keyword">from</span> `dashboard_stb`.stability_capacity);         |</div><div class="line">| create table `dashboard`.stability_dailymaxflow(select * <span class="keyword">from</span> `dashboard_stb`.stability_dailymaxflow); |</div><div class="line">| create table `dashboard`.stability_indextype(select * <span class="keyword">from</span> `dashboard_stb`.stability_indextype);       |</div><div class="line">| create table `dashboard`.stability_ktraceagent(select * <span class="keyword">from</span> `dashboard_stb`.stability_ktraceagent);   </div><div class="line"># 此处省略N行</div><div class="line">+--------------------------------------------------------------------------------------------------------+</div></pre></td></tr></table></figure>
<p>粘贴进去直接运行即可<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">mysql&gt;  create table `dashboard`.stability_maccpu(select * <span class="keyword">from</span> `dashboard_stb`.stability_maccpu);</div><div class="line">Query OK, <span class="number">138138</span> rows affected (<span class="number">2.16</span> sec)</div><div class="line">Records: <span class="number">138138</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></div><div class="line"></div><div class="line">mysql&gt;  create table `dashboard`.stability_macmem(select * <span class="keyword">from</span> `dashboard_stb`.stability_macmem);</div><div class="line">Query OK, <span class="number">138137</span> rows affected (<span class="number">2.07</span> sec)</div><div class="line">Records: <span class="number">138137</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></div><div class="line"></div><div class="line">mysql&gt;  create table `dashboard`.stability_macssd(select * <span class="keyword">from</span> `dashboard_stb`.stability_macssd);</div><div class="line">Query OK, <span class="number">138139</span> rows affected (<span class="number">2.17</span> sec)</div><div class="line">Records: <span class="number">138139</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></div><div class="line"># 此处省略N行</div></pre></td></tr></table></figure></p>
<h2 id="全库备份导入新库"><a href="#全库备份导入新库" class="headerlink" title="全库备份导入新库"></a>全库备份导入新库</h2><p>数据库全量导出为sql<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">mysqldump</span> <span class="selector-tag">-uxxx</span> <span class="selector-tag">-pxxx</span> <span class="selector-tag">dashboard</span> &gt; <span class="selector-tag">dashboard</span><span class="selector-class">.sql</span></div></pre></td></tr></table></figure></p>
<p>通过sql建立新库<br><figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta"># 建新库</span></div><div class="line">mysql&gt; create databases dashboard_new<span class="type"></span></div><div class="line"><span class="meta"># 导入数据</span></div><div class="line">./mysql -uxxx -p --<span class="keyword">default</span>-character-<span class="keyword">set</span>=utf8 dashboard_new <span class="type"></span>&lt; dashboard.sql</div></pre></td></tr></table></figure></p>
<p>【转载请注明：<a href="http://cuihuan.net/article/mysql%E6%95%B0%E6%8D%AE%E5%AF%BC%E5%BA%93%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C.html">mysql 简单全量备份和快速恢复</a> | <a href="http://cuihuan.net">靠谱崔小拽</a> 】</p>
]]></content>
      
        
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[postMessage处理iframe 跨域问题]]></title>
      <url>/2016/02/29/postMessage%E5%A4%84%E7%90%86iframe%20%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98/</url>
      <content type="html"><![CDATA[<blockquote>
<p>背景：由于同源策略存在，javascript的跨域一直都是一个棘手的问题。<code>父页面无法直接获取iframe内部的跨域资源；同时，iframe内部的跨域资源也无法将信息直接传递给父页面</code>。</p>
</blockquote>
<h2 id="一：传统的解决方式。"><a href="#一：传统的解决方式。" class="headerlink" title="一：传统的解决方式。"></a>一：传统的解决方式。</h2><p>传统的iframe资源解决方式：主要通过通过中间页面代理，此处不再赘述，参考<a href="http://www.cnblogs.com/snandy/p/3900016.html" target="_blank" rel="external">中间页获取跨域iframe</a></p>
<h2 id="二：html5-postMessage的产生"><a href="#二：html5-postMessage的产生" class="headerlink" title="二：html5 postMessage的产生"></a>二：html5 postMessage的产生</h2><p>随着HTML5的发展，html5工作组提供了两个重要的接口：<code>postMessage(send) 和 onmessage</code>。这两个接口有点类似于websocket，可以实现两个跨域站点页面之间的数据传递。</p>
<p><a href="https://www.w3.org/TR/websockets/?cm_mc_uid=62901929538214344332551&amp;cm_mc_sid_50200000=1456119382" target="_blank" rel="external">postMessage API</a></p>
<p>下面是实践过程中两个小栗子：分别父页面传递信息给iframe，iframe传递信息给父页面。</p>
<h2 id="三：iframe获取父页面信息"><a href="#三：iframe获取父页面信息" class="headerlink" title="三：iframe获取父页面信息"></a>三：iframe获取父页面信息</h2><p>话不多说，直接上码：<br>参考demo：<a href="http://cuihuan.net:1015/demo_file/postmesage/demo.html">父页面传给子页面demo</a></p>
<h3 id="父页面代码"><a href="#父页面代码" class="headerlink" title="父页面代码"></a>父页面代码</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Type"</span> <span class="attr">content</span>=<span class="string">"text/html; charset=UTF-8"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>崔涣 iframe postmessage 父页面<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/JavaScript"</span>&gt;</span><span class="javascript"></span></div><div class="line">        <span class="function"><span class="keyword">function</span> <span class="title">sendIt</span>(<span class="params"></span>) </span>&#123;</div><div class="line">            <span class="comment">// 通过 postMessage 向子窗口发送数据</span></div><div class="line">            <span class="built_in">document</span>.getElementById(<span class="string">"otherPage"</span>).contentWindow</div><div class="line">                    .postMessage(</div><div class="line">                    <span class="built_in">document</span>.getElementById(<span class="string">"message"</span>).value,</div><div class="line">                    <span class="string">"http://cuihuan.net:8003"</span></div><div class="line">            );</div><div class="line">        &#125;</div><div class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line"><span class="comment">&lt;!-- 通过 iframe 嵌入子页面 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">"http://cuihuan.net:8003/test.html"</span> <span class="attr">id</span>=<span class="string">"otherPage"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">br</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">br</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">id</span>=<span class="string">"message"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">value</span>=<span class="string">"Send to child.com"</span> <span class="attr">onclick</span>=<span class="string">"sendIt()"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="子页面代码"><a href="#子页面代码" class="headerlink" title="子页面代码"></a>子页面代码</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span> </div><div class="line"> <span class="tag">&lt;<span class="name">head</span>&gt;</span> </div><div class="line"> <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Type"</span> <span class="attr">content</span>=<span class="string">"text/html; charset=UTF-8"</span>&gt;</span> </div><div class="line"> <span class="tag">&lt;<span class="name">title</span>&gt;</span>崔涣测试子页面信息<span class="tag">&lt;/<span class="name">title</span>&gt;</span> </div><div class="line"> <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/JavaScript"</span>&gt;</span><span class="javascript"> </span></div><div class="line">	 <span class="comment">//event 参数中有 data 属性，就是父窗口发送过来的数据</span></div><div class="line">	 <span class="built_in">window</span>.addEventListener(<span class="string">"message"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"> event </span>) </span>&#123; </div><div class="line">		 <span class="comment">// 把父窗口发送过来的数据显示在子窗口中</span></div><div class="line">	   <span class="built_in">document</span>.getElementById(<span class="string">"content"</span>).innerHTML+=event.data+<span class="string">"&lt;br/&gt;"</span>; </div><div class="line">	 &#125;, <span class="literal">false</span> ); </div><div class="line"></div><div class="line"> <span class="tag">&lt;/<span class="name">script</span>&gt;</span> </div><div class="line"> <span class="tag">&lt;/<span class="name">head</span>&gt;</span> </div><div class="line"> <span class="tag">&lt;<span class="name">body</span>&gt;</span> </div><div class="line">	 this is the 8003 port for cuixiaozhuai </div><div class="line">	 <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"content"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span> </div><div class="line"> <span class="tag">&lt;/<span class="name">body</span>&gt;</span> </div><div class="line"> <span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure>
<p>demo 效果如下图：两个跨域页面之间，父页面给子页面传递数据。<br><a href="http://cuihuan.net/wp-content/uploads/2016/02/16743333-E2AF-40E5-8DD2-0CBCE8919C66.png"><img src="http://cuihuan.net/wp-content/uploads/2016/02/16743333-E2AF-40E5-8DD2-0CBCE8919C66.png" alt="16743333-E2AF-40E5-8DD2-0CBCE8919C66"></a> </p>
<h2 id="四：iframe传递信息给父页面"><a href="#四：iframe传递信息给父页面" class="headerlink" title="四：iframe传递信息给父页面"></a>四：iframe传递信息给父页面</h2><p>参考demo：<a href="http://cuihuan.net:1015/demo_file/postmesage/son2Parent.html">跨域子页面传给父页面demo</a></p>
<h3 id="父页面代码-1"><a href="#父页面代码-1" class="headerlink" title="父页面代码"></a>父页面代码</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line"> <span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line"> <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Type"</span> <span class="attr">content</span>=<span class="string">"text/html; charset=UTF-8"</span>&gt;</span></div><div class="line"> <span class="tag">&lt;<span class="name">title</span>&gt;</span>崔涣测试父页面<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line"> <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/JavaScript"</span>&gt;</span><span class="javascript"></span></div><div class="line">     <span class="comment">//event 参数中有 data 属性，就是父窗口发送过来的数据</span></div><div class="line">     <span class="built_in">window</span>.addEventListener(<span class="string">"message"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"> event </span>) </span>&#123;</div><div class="line">         <span class="comment">// 把父窗口发送过来的数据显示在子窗口中</span></div><div class="line">       <span class="built_in">document</span>.getElementById(<span class="string">"content"</span>).innerHTML+=event.data+<span class="string">"&lt;br/&gt;"</span>;</div><div class="line">     &#125;, <span class="literal">false</span> );</div><div class="line"></div><div class="line"> <span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"> <span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"> <span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">"http://cuihuan.net:8003/iframeSon.html"</span> <span class="attr">id</span>=<span class="string">"otherPage"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">br</span>/&gt;</span></div><div class="line">     this is the 1015 port for cuixiaozhuai。</div><div class="line">     <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"content"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"> <span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"> <span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="子页面代码-1"><a href="#子页面代码-1" class="headerlink" title="子页面代码"></a>子页面代码</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Type"</span> <span class="attr">content</span>=<span class="string">"text/html; charset=UTF-8"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>崔小涣iframe postmessage 测试页面<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/JavaScript"</span>&gt;</span><span class="javascript"></span></div><div class="line">        <span class="function"><span class="keyword">function</span> <span class="title">sendIt</span>(<span class="params"></span>) </span>&#123;</div><div class="line">            <span class="comment">// 子页面给父页面传输信息 </span></div><div class="line">            parent.postMessage(</div><div class="line">                <span class="built_in">document</span>.getElementById(<span class="string">"message"</span>).value,</div><div class="line">                <span class="string">"http://cuihuan.net:1015"</span></div><div class="line">            );</div><div class="line">        &#125;</div><div class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">br</span>/&gt;</span></div><div class="line">this is the  port for cuixiaozhuai</div><div class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">id</span>=<span class="string">"message"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">value</span>=<span class="string">"Send to child.com"</span> <span class="attr">onclick</span>=<span class="string">"sendIt()"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure>
<p>demo 效果如下图：两个跨域页面之间，子页面传递数据给父页面传递数据。<br><a href="http://cuihuan.net/wp-content/uploads/2016/02/22433B4C-8836-4546-93DB-7A896F8B4B37.png"><img src="http://cuihuan.net/wp-content/uploads/2016/02/22433B4C-8836-4546-93DB-7A896F8B4B37.png" alt="22433B4C-8836-4546-93DB-7A896F8B4B37"></a> </p>
<h2 id="五：postmessage简单分析和安全问题"><a href="#五：postmessage简单分析和安全问题" class="headerlink" title="五：postmessage简单分析和安全问题"></a>五：postmessage简单分析和安全问题</h2><p>postmessage 传送过来的信息如下图，<br><a href="http://cuihuan.net/wp-content/uploads/2016/02/BABB5101-CD9D-448C-99EE-910334405D3D.png"><img src="http://cuihuan.net/wp-content/uploads/2016/02/BABB5101-CD9D-448C-99EE-910334405D3D.png" alt="BABB5101-CD9D-448C-99EE-910334405D3D"></a></p>
<p>几乎包含了所有应该有的信息。甚至data中可以包含object，出于安全考虑可以域的校验，数据规则的校验安全校验，如下代码<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="built_in">window</span>.addEventListener(<span class="string">'message'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</div><div class="line">       </div><div class="line">       <span class="comment">//校验函数是否合法</span></div><div class="line">       <span class="keyword">var</span> checkMessage = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">           <span class="comment">// 只获取需要的域，并非所有都可以跨域</span></div><div class="line">           <span class="keyword">if</span> (event.origin != <span class="string">"need domain"</span>) &#123;</div><div class="line">               <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           </div><div class="line">           <span class="keyword">var</span> message = event.data;</div><div class="line">           <span class="comment">// 传输数据类型校验</span></div><div class="line">           <span class="keyword">if</span> (<span class="keyword">typeof</span>(message) !== <span class="string">'object'</span>) &#123;</div><div class="line">               <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="comment">// message 的rule中包含xxx则为xxx需要字段。</span></div><div class="line">           <span class="keyword">return</span> message.rule === <span class="string">"xxx"</span>;</div><div class="line">       &#125;;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (checkMessage()) &#123;</div><div class="line">           <span class="comment">// 通过校验进行相关操作</span></div><div class="line">           addDetailFunc(event);</div><div class="line">       &#125;</div><div class="line">   &#125;);</div></pre></td></tr></table></figure></p>
<p>【转载请注明：<a href="http://cuihuan.net/article/postmessage%E5%A4%84%E7%90%86iframe-%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98.html">postMessage处理iframe 跨域问题</a> | <a href="http://cuihuan.net">靠谱崔小拽</a> 】</p>
]]></content>
      
        
        <tags>
            
            <tag> javascript </tag>
            
            <tag> iframe跨域 </tag>
            
            <tag> iframe自适应高度 </tag>
            
            <tag> iframe </tag>
            
            <tag> html5 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[YII2数据库查询实践]]></title>
      <url>/2016/01/10/YII2%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9F%A5%E8%AF%A2%E5%AE%9E%E8%B7%B5/</url>
      <content type="html"><![CDATA[<blockquote>
<p>初探yii2框架，对增删改查，关联查询等数据库基本操作的简单实践。</p>
</blockquote>
<h2 id="数据库配置。"><a href="#数据库配置。" class="headerlink" title="数据库配置。"></a>数据库配置。</h2><p>/config/db.php 进行数据库配置<br>配置可以参考<a href="http://www.yiichina.com/doc/guide/2.0/start-databases" target="_blank" rel="external"> yii文档 </a><br>实践过程中有个test库-》test表-》两条记录如下<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="section">mysql&gt; select * from test;</span></div><div class="line">+----+--------+</div><div class="line"><span class="section">| id | name   |</span></div><div class="line">+----+--------+</div><div class="line">|  1 | zhuai  |</div><div class="line"><span class="section">|  2 | heng   | </span></div><div class="line">+----+--------+</div><div class="line">18 rows in set (0.00 sec)</div></pre></td></tr></table></figure></p>
<h2 id="sql-查询方式"><a href="#sql-查询方式" class="headerlink" title="sql 查询方式"></a>sql 查询方式</h2><p>yii2 提供了原始的数据库查询方式findBySql；同时，<code>通过占位符的方式，自动进行了基本的sql注入防御</code>。上码<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 最基本的查询方式</span></div><div class="line">$sql = <span class="string">"select * from test where 1"</span>;</div><div class="line">$res = Test::findBySql($sql)-&gt;all();</div><div class="line">var_dump(count($res));    <span class="comment">// res-&gt;2 </span></div><div class="line"></div><div class="line"><span class="comment">// findbysql 防止sql注入方式</span></div><div class="line">$id = <span class="string">'1 or 1=1'</span>;</div><div class="line">$sql = <span class="string">"select * from test where id = "</span> . $id;</div><div class="line">$res = Test::findBySql($sql)-&gt;all();</div><div class="line">var_dump(count($res));   <span class="comment">// res-&gt; 2</span></div><div class="line"></div><div class="line">$sql = <span class="string">"select * from test where id = :id"</span>;</div><div class="line"><span class="comment">// 定位符会自动防止sql 注入</span></div><div class="line">$res = Test::findBySql($sql,<span class="keyword">array</span>(<span class="string">":id"</span>=&gt;$id))-&gt;all();</div><div class="line">var_dump(count($res));  <span class="comment">// res-&gt;1</span></div></pre></td></tr></table></figure></p>
<h2 id="activeRecord查询方式"><a href="#activeRecord查询方式" class="headerlink" title="activeRecord查询方式"></a>activeRecord查询方式</h2><p>每个框架除了原有的sql方式，都会提供相应的封装的查询方式，yii2亦然。</p>
<h3 id="创建model"><a href="#创建model" class="headerlink" title="创建model"></a>创建model</h3><p>yii的model基本方式如下，代码如下不赘述。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?php</span></span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">models</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Yii</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">yii</span>\<span class="title">db</span>\<span class="title">ActiveRecord</span>;</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span> <span class="keyword">extends</span> <span class="title">ActiveRecord</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// 可无，对应表：默认类名和表名匹配，则无需此函数</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">tableName</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">'test'</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 可无，验证器：主要用于校验各个字段</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">rules</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> [</div><div class="line">            [<span class="string">'id'</span>, <span class="string">'integer'</span>],</div><div class="line">            [<span class="string">'name'</span>, <span class="string">'string'</span>, <span class="string">'length'</span> =&gt; [<span class="number">0</span>, <span class="number">100</span>]],</div><div class="line">        ];</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>使用的时候需要引入model<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">use</span> app\models\<span class="keyword">Test</span>;</div></pre></td></tr></table></figure></p>
<h3 id="增加操作"><a href="#增加操作" class="headerlink" title="增加操作"></a>增加操作</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// add 操作</span></div><div class="line">$test = <span class="keyword">new</span> Test();</div><div class="line">$test-&gt;name = <span class="string">'test'</span>;</div><div class="line"></div><div class="line"><span class="comment">// 合法性校验</span></div><div class="line">$test-&gt;validate();</div><div class="line"><span class="keyword">if</span>($test-&gt;hasErrors())&#123;</div><div class="line">    <span class="keyword">echo</span> <span class="string">"数据不合法"</span>;</div><div class="line">    <span class="keyword">die</span>;</div><div class="line">&#125;</div><div class="line">$test-&gt;save();</div></pre></td></tr></table></figure>
<h3 id="查询操作"><a href="#查询操作" class="headerlink" title="查询操作"></a>查询操作</h3><p>查询操作先上官方文档<br><a href="http://www.yiichina.com/doc/api/2.0/yii-db-activerecord" target="_blank" rel="external"> activeRecord doc</a><br><a href="http://www.yiichina.com/doc/api/2.0/yii-db-query#where(-detail" target="_blank" rel="external"> where doc</a><br>需要强调的是：yii查询提供了特别多丰富的库，例如代码中的批量查询处理等等，细节可以看文档。</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="regexp">// select</span></div><div class="line">// id = <span class="number">1</span></div><div class="line">$res = Test::find<span class="function"><span class="params">()</span>-&gt;</span>where<span class="function"><span class="params">([<span class="string">'id'</span> =&gt; <span class="number">1</span>])</span>-&gt;</span>all();</div><div class="line">var_dump(count($res));  <span class="regexp">//1</span></div><div class="line"></div><div class="line">// id &gt; <span class="number">0</span></div><div class="line">$res = Test::find<span class="function"><span class="params">()</span>-&gt;</span>where<span class="function"><span class="params">([<span class="string">'&gt;'</span>,<span class="string">'id'</span>,<span class="number">0</span>])</span>-&gt;</span>all();</div><div class="line">var_dump(count($res));  <span class="regexp">//2</span></div><div class="line"></div><div class="line">// id &gt; =<span class="number">1</span> id &lt;=<span class="number">2</span></div><div class="line">$res = Test::find<span class="function"><span class="params">()</span>-&gt;</span>where<span class="function"><span class="params">([<span class="string">'between'</span>,<span class="string">'id'</span>,<span class="number">1</span>,<span class="number">2</span>])</span>-&gt;</span>all();</div><div class="line">var_dump(count($res));  <span class="regexp">//2</span></div><div class="line"></div><div class="line">// name字段like</div><div class="line">$res = Test::find<span class="function"><span class="params">()</span>-&gt;</span>where<span class="function"><span class="params">([<span class="string">'like'</span>, <span class="string">'name'</span>, <span class="string">'cuihuan'</span>])</span>-&gt;</span>all();</div><div class="line">var_dump(count($res));  <span class="regexp">//2</span></div><div class="line"></div><div class="line"></div><div class="line">// 查询的使用 obj-&gt;array</div><div class="line">$res = Test::find<span class="function"><span class="params">()</span>-&gt;</span>where<span class="function"><span class="params">([<span class="string">'between'</span>,<span class="string">'id'</span>,<span class="number">1</span>,<span class="number">2</span>])</span>-&gt;</span>asArray<span class="function"><span class="params">()</span>-&gt;</span>all();</div><div class="line">var_dump($res[<span class="number">0</span>][<span class="string">'id'</span>]);  <span class="regexp">//2</span></div><div class="line"></div><div class="line">// 批量查询,对于大内存操作的批量查询</div><div class="line">foreach <span class="function"><span class="params">(Test::find()-&gt;batch(<span class="number">1</span>) as $test)</span> &#123;</span></div><div class="line">    <span class="title">var_dump</span><span class="params">(count($test))</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="删除操作"><a href="#删除操作" class="headerlink" title="删除操作"></a>删除操作</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// delete </span></div><div class="line"><span class="comment">// 选出来删除</span></div><div class="line">$res = Test::find()-&gt;where([<span class="string">'id'</span>=&gt;<span class="number">1</span>])-&gt;all();</div><div class="line">$res[<span class="number">0</span>]-&gt;delete();</div><div class="line"></div><div class="line"><span class="comment">// 直接删除</span></div><div class="line">var_dump(Test::deleteAll(<span class="string">'id&gt;:id'</span>, <span class="keyword">array</span>(<span class="string">':id'</span> =&gt; <span class="number">2</span>)));</div></pre></td></tr></table></figure>
<h3 id="修改操作"><a href="#修改操作" class="headerlink" title="修改操作"></a>修改操作</h3><p>除了代码中方式，yii2直接提供update操作。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 活动记录修改</span></div><div class="line">$res = Test::find()-&gt;where([<span class="string">'id'</span>=&gt;<span class="number">4</span>])-&gt;one();</div><div class="line">$res-&gt;name = <span class="string">"update"</span>;</div><div class="line">$res-&gt;save();</div></pre></td></tr></table></figure></p>
<h3 id="关联查询操作"><a href="#关联查询操作" class="headerlink" title="关联查询操作"></a>关联查询操作</h3><p>关联查询示例中两个表:<br>一个学生表(student):id ，name;<br>一个分数表(score)：id,stu_id,score<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 相应学生的所有score</span></div><div class="line">$stu = Student::find()-&gt;where([<span class="string">'name'</span>=&gt;<span class="string">'xiaozhuai'</span>])-&gt;one();</div><div class="line">var_dump($stu-&gt;id);</div><div class="line"></div><div class="line"><span class="comment">// 基本获取</span></div><div class="line">$scores_1 = $stu-&gt;hasMany(<span class="string">'app\model\Score'</span>,[<span class="string">'stu_id'</span>=&gt;$stu-&gt;id])-&gt;asArray()-&gt;all();</div><div class="line">$scores_2 = $stu-&gt;hasMany(Score::className(),[<span class="string">'stu_id'</span>=&gt;<span class="string">'id'</span>])-&gt;asArray()-&gt;all();</div><div class="line">var_dump($scores_1);</div><div class="line">var_dump($scores_2);</div></pre></td></tr></table></figure></p>
<p>两种关联查询方式；但是，在controller进行相关操作，代码显的过于混乱，在model中封装调用</p>
<p>首先在student model中封装相关关联调用函数<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?php</span></span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">models</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Yii</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">yii</span>\<span class="title">db</span>\<span class="title">ActiveRecord</span>;</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span> <span class="keyword">extends</span> <span class="title">ActiveRecord</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">tableName</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">'student'</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 获取分数信息</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getScores</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        $scores = <span class="keyword">$this</span>-&gt;hasMany(Score::className(), [<span class="string">'stu_id'</span> =&gt; <span class="string">'id'</span>])-&gt;asArray()-&gt;all();</div><div class="line"></div><div class="line">        <span class="keyword">return</span> $scores;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>之后直接调用，两种调用方式<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 函数封装之后调用</span></div><div class="line">$scores = $stu-&gt;getScores();</div><div class="line">var_dump($scores);</div><div class="line"></div><div class="line"><span class="comment">// 利用__get 的自动调用的方式</span></div><div class="line">$scores = $stu-&gt;scores;</div><div class="line">var_dump($scores);</div></pre></td></tr></table></figure></p>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>上面在yii2的部署和使用过程中的一些基本的增删改查，关联查询等操作。但是如果想要将yii2的db操作使用好，还要看文档大法：<br><a href="http://www.yiichina.com/doc/api/2.0/yii-db-activerecord" target="_blank" rel="external"> activeRecord doc</a></p>
<p>【转载请注明：<a href="http://cuihuan.net/article/yii2%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9F%A5%E8%AF%A2%E5%AE%9E%E8%B7%B5.html">YII2数据库查询实践</a> | <a href="http://cuihuan.net">靠谱崔小拽</a> 】</p>
]]></content>
      
        
        <tags>
            
            <tag> db </tag>
            
            <tag> active record </tag>
            
            <tag> yii2 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[机器多次恶意提交攻击简单防范]]></title>
      <url>/2016/01/07/%E6%9C%BA%E5%99%A8%E5%A4%9A%E6%AC%A1%E6%81%B6%E6%84%8F%E6%8F%90%E4%BA%A4%E6%94%BB%E5%87%BB/</url>
      <content type="html"><![CDATA[<blockquote>
<p>先说背景：机器不断的发送请求或者恶意提交，会给服务器造成很大压力；针对这种攻击<code>最优的策略是判断提交次数，产生动态验证码</code>，即<code>判断ip规定时间内重复发送达到N次弹出验证码</code>。下面是小拽在实践过程中一个简单的识别ip，利用session记录和防御的过程。</p>
</blockquote>
<h2 id="识别和校验ip"><a href="#识别和校验ip" class="headerlink" title="识别和校验ip"></a>识别和校验ip</h2><p>过程如下；</p>
<ul>
<li>识别ip</li>
<li>ip属于白名单直接通过[白名单策略：内网ip+指定ip表]</li>
<li>利用session存储ip的请求时间戳</li>
<li>校验规定时间内ip的请求次数</li>
<li>采取相应的措施</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 获取和校验ip；同时防止短时间内多次提交</div><div class="line"> *</div><div class="line"> * <span class="doctag">@notice</span>        ：弹出验证码，需要替换掉echo $echo_str 即可。</div><div class="line"> * <span class="doctag">@return</span> string ：返回校验成功的ip</div><div class="line"> */</div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getAndCheckIP</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line"></div><div class="line">    <span class="comment">// 获取环境ip</span></div><div class="line">    <span class="keyword">if</span> (getenv(<span class="string">"HTTP_CLIENT_IP"</span>) &amp;&amp; strcasecmp(getenv(<span class="string">"HTTP_CLIENT_IP"</span>), <span class="string">"unknown"</span>))</div><div class="line">        $ip = getenv(<span class="string">"HTTP_CLIENT_IP"</span>);</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (getenv(<span class="string">"HTTP_X_FORWARDED_FOR"</span>) &amp;&amp; strcasecmp(getenv(<span class="string">"HTTP_X_FORWARDED_FOR"</span>), <span class="string">"unknown"</span>))</div><div class="line">        $ip = getenv(<span class="string">"HTTP_X_FORWARDED_FOR"</span>);</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (getenv(<span class="string">"REMOTE_ADDR"</span>) &amp;&amp; strcasecmp(getenv(<span class="string">"REMOTE_ADDR"</span>), <span class="string">"unknown"</span>))</div><div class="line">        $ip = getenv(<span class="string">"REMOTE_ADDR"</span>);</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">isset</span>($_SERVER[<span class="string">'REMOTE_ADDR'</span>]) &amp;&amp; $_SERVER[<span class="string">'REMOTE_ADDR'</span>] &amp;&amp; strcasecmp($_SERVER[<span class="string">'REMOTE_ADDR'</span>], <span class="string">"unknown"</span>))</div><div class="line">        $ip = $_SERVER[<span class="string">'REMOTE_ADDR'</span>];</div><div class="line">    <span class="keyword">else</span></div><div class="line">        $ip = <span class="string">"unknown"</span>;</div><div class="line"></div><div class="line">    <span class="comment">// check 环境ip</span></div><div class="line">    <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;isWhiteList($ip)) &#123;</div><div class="line">        $echo_str = <span class="string">"提交过于频繁,请稍后再试！"</span>;</div><div class="line">        <span class="comment">// 构建ip的时间栈数据</span></div><div class="line">        <span class="keyword">if</span> (!is_array($_SESSION[$ip])) &#123;</div><div class="line">            $_SESSION[$ip] = <span class="keyword">array</span>();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($_SESSION[$ip][<span class="number">0</span>])) &#123;</div><div class="line">            $_SESSION[$ip][] = time();</div><div class="line"></div><div class="line">            <span class="comment">// session 保存时间为6小时。清理session</span></div><div class="line">            $post_interval_first = time() - $_SESSION[$ip][<span class="number">0</span>];</div><div class="line">            <span class="keyword">if</span> ($post_interval_first &gt; <span class="number">21600</span>) &#123;</div><div class="line">                $_SESSION[$ip] = <span class="keyword">array</span>();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// 两次提交小于1s，禁止提交</span></div><div class="line">            $post_interval_pre = time() - $_SESSION[$ip][count($_SESSION[$ip]) - <span class="number">3</span>];</div><div class="line">            <span class="keyword">if</span> ($post_interval_pre &lt; <span class="number">1</span>) &#123;</div><div class="line">                <span class="keyword">echo</span> $echo_str;</div><div class="line">                <span class="keyword">exit</span>;</div><div class="line">            &#125;;</div><div class="line"></div><div class="line">            <span class="comment">// 您在10s内已经提交了3请求，禁止提交</span></div><div class="line">            $post_interval_third = time() - $_SESSION[$ip][count($_SESSION[$ip]) - <span class="number">3</span>];</div><div class="line">            <span class="keyword">if</span> (<span class="keyword">isset</span>($_SESSION[$ip][<span class="number">3</span>]) &amp;&amp; ($post_interval_third &lt; <span class="number">10</span>)) &#123;</div><div class="line">                <span class="keyword">echo</span> $echo_str;</div><div class="line">                <span class="keyword">exit</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// 您在1分钟期间已经提交了5请求，禁止提交</span></div><div class="line">            $post_interval_fifth = time() - $_SESSION[$ip][count($_SESSION[$ip]) - <span class="number">3</span>];</div><div class="line">            <span class="keyword">if</span> (<span class="keyword">isset</span>($_SESSION[$ip][<span class="number">5</span>]) &amp;&amp; ($post_interval_fifth &lt; <span class="number">60</span>)) &#123;</div><div class="line">                <span class="keyword">echo</span> $echo_str;</div><div class="line">                <span class="keyword">exit</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// 6小时内提交10次，禁止提交</span></div><div class="line">            <span class="keyword">if</span> (<span class="keyword">isset</span>($_SESSION[$ip][<span class="number">10</span>])) &#123;</div><div class="line">                <span class="keyword">echo</span> $echo_str;</div><div class="line">                <span class="keyword">exit</span>;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            $_SESSION[$ip][] = time();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> ($ip);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="白名单策略"><a href="#白名单策略" class="headerlink" title="白名单策略"></a>白名单策略</h2><p>白名单策略采用：内网ip放行和特定ip放行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 检验是否存在于白名单中</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> $ip    ：校验的ip</div><div class="line"> * <span class="doctag">@return</span> bool  ：校验结果</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">isWhiteList</span><span class="params">($ip)</span></span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 内网ip默认全部存在于白名单中</div><div class="line">     */</div><div class="line">    <span class="keyword">if</span>(!filter_var($ip, FILTER_VALIDATE_IP, FILTER_FLAG_NO_PRIV_RANGE | FILTER_FLAG_NO_RES_RANGE))&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 是否在写死的whitelist 里面</span></div><div class="line">    <span class="keyword">return</span> in_array($ip,<span class="keyword">$this</span>-&gt;_WHTTE_LIST);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="防攻击策略"><a href="#防攻击策略" class="headerlink" title="防攻击策略"></a>防攻击策略</h2><p>小拽采用的比较简单的策略，如上面代码，实际过程中可以结合业务需求。</p>
<ul>
<li>1s内禁止重复提交</li>
<li>5s内提交上限3次</li>
<li>60s内提交上限5次</li>
<li>6小时内提交上限10次</li>
</ul>
<p>【转载请注明：<a href="http://cuihuan.net/article/%E6%9C%BA%E5%99%A8%E5%A4%9A%E6%AC%A1%E6%81%B6%E6%84%8F%E6%8F%90%E4%BA%A4%E6%94%BB%E5%87%BB%E7%AE%80%E5%8D%95%E9%98%B2%E8%8C%83.html">机器多次恶意提交攻击简单防范</a> | <a href="http://cuihuan.net">靠谱崔小拽</a> 】</p>
]]></content>
      
        
        <tags>
            
            <tag> php </tag>
            
            <tag> ip </tag>
            
            <tag> 恶意攻击 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[检验mysql主从备份，读写分离]]></title>
      <url>/2016/01/03/%E6%A3%80%E9%AA%8Cmysql%E4%B8%BB%E4%BB%8E%E5%A4%87%E4%BB%BD%EF%BC%8C%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/</url>
      <content type="html"><![CDATA[<blockquote>
<p>先说背景：mysql的主从部署，读写分离，负载均衡之后；需要简单测试和校验一下，在实践中写了个简单的php脚本和校验过程，mark一下，方便再次部署校验。</p>
</blockquote>
<h2 id="数据库部署和实践"><a href="#数据库部署和实践" class="headerlink" title="数据库部署和实践"></a>数据库部署和实践</h2><p>数据库在实践中，<code>往往需要进行多机主从备份保证安全</code>，这个毋庸置疑；<code>进行读写分离和负载均衡可以极大的提升mysql的读写性能</code>。作者在实践中采用阿里的ameoba进行了读写分离和负载均衡操作。细节步骤参考小拽文章:<a href="http://www.baidu.com" target="_blank" rel="external"> mysql主从备份，读写分离和负载均衡实践 </a></p>
<p>那么问题来了，部署完了，校验也需慎重，下面是简单的校验过程。</p>
<h2 id="php简单读写库脚本"><a href="#php简单读写库脚本" class="headerlink" title="php简单读写库脚本"></a>php简单读写库脚本</h2><p>上码：能用代码说的，最好不用文字说话！<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?php</span></span></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 进行读写分离的校验</div><div class="line"> * <span class="doctag">@notice</span> ：需要关闭主从备份的情况下进行</div><div class="line"> * 原理：打开主从，写主库，从库获取数据，校验主从备份；关闭主从写ameoba,校验读写分离和负载</div><div class="line"> *</div><div class="line"> * <span class="doctag">@author</span>: cuixiaohuan</div><div class="line"> * Date: 15/12/29</div><div class="line"> * Time: 下午9:10</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReadAndWriteTest</span> </span>&#123;</div><div class="line">   </div><div class="line">    <span class="comment">// ameoba 设定端口,校验读写时，放主库配置</span></div><div class="line">    <span class="keyword">const</span> IP   =<span class="string">"ip:port"</span>;</div><div class="line">    <span class="keyword">const</span> PWD  =<span class="string">"pwd"</span>;</div><div class="line">    <span class="keyword">const</span> USER =<span class="string">"user"</span>;</div><div class="line">    <span class="keyword">const</span> DB   =<span class="string">"db"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</div><div class="line">        error_reporting(E_ALL ^ E_DEPRECATED);</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;initDb();</div><div class="line">        <span class="keyword">$this</span>-&gt;_writeTest();</div><div class="line">        <span class="keyword">$this</span>-&gt;_selectTest();</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 进行10次读操作</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">_selectTest</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; <span class="number">10</span>; $i++) &#123;</div><div class="line">            $read_sql = <span class="string">'select * from test limit 10'</span>;</div><div class="line">            $g_result = mysql_query($read_sql);</div><div class="line">            var_dump($g_result);</div><div class="line">            mysql_free_result($g_result);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 进行10次写操作</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">_writeTest</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; <span class="number">10</span>; $i++) &#123;</div><div class="line">            $id        = uniqid();</div><div class="line">            $content   = <span class="string">"pingce"</span> . uniqid();</div><div class="line">            $write_sql = <span class="string">'INSERT INTO `test`(`test`, `test1`) VALUES ("'</span> . $id . <span class="string">'","'</span> . $content . <span class="string">'")'</span>;</div><div class="line">            $g_result = mysql_query($write_sql);</div><div class="line">            var_dump($g_result);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 初始化数据库连接信息 info</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">initDb</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        $crowd_conn = mysql_pconnect(<span class="keyword">self</span>::IP, <span class="keyword">self</span>::USER, <span class="keyword">self</span>::PWD);</div><div class="line">        <span class="keyword">if</span> (!$crowd_conn) &#123;</div><div class="line">            <span class="keyword">die</span>(<span class="string">"Could not connect:"</span> . mysql_error());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        $crowd_db = mysql_select_db(<span class="keyword">self</span>::DB, $crowd_conn);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">$rw = <span class="keyword">new</span> ReadAndWriteTest();</div></pre></td></tr></table></figure></p>
<h2 id="主从备份校验"><a href="#主从备份校验" class="headerlink" title="主从备份校验"></a>主从备份校验</h2><ul>
<li>开启slave</li>
<li>调整数据库信息为mysql，主库信息，运行脚本。</li>
<li>查看从库的log，有如下写入操作，说明实时主从备份成功。<figure class="highlight basic"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">151231 </span><span class="number">15</span>:<span class="number">36</span>:<span class="number">21</span> <span class="number">4</span> Query start slave</div><div class="line"><span class="symbol">14 </span>Connect <span class="keyword">Out</span> pingce@<span class="number">10.95.112.120</span>:<span class="number">3666</span></div><div class="line"><span class="symbol">15 </span>Query BEGIN</div><div class="line"><span class="symbol">15 </span>Query INSERT INTO `test`(`test`, `test1`) VALUES (<span class="string">"5684d957e5c85"</span>,<span class="string">"pingce5684d957e5cf2"</span>)</div><div class="line"><span class="symbol">15 </span>Query COMMIT /* implicit, from Xid_log_event */</div><div class="line"><span class="symbol">15 </span>Query BEGIN</div><div class="line"><span class="symbol">15 </span>Query INSERT INTO `test`(`test`, `test1`) VALUES (<span class="string">"5684d957e7937"</span>,<span class="string">"pingce5684d957e7982"</span>)</div><div class="line"><span class="symbol">15 </span>Query COMMIT /* implicit, from Xid_log_event */</div><div class="line"><span class="symbol">15 </span>Query BEGIN</div><div class="line"><span class="symbol">15 </span>Query INSERT INTO `test`(`test`, `test1`) VALUES (<span class="string">"5684d957e8e96"</span>,<span class="string">"pingce5684d957e8ee4"</span>)</div><div class="line"><span class="symbol">15 </span>Query COMMIT /* implicit, from Xid_log_event */</div><div class="line"><span class="symbol">15 </span>Query BEGIN</div><div class="line"><span class="symbol">15 </span>Query INSERT INTO `test`(`test`, `test1`) VALUES (<span class="string">"5684d957ea2c2"</span>,<span class="string">"pingce5684d957ea2eb"</span>)</div><div class="line"><span class="symbol">15 </span>Query COMMIT /* implicit, from Xid_log_event */</div><div class="line"><span class="symbol">15 </span>Query BEGIN</div><div class="line"><span class="symbol">15 </span>Query INSERT INTO `test`(`test`, `test1`) VALUES (<span class="string">"5684d957eb565"</span>,<span class="string">"pingce5684d957eb5b3"</span>)</div><div class="line"><span class="symbol">15 </span>Query COMMIT /* implicit, from Xid_log_event */</div><div class="line"><span class="symbol">15 </span>Query BEGIN</div><div class="line"><span class="symbol">15 </span>Query INSERT INTO `test`(`test`, `test1`) VALUES (<span class="string">"5684d957ec7ee"</span>,<span class="string">"pingce5684d957ec83e"</span>)</div><div class="line"><span class="symbol">15 </span>Query COMMIT /* implicit, from Xid_log_event */</div><div class="line"><span class="symbol">15 </span>Query BEGIN</div><div class="line"><span class="symbol">15 </span>Query INSERT INTO `test`(`test`, `test1`) VALUES (<span class="string">"5684d957eda2f"</span>,<span class="string">"pingce5684d957eda78"</span>)</div><div class="line"><span class="symbol">15 </span>Query COMMIT /* implicit, from Xid_log_event */</div><div class="line"><span class="symbol">15 </span>Query BEGIN</div><div class="line"><span class="symbol">15 </span>Query INSERT INTO `test`(`test`, `test1`) VALUES (<span class="string">"5684d957eeca4"</span>,<span class="string">"pingce5684d957eecf0"</span>)</div><div class="line"><span class="symbol">15 </span>Query COMMIT /* implicit, from Xid_log_event */</div><div class="line"><span class="symbol">15 </span>Query BEGIN</div><div class="line"><span class="symbol">15 </span>Query INSERT INTO `test`(`test`, `test1`) VALUES (<span class="string">"5684d957eff16"</span>,<span class="string">"pingce5684d957eff61"</span>)</div><div class="line"><span class="symbol">15 </span>Query COMMIT /* implicit, from Xid_log_event */</div><div class="line"><span class="symbol">15 </span>Query BEGIN</div><div class="line"><span class="symbol">15 </span>Query INSERT INTO `test`(`test`, `test1`) VALUES (<span class="string">"5684d957f121e"</span>,<span class="string">"pingce5684d957f126d"</span>)</div><div class="line"><span class="symbol">15 </span>Query COMMIT /* implicit, from Xid_log_event */</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="检验读写分离"><a href="#检验读写分离" class="headerlink" title="检验读写分离"></a>检验读写分离</h2><ul>
<li><p>读写分离，首先需要关闭从机器上的slave。原因：存在主从的话，无法通过log查看出读写分离操作。</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql&gt; <span class="literal">stop</span> <span class="literal">slave</span>;</div><div class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.08</span> sec)</div></pre></td></tr></table></figure>
</li>
<li><p>运行脚本：如下信息标示，运行成功。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">[cuixiaohuan TestScript]$ /home/work/lamp/php5/bin/php ReadAndWriteTest.php</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>(<span class="string">`test`</span>, <span class="string">`test1`</span>) <span class="keyword">VALUES</span> (<span class="string">"5684d957e5c85"</span>,<span class="string">"pingce5684d957e5cf2"</span>)bool(<span class="literal">true</span>)</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>(<span class="string">`test`</span>, <span class="string">`test1`</span>) <span class="keyword">VALUES</span> (<span class="string">"5684d957e7937"</span>,<span class="string">"pingce5684d957e7982"</span>)bool(<span class="literal">true</span>)</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>(<span class="string">`test`</span>, <span class="string">`test1`</span>) <span class="keyword">VALUES</span> (<span class="string">"5684d957e8e96"</span>,<span class="string">"pingce5684d957e8ee4"</span>)bool(<span class="literal">true</span>)</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>(<span class="string">`test`</span>, <span class="string">`test1`</span>) <span class="keyword">VALUES</span> (<span class="string">"5684d957ea2c2"</span>,<span class="string">"pingce5684d957ea2eb"</span>)bool(<span class="literal">true</span>)</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>(<span class="string">`test`</span>, <span class="string">`test1`</span>) <span class="keyword">VALUES</span> (<span class="string">"5684d957eb565"</span>,<span class="string">"pingce5684d957eb5b3"</span>)bool(<span class="literal">true</span>)</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>(<span class="string">`test`</span>, <span class="string">`test1`</span>) <span class="keyword">VALUES</span> (<span class="string">"5684d957ec7ee"</span>,<span class="string">"pingce5684d957ec83e"</span>)bool(<span class="literal">true</span>)</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>(<span class="string">`test`</span>, <span class="string">`test1`</span>) <span class="keyword">VALUES</span> (<span class="string">"5684d957eda2f"</span>,<span class="string">"pingce5684d957eda78"</span>)bool(<span class="literal">true</span>)</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>(<span class="string">`test`</span>, <span class="string">`test1`</span>) <span class="keyword">VALUES</span> (<span class="string">"5684d957eeca4"</span>,<span class="string">"pingce5684d957eecf0"</span>)bool(<span class="literal">true</span>)</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>(<span class="string">`test`</span>, <span class="string">`test1`</span>) <span class="keyword">VALUES</span> (<span class="string">"5684d957eff16"</span>,<span class="string">"pingce5684d957eff61"</span>)bool(<span class="literal">true</span>)</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>(<span class="string">`test`</span>, <span class="string">`test1`</span>) <span class="keyword">VALUES</span> (<span class="string">"5684d957f121e"</span>,<span class="string">"pingce5684d957f126d"</span>)bool(<span class="literal">true</span>)</div><div class="line"><span class="keyword">resource</span>(<span class="number">5</span>) <span class="keyword">of</span> <span class="keyword">type</span> (mysql <span class="keyword">result</span>)</div><div class="line"><span class="keyword">resource</span>(<span class="number">6</span>) <span class="keyword">of</span> <span class="keyword">type</span> (mysql <span class="keyword">result</span>)</div><div class="line"><span class="keyword">resource</span>(<span class="number">7</span>) <span class="keyword">of</span> <span class="keyword">type</span> (mysql <span class="keyword">result</span>)</div><div class="line"><span class="keyword">resource</span>(<span class="number">8</span>) <span class="keyword">of</span> <span class="keyword">type</span> (mysql <span class="keyword">result</span>)</div><div class="line"><span class="keyword">resource</span>(<span class="number">9</span>) <span class="keyword">of</span> <span class="keyword">type</span> (mysql <span class="keyword">result</span>)</div><div class="line"><span class="keyword">resource</span>(<span class="number">10</span>) <span class="keyword">of</span> <span class="keyword">type</span> (mysql <span class="keyword">result</span>)</div><div class="line"><span class="keyword">resource</span>(<span class="number">11</span>) <span class="keyword">of</span> <span class="keyword">type</span> (mysql <span class="keyword">result</span>)</div><div class="line"><span class="keyword">resource</span>(<span class="number">12</span>) <span class="keyword">of</span> <span class="keyword">type</span> (mysql <span class="keyword">result</span>)</div><div class="line"><span class="keyword">resource</span>(<span class="number">13</span>) <span class="keyword">of</span> <span class="keyword">type</span> (mysql <span class="keyword">result</span>)</div><div class="line"><span class="keyword">resource</span>(<span class="number">14</span>) <span class="keyword">of</span> <span class="keyword">type</span> (mysql <span class="keyword">result</span>)</div></pre></td></tr></table></figure>
</li>
<li><p>查询读写库的log</p>
<blockquote>
<p>解释：之所以主库放一个读写库，是因为有些要求超高一致性的数据，备份可能会有延迟；所以，主库承担读写操作，和高负载。</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">#读写机器log：  进行了<span class="number">10</span>次写和 四次读</div><div class="line"><span class="number">151231</span> <span class="number">15</span>:<span class="number">29</span>:<span class="number">27</span> <span class="number">19</span> Query set names gbk^@</div><div class="line"><span class="number">19</span> Query INSERT INTO `test`(`test`, `test1`) VALUES (<span class="string">"5684d957e5c85"</span>,<span class="string">"pingce5684d957e5cf2"</span>)</div><div class="line"><span class="number">19</span> Query INSERT INTO `test`(`test`, `test1`) VALUES (<span class="string">"5684d957e7937"</span>,<span class="string">"pingce5684d957e7982"</span>)</div><div class="line"><span class="number">19</span> Query INSERT INTO `test`(`test`, `test1`) VALUES (<span class="string">"5684d957e8e96"</span>,<span class="string">"pingce5684d957e8ee4"</span>)</div><div class="line"><span class="number">19</span> Query INSERT INTO `test`(`test`, `test1`) VALUES (<span class="string">"5684d957ea2c2"</span>,<span class="string">"pingce5684d957ea2eb"</span>)</div><div class="line"><span class="number">19</span> Query INSERT INTO `test`(`test`, `test1`) VALUES (<span class="string">"5684d957eb565"</span>,<span class="string">"pingce5684d957eb5b3"</span>)</div><div class="line"><span class="number">19</span> Query INSERT INTO `test`(`test`, `test1`) VALUES (<span class="string">"5684d957ec7ee"</span>,<span class="string">"pingce5684d957ec83e"</span>)</div><div class="line"><span class="number">19</span> Query INSERT INTO `test`(`test`, `test1`) VALUES (<span class="string">"5684d957eda2f"</span>,<span class="string">"pingce5684d957eda78"</span>)</div><div class="line"><span class="number">19</span> Query INSERT INTO `test`(`test`, `test1`) VALUES (<span class="string">"5684d957eeca4"</span>,<span class="string">"pingce5684d957eecf0"</span>)</div><div class="line"><span class="number">19</span> Query INSERT INTO `test`(`test`, `test1`) VALUES (<span class="string">"5684d957eff16"</span>,<span class="string">"pingce5684d957eff61"</span>)</div><div class="line"><span class="number">19</span> Query INSERT INTO `test`(`test`, `test1`) VALUES (<span class="string">"5684d957f121e"</span>,<span class="string">"pingce5684d957f126d"</span>)</div><div class="line"><span class="number">19</span> Query select * <span class="keyword">from</span> test limit <span class="number">10</span></div><div class="line"><span class="number">151231</span> <span class="number">15</span>:<span class="number">29</span>:<span class="number">28</span> <span class="number">19</span> Query select * <span class="keyword">from</span> test limit <span class="number">10</span></div><div class="line"><span class="number">19</span> Query select * <span class="keyword">from</span> test limit <span class="number">10</span></div><div class="line"><span class="number">19</span> Query select * <span class="keyword">from</span> test limit <span class="number">10</span></div><div class="line"><span class="number">19</span> Query select * <span class="keyword">from</span> test limit <span class="number">10</span></div></pre></td></tr></table></figure>
</blockquote>
</li>
<li><p>查看读库的log</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"># 只进行了读操作，校正了数据库的读写分离操作。</div><div class="line">151231 15:29:20 4 <span class="keyword">Query</span> stop slave</div><div class="line">151231 15:29:27 3 <span class="keyword">Query</span> <span class="keyword">set</span> names gbk^@</div><div class="line">3 <span class="keyword">Query</span> select * from <span class="keyword">test</span> limit 10</div><div class="line">3 <span class="keyword">Query</span> select * from <span class="keyword">test</span> limit 10</div><div class="line">3 <span class="keyword">Query</span> select * from <span class="keyword">test</span> limit 10</div><div class="line">3 <span class="keyword">Query</span> select * from <span class="keyword">test</span> limit 10</div><div class="line">3 <span class="keyword">Query</span> select * from <span class="keyword">test</span> limit 10</div><div class="line">3 <span class="keyword">Query</span> select * from <span class="keyword">test</span> limit 10</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>一句话：打开slave，校验主从备份；关闭slave，校验读写分离。</p>
<p>【转载请注明：<a href="http://cuihuan.net/article/%E6%A3%80%E9%AA%8Cmysql%E4%B8%BB%E4%BB%8E%E5%A4%87%E4%BB%BD%EF%BC%8C%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB.html"> 检验mysql主从备份，读写分离 </a> | <a href="http://cuihuan.net">靠谱崔小拽</a> 】</p>
]]></content>
      
        
        <tags>
            
            <tag> mysql </tag>
            
            <tag> 读写分离 </tag>
            
            <tag> 主从备份 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[php反射调用private方法实践]]></title>
      <url>/2015/12/20/php%E5%8F%8D%E5%B0%84%E8%B0%83%E7%94%A8private%E6%96%B9%E6%B3%95%E5%AE%9E%E8%B7%B5/</url>
      <content type="html"><![CDATA[<blockquote>
<p>问题背景：单测中有个普遍性的问题，<code>被侧类中的private方法无法直接调用</code>。小拽在处理过程中通过<code>反射改变方法权限，进行单测</code>，分享一下，直接上代码。</p>
</blockquote>
<h2 id="简单被测试类"><a href="#简单被测试类" class="headerlink" title="简单被测试类"></a>简单被测试类</h2><p>生成一个简单的被测试类，只有个private方法。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?php</span></span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 崔小涣单测的基本模板。</div><div class="line"> *</div><div class="line"> * <span class="doctag">@author</span> cuihuan</div><div class="line"> * <span class="doctag">@date</span> 2015/11/12 22:15:31</div><div class="line"> * <span class="doctag">@version</span> $Revision:1.0$</div><div class="line"> **/</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 私有方法</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> $params</div><div class="line">     * <span class="doctag">@return</span> bool</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">privateFunc</span><span class="params">($params)</span></span>&#123;</div><div class="line">        <span class="keyword">if</span>(!<span class="keyword">isset</span>($params))&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">echo</span> <span class="string">"test success"</span>;</div><div class="line">        <span class="keyword">return</span> $params;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="单测代码"><a href="#单测代码" class="headerlink" title="单测代码"></a>单测代码</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?php</span></span></div><div class="line"><span class="comment">/***************************************************************************</span></div><div class="line"> *</div><div class="line"> * $Id: MyClassTest T,v 1.0 PsCaseTest cuihuan Exp$</div><div class="line"> *</div><div class="line"> **************************************************************************/</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 崔小涣单测的基本模板。 </div><div class="line"> * </div><div class="line"> * <span class="doctag">@author</span> cuihuan</div><div class="line"> * <span class="doctag">@date</span> 2015/11/12 22:09:31</div><div class="line"> * <span class="doctag">@version</span> $Revision:1.0$</div><div class="line"> **/</div><div class="line"></div><div class="line"><span class="keyword">require_once</span> (<span class="string">'./MyClass.php'</span>);</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClassTest</span> <span class="keyword">extends</span> <span class="title">PHPUnit_Framework_TestCase</span> </span>&#123;</div><div class="line">    <span class="keyword">const</span> CLASS_NAME = <span class="string">'MyClass'</span>;</div><div class="line">    <span class="keyword">const</span> FAIL       = <span class="string">'fail'</span>;</div><div class="line"></div><div class="line">    <span class="keyword">protected</span> $objMyClass;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * <span class="doctag">@brief</span> setup: Sets up the fixture, for example, opens a network connection.</div><div class="line">     *</div><div class="line">     * 可以看做phpunit的构造函数</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setup</span><span class="params">()</span> </span>&#123;</div><div class="line">        date_default_timezone_set(<span class="string">'PRC'</span>);</div><div class="line">        <span class="keyword">$this</span>-&gt;objMyClass = <span class="keyword">new</span> MyClass();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 利用反射，对类中的private 和 protect 方法进行单元测试</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> $strMethodName  string  ：反射函数名</div><div class="line">     * <span class="doctag">@return</span> ReflectionMethod obj   ：回调对象</div><div class="line">     */</div><div class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getPrivateMethod</span><span class="params">($strMethodName)</span> </span>&#123;</div><div class="line">        $objReflectClass = <span class="keyword">new</span> ReflectionClass(<span class="keyword">self</span>::CLASS_NAME);</div><div class="line">        $method          = $objReflectClass-&gt;getMethod($strMethodName);</div><div class="line">        $method-&gt;setAccessible(<span class="keyword">true</span>);</div><div class="line">        <span class="keyword">return</span> $method;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * <span class="doctag">@brief</span> :测试private函数的调用</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testPrivateFunc</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        $testCase = <span class="string">'just a test string'</span>;</div><div class="line"></div><div class="line">        <span class="comment">// 反射该类</span></div><div class="line">        $testFunc = <span class="keyword">self</span>::getPrivateMethod(<span class="string">'privateFunc'</span>);</div><div class="line">        $res = $testFunc-&gt;invokeArgs(<span class="keyword">$this</span>-&gt;objMyClass, <span class="keyword">array</span>($testCase));</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;assertEquals($testCase, $res);</div><div class="line">        <span class="keyword">$this</span>-&gt;expectOutputRegex(<span class="string">'/success/i'</span>);</div><div class="line">        </div><div class="line">        <span class="comment">// 捕获没有参数异常测试</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">             $testFunc-&gt;invokeArgs(<span class="keyword">$this</span>-&gt;transfer2Pscase, <span class="keyword">array</span>());</div><div class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $expected) &#123;</div><div class="line">            <span class="keyword">$this</span>-&gt;assertNotNull($expected);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;fail(<span class="keyword">self</span>::FAIL);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>##运行结果<br><figure class="highlight subunit"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">cuihuan:test cuixiaohuan$ phpunit MyClassTest.php </div><div class="line">PHPUnit 4.8.6 by Sebastian Bergmann and contributors.</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">Time:</span> 103 ms, Memory: 11.75Mb</div><div class="line"></div><div class="line">OK (1 test, 3 assertions)</div></pre></td></tr></table></figure></p>
<h2 id="关键代码分析"><a href="#关键代码分析" class="headerlink" title="关键代码分析"></a>关键代码分析</h2><p>封装了一个，被测类方法的反射调用；同时，<code>返回方法之前处理方法的接入权限为true</code>，便可以访问private的函数方法。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 利用反射，对类中的private 和 protect 方法进行单元测试</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> $strMethodName  string  ：反射函数名</div><div class="line"> * <span class="doctag">@return</span> ReflectionMethod obj   ：回调对象</div><div class="line"> */</div><div class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getPrivateMethod</span><span class="params">($strMethodName)</span> </span>&#123;</div><div class="line">    $objReflectClass = <span class="keyword">new</span> ReflectionClass(<span class="keyword">self</span>::CLASS_NAME);</div><div class="line">    $method          = $objReflectClass-&gt;getMethod($strMethodName);</div><div class="line">    $method-&gt;setAccessible(<span class="keyword">true</span>);</div><div class="line">    <span class="keyword">return</span> $method;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>【转载请注明：<a href="http://cuihuan.net/article/phpunit%E5%8D%95%E6%B5%8B%E4%B8%AD%E8%B0%83%E7%94%A8private%E6%96%B9%E6%B3%95%E5%A4%84%E7%90%86.html">phpunit单测中调用private方法处理</a> | <a href="http://cuihuan.net">靠谱崔小拽</a> 】</p>
]]></content>
      
        
        <tags>
            
            <tag> php </tag>
            
            <tag> 单元测试 </tag>
            
            <tag> phpunit </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[mysql 简单全量备份和快速恢复]]></title>
      <url>/2015/12/11/mysql%20%E7%AE%80%E5%8D%95%E5%85%A8%E9%87%8F%E5%A4%87%E4%BB%BD%E5%92%8C%E5%BF%AB%E9%80%9F%E6%81%A2%E5%A4%8D/</url>
      <content type="html"><![CDATA[<blockquote>
<p>一个简单的mysql全量备份脚本，备份最近15天的数据。</p>
</blockquote>
<h2 id="备份"><a href="#备份" class="headerlink" title="备份"></a>备份</h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#每天备份mysql数据库(保存最近15天的数据脚本)</span></div><div class="line">DATE=$(date +%Y%m%d)</div><div class="line"><span class="regexp">/home/</span>cuixiaohuan<span class="regexp">/lamp/my</span>sql5<span class="regexp">/bin/my</span>sqldump -uuser -ppassword need_db &gt; <span class="regexp">/home/</span>cuixiaohuan<span class="regexp">/bak_sql/my</span>sql_dbxx_<span class="variable">$DATE</span>.sql;</div><div class="line">find <span class="regexp">/home/</span>cuixiaohuan<span class="regexp">/bak_sql/</span> -mtime +<span class="number">15</span> -name <span class="string">'*.sql'</span> -exec rm -rf &#123;&#125; \;</div></pre></td></tr></table></figure>
<h2 id="恢复"><a href="#恢复" class="headerlink" title="恢复"></a>恢复</h2><p>mysql 数据导入<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">drop</span> <span class="keyword">databases</span> need_db;</div><div class="line"><span class="keyword">create</span> <span class="keyword">databases</span> need_db;</div></pre></td></tr></table></figure></p>
<p>导入数据：必须设定编码进行恢复<br><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./mysql -uroot -p --<span class="keyword">default</span>-character-<span class="keyword">set</span>=utf8 need_db &lt; xx.sql</div></pre></td></tr></table></figure></p>
<p>【转载请注明：<a href="http://cuihuan.net/article/mysql-%E7%AE%80%E5%8D%95%E5%85%A8%E9%87%8F%E5%A4%87%E4%BB%BD%E5%92%8C%E5%BF%AB%E9%80%9F%E6%81%A2%E5%A4%8D.html">mysql 简单全量备份和快速恢复</a> | <a href="http://cuihuan.net">靠谱崔小拽</a> 】</p>
]]></content>
      
        
        <tags>
            
            <tag> 备份 </tag>
            
            <tag> mysql </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[linux 查找清理大文件]]></title>
      <url>/2015/12/08/linux%20%E6%9F%A5%E6%89%BE%E6%B8%85%E7%90%86%E5%A4%A7%E6%96%87%E4%BB%B6/</url>
      <content type="html"><![CDATA[<blockquote>
<p>linux 经常硬盘空间不足，往往是由于一些大文件造成；之前寻找大文件总是很头疼，速度特别慢。<br>经学弟介绍使用：<code>du -sh * |grep G</code> 查找和清理速度不错，分享一下清理过程。</p>
</blockquote>
<h2 id="查看系统存储状态"><a href="#查看系统存储状态" class="headerlink" title="查看系统存储状态"></a>查看系统存储状态</h2><figure class="highlight prolog"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[cuihuan:~ cuixiaohuan]$ df -h</div><div class="line"><span class="symbol">Filesystem</span> <span class="symbol">Size</span> <span class="symbol">Used</span> <span class="symbol">Avail</span> <span class="symbol">Use</span><span class="comment">% Mounted on</span></div><div class="line">/dev/sda2 <span class="number">8.2</span><span class="symbol">G</span> <span class="number">6.7</span><span class="symbol">G</span> <span class="number">1.6</span><span class="symbol">G</span> <span class="number">82</span><span class="comment">% /</span></div><div class="line">/dev/sda3 <span class="number">1.4</span><span class="symbol">T</span> <span class="number">1.3</span><span class="symbol">T</span> <span class="number">50</span><span class="symbol">G</span> <span class="number">97</span><span class="comment">% /home</span></div></pre></td></tr></table></figure>
<p>1.5T的硬盘占用了97%，确实不够用了，必须着手清理一下</p>
<h2 id="查找大文件"><a href="#查找大文件" class="headerlink" title="查找大文件"></a>查找大文件</h2><p>主要使用查找命令：<code>du -sh * |grep G</code><br>从根文件开始查找<br><figure class="highlight erlang-repl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[cuihuan:~]$ du -sh * | grep G</div><div class="line">。。。</div><div class="line"><span class="number">73</span>G mongodb</div><div class="line"><span class="number">103</span>G mxm</div><div class="line"><span class="number">2.1</span>G online</div><div class="line"><span class="number">613</span>G thirdparty [binggo!!!]</div><div class="line">。。。</div></pre></td></tr></table></figure></p>
<p>bingo 613g，看来这个主要矛盾了，进一步分析该文件</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">[cuihuan:~ mysql5]$ du -<span class="keyword">sh</span> *</div><div class="line">116M bin</div><div class="line">904K <span class="keyword">include</span></div><div class="line">13M lib</div><div class="line">17M libexec</div><div class="line">458G <span class="keyword">log</span> [-__]</div><div class="line">8.0K my.cnf</div><div class="line">76M mysql-<span class="keyword">test</span></div><div class="line">13M share</div><div class="line">2.9M sql-bench</div><div class="line">4.0K <span class="keyword">test</span></div><div class="line">4.0K tmp</div><div class="line">101G <span class="keyword">var</span> [-_-]</div><div class="line">[cuihuan:~ mysql5]$ <span class="keyword">cd</span> <span class="built_in">log</span></div><div class="line">[cuihuan:~ <span class="keyword">log</span>]$ <span class="keyword">ls</span> -lh</div><div class="line"><span class="keyword">total</span> 458G</div><div class="line">-rw-rw---- 1 work work 870K <span class="keyword">Dec</span> 2 17:42 mysql.<span class="keyword">err</span></div><div class="line">-rw-rw---- 1 work work 3.9K Mar 24 2015 mysql.<span class="keyword">err</span>-old</div><div class="line">-rw-rw---- 1 work work 446G <span class="keyword">Dec</span> 3 15:19 mysql.<span class="keyword">log</span> 【-__】</div><div class="line">-rw-rw---- 1 work work 11G <span class="keyword">Dec</span> 3 15:10 slow.<span class="built_in">log</span></div></pre></td></tr></table></figure>
<p>经过分析看到mysql.log的日志占了446G,着手清理下。【mysql log 好的保存方式是：天级导出，清理n天之前的log，此处不再赘述】</p>
<h2 id="清理之后效果"><a href="#清理之后效果" class="headerlink" title="清理之后效果"></a>清理之后效果</h2><p>清理 mysql.log 和var  之后<br>清理了大约<code>500g</code>的空间<br><figure class="highlight prolog"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[cuihuan:~ var]$ df -h   </div><div class="line"><span class="symbol">Filesystem</span> <span class="symbol">Size</span> <span class="symbol">Used</span> <span class="symbol">Avail</span> <span class="symbol">Use</span><span class="comment">% Mounted on</span></div><div class="line">/dev/sda2 <span class="number">8.2</span><span class="symbol">G</span> <span class="number">6.7</span><span class="symbol">G</span> <span class="number">1.6</span><span class="symbol">G</span> <span class="number">82</span><span class="comment">% /</span></div><div class="line">/dev/sda3 <span class="number">1.4</span><span class="symbol">T</span> <span class="number">757</span><span class="symbol">G</span> <span class="number">584</span><span class="symbol">G</span> <span class="number">57</span><span class="comment">% /home</span></div></pre></td></tr></table></figure></p>
<p>【转载请注明：<a href="http://cuihuan.net/article/linux-%E6%9F%A5%E6%89%BE%E6%B8%85%E7%90%86%E5%A4%A7%E6%96%87%E4%BB%B6.html">linux 查找清理大文件</a> | <a href="http://cuihuan.net">靠谱崔小拽</a> 】</p>
]]></content>
      
        
        <tags>
            
            <tag> linux </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[echarts动态获取数据实例]]></title>
      <url>/2015/12/06/echarts%E5%8A%A8%E6%80%81%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE%E5%AE%9E%E4%BE%8B/</url>
      <content type="html"><![CDATA[<blockquote>
<p>echarts动态获取数据库的实时数据的简单实例。实例演示： <a href="http://cuihuan.net:1015/demo_file/echarts_realtime_demo/demo.html"> 跳转demo </a></p>
</blockquote>
<h2 id="引入echarts-文件。"><a href="#引入echarts-文件。" class="headerlink" title="引入echarts 文件。"></a>引入echarts 文件。</h2><p>引入echarts的文件方式有多种，比较推荐模块化的引入方式。<br>小拽的简单demo是直接引入文件，提供一个下载地址 ：<a href="http://cuihuan.net:1015/component/echarts/build/echarts-all.js"> 点击下载 </a></p>
<h2 id="html-部分代码"><a href="#html-部分代码" class="headerlink" title="html 部分代码"></a>html 部分代码</h2><p>一块div 用于echart的展现。<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;<span class="keyword">div</span> <span class="built_in">id</span>=<span class="string">"echart_show"</span> style=<span class="string">"height:500px"</span>&gt;这里是一个布局展现&lt;/<span class="keyword">div</span>&gt;</div></pre></td></tr></table></figure></p>
<h2 id="js-部分代码"><a href="#js-部分代码" class="headerlink" title="js 部分代码"></a>js 部分代码</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div></pre></td><td class="code"><pre><div class="line">$(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// 绘制反馈量图形</span></div><div class="line">    <span class="keyword">var</span> init_echarts = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> refreshChart = <span class="function"><span class="keyword">function</span> (<span class="params">show_data</span>) </span>&#123;</div><div class="line">            my_demo_chart = echarts.init(<span class="built_in">document</span>.getElementById(<span class="string">'echart_show'</span>));</div><div class="line">            my_demo_chart.showLoading(&#123;</div><div class="line">                <span class="attr">text</span>: <span class="string">'加载中...'</span>,</div><div class="line">                <span class="attr">effect</span>: <span class="string">'whirling'</span></div><div class="line">            &#125;);</div><div class="line"></div><div class="line"></div><div class="line">            <span class="keyword">var</span> echarts_all_option = &#123;</div><div class="line">                <span class="attr">title</span>: &#123;</div><div class="line">                    <span class="attr">text</span>: <span class="string">'动态数据'</span>,</div><div class="line">                    <span class="attr">subtext</span>: <span class="string">'纯属虚构'</span></div><div class="line">                &#125;,</div><div class="line">                <span class="attr">tooltip</span>: &#123;</div><div class="line">                    <span class="attr">trigger</span>: <span class="string">'axis'</span></div><div class="line">                &#125;,</div><div class="line">                <span class="attr">legend</span>: &#123;</div><div class="line">                    <span class="attr">data</span>: [<span class="string">'最新成交价'</span>, <span class="string">'预购队列'</span>]</div><div class="line">                &#125;,</div><div class="line">                <span class="attr">toolbox</span>: &#123;</div><div class="line">                    <span class="attr">show</span>: <span class="literal">true</span>,</div><div class="line">                    <span class="attr">feature</span>: &#123;</div><div class="line">                        <span class="attr">mark</span>: &#123;<span class="attr">show</span>: <span class="literal">true</span>&#125;,</div><div class="line">                        <span class="attr">dataView</span>: &#123;<span class="attr">show</span>: <span class="literal">true</span>, <span class="attr">readOnly</span>: <span class="literal">false</span>&#125;,</div><div class="line">                        <span class="attr">magicType</span>: &#123;<span class="attr">show</span>: <span class="literal">true</span>, <span class="attr">type</span>: [<span class="string">'line'</span>, <span class="string">'bar'</span>]&#125;,</div><div class="line">                        <span class="attr">restore</span>: &#123;<span class="attr">show</span>: <span class="literal">true</span>&#125;,</div><div class="line">                        <span class="attr">saveAsImage</span>: &#123;<span class="attr">show</span>: <span class="literal">true</span>&#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;,</div><div class="line">                <span class="attr">dataZoom</span>: &#123;</div><div class="line">                    <span class="attr">show</span>: <span class="literal">false</span>,</div><div class="line">                    <span class="attr">start</span>: <span class="number">0</span>,</div><div class="line">                    <span class="attr">end</span>: <span class="number">100</span></div><div class="line">                &#125;,</div><div class="line">                <span class="attr">xAxis</span>: [</div><div class="line">                    &#123;</div><div class="line">                        <span class="attr">type</span>: <span class="string">'category'</span>,</div><div class="line">                        <span class="attr">boundaryGap</span>: <span class="literal">true</span>,</div><div class="line">                        <span class="attr">data</span>: (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">                            <span class="keyword">var</span> now = <span class="keyword">new</span> <span class="built_in">Date</span>();</div><div class="line">                            <span class="keyword">var</span> res = [];</div><div class="line">                            <span class="keyword">var</span> len = <span class="number">10</span>;</div><div class="line">                            <span class="keyword">while</span> (len--) &#123;</div><div class="line">                                res.unshift(now.toLocaleTimeString().replace(<span class="regexp">/^\D*/</span>, <span class="string">''</span>));</div><div class="line">                                now = <span class="keyword">new</span> <span class="built_in">Date</span>(now - <span class="number">2000</span>);</div><div class="line">                            &#125;</div><div class="line">                            <span class="keyword">return</span> res;</div><div class="line">                        &#125;)()</div><div class="line">                    &#125;,</div><div class="line">                    &#123;</div><div class="line">                        <span class="attr">type</span>: <span class="string">'category'</span>,</div><div class="line">                        <span class="attr">boundaryGap</span>: <span class="literal">true</span>,</div><div class="line">                        <span class="attr">data</span>: (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">                            <span class="keyword">var</span> res = [];</div><div class="line">                            <span class="keyword">var</span> len = <span class="number">10</span>;</div><div class="line">                            <span class="keyword">while</span> (len--) &#123;</div><div class="line">                                res.push(len + <span class="number">1</span>);</div><div class="line">                            &#125;</div><div class="line">                            <span class="keyword">return</span> res;</div><div class="line">                        &#125;)()</div><div class="line">                    &#125;</div><div class="line">                ],</div><div class="line">                <span class="attr">yAxis</span>: [</div><div class="line">                    &#123;</div><div class="line">                        <span class="attr">type</span>: <span class="string">'value'</span>,</div><div class="line">                        <span class="attr">scale</span>: <span class="literal">true</span>,</div><div class="line">                        <span class="attr">name</span>: <span class="string">'价格'</span>,</div><div class="line">                        <span class="attr">boundaryGap</span>: [<span class="number">0.2</span>, <span class="number">0.2</span>]</div><div class="line">                    &#125;,</div><div class="line">                    &#123;</div><div class="line">                        <span class="attr">type</span>: <span class="string">'value'</span>,</div><div class="line">                        <span class="attr">scale</span>: <span class="literal">true</span>,</div><div class="line">                        <span class="attr">name</span>: <span class="string">'预购量'</span>,</div><div class="line">                        <span class="attr">boundaryGap</span>: [<span class="number">0.2</span>, <span class="number">0.2</span>]</div><div class="line">                    &#125;</div><div class="line">                ],</div><div class="line">                <span class="attr">series</span>: [</div><div class="line">                    &#123;</div><div class="line">                        <span class="attr">name</span>: <span class="string">'预购队列'</span>,</div><div class="line">                        <span class="attr">type</span>: <span class="string">'bar'</span>,</div><div class="line">                        <span class="attr">xAxisIndex</span>: <span class="number">1</span>,</div><div class="line">                        <span class="attr">yAxisIndex</span>: <span class="number">1</span>,</div><div class="line">                        <span class="comment">// 获取到数据库的数据</span></div><div class="line">                        data: show_data[<span class="number">0</span>]</div><div class="line">                    &#125;,</div><div class="line">                    &#123;</div><div class="line">                        <span class="attr">name</span>: <span class="string">'最新成交价'</span>,</div><div class="line">                        <span class="attr">type</span>: <span class="string">'line'</span>,</div><div class="line">                        <span class="comment">// 实时获取的数据</span></div><div class="line">                        data:show_data[<span class="number">1</span>]</div><div class="line">                    &#125;</div><div class="line">                ]</div><div class="line">            &#125;;</div><div class="line"></div><div class="line">            my_demo_chart.hideLoading();</div><div class="line">            my_demo_chart.setOption(echarts_all_option);</div><div class="line"></div><div class="line">        &#125;;</div><div class="line"></div><div class="line">        <span class="comment">// 获取原始数据</span></div><div class="line">        $.ajax(&#123;</div><div class="line">            <span class="attr">url</span>: <span class="string">"http://cuihuan.net:1015/demo_file/echarts_realtime_demo/get_data.php"</span>,</div><div class="line">            <span class="attr">data</span>: &#123;<span class="attr">type</span>: <span class="string">"2"</span>&#125;,</div><div class="line">            <span class="attr">success</span>: <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</div><div class="line">                <span class="comment">// 根据数据库取到结果拼接现在结果</span></div><div class="line">                refreshChart(<span class="built_in">eval</span>(data));</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="comment">// 开启实时获取数据更新</span></div><div class="line">    $(<span class="string">"#getData"</span>).on(<span class="string">"click"</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> timeTicket;</div><div class="line">        <span class="keyword">var</span> lastData = <span class="number">11</span>;</div><div class="line">        <span class="keyword">var</span> axisData;</div><div class="line">        clearInterval(timeTicket);</div><div class="line">        timeTicket = setInterval(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">            <span class="comment">// 获取实时更新数据</span></div><div class="line">            $.ajax(&#123;</div><div class="line">                <span class="attr">url</span>: <span class="string">"http://cuihuan.net:1015/demo_file/echarts_realtime_demo/get_data.php"</span>,</div><div class="line">                <span class="attr">data</span>: &#123;<span class="attr">type</span>: <span class="string">"new"</span>&#125;,</div><div class="line">                <span class="attr">success</span>: <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</div><div class="line">                    <span class="comment">// 根据条件转换成相应的api 转化为echart 需要的数据</span></div><div class="line">                    <span class="comment">// todo 更新数据采用随机更新的方式</span></div><div class="line">                    lastData += <span class="built_in">Math</span>.random() * ((<span class="built_in">Math</span>.round(<span class="built_in">Math</span>.random() * <span class="number">10</span>) % <span class="number">2</span>) == <span class="number">0</span> ? <span class="number">1</span> : <span class="number">-1</span>);</div><div class="line">                    lastData = lastData.toFixed(<span class="number">1</span>) - <span class="number">0</span>;</div><div class="line">                    axisData = (<span class="keyword">new</span> <span class="built_in">Date</span>()).toLocaleTimeString().replace(<span class="regexp">/^\D*/</span>, <span class="string">''</span>);</div><div class="line"></div><div class="line">                    <span class="comment">// 动态数据接口 addData</span></div><div class="line">                    my_demo_chart.addData([</div><div class="line">                        [</div><div class="line">                            <span class="number">0</span>,        <span class="comment">// 系列索引</span></div><div class="line">                            <span class="built_in">Math</span>.round(<span class="built_in">Math</span>.random() * <span class="number">1000</span>), <span class="comment">// 新增数据</span></div><div class="line">                            <span class="literal">true</span>,     <span class="comment">// 新增数据是否从队列头部插入</span></div><div class="line">                            <span class="literal">false</span>     <span class="comment">// 是否增加队列长度，false则自定删除原有数据，队头插入删队尾，队尾插入删队头</span></div><div class="line">                        ],</div><div class="line">                        [</div><div class="line">                            <span class="number">1</span>,        <span class="comment">// 系列索引</span></div><div class="line">                            lastData, <span class="comment">// 新增数据</span></div><div class="line">                            <span class="literal">false</span>,    <span class="comment">// 新增数据是否从队列头部插入</span></div><div class="line">                            <span class="literal">false</span>,    <span class="comment">// 是否增加队列长度，false则自定删除原有数据，队头插入删队尾，队尾插入删队头</span></div><div class="line">                            axisData  <span class="comment">// 坐标轴标签</span></div><div class="line">                        ]</div><div class="line">                    ]);</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line"></div><div class="line">        &#125;, <span class="number">2100</span>);</div><div class="line"></div><div class="line">        <span class="comment">// 关闭更新操作</span></div><div class="line">        $(<span class="string">"#stopData"</span>).on(<span class="string">"click"</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">            clearInterval(timeTicket);</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">    &#125;);</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">// 默认加载</span></div><div class="line">    <span class="keyword">var</span> default_load = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">        init_echarts();</div><div class="line">    &#125;)();</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h2 id="php-部分代码"><a href="#php-部分代码" class="headerlink" title="php 部分代码"></a>php 部分代码</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 连接数据库获取数据</div><div class="line"> *</div><div class="line"> * User: cuixiaohuan</div><div class="line"> * Date: 15/12/4</div><div class="line"> * Time: 下午6:47</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="comment">// 获取请求的类型</span></div><div class="line">$type = $_GET[<span class="string">'type'</span>];</div><div class="line"></div><div class="line"><span class="comment">// 连接服务器</span></div><div class="line">$link = mysql_connect(<span class="string">'ip:port'</span>, <span class="string">'user'</span>, <span class="string">'password'</span>);</div><div class="line"><span class="keyword">if</span> (!$link) &#123;</div><div class="line">    <span class="keyword">die</span>(<span class="string">"Could not connect:"</span> . mysql_error());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 获取test库数据</span></div><div class="line">$crowd_db = mysql_select_db(<span class="string">'test'</span>, $link);</div><div class="line">$day_time = date(<span class="string">"Y-m-d"</span>);</div><div class="line"></div><div class="line"><span class="comment">// 根据传输过来的数据获取数据</span></div><div class="line">$static_sql = <span class="string">"select v from test where id = "</span> . $type . <span class="string">" limit 10"</span>;</div><div class="line"></div><div class="line"><span class="comment">// 获取数据之后返回</span></div><div class="line">$res = mysql_query($static_sql, $link_2004);</div><div class="line"></div><div class="line"><span class="keyword">if</span> ($res) &#123;</div><div class="line">    <span class="comment">// 将结果进行入库操作</span></div><div class="line">    $row = mysql_fetch_row($res);</div><div class="line"></div><div class="line">    <span class="keyword">if</span>($row[<span class="number">0</span>])&#123;</div><div class="line">        <span class="keyword">echo</span> $row[<span class="number">0</span>];</div><div class="line">    &#125;</div><div class="line">    mysql_free_result($res);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="简单说明"><a href="#简单说明" class="headerlink" title="简单说明"></a>简单说明</h2><p>小拽的demo中，根据echarts的api，绘制出了原有的图形展示；之后，对js设置了个定时任务，实时的去获取数据库中可能新入库的数据，接口通过php简单调用数据库实现。</p>
<p><a href="http://cuihuan.net"> 小拽个人小站 </a></p>
]]></content>
      
        
        <tags>
            
            <tag> javascript </tag>
            
            <tag> 前端 </tag>
            
            <tag> 动态获取数据 </tag>
            
            <tag> pho </tag>
            
            <tag> echarts </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[【wordpress优化】压缩和使用静态缓存]]></title>
      <url>/2015/12/06/%E3%80%90wordpress%E4%BC%98%E5%8C%96%E3%80%91%E5%8E%8B%E7%BC%A9%E5%92%8C%E4%BD%BF%E7%94%A8%E9%9D%99%E6%80%81%E7%BC%93%E5%AD%98/</url>
      <content type="html"><![CDATA[<blockquote>
<p>先说背景：wordpress个人网站，整体性能挺不错；但是，由于采用php动态获取数据，构成页面的方式，势必会影响页面加载速度。对于一些最常用的页面[例如首页]等等，完全可以采用生成伪静态页面缓存的方式加载。</p>
<p>针对现有的缓存方式调研了一下：本文使用<code>wp super cache</code>进行了优化，提升加载速度200%以上。</p>
</blockquote>
<h2 id="无图无真想，先看效果"><a href="#无图无真想，先看效果" class="headerlink" title="无图无真想，先看效果"></a>无图无真想，先看效果</h2><p>针对相同页面在chrome下做了个加载时间，大小的对比，如下图</p>
<p>优化前数据：23ms感知页面；3.62s加载完成；页面大小：419k；请求个数：25个；<br><a href="http://cuihuan.net/wp-content/uploads/2015/12/E6B50C39-73D4-4397-9A79-794C58FC8A6A.png"><img src="http://cuihuan.net/wp-content/uploads/2015/12/E6B50C39-73D4-4397-9A79-794C58FC8A6A-1024x490.png" alt="原始加载时间"></a></p>
<p>优化后数据：106ms感知页面；<code>1.81s</code>加载完成；页面大小<code>13.9k</code>；请求个数24个；<br><img src="http://cuihuan.net/wp-content/uploads/2015/12/1FDB64C3-369A-47E4-8CF7-FE2E7676FC4C1-1024x482.png" alt="原始加载时间"></p>
<p>效果不错，后文做个详细分析。</p>
<h2 id="了解-wp-super-cache"><a href="#了解-wp-super-cache" class="headerlink" title="了解 wp super cache"></a>了解 wp super cache</h2><p><a href="http://z9.io/wp-super-cache/" target="_blank" rel="external"> wp super cache </a> 是wordpress的一种缓存优化插件，本质是利用缓存机制提升页面加载速度。<br><strong>实现原理:</strong> php最终在前端展现时需要转换为html，然后获取响应的数据；wp super cache 则提前将php文件转换为的html伪静态文件进行存储，一旦发生请求，直接返回生成的页面；减少了数据库取数据，转换等过程，来增加加载速度。<br><strong>优 点:</strong> 增加了加载速度。<br><strong>缺 点:</strong> 增加了存储成本，而且要不断的更新，如果用户量大，个人感觉存储和离线成本增加会挺多。</p>
<h2 id="安装-wp-super-cache"><a href="#安装-wp-super-cache" class="headerlink" title="安装 wp super cache"></a>安装 wp super cache</h2><p>官网下载地址：<a href="http://z9.io/wp-super-cache/" target="_blank" rel="external"> http://z9.io/wp-super-cache/ </a><br>【无法翻墙可参考小拽博文：<a href="http://cuihuan.net/article/%E4%B8%8D%E7%BF%BB%E5%A2%99%EF%BC%8C%E4%B8%8B%E8%BD%BDwordpress%E5%AE%98%E6%96%B9%E6%8F%92%E4%BB%B6%E5%B0%8F%E6%8A%80%E5%B7%A7.html"> 不翻墙，下载wordpress官方主题和插件小技巧 </a>】</p>
<p>注意：安装wp super cache 需要设定固定连接 如下图<br>推荐采用【自定义结果】：<a href="http://cuihuan.net/article/%postname%.html">http://cuihuan.net/article/%postname%.html</a><br>原因在于其他包含字母或者日期不太容易表意，也不利于阅读和seo等等。<br><a href="http://cuihuan.net/wp-content/uploads/2015/12/BEA1E968-7B4D-4CED-AC56-8E3F4A5A6F2C.png"><img src="http://cuihuan.net/wp-content/uploads/2015/12/BEA1E968-7B4D-4CED-AC56-8E3F4A5A6F2C-1024x546.png" alt="修改链接格式"></a></p>
<p>如果最初采用的是<a href="http://xxx/?p=xxx的方式，需要对服务器进行相关设置，否则会一直出现404。解决和设置办法，在另一篇文章中，此处不赘述（[wp" target="_blank" rel="external">http://xxx/?p=xxx的方式，需要对服务器进行相关设置，否则会一直出现404。解决和设置办法，在另一篇文章中，此处不赘述（[wp</a> super cache 安装和问题解决](<a href="http://cuihuan.net/article/wp%20super%20cache%20%E5%AE%89%E8%A3%85%E5%92%8C%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3.html)）。">http://cuihuan.net/article/wp%20super%20cache%20%E5%AE%89%E8%A3%85%E5%92%8C%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3.html)）。</a></p>
<p>安装成功后，后台设置中会出现wp super cache</p>
<h2 id="配置-wp-super-cache"><a href="#配置-wp-super-cache" class="headerlink" title="配置 wp super cache"></a>配置 wp super cache</h2><p>安装成功后的简单个人推荐设置。</p>
<p>通用-》启用cache：开启<br>高级-》启用缓存：开启<br>高级-》模式选择：推荐mode_rewrite 这个需要apache或者nginx进行相关设置，这个速度最快；如果不想设置，可以选择php缓存模式。<br>高级-》压缩页面：必选。<br>高级-》页面更新清除，评论更新清楚：推荐。作用是更新文章，评论之后触发缓存更新。<br>高级-》移动支持：推荐。<br>其他一些设置根据个人需求增加。</p>
<p>配置，更新之后，进入网站cache目录下会出现缓存的html文件和gzip的压缩文件（前提是设置了giz压缩）。</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@cuixiaohuan cuihuan.<span class="keyword">net</span>]# <span class="keyword">pwd</span></div><div class="line">xxx/wp-content/cache/supercache/cuihuan.<span class="keyword">net</span></div><div class="line">[root@cuixiaohuan cuihuan.<span class="keyword">net</span>]# <span class="keyword">ls</span> -lh</div><div class="line"><span class="keyword">total</span> 52K</div><div class="line">-rw-r--r-- 1 apache apache 40K <span class="keyword">Dec</span> 5 11:33 index.html</div><div class="line">-rw-r--r-- 1 apache apache 9.5K <span class="keyword">Dec</span> 5 11:33 index.html.gz</div></pre></td></tr></table></figure>
<h2 id="效果分析"><a href="#效果分析" class="headerlink" title="效果分析"></a>效果分析</h2><p>优化前数据：23ms感知页面；3.62s加载完成；页面大小：419k；请求个数：25个；<br>优化后数据：106ms感知页面；<code>1.81s</code>加载完成；页面大小<code>13.9k</code>；请求个数24个；</p>
<p>感知页面变慢：原因在于，原始php页面相对较小，传输也相对较快，传输基本框架之后，才进行页面dom绘制，js渲染，数据获取和再次渲染，所以感知时间原始的快。但是对于750ms以下的对于用户几乎都是无感知。</p>
<p>加载完成变快：最主要达到的效果，节省最多的时间在于数据库获取数据的时间。</p>
<p>页面大小变小：<code>这块小的有点出乎意外</code>，小是应该的，但是小这么多就有点🐂了；之后分析了下页面，可能和文章异步获取，存储的html只获取了部分页面的文章，同时，对jquery等等组件肯定是利用缓存，不计入数据大小了。</p>
<p>请求数目变化不大。</p>
<blockquote>
<p>整体效果：加载快了，页面小了。</p>
</blockquote>
<p>【转载请注明：<a href="http://cuihuan.net/article/%E3%80%90wordpress%E4%BC%98%E5%8C%96%E3%80%91wp-super-cache-%E9%9D%99%E6%80%81%E7%BC%93%E5%AD%98.html">【wordpress优化】压缩和使用静态缓存 </a> | <a href="http://cuihuan.net"> 靠谱崔小拽 </a>】</p>
]]></content>
      
        
        <tags>
            
            <tag> php </tag>
            
            <tag> 缓存 </tag>
            
            <tag> wordpress </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[crontab 误删除恢复]]></title>
      <url>/2015/12/03/crontab%20%E8%AF%AF%E5%88%A0%E9%99%A4%E6%81%A2%E5%A4%8D/</url>
      <content type="html"><![CDATA[<blockquote>
<p>操作过程中：crontab被全部干掉了，利用log恢复过程记录。</p>
</blockquote>
<h2 id="事故原因分析："><a href="#事故原因分析：" class="headerlink" title="事故原因分析："></a>事故原因分析：</h2><p>回忆自己操作过程中，未进行crontab的清空，网上查了下原因，并且复现了下。可能原因如下：</p>
<p><strong>如果在SSH远程终端中敲下“crontab”命令之后，远程连接被一些原因（比如 糟糕的网络，程序异常）意外终止了，那么Crontab计划任务就会被操作系统所清空。听起来很不可思议，但是经过在虚拟机上的多次测试，它确确实实的发生了。测试方式为 用SecureCRT开一个SSH窗口，然后敲下命令“crontab”，接着在“任务管理器”中直接杀掉SecureCRT进程，再通过另外一个SSH窗口执行“crontab -l”，就会发现，所有的计划任务都不存在了。在今天事故发生的时间点上，就有人在服务器上遇到了这样的情况。</strong></p>
<h2 id="恢复操作"><a href="#恢复操作" class="headerlink" title="恢复操作"></a>恢复操作</h2><ul>
<li><p>获取完整日志和cmd日志。<br>从日志中恢复出一份最近几天的完整crontab 运行日志和cmd日志，并存储，用于之后完善和核准例行时间。</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">cat</span> /var/<span class="built_in">log</span>/cron | <span class="keyword">grep</span> -i <span class="string">"`which cron`"</span> &gt; ./all_temp</div><div class="line"><span class="keyword">cat</span>  ./all_temp | <span class="keyword">grep</span> -v <span class="comment">"&lt;command&gt;” &gt; ./cmd_temp</span></div></pre></td></tr></table></figure>
</li>
<li><p>获取所有crontab指令。<br>从日志中恢复一份去重的crontab log。【相当于所有的crontab命令】</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">awk -F'(' '/crond/&#123;a[<span class="variable">$3</span>]=<span class="variable">$0&#125;</span>END&#123;<span class="keyword">for</span>(i <span class="keyword">in</span> a)<span class="keyword">print</span> a[i]&#125;' /<span class="keyword">var</span>/<span class="keyword">log</span>/cron* &gt;crontab.txt</div></pre></td></tr></table></figure>
</li>
<li><p>手工恢复：<br>从crontab.txt 中找出每一条指令，然后在cmd_temp 中匹配运行次数，重新编辑crontab 添加</p>
</li>
</ul>
<h2 id="反思工作"><a href="#反思工作" class="headerlink" title="反思工作"></a>反思工作</h2><p>防止类似事件再次发生，写个简单shell脚本，每天对crontab进行备份，备份最近15天的数据。过期清楚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"><span class="comment"># 每天对crontab 进行备份 ，同时删除最近15天的数据</span></div><div class="line">DATE=$(date +%Y%m%d)</div><div class="line"></div><div class="line">crontab <span class="_">-l</span> &gt; /home/work/bak/crontab_<span class="variable">$DATE</span>.bak</div><div class="line">find /home/work/bak/ -mtime +15 -name <span class="string">'*.bak'</span> -exec rm -rf &#123;&#125; \;</div></pre></td></tr></table></figure></p>
<p><a href="http://cuihuan.net/?p=282"> 本人小站原文链接 </a></p>
]]></content>
      
        
        <tags>
            
            <tag> crontab </tag>
            
            <tag> linux </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[jsonp + php 跨域实例]]></title>
      <url>/2015/12/02/jsonp%20+%20php%20%E8%B7%A8%E5%9F%9F%E5%AE%9E%E4%BE%8B/</url>
      <content type="html"><![CDATA[<blockquote>
<p>由于跨域的存在，使资源交互在不同域名间变的复杂和安全。对于跨域数据传输，当数据长度较小(<strong>get的长度内</strong>)，jsonp是一种较好的解决方案。</p>
<p>分享一个自己在jsonp使用过程中的demo。<br>关于跨域可以参考：<a href="http://www.cnblogs.com/rainman/archive/2011/02/20/1959325.html" target="_blank" rel="external">跨域总结与解决办法</a></p>
</blockquote>
<h2 id="jsonp的js端调用"><a href="#jsonp的js端调用" class="headerlink" title="jsonp的js端调用"></a>jsonp的js端调用</h2><p>主要功能：通过jsonp向服务器，调用相应接口，获应数据；根据获取数据结果做出相应回调。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * jsonp demo</div><div class="line"> * 通过回调函数，进行获取之后的事件加载</div><div class="line"> *</div><div class="line"> * @author:cuihuan</div><div class="line"> * @private</div><div class="line"> */</div><div class="line">_jsonpDemo:<span class="function"><span class="keyword">function</span>(<span class="params">callback</span>)</span>&#123;</div><div class="line">    $.ajax(&#123;</div><div class="line">        <span class="attr">url</span>: <span class="string">"http://your_site_url"</span>,</div><div class="line">        <span class="attr">type</span>: <span class="string">'GET'</span>,</div><div class="line">        <span class="attr">dataType</span>: <span class="string">'JSONP'</span>,</div><div class="line">        <span class="attr">success</span>: <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</div><div class="line">            <span class="keyword">if</span> (data &amp;&amp; data.status) &#123;</div><div class="line">                <span class="keyword">if</span> (data.status == <span class="string">"0"</span>) &#123;</div><div class="line">                    <span class="comment">// failure solve</span></div><div class="line">                    ...</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (data.status == <span class="number">500</span>) &#123;</div><div class="line">                    <span class="comment">// server error log</span></div><div class="line">                    _sendInternalLog(data.info);</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (data.status == <span class="number">1</span>) &#123;</div><div class="line">                    <span class="comment">//success solve </span></div><div class="line">                    ...</div><div class="line">                &#125;</div><div class="line">                </div><div class="line">                <span class="comment">// callback func</span></div><div class="line">               (callback &amp;&amp; <span class="keyword">typeof</span>(callback) === <span class="string">"function"</span> ) &amp;&amp; callback(); </div><div class="line">            &#125;</div><div class="line"></div><div class="line">        &#125;,</div><div class="line">        <span class="attr">error</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">            _sendFailLog();</div><div class="line">        &#125;</div><div class="line">    &#125;)</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="jsonp-服务器端-php"><a href="#jsonp-服务器端-php" class="headerlink" title="jsonp 服务器端 (php)"></a>jsonp 服务器端 (php)</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 接口返回相应数据</div><div class="line"> *</div><div class="line"> * status: 0 标示失败，1标示成功,500发生错误</div><div class="line"> * return: jsonp </div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">actionGetJsonPInfo</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        $data = getNeedData()</div><div class="line">        <span class="keyword">if</span> ($data[<span class="string">'status'</span>] == <span class="string">"success"</span>) &#123;</div><div class="line">            $res = <span class="keyword">array</span>(<span class="string">"status"</span> =&gt; <span class="string">"1"</span>, <span class="string">'info'</span> =&gt; $data[<span class="string">'info'</span>]);</div><div class="line">        &#125;<span class="keyword">else</span>&#123;</div><div class="line">            $res = <span class="keyword">array</span>(<span class="string">"status"</span> =&gt; <span class="string">"0"</span>, <span class="string">'info'</span> =&gt; <span class="string">'0'</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;<span class="keyword">catch</span> (<span class="keyword">Exception</span> $e)&#123;</div><div class="line">        $res = <span class="keyword">array</span>(<span class="string">"status"</span> =&gt; <span class="string">"500"</span>, <span class="string">'info'</span>=&gt; $e);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// jsonp 通过get请求的返回数据形式</span></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span> ($_GET[<span class="string">'callback'</span>])) &#123;</div><div class="line">        header(<span class="string">"Content-Type: application/json"</span>);</div><div class="line">        <span class="keyword">echo</span> $_GET[<span class="string">'callback'</span>].<span class="string">"("</span>.json_encode($res).<span class="string">")"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>目前来说，数据量小的跨域传输，jsonp是一种很好的解决方案。</li>
<li>jsonp在data中可以自动识别，res.status，res.info等状态位，比较方便。</li>
<li>php端的接受代码最好不要采用 Access-Control-Allow-Origin:* 风险太大。</li>
</ul>
<p><a href="http://cuihuan.net/?p=278"> 本人小站原文 </a></p>
]]></content>
      
        
        <tags>
            
            <tag> javascript </tag>
            
            <tag> cors </tag>
            
            <tag> 跨域 </tag>
            
            <tag> jsonp </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[php 操作不同数据库]]></title>
      <url>/2015/11/30/php%20%E6%93%8D%E4%BD%9C%E4%B8%8D%E5%90%8C%E6%95%B0%E6%8D%AE%E5%BA%93/</url>
      <content type="html"><![CDATA[<blockquote>
<p>php脚本经常，处理处理不同机器上，不同数据库之间数据；而且脚本特别容易写错，抽取了个工作中最常用到的多库同步，特此记忆！</p>
</blockquote>
<h2 id="上代码"><a href="#上代码" class="headerlink" title="上代码"></a>上代码</h2><p>举个php操作不同数据库，进行数据同步的栗子。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 同步库1的数据到库2</div><div class="line"> * </div><div class="line"> * <span class="doctag">@author</span>  ：cuihuan</div><div class="line"> * <span class="doctag">@date</span>    ：2015-10-11</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">synchDbDiff</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// 连接库1</span></div><div class="line">    $crowd_conn_1 = mysql_connect(<span class="string">'ip_1:port_1'</span>, <span class="string">'name_1'</span>, <span class="string">'pw_1'</span>);</div><div class="line">    <span class="keyword">if</span> (!$crowd_conn_1) &#123;</div><div class="line">        <span class="keyword">die</span>(<span class="string">"Could not connect:"</span> . mysql_error());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    mysql_select_db(<span class="string">'test_data'</span>, $crowd_conn_1);</div><div class="line"></div><div class="line">    <span class="comment">// 连接库2</span></div><div class="line">    $crowd_conn_2 = mysql_connect(<span class="string">'ip_2:port_2'</span>, <span class="string">'name_2'</span>, <span class="string">'pw_2'</span>);</div><div class="line">    <span class="keyword">if</span> (!$crowd_conn_1) &#123;</div><div class="line">        <span class="keyword">die</span>(<span class="string">"Could not connect:"</span> . mysql_error());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    mysql_select_db(<span class="string">'test_data'</span>, $crowd_conn_2);</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">//获取未同步的数据</span></div><div class="line">    $get_data_sql = <span class="string">"SELECT `id`, `text` FROM `fb_conversation` WHERE `flag` = 1"</span>;</div><div class="line">    $c_result = mysql_query($get_data_sql, $crowd_conn_1);</div><div class="line">    <span class="keyword">$this</span>-&gt;check_res($c_result);</div><div class="line">    <span class="keyword">if</span> ($c_result) &#123;</div><div class="line">        <span class="keyword">while</span> ($row = mysql_fetch_array($c_result, MYSQL_NUM)) &#123;</div><div class="line"></div><div class="line">            <span class="comment">// 更新同步</span></div><div class="line">            $new_data_sql = <span class="string">"update from fb_conversation set text ="</span> . $row[<span class="number">1</span>] . <span class="string">"  where id = "</span> . $row[<span class="number">0</span>];</div><div class="line">            $res = mysql_query($new_data_sql, $crowd_conn_2);</div><div class="line">            <span class="keyword">$this</span>-&gt;check_res($c_result);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><a href="http://cuihuan.net/?p=275"> 个人小站原文链接 </a></p>
]]></content>
      
        
        <tags>
            
            <tag> php </tag>
            
            <tag> mysql </tag>
            
            <tag> 数据库同步 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[【redis学习一】基本概念和基本操作]]></title>
      <url>/2015/11/28/%E3%80%90redis%E5%AD%A6%E4%B9%A0%E4%B8%80%E3%80%91%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%E5%92%8C%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C/</url>
      <content type="html"><![CDATA[<h2 id="redis-基础"><a href="#redis-基础" class="headerlink" title="redis 基础"></a>redis 基础</h2><p><strong>官网地址</strong>：<a href="http://redis.io/" target="_blank" rel="external"> http://redis.io/ </a></p>
<p><strong>基本介绍</strong>：redis 是一个ansi c编写，支持网络的，基于内存的可持久化的日执行，kv数据库；10年期redis有vmare主持开发。</p>
<p>支持数据类型：redis支持strings,hashes list set sorted等结构。</p>
<p>持久化：存储于内存或虚拟内存中，有两种持久化的方式：</p>
<ul>
<li>：截图，内存数据不断写入硬盘【性能较高】</li>
<li>：log：记录每次更新的日志。【稳定性好】</li>
</ul>
<p>支持主从同步，性能非常优秀。<br>提供多种语言的api  基本上知道的都有。</p>
<p>使用场景：(个人觉的可以有的使用场景)<br>1：权限【权限每次都要入库校验，放在前端不靠谱，放在cache最合适】<br>2：缓存【例如批量操作数据，可以先缓存】<br>3：预取【例如topN数据,另外可能用到的数据，提前取出来，加快页面加载】<br>4：构建消息队列【可以根据redis的数据结构list，构造；数据批量入库，加快页面相应等方面不错】。<br>5：计数器【类似于批量入库的原理，可以计数，redis原子性的，可以精确支持】<br>6：其他场景还在不断探索中。</p>
<h2 id="安装和基本操作"><a href="#安装和基本操作" class="headerlink" title="安装和基本操作"></a>安装和基本操作</h2><p>安装参考：<a href="http://www.runoob.com/redis/redis-install.html" target="_blank" rel="external"> http://www.runoob.com/redis/redis-install.html </a></p>
<p>基本操作：<a href="http://redisdoc.com/" target="_blank" rel="external"> 官方文档地址 </a></p>
<p>启动：./redis-server<br>关闭：redis-cli shutdown<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">[cuihuan bin]$ ./redis-cli shutdown</div><div class="line">[cuihuan bin]$ ./redis-server    </div><div class="line">[<span class="number">325</span>] <span class="number">24</span> Sep <span class="number">18</span>:<span class="number">49</span>:<span class="number">06.632</span> # Warning: no config file specified, using the default config. In order to specify a config file use ./redis-server /path/to/redis.conf</div><div class="line">                <span class="symbol">_</span>.<span class="symbol">_</span>                                                 </div><div class="line">           <span class="symbol">_</span>.-``<span class="symbol">__</span> ''-.<span class="symbol">_</span>                                            </div><div class="line">      <span class="symbol">_</span>.-``    `.  `<span class="symbol">_</span>.  ''-.<span class="symbol">_</span>           Redis <span class="number">2.6</span>.10 (<span class="number">00000000</span>/<span class="number">0</span>) <span class="number">64</span> bit</div><div class="line">  .-`` .-```.  ```\/    <span class="symbol">_</span>.,<span class="symbol">_</span> ''-.<span class="symbol">_</span>                                  </div><div class="line"> (    '      ,       .-`  | `,    )     Running <span class="keyword">in</span> stand alone mode</div><div class="line"> |`-.<span class="symbol">_</span>`-...-` <span class="symbol">__</span>...-.``-.<span class="symbol">_</span>|'` <span class="symbol">_</span>.-'|     Port: <span class="number">6379</span></div><div class="line"> |    `-.<span class="symbol">_</span>   `.<span class="symbol">_</span>    /     <span class="symbol">_</span>.-'    |     PID: <span class="number">325</span></div><div class="line">  `-.<span class="symbol">_</span>    `-.<span class="symbol">_</span>  `-./  <span class="symbol">_</span>.-'    <span class="symbol">_</span>.-'                                  </div><div class="line"> |`-.<span class="symbol">_</span>`-.<span class="symbol">_</span>    `-.<span class="symbol">__</span>.-'    <span class="symbol">_</span>.-'<span class="symbol">_</span>.-'|                                 </div><div class="line"> |    `-.<span class="symbol">_</span>`-.<span class="symbol">_</span>        <span class="symbol">_</span>.-'<span class="symbol">_</span>.-'    |           http://redis.io       </div><div class="line">  `-.<span class="symbol">_</span>    `-.<span class="symbol">_</span>`-.<span class="symbol">__</span>.-'<span class="symbol">_</span>.-'    <span class="symbol">_</span>.-'                                  </div><div class="line"> |`-.<span class="symbol">_</span>`-.<span class="symbol">_</span>    `-.<span class="symbol">__</span>.-'    <span class="symbol">_</span>.-'<span class="symbol">_</span>.-'|                                 </div><div class="line"> |    `-.<span class="symbol">_</span>`-.<span class="symbol">_</span>        <span class="symbol">_</span>.-'<span class="symbol">_</span>.-'    |                                 </div><div class="line">  `-.<span class="symbol">_</span>    `-.<span class="symbol">_</span>`-.<span class="symbol">__</span>.-'<span class="symbol">_</span>.-'    <span class="symbol">_</span>.-'                                  </div><div class="line">      `-.<span class="symbol">_</span>    `-.<span class="symbol">__</span>.-'    <span class="symbol">_</span>.-'                                      </div><div class="line">          `-.<span class="symbol">_</span>        <span class="symbol">_</span>.-'                                          </div><div class="line">              `-.<span class="symbol">__</span>.-'                                              </div><div class="line"></div><div class="line">[<span class="number">325</span>] <span class="number">24</span> Sep <span class="number">18</span>:<span class="number">49</span>:<span class="number">06.633</span> # Server started, Redis version <span class="number">2.6</span>.10</div><div class="line">[<span class="number">325</span>] <span class="number">24</span> Sep <span class="number">18</span>:<span class="number">49</span>:<span class="number">06.633</span> # WARNING overcommit_memory <span class="built_in">is</span> set to <span class="number">0</span>! Background <span class="built_in">save</span> may fail under low memory condition. To <span class="built_in">fix</span> this issue add 'vm.overcommit_memory = <span class="number">1</span>' to /etc/sysctl.conf <span class="keyword">and</span> <span class="keyword">then</span> reboot <span class="keyword">or</span> run the command 'sysctl vm.overcommit_memory=<span class="number">1</span>' <span class="keyword">for</span> this to take effect.</div><div class="line">[<span class="number">325</span>] <span class="number">24</span> Sep <span class="number">18</span>:<span class="number">49</span>:<span class="number">06.673</span> * DB loaded from disk: <span class="number">0.039</span> seconds</div><div class="line">[<span class="number">325</span>] <span class="number">24</span> Sep <span class="number">18</span>:<span class="number">49</span>:<span class="number">06.673</span> * The server <span class="built_in">is</span> now ready to accept connections on port <span class="number">6379</span></div></pre></td></tr></table></figure></p>
<p>安装成功的标志 redis-cli 可以成功进入   </p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[cuihuan bin]$ ./redis-<span class="keyword">cli</span></div><div class="line">redis <span class="number">127.0</span><span class="meta">.0</span><span class="meta">.1</span>:<span class="number">6379</span>&gt;</div></pre></td></tr></table></figure>
<blockquote>
<p>注意：使用过程中如果是保密性高的数据，可以设置登录密码，增加安全想；但如果是简单数据，则可以不设置，优点就是速度稍快。</p>
</blockquote>
<p>redis 基本配置：<br>daemonize: yes 标示在后台运行<br>bind：绑定请求的地址<br>port：端口号，默认6379<br>timeout:默认客户端连接超时  多长时间不操作关闭(默认永久，此处改为3600)</p>
<p>loglevel: log等级<br>databases：默认连接数据库的个数 【此处为8】<br>slaveof 主从库</p>
<p>masterauth :密码验证<br>requirepass:是否需要密码</p>
<p>maxclients :最大客户机个数 设置为10000<br>maxmemory:最大内存个数 6625156  [机器内存32G,分配大约6g]</p>
<p>最基本的操作<br>set name xxx<br>get name xxx<br>del name xxx<br>exists name xxx</p>
<p>举个栗子<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"># <span class="selector-tag">get</span> <span class="selector-tag">val</span></div><div class="line"><span class="selector-tag">redis</span> 127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">get</span> <span class="selector-tag">name</span></div><div class="line">"<span class="selector-tag">cuixiaohuan</span>"</div><div class="line"></div><div class="line"># <span class="selector-tag">set</span> <span class="selector-tag">val</span> </div><div class="line"><span class="selector-tag">redis</span> 127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">set</span> <span class="selector-tag">name</span> <span class="selector-tag">cuixiaohuan_2</span> </div><div class="line"><span class="selector-tag">OK</span></div><div class="line"><span class="selector-tag">redis</span> 127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">get</span> <span class="selector-tag">name</span></div><div class="line">"<span class="selector-tag">cuixiaohuan_2</span>"</div><div class="line"></div><div class="line"># <span class="selector-tag">check</span> <span class="selector-tag">exists</span>; <span class="selector-tag">if</span> <span class="selector-tag">exists</span> <span class="selector-tag">return</span> 1</div><div class="line"><span class="selector-tag">redis</span> 127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">exists</span> <span class="selector-tag">name</span></div><div class="line">(<span class="selector-tag">integer</span>) 1</div><div class="line"></div><div class="line"># <span class="selector-tag">del</span> <span class="selector-tag">val</span></div><div class="line"><span class="selector-tag">redis</span> 127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">del</span> <span class="selector-tag">name</span></div><div class="line">(<span class="selector-tag">integer</span>) 1</div><div class="line"><span class="selector-tag">redis</span> 127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">get</span> <span class="selector-tag">name</span></div><div class="line">(<span class="selector-tag">nil</span>)</div></pre></td></tr></table></figure></p>
<p>其他常用操作：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"># <span class="selector-tag">ping</span> <span class="selector-pseudo">:check</span> <span class="selector-tag">connect</span></div><div class="line"><span class="selector-tag">redis</span> 127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">ping</span></div><div class="line"><span class="selector-tag">PONG</span></div><div class="line"></div><div class="line"># <span class="selector-tag">dbsize</span> <span class="selector-pseudo">:check</span> <span class="selector-tag">size</span></div><div class="line"><span class="selector-tag">redis</span> 127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">dbsize</span></div><div class="line">(<span class="selector-tag">integer</span>) 1</div><div class="line"></div><div class="line"><span class="selector-id">#flush</span> <span class="selector-pseudo">:clear</span> <span class="selector-tag">db</span></div><div class="line"><span class="selector-tag">redis</span> 127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">dbsize</span></div><div class="line">(<span class="selector-tag">integer</span>) 1</div><div class="line"><span class="selector-tag">redis</span> 127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">flushdb</span></div><div class="line"><span class="selector-tag">OK</span></div><div class="line"><span class="selector-tag">redis</span> 127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">dbsize</span></div><div class="line">(<span class="selector-tag">integer</span>) 0</div></pre></td></tr></table></figure></p>
<p><a href="http://cuihuan.net/?p=266"> 个人小站原文链接 </a></p>
]]></content>
      
        
        <tags>
            
            <tag> redis </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[【redis学习二】多php版本下phpredis扩展安装]]></title>
      <url>/2015/11/28/%E3%80%90redis%E5%AD%A6%E4%B9%A0%E4%BA%8C%E3%80%91%E5%A4%9Aphp%E7%89%88%E6%9C%AC%E4%B8%8Bphpredis%E6%89%A9%E5%B1%95%E5%AE%89%E8%A3%85/</url>
      <content type="html"><![CDATA[<blockquote>
<p>背景：安装完redis之后，需要安装phpredis扩展，才能让php操作redis；本机有多个php版本，安装过程中遇到的坑分享一下。</p>
</blockquote>
<p>##一 下载<br>git上下载redis的扩展包<br>    git clone <a href="https://github.com/nicolasff/phpredis" target="_blank" rel="external">https://github.com/nicolasff/phpredis</a></p>
<p>##二 挂载和configure<br>   在shell中输入 phpize 【注意：多个php版本的时候需要指定】<br>     ./configure<br>【phpize是用来扩展php扩展模块的，通过phpize可以建立php的外挂模块】</p>
<p>注意：（phpize 如果包含多个php，必须指定位置）<br>    cuihuan:phpredis cuixiaohuan$ ../php/bin/phpize<br>    Configuring for:<br>    PHP Api Version:         20121113<br>    Zend Module Api No:      20121212<br>    Zend Extension Api No:   220121212<br>    Cannot find autoconf. Please check your autoconf installation and the<br>    $PHP_AUTOCONF environment variable. Then, rerun this script.</p>
<p>报错的话需要安装：brew install autoconf  [phpize 报错] 否则没有phpize<br>    [work@cuixiaozhuai phpredis]$ ../php/bin/phpize<br>    Configuring for:<br>    PHP Api Version:         20041225<br>    Zend Module Api No:      20060613<br>    Zend Extension Api No:   220060519<br>    [work@cuixiaozhuai phpredis]$  ./configure –with-php-config=/home/work/thirdparty/php5/bin/php-config </p>
<p>当存在多个版本的php的时候，需要指定配置文件<br>     ./configure –with-php-config=/home/work/thirdparty/php5/bin/php-config </p>
<p>##三 编译和安装<br> make  之后最好make test<br>   make install<br>    cuihuan:phpredis cuixiaohuan$ make<br>    。。。<br>    Build complete.<br>    Don’t forget to run ‘make test’.</p>
<pre><code>cuihuan:phpredis cuixiaohuan$ make test
cuihuan:phpredis cuixiaohuan$ make install
</code></pre><p>##四 问题修复<br>【已修复，但是原因可能不太准确】<br>make编译报错<br>    .libs/redis_cluster.o(.data.rel.local+0x0): In function <code>ht_free_seed&#39;:
    /home/work/thirdparty/php5/php5/phpredis/redis_cluster.c:226:     multiple definition of</code>arginfo_scan’<br>    .libs/redis.o(.data.rel.local+0xe0):/home/work/thirdparty/php5/php5/p hpredis/redis.c:452: first defined here<br>    /usr/bin/ld: Warning: size of symbol <code>arginfo_scan&#39; changed from 160 in .libs/redis.o to 200 in .libs/redis_cluster.o
    .libs/redis_cluster.o(.data.rel.local+0xe0): In function</code>create_cluster_context’:<br>    /home/work/thirdparty/php5/php5/phpredis/redis_cluster.c:276:     multiple definition of `arginfo_kscan’<br>    .libs/redis.o(.data.rel.local+0x0):/home/work/thirdparty/php5/php5/phpredis/redis.c:364: first defined here<br>    collect2: ld returned 1 exit status<br>    make: <em>*</em> [redis.la] Error 1</p>
<p>最初以为是php多个版本生成install问题，采用./configure 指定php版本，指定php位置。<br>但是效果还是有问题。<br>最终通过修改redis_cluester.c 中，注释掉了这两个重复的<br>      40 </p>
<pre><code>41 /* Argument info for HSCAN, SSCAN, HSCAN */

42 /*ZEND_BEGIN_ARG_INFO_EX(arginfo_kscan, 0, 0, 2)

43     ZEND_ARG_INFO(0, str_key)

44     ZEND_ARG_INFO(1, i_iterator)

45     ZEND_ARG_INFO(0, str_pattern)

46     ZEND_ARG_INFO(0, i_count)

47 ZEND_END_ARG_INFO();

48 */

49 

50 /* Argument infor for SCAN */

51 /*

52 ZEND_BEGIN_ARG_INFO_EX(arginfo_scan, 0, 0, 2)

53     ZEND_ARG_INFO(1, i_iterator)

54     ZEND_ARG_INFO(0, str_node)

55     ZEND_ARG_INFO(0, str_pattern)

56     ZEND_ARG_INFO(0, i_count)

57 ZEND_END_ARG_INFO();

58 */
</code></pre><p>##五 简单测试</p>
<pre><code>&lt;?php
    $redis = new Redis();
    $conn = $redis-&gt;connect(&apos;127.0.0.1&apos;,6379);

    echo &quot;redis pass and status show&lt;/br&gt;&quot;;
    var_dump($redis-&gt;ping());

    $redis-&gt;set(&apos;test_key&apos;,&apos;test_value&apos;);
    echo &quot;test set val=&quot;.$redis-&gt;get(&apos;test_key&apos;).&quot;&lt;/br&gt;&quot;;

    $redis-&gt;setnx(&apos;unique_key&apos;,&quot;unique_val&quot;);
    $redis-&gt;setnx(&apos;unique_key&apos;,&quot;unique_val_2&quot;);

    echo $redis-&gt;get(&quot;unique_key&quot;);

    sleep(60);
    echo &apos;is exist&apos;.$redis-&gt;exists(&apos;test_60s&apos;);
    echo &apos;not has value&apos;.$redis-&gt;get(&apos;test_60s&apos;);
    $redis-&gt;delete(&apos;test_key&apos;,&apos;test_60s&apos;);
</code></pre><p><a href="http://cuihuan.net/?p=248"> 个人小站原文链接 </a></p>
]]></content>
      
        
        <tags>
            
            <tag> php </tag>
            
            <tag> redis </tag>
            
            <tag> phpredis </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[php 处理unicode解码]]></title>
      <url>/2015/11/28/php%20%E5%A4%84%E7%90%86unicode%E8%A7%A3%E7%A0%81/</url>
      <content type="html"><![CDATA[<blockquote>
<p>备忘：这个算是解码比较靠谱的，亲测。参考自stackoverflow，mark 分享</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// change unicode to unt-8</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">replace_unicode_escape_sequence</span><span class="params">($match)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> mb_convert_encoding(pack(<span class="string">'H*'</span>, $match[<span class="number">1</span>]), <span class="string">'UTF-8'</span>, <span class="string">'UCS-2BE'</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">unicode_decode</span><span class="params">($str)</span> </span>&#123;</div><div class="line"> <span class="keyword">return</span> preg_replace_callback(<span class="string">'/u([0-9a-f]&#123;4&#125;)/i'</span>, <span class="string">'replace_unicode_escape_sequence'</span>, $str); </div><div class="line">&#125;</div><div class="line"></div><div class="line">$str = unicode_decode(<span class="string">'&#123;"u5173u952eu8bcd":[&#123;"","key":"u767eu5ea6"&#125;]&#125;'</span>);</div></pre></td></tr></table></figure>
<p>问题：使用过程中，遇到一个问题：就是当多次调用改函数的时候，出现错误。原因在于函数名方式调用问题。</p>
<p>如果编码是 \u5173\u952e\u8bcd 正则改为/\u([0-9a-f]{4})/i 即可<br><a href="http://cuihuan.net/?p=194"> 个人小站原文链接 </a></p>
]]></content>
      
        
        <tags>
            
            <tag> php </tag>
            
            <tag> unicode </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[phpUnit 安装，实例和简单部署]]></title>
      <url>/2015/11/28/phpUnit%20%E5%AE%89%E8%A3%85%EF%BC%8C%E5%AE%9E%E4%BE%8B%E5%92%8C%E7%AE%80%E5%8D%95%E9%83%A8%E7%BD%B2/</url>
      <content type="html"><![CDATA[<blockquote>
<p>背景：一个小脚本，保证稳定为主；所以试用了下phpunit，快捷方便</p>
</blockquote>
<h3 id="phpunit-的安装"><a href="#phpunit-的安装" class="headerlink" title="phpunit 的安装"></a>phpunit 的安装</h3><p>phpunit是一个轻量级的php单元测试框架，通过pear安装<br>安装过程<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">wget https:<span class="comment">//phar.phpunit.de/phpunit.phar</span></div><div class="line">chmod +x phpunit<span class="selector-class">.phar</span></div><div class="line">sudo mv phpunit<span class="selector-class">.phar</span> /usr/local/bin/phpunit</div><div class="line">phpunit --version</div></pre></td></tr></table></figure></p>
<p>成功之后显示如下:<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">cuihuan:</span>~ cuixiaohuan$ phpunit --version</div><div class="line">PHPUnit <span class="number">4</span>.<span class="number">8</span>.<span class="number">6</span> <span class="keyword">by </span><span class="keyword">Sebastian </span><span class="keyword">Bergmann </span><span class="keyword">and </span>contributors.</div></pre></td></tr></table></figure></p>
<h3 id="简单试用"><a href="#简单试用" class="headerlink" title="简单试用"></a>简单试用</h3><p>测试类集成框架</p>
<p><strong>class PsCaseTest extends PHPUnit_Framework_TestCase{}</strong></p>
<p>其中phpunit<br>默认首先执行 setup<br>默认最后执行 teardown</p>
<p>举个栗子：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="php"><span class="meta">&lt;?php</span></span></div><div class="line"><span class="comment">/***************************************************************************</span></div><div class="line"> *</div><div class="line"> * $Id: PsCaseTest,v 1.0 PsCaseTest cuihuan Exp$</div><div class="line"> *</div><div class="line"> **************************************************************************/</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@file</span> PsCaseTest.php</div><div class="line"> * <span class="doctag">@author</span> cuihuan</div><div class="line"> * <span class="doctag">@date</span> 2015/09/11 10:09:31</div><div class="line"> * <span class="doctag">@version</span> $Revision:1.0$</div><div class="line"> * <span class="doctag">@brief</span>  pscase接口单元测试</div><div class="line"> *</div><div class="line"> **/</div><div class="line"></div><div class="line"><span class="keyword">require_once</span> dirname(<span class="keyword">__FILE__</span>) . (<span class="string">'/PsCase.php'</span>);</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">PsCaseTest</span> <span class="keyword">extends</span> <span class="title">PHPUnit_Framework_TestCase</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * <span class="doctag">@var</span> object pscase类</div><div class="line">     */</div><div class="line">    <span class="keyword">protected</span> $pscase;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * <span class="doctag">@brief</span> setup: Sets up the fixture, for example, opens a network connection.</div><div class="line">     *</div><div class="line">     * This method is called before a test is executed.  </div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setup</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;pscase = <span class="keyword">new</span> PsCase();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * <span class="doctag">@brief</span> teardown: Tears down the fixture, for example, closes a network connection.</div><div class="line">     * </div><div class="line">     * This method is called after a test is executed.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">teardown</span><span class="params">()</span></span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * <span class="doctag">@brief</span> : 测试config文件的获取</div><div class="line">     *</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testGetConfig</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;assertEquals(<span class="keyword">true</span>,<span class="keyword">$this</span>-&gt;pscase-&gt;debugText(<span class="string">"11"</span>));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h3><p>运行方式：phpunit  —bootstrap [源文件] 测试文件<br>具体如下：<br><figure class="highlight subunit"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">cuihuande:newcode cuixiaohuan$ phpunit --bootstrap ./PsCase.php ./PsCaseTest.php</div><div class="line"></div><div class="line">32015<span class="string">-09</span><span class="string">-11</span> 02:09:36:11&lt;br&gt;</div><div class="line">5</div><div class="line"></div><div class="line"><span class="keyword">Time:</span> 116 ms, Memory: 11.75Mb</div><div class="line"></div><div class="line">OK (1 test, 1 assertion)  【表示运行成功】</div></pre></td></tr></table></figure></p>
<h3 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h3><p>部署就不不赘述了，写个shell脚本，crontab天极运行，加个报警邮件，简单的单元测试ok，从此再也不用担心错误和回归测试了。</p>
<p><a href="http://cuihuan.net/?p=260"> 个人小站原文链接 </a></p>
]]></content>
      
        
        <tags>
            
            <tag> php </tag>
            
            <tag> 单元测试 </tag>
            
            <tag> phpunit </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[canvas 生成和合并图片]]></title>
      <url>/2015/11/23/canvas_combine_pic/</url>
      <content type="html"><![CDATA[<blockquote>
<p>先说背景：工作中遇到一个问题，file组件上传图片，file是可以上传n张图片；但是，后台逻辑历史原因，只能展现一张。因此：考虑到成本，决定在前端<strong>将多张图片合并成一张给后端</strong>。</p>
</blockquote>
<h3 id="先上代码"><a href="#先上代码" class="headerlink" title="先上代码"></a>先上代码</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line">_mergeImage2Canvas:<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="comment">// 获取file上传和展现的图片。一般file上传之后，有个小图标展现。</span></div><div class="line">    <span class="keyword">var</span> imgs = $(<span class="string">".img_files"</span>);</div><div class="line">    <span class="keyword">if</span> (!imgs) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 创建原始图像</span></div><div class="line">    <span class="comment">// 原因：file上传之后，展现往往是个缩略图，无法取到真正大小</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; imgs.length; i++) &#123;</div><div class="line">        <span class="keyword">var</span> fbwImg   = <span class="built_in">document</span>.createElement(<span class="string">"img"</span>);</div><div class="line">        <span class="keyword">var</span> fbwImgID = <span class="string">"temp_img_id"</span> + i;</div><div class="line">        $(<span class="string">"#"</span> + fbwImgID).remove();</div><div class="line">        fbwImg.src   = imgs[i].src;</div><div class="line">        fbwImg.className     = <span class="string">"temp-img-class"</span>;</div><div class="line">        <span class="comment">// 不显示，仅供调用</span></div><div class="line">        fbwImg.style.display = <span class="string">"none"</span>;</div><div class="line"></div><div class="line">        <span class="comment">// 临时区域扩展</span></div><div class="line">        $(<span class="string">"#temp_section"</span>).append(fbwImg);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 合并原始图片，生成一个新的base64 图片</span></div><div class="line">    <span class="keyword">var</span> getOriginImgBase64 = <span class="function"><span class="keyword">function</span> (<span class="params">oriImgs</span>) </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!oriImgs) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="comment">// 获取canvas的宽高</span></div><div class="line">        <span class="comment">// 原因：canvas需要首先指定宽高，所以需要提前获取最终的宽高</span></div><div class="line">        <span class="keyword">var</span> maxWidth = <span class="number">0</span>;</div><div class="line">        <span class="keyword">var</span> height = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; oriImgs.length; i++) &#123;</div><div class="line">            <span class="keyword">var</span> img = oriImgs[i];</div><div class="line">            <span class="keyword">if</span> (img.width &gt; maxWidth) &#123;</div><div class="line">                maxWidth = img.width;</div><div class="line">            &#125;</div><div class="line">            height += img.height;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 设定canvas</span></div><div class="line">        <span class="keyword">var</span> canvas    = <span class="built_in">document</span>.createElement(<span class="string">"canvas"</span>);</div><div class="line">        canvas.width  = maxWidth + <span class="number">10</span>;</div><div class="line">        canvas.height = height + <span class="number">10</span>;</div><div class="line">        <span class="keyword">var</span> ctx       = canvas.getContext(<span class="string">"2d"</span>);</div><div class="line"></div><div class="line">        <span class="comment">// 留5margin</span></div><div class="line">        <span class="keyword">var</span> dheight = <span class="number">5</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; oriImgs.length; j++) &#123;</div><div class="line">            <span class="keyword">var</span> img     = oriImgs[j];</div><div class="line">            <span class="keyword">var</span> cheight = img.height;</div><div class="line">            <span class="keyword">var</span> cwidth  = img.width;</div><div class="line"></div><div class="line">            <span class="comment">// 留5 margin</span></div><div class="line">            ctx.drawImage(img, <span class="number">5</span>, dheight, cwidth, cheight);</div><div class="line"></div><div class="line">            dheight = dheight + cheight + <span class="number">5</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 生成的base64 放在需要的一个全局变量中。</span></div><div class="line">        fbw_img_data = canvas.toDataURL(<span class="string">'image/png'</span>);</div><div class="line">        </div><div class="line">        <span class="comment">// 清理</span></div><div class="line">        $(<span class="string">".temp_img_class"</span>).remove();</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="comment">// 之所以使用timer，考虑到dom树如果没有加载完成，会取到高度有误差</span></div><div class="line">    <span class="keyword">var</span> imgTimer = <span class="literal">null</span>;</div><div class="line">    imgTimer = setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">        getOriginImgBase64($(<span class="string">".temp_img_class"</span>));</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (imgTimer) &#123;</div><div class="line">            clearTimeout(imgTimer);</div><div class="line">        &#125;</div><div class="line">    &#125;, <span class="number">300</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="合成效果"><a href="#合成效果" class="headerlink" title="合成效果"></a>合成效果</h3><p>图片一：小站logo</p>
<p><a href="http://cuihuan.net/wp-content/uploads/2015/11/cuihuan_title-1.jpg"><img src="http://cuihuan.net/wp-content/uploads/2015/11/cuihuan_title-1.jpg" alt="cuihuan_title (1)"></a> </p>
<p>图片二：小图标：<br><a href="http://cuihuan.net/wp-content/uploads/2015/11/del.png"><img src="http://cuihuan.net/wp-content/uploads/2015/11/del.png" alt="del"></a></p>
<p>合成效果：</p>
<p> <a href="http://cuihuan.net/wp-content/uploads/2015/11/下载.png"><img src="http://cuihuan.net/wp-content/uploads/2015/11/下载.png" alt="下载"></a></p>
<h3 id="原理简介"><a href="#原理简介" class="headerlink" title="原理简介"></a>原理简介</h3><p>主要是通过canvas 获取多个图片的base64编码，之后通过drawImage 函数合并和toDataUrl的方式合成。</p>
<h3 id="问题思考"><a href="#问题思考" class="headerlink" title="问题思考"></a>问题思考</h3><ul>
<li>问题一：必须支持canvas，否则还需要后台统一跑脚本处理。</li>
<li>问题二：性能消耗过大。append img 和base64代码对dom的消耗都挺大，尤其是在移动端，很容易造成崩溃。解决办法：设定最大宽度，将图片等比缩放，这样子就少了向dom扩展元素这部分的损耗。</li>
<li>问题三：base64 在传输上性能消耗也挺大，没有file原生的好。</li>
</ul>
<p>因此：出了必须前端搞定，最好的方式，还是在后台跑脚本运行合并。</p>
<p><a href="http://cuihuan.net/?p=253"> 个人小站原文链接 </a></p>
]]></content>
      
        
        <tags>
            
            <tag> 合成图片 </tag>
            
            <tag> canvas </tag>
            
            <tag> javascript </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Nginx实践二：nginx端口配置，域名重定向设置]]></title>
      <url>/2015/11/18/Nginx%E5%AE%9E%E8%B7%B5%E4%BA%8C%EF%BC%9Anginx%E7%AB%AF%E5%8F%A3%E9%85%8D%E7%BD%AE%EF%BC%8C%E5%9F%9F%E5%90%8D%E9%87%8D%E5%AE%9A%E5%90%91%E8%AE%BE%E7%BD%AE/</url>
      <content type="html"><![CDATA[<blockquote>
<p>nginx替换apache之后，需要进行两个基本设置，一是：域名绑定和重定向，防止盗链，死链，参考文章<a href="http://cuihuan.net/?p=154"> apache 防盗链 </a>；二是：设置多个端口，一个端口显然无法满足需求。</p>
</blockquote>
<h3 id="域名防盗链设置"><a href="#域名防盗链设置" class="headerlink" title="域名防盗链设置"></a>域名防盗链设置</h3><p>域名防盗链主要通过，设定服务器域名，非域名重定向到现有域名（相对于之前的黑名单，我太单纯了，流量可以重定向利用一下）。</p>
<p>配置nginx.conf</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># default 默认只能server_name 访问</span></div><div class="line"><span class="attribute">listen</span> <span class="number">80</span> default ;</div><div class="line"><span class="attribute">server_name</span> cuihuan.net;</div><div class="line"></div><div class="line"><span class="comment"># 重定向</span></div><div class="line"><span class="attribute">if</span> (<span class="variable">$host</span> != <span class="string">"cuihuan.net"</span>) &#123;</div><div class="line">    <span class="attribute">rewrite</span><span class="regexp"> ^/(.*)$</span> http://cuihuan.net/<span class="variable">$1</span> <span class="literal">permanent</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>解释：首先80端口默认只能域名访问 ，默认的域名cuihuan.net。 对于所有非cuihuan.net 的过来的数据直接引流的cuihuan.net。如下图【这个战斗力为五的渣渣还挂在我的页面】</p>
<p><img src="http://cuihuan.net/wp-content/uploads/2015/11/4BF263AE-6ACD-4634-9000-795C0FB5F323-1024x851.png" alt="4BF263AE-6ACD-4634-9000-795C0FB5F323"></p>
<p>进行了转码后还可以避免搜索引擎抓的域名出现死链。</p>
<p><a href="http://cuihuan.net/wp-content/uploads/2015/11/18AC69FB-9C9D-4CE6-8D9A-8F3BFC40D75C.png"><img src="http://cuihuan.net/wp-content/uploads/2015/11/18AC69FB-9C9D-4CE6-8D9A-8F3BFC40D75C-1024x467.png" alt="18AC69FB-9C9D-4CE6-8D9A-8F3BFC40D75C"></a></p>
<h3 id="配置多端口："><a href="#配置多端口：" class="headerlink" title="配置多端口："></a>配置多端口：</h3><p> 这个就简单了，直接把上面配置好的server copy一个挂上其他web服务或者phpadmin等等<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="section">server</span> &#123;</div><div class="line">    <span class="attribute">listen</span> <span class="number">8002</span> default ;</div><div class="line">    <span class="attribute">server_name</span> cuihuan.net;</div><div class="line"></div><div class="line">    <span class="attribute">if</span> (<span class="variable">$host</span> != <span class="string">"cuihuan.net"</span>) &#123;</div><div class="line">        <span class="attribute">rewrite</span><span class="regexp"> ^/(.*)$</span> http://cuihuan.net/<span class="variable">$1</span> <span class="literal">permanent</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="attribute">location</span> / &#123;</div><div class="line">        <span class="attribute">root</span> /var/www/weixin;</div><div class="line">        <span class="attribute">index</span> index.php;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="attribute">location</span> <span class="regexp">~ \.php$</span> &#123;</div><div class="line">        <span class="attribute">root</span> /var/www/weixin;</div><div class="line">        <span class="attribute">fastcgi_pass</span> <span class="number">127.0.0.1:9000</span>;</div><div class="line">        <span class="attribute">fastcgi_index</span> index.php;</div><div class="line">        <span class="attribute">fastcgi_param</span> SCRIPT_FILENAME /var/www/weixin<span class="variable">$fastcgi_script_name</span>;</div><div class="line">        <span class="attribute">include</span> fastcgi_params;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">   <span class="comment"># set nginx stutus</span></div><div class="line">   <span class="attribute">location</span> /NginxStatus&#123;</div><div class="line">        <span class="attribute">stub_status</span> <span class="literal">on</span>;</div><div class="line">        <span class="attribute">access_log</span> <span class="literal">on</span>;</div><div class="line">        <span class="attribute">auth_basic</span> <span class="string">"NginxStatus"</span>;</div><div class="line">        <span class="attribute">auth_basic_user_file</span> conf/htpasswd;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">#set deny all file</span></div><div class="line">    <span class="attribute">error_page</span> <span class="number">404</span> /<span class="number">404</span>.html;</div><div class="line">    <span class="attribute">location</span> = /var/www/wordpress/40x.html &#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="attribute">error_page</span> <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span> /50x.html;</div><div class="line">    <span class="attribute">location</span> = /home/www/wordpress/50x.html &#123;</div><div class="line">    &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p>对于nginx搭建小网站来说，这个是基本的配置。个人感觉相对于之前<a href="http://cuihuan.net/?p=154"> apache 防盗链配置 </a>来说难易差不多。</p>
</blockquote>
<p> <a href="http://cuihuan.net/?p=225"> 相关文章：Nginx实践一：centos apache更换为nginx </a></p>
<p><a href="http://cuihuan.net/?p=241"> 个人小站原文链接 </a></p>
]]></content>
      
        
        <tags>
            
            <tag> nginx </tag>
            
            <tag> apache </tag>
            
            <tag> 服务器 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Nginx实践一：centos apache更换为nginx]]></title>
      <url>/2015/11/18/Nginx%E5%AE%9E%E8%B7%B5%E4%B8%80%EF%BC%9Acentos%20apache%E6%9B%B4%E6%8D%A2%E4%B8%BAnginx/</url>
      <content type="html"><![CDATA[<blockquote>
<p>背景介绍： 阿里云，512M内存（最屌丝配置），搭建lamp 环境，除去 mysql分配了100M左右（这个不能再少了），http竟然占用了200多M，太庞大，决定换为较轻量级，高并发的nginx。</p>
</blockquote>
<h3 id="背景数据"><a href="#背景数据" class="headerlink" title="背景数据"></a>背景数据</h3><p>如下图所示：系统也就500M ,出了mysql占用的100M, httpd 占了1/2 还多（经常达到十几个进程），剩余50M，有时更少不能忍，经常造成数据库崩掉，写了个自动重启脚本，但觉的不是治本之策</p>
<pre><code># 统计apache 进程个数
ps aux|grep httpd | wc –l
</code></pre><p><a href="http://cuihuan.net/wp-content/uploads/2015/11/8C2E5AE4-0A5E-479E-8C20-1CFF0C35F6D7.png"><img src="http://cuihuan.net/wp-content/uploads/2015/11/8C2E5AE4-0A5E-479E-8C20-1CFF0C35F6D7-1024x621.png" alt="ngnix 服务器占用"></a></p>
<h3 id="解决策略"><a href="#解决策略" class="headerlink" title="解决策略"></a>解决策略</h3><ul>
<li>1：针对Apache进行优化。包括优化worker运行方式等等。可以参考<a href="https://linux.cn/article-5294-2.html" target="_blank" rel="external"> apache优化 </a></li>
<li>2 :更换轻量级服务器。采用nginx 或者lighthttpd等更轻量的服务器。传说中Nginx大法负载均衡和高并发略胜一筹，决定实践一把。</li>
</ul>
<h3 id="apache替换为nginx"><a href="#apache替换为nginx" class="headerlink" title="apache替换为nginx"></a>apache替换为nginx</h3><ul>
<li><p>1： 停掉apache<br>  sudo service httpd stop</p>
<p>注意：以防万一，最好不好提前卸掉。</p>
</li>
<li><p>2：安装nginx<br>  yum install nginx</p>
</li>
<li><p>3：启动nginx<br>  sudo nginx</p>
<p>安装成功之后，启动成功如下图 <a href="http://cuihuan.net/wp-content/uploads/2015/11/CB5A50FB-8B68-4F21-A6F4-BDC7AF6C93B2.png"><img src="http://cuihuan.net/wp-content/uploads/2015/11/CB5A50FB-8B68-4F21-A6F4-BDC7AF6C93B2-1024x302.png" alt="CB5A50FB-8B68-4F21-A6F4-BDC7AF6C93B2"></a></p>
</li>
<li>4：简单配置nginx<br>主要是简单修改下log【方便追查问题】 和 web_root 对应文件【快速启用网站】</li>
<li><p>5：重启nginx<br>  [root@iZ25xlozdf2Z nginx]# nginx -s quit<br>  [root@iZ25xlozdf2Z nginx]# nginx</p>
<p>如下图，配置web目录成功！ <a href="http://cuihuan.net/wp-content/uploads/2015/11/BAEF603F-CA9C-436E-B870-3E70C11542D0.png"><img src="http://cuihuan.net/wp-content/uploads/2015/11/BAEF603F-CA9C-436E-B870-3E70C11542D0.png" alt="BAEF603F-CA9C-436E-B870-3E70C11542D0"></a></p>
</li>
<li><p>6：添加php 支持<br>安装php-fpm<br>  yum install php-fpm</p>
<p>nginx.conf设置<br>  location ~ .php$ {</p>
<pre><code>root /var/www/html;
fastcgi_pass 127.0.0.1:9000;
fastcgi_index index.php;
fastcgi_param SCRIPT_FILENAME         /var/www/html$fastcgi_script_name;
include fastcgi_params;
</code></pre><p>  }</p>
</li>
<li><p>7：重新启动服务，网站回复。<br><a href="http://cuihuan.net/wp-content/uploads/2015/11/A8D2AD14-7AB9-4421-AF40-B1BE0A5355C3.png"><img src="http://cuihuan.net/wp-content/uploads/2015/11/A8D2AD14-7AB9-4421-AF40-B1BE0A5355C3-1024x718.png" alt="A8D2AD14-7AB9-4421-AF40-B1BE0A5355C3"></a></p>
</li>
<li>8：耗存简单对比 如下图：基本上节省了200M，虽然这个可能是运行初期数据；但是，还是确实轻了不少，每个服务占存基本上1/4，线程也少了不少。内存占用方面表现，感觉尚可，接下就看性能了 <a href="http://cuihuan.net/wp-content/uploads/2015/11/E773D2EE-2F51-4113-AAE1-939CD88DCAEE.png"><img src="http://cuihuan.net/wp-content/uploads/2015/11/E773D2EE-2F51-4113-AAE1-939CD88DCAEE-1024x667.png" alt="E773D2EE-2F51-4113-AAE1-939CD88DCAEE"></a></li>
</ul>
<h3 id="后续"><a href="#后续" class="headerlink" title="后续"></a>后续</h3><p>初次接触nginx，整体感觉还不错。后续，进行基本的防攻击，多端口设置，和性能配置。</p>
<p><a href="http://cuihuan.net/?p=225"> 个人小站原文链接 </a></p>
]]></content>
      
        
        <tags>
            
            <tag> nginx </tag>
            
            <tag> apache </tag>
            
            <tag> php </tag>
            
        </tags>
        
    </entry>
    
  
  
</search>
