<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="nginx,基本原理," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="由于性能问题，需要将 apache + php5.2 升级到 nginx + php7，对于nginx的性能和热加载早有耳闻，why nginx so diao。小拽进行了初探，有任何疑问或不准确的地方，欢迎直接开炮！！！

一、nginx现状nginx 是当前的使用最广泛的webserver ,支持http正向/反向代理，支持TCP/UDP层代理，来看下netcraft的数据

nginx在全">
<meta property="og:type" content="article">
<meta property="og:title" content="【nginx学习一】基本原理学习">
<meta property="og:url" content="http://cuihuan.net/2017/03/14/nginx_study_1/index.html">
<meta property="og:site_name" content="靠谱崔小拽">
<meta property="og:description" content="由于性能问题，需要将 apache + php5.2 升级到 nginx + php7，对于nginx的性能和热加载早有耳闻，why nginx so diao。小拽进行了初探，有任何疑问或不准确的地方，欢迎直接开炮！！！

一、nginx现状nginx 是当前的使用最广泛的webserver ,支持http正向/反向代理，支持TCP/UDP层代理，来看下netcraft的数据

nginx在全">
<meta property="og:image" content="http://cuihuan.net/wp_content/new/nginx1/nginx_trend_all.png">
<meta property="og:image" content="http://cuihuan.net/wp_content/new/nginx1/nginx_trend_top.png">
<meta property="og:image" content="http://cuihuan.net/wp_content/new/nginx1/nginx_compare.png">
<meta property="og:image" content="http://cuihuan.net/wp_content/new/nginx1/nginx_framework.png">
<meta property="og:image" content="http://cuihuan.net/wp_content/new/nginx1/nginx_conf_reload.png">
<meta property="og:image" content="http://cuihuan.net/wp_content/new/nginx1/nginx_bit_reload.png">
<meta property="og:image" content="http://cuihuan.net/wp_content/new/nginx1/nginx_flow.png">
<meta property="og:image" content="http://cuihuan.net/wp_content/new/nginx1/nginx_task.png">
<meta property="og:image" content="http://cuihuan.net/wp_content/new/nginx1/nginx_task2.png">
<meta property="og:image" content="http://cuihuan.net/wp_content/new/nginx1/nginx_event_.png">
<meta property="og:image" content="http://cuihuan.net/wp_content/new/nginx1/nginx_epoll.png">
<meta property="og:updated_time" content="2017-06-20T09:13:32.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="【nginx学习一】基本原理学习">
<meta name="twitter:description" content="由于性能问题，需要将 apache + php5.2 升级到 nginx + php7，对于nginx的性能和热加载早有耳闻，why nginx so diao。小拽进行了初探，有任何疑问或不准确的地方，欢迎直接开炮！！！

一、nginx现状nginx 是当前的使用最广泛的webserver ,支持http正向/反向代理，支持TCP/UDP层代理，来看下netcraft的数据

nginx在全">
<meta name="twitter:image" content="http://cuihuan.net/wp_content/new/nginx1/nginx_trend_all.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '小拽'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://cuihuan.net/2017/03/14/nginx_study_1/"/>





  <title>【nginx学习一】基本原理学习 | 靠谱崔小拽</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?15d3caeed62b266d96dd734894786f13";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">靠谱崔小拽</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">享受技术和生活带来的乐趣</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            博客
          </a>
        </li>
      
        
        <li class="menu-item menu-item-shuoshuo">
          <a href="/shuoshuo" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />
            
            说说
          </a>
        </li>
      
        
        <li class="menu-item menu-item-history">
          <a href="/history" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-camera"></i> <br />
            
            时光机
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-demo">
          <a href="http://cuihuan.net:1015" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-fighter-jet"></i> <br />
            
            demo
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://cuihuan.net/2017/03/14/nginx_study_1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="崔小拽">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/wp_content/base/cuihuan_title.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="靠谱崔小拽">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">【nginx学习一】基本原理学习</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-03-14T23:21:35+08:00">
                2017-03-14
              </time>
            

            

            
          </span>

          

          
            
                <span class="post-comments-count">
                  <span class="post-meta-divider">|</span>
                  <span class="post-meta-item-icon">
                    <i class="fa fa-comment-o"></i>
                  </span>
                  <a href="/2017/03/14/nginx_study_1/#comments" itemprop="discussionUrl">
                    <span class="post-comments-count valine-comment-count" data-xid="/2017/03/14/nginx_study_1/" itemprop="commentCount"></span>
                  </a>
                </span>

            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <blockquote>
<p>由于性能问题，需要将 apache + php5.2 升级到 nginx + php7，对于nginx的性能和热加载早有耳闻，why nginx so diao。小拽进行了初探，<code>有任何疑问或不准确的地方，欢迎直接开炮</code>！！！</p>
</blockquote>
<h2 id="一、nginx现状"><a href="#一、nginx现状" class="headerlink" title="一、nginx现状"></a>一、nginx现状</h2><p>nginx 是当前的<code>使用最广泛的webserver ,支持http正向/反向代理，支持TCP/UDP层代理</code>，来看下netcraft的数据</p>
<p><a href="http://cuihuan.net/wp_content/new/nginx1/nginx_trend_all.png"><img src="http://cuihuan.net/wp_content/new/nginx1/nginx_trend_all.png" alt="webserver_all"></a><br><a href="http://cuihuan.net/wp_content/new/nginx1/nginx_trend_top.png"><img src="http://cuihuan.net/wp_content/new/nginx1/nginx_trend_top.png" alt="webserver_top"></a></p>
<p>nginx在<code>全部网站中占比达到18%</code>，在<code>top millon busest 达到28%</code>，而且一直在增加。当下最时尚的webserver非nginx莫属</p>
<blockquote>
<p>更全数据可以参考：<a href="https://news.netcraft.com/archives/2017/01/12/january-2017-web-server-survey.html" target="_blank" rel="external">【netcraft】</a></p>
</blockquote>
<h2 id="二、nginx的特点"><a href="#二、nginx的特点" class="headerlink" title="二、nginx的特点"></a>二、nginx的特点</h2><p>深入了解nginx之前，先泛泛的了解下nginx的几个特点</p>
<ul>
<li>性能好<ul>
<li>非阻塞IO/高并发,支持文件IO</li>
<li>多worker，thread pool </li>
<li>基于rbtree的定时器</li>
<li>系统特性的持续支持</li>
</ul>
</li>
<li>功能强大<ul>
<li>webserver/cache/keepalive/pipeline等等</li>
<li>各种upstream的支持【fastcgi/http/…】</li>
<li>输出灵活【chunk/zip/…】</li>
<li>在不断的发展 http2,tcp,udp,proxy…</li>
</ul>
</li>
<li>运维的友好【这个对于开发和部署很重要】<ul>
<li>配置非常规范【个人认为：约定及规范是最好的实践】</li>
<li>热加载和热更新【后文会详细介绍，能在二进制的层面热更新】</li>
<li>日志强大【真的很强的，很多变量支撑】</li>
</ul>
</li>
<li>扩展强大</li>
</ul>
<p>下图是nginx、apache和lighttpd的一个对比。系统压力，内存占用，upstream支持等多个方面都非常不错<br><a href="http://cuihuan.net/wp_content/new/nginx1/nginx_compare.png"><img src="http://cuihuan.net/wp_content/new/nginx1/nginx_compare.png" alt="nginx对比图"></a></p>
<h2 id="三、nginx的核心机制"><a href="#三、nginx的核心机制" class="headerlink" title="三、nginx的核心机制"></a>三、nginx的核心机制</h2><h3 id="3-1-运行方式"><a href="#3-1-运行方式" class="headerlink" title="3.1 运行方式"></a>3.1 运行方式</h3><p>一句话简述nginx的运行方式：<code>master-worker多进程模式运行，单线程/非阻塞执行</code></p>
<p>如下官方图：nginx 启动后生成master，master会启动conf数量的<code>worker进程</code>，当用户的请求过来之后，由不同的worker调起<code>执行线程</code>，非阻塞的执行请求。这种运行方式相对于<code>apache的进程执行</code>相对轻量很多，支撑的并发性也会高很多。<br><a href="http://cuihuan.net/wp_content/new/nginx1/nginx_framework.png"><img src="http://cuihuan.net/wp_content/new/nginx1/nginx_framework.png" alt="nginx 基本框架"></a></p>
<h3 id="3-2-进程管理"><a href="#3-2-进程管理" class="headerlink" title="3.2 进程管理"></a>3.2 进程管理</h3><p>nginx是master-worker进程工作模式，那么nginx是如何管理master启程，怎么做到热加载的？</p>
<h4 id="3-2-1-配置热加载"><a href="#3-2-1-配置热加载" class="headerlink" title="3.2.1 配置热加载"></a>3.2.1 配置热加载</h4><p>官方图很赞，在<code>更换配置之后，master生成新的worker，直到原有的worker全部任务结束kill掉之后</code>。从现象上作证，也就是在relaod配置之后，短时间可能出现超过conf数量的进程，更新完成后，进程会完全改变。</p>
<blockquote>
<p>不更新、直接替换，这种设计思路在代码部署中也很常见，包括mysql迁移，代码更新，服务尝试，很值的学习。<br><a href="http://cuihuan.net/wp_content/new/nginx1/nginx_conf_reload.png"><img src="http://cuihuan.net/wp_content/new/nginx1/nginx_conf_reload.png" alt="nginx 配置热加载"></a></p>
</blockquote>
<h4 id="3-2-2-版本更新热加载"><a href="#3-2-2-版本更新热加载" class="headerlink" title="3.2.2 版本更新热加载"></a>3.2.2 版本更新热加载</h4><p>了解了worker的热加载之后，理解master就非常简单了，通过信号控制，同时存在两个master，逐步替代。<br><a href="http://cuihuan.net/wp_content/new/nginx1/nginx_bit_reload.png"><img src="http://cuihuan.net/wp_content/new/nginx1/nginx_bit_reload.png" alt="nginx 线程热加载"></a></p>
<p>关于replace过程中如何细节控制一致性，稳定性，信号控制，log控制等等，敬请期待小拽的进一步探索！</p>
<h3 id="3-3-处理流程和模块"><a href="#3-3-处理流程和模块" class="headerlink" title="3.3 处理流程和模块"></a>3.3 处理流程和模块</h3><p>启动进程后，请求在nginx内部是如何流转的，nginx内部包括哪些模块？</p>
<h4 id="3-3-1-worker处理过程"><a href="#3-3-1-worker处理过程" class="headerlink" title="3.3.1 worker处理过程"></a>3.3.1 worker处理过程</h4><ol>
<li>【post header】请求到达后首先读取header，log中request time初始时间便从此开始。</li>
<li>【rewrite】请求相关的配置和参数</li>
<li>【pre-access】预处理阶段，频率控制，高频绝句</li>
<li>【acess】权限控制，白名单，403，access deny ，静态文件开放等均有这个模块产生</li>
<li>【content】这个模块会调用upstream产生内容，这个阶段最重要<code>此处调起了工作线程，调用fastcgi，http，以及各种操作产生内容均在此处</code>。性能优化可能需要确认程序执行时间，对应access log中的upstream time 由此产生，记录了nginx中程序运行的全量时间，而request - upstream 就是网络传输和预处理时间。</li>
<li>【filter】内容过滤，包括gzip压缩，返回等在此处</li>
<li>【log】日志的产生</li>
<li>【重定向】<code>没有这个模块，所有的进行智能单向走，有了这个，在任何阶段都可以产生返回</code>，例如client主动阶段产生499的log，过程可能就是1-》2-》8-》7 over</li>
</ol>
<blockquote>
<p>摘自某ppt的一个图，如侵权，请尽快联系小拽<br><a href="http://cuihuan.net/wp_content/new/nginx1/nginx_flow.png"><img src="http://cuihuan.net/wp_content/new/nginx1/nginx_flow.png" alt="nginx 主要流程和模块"></a></p>
</blockquote>
<p>各个阶段的主要状态机可以参考:<a href="http://www.nginxguts.com/2011/01/phases/" target="_blank" rel="external">【跳转】</a></p>
<h3 id="3-4-请求管理"><a href="#3-4-请求管理" class="headerlink" title="3.4 请求管理"></a>3.4 请求管理</h3><p>了解了worker的工作模式和worker的内部主要模块，那么worker是如何管理请求的？</p>
<h4 id="3-4-1-任务调度"><a href="#3-4-1-任务调度" class="headerlink" title="3.4.1 任务调度"></a>3.4.1 任务调度</h4><blockquote>
<p>官方阐述：It’s well known that NGINX uses <code>an asynchronous, event‑driven approach to handling connections</code>. This means that instead of creating another dedicated process or thread for each request (like servers with a traditional architecture), it handles multiple connections and requests in one worker process. To achieve this, NGINX works with sockets in a non‑blocking mode and uses efficient methods such as epoll and kqueue.<br>核心词：<code>异步，事件驱动，链接控制</code></p>
</blockquote>
<p>解释的很清楚，<code>nginx并不是通过每个请求都创建线程，而是通过内部管理的调度分配</code>。<br>如下图：此处不翻译了，大家直接看原版<br>epoll详解：<a href="http://man7.org/linux/man-pages/man7/epoll.7.html" target="_blank" rel="external">【跳转】</a></p>
<p><a href="http://cuihuan.net/wp_content/new/nginx1/nginx_task.png"><img src="http://cuihuan.net/wp_content/new/nginx1/nginx_task.png" alt="nginx 任务基本框架"></a></p>
<h4 id="3-4-2-线程池"><a href="#3-4-2-线程池" class="headerlink" title="3.4.2 线程池"></a>3.4.2 线程池</h4><p>官方说明</p>
<blockquote>
<p>Let’s return to our poor sales assistant who delivers goods from a faraway warehouse. But he has become smarter (or maybe he became smarter after being beaten by the crowd of angry clients?) and hired a delivery service. Now when somebody asks for something from the faraway warehouse, instead of going to the warehouse himself, he just drops an order to a delivery service and they will handle the order while our sales assistant will continue serving other customers. Thus only those clients whose goods aren’t in the store are waiting for delivery, while others can be served immediately.</p>
</blockquote>
<p>小拽认为简而言之：<code>结合实际情况，除了空闲被动给，更多的通过事件驱动主动要</code>，通过这种方式在执行资源紧缺的情况下，达到一个执行资源的优化部署，如下图。<br><a href="http://cuihuan.net/wp_content/new/nginx1/nginx_task2.png"><img src="http://cuihuan.net/wp_content/new/nginx1/nginx_task2.png" alt="nginx 任务基本框架"></a><br>线程池官网详解：<a href="https://www.nginx.com/blog/thread-pools-boost-performance-9x/" target="_blank" rel="external">【跳转】</a></p>
<h4 id="3-4-3-事件调度"><a href="#3-4-3-事件调度" class="headerlink" title="3.4.3 事件调度"></a>3.4.3 事件调度</h4><p>请求的具体调度基于事件，例如网络IO,磁盘IO,定时器等均可以对事件进行阻塞，当阻塞的事件空闲时，发出调度请求，完成处理。<br>需要额外提一下，<code>nginx的定时器基于rbtree，红黑树的快速插入和查询保证了nginx事件调度的高效性</code><br>事件框架的处理模型<br><a href="http://cuihuan.net/wp_content/new/nginx1/nginx_event_.png"><img src="http://cuihuan.net/wp_content/new/nginx1/nginx_event_.png" alt="nginx 事件"></a><br><a href="http://cuihuan.net/wp_content/new/nginx1/nginx_epoll.png"><img src="http://cuihuan.net/wp_content/new/nginx1/nginx_epoll.png" alt="nginx epoll"></a></p>
<h2 id="四、简单总结"><a href="#四、简单总结" class="headerlink" title="四、简单总结"></a>四、简单总结</h2><ul>
<li>性能：nginx 工作模式是master-worker进程方式，执行请求是有更轻量线程完成。</li>
<li>热加载：nginx 替换非更新的方式是nginx热加载的本质</li>
<li>功能强大：nginx upstream是在线程层面调度，兼容多种，所以可以扩展很多功能强大</li>
<li>处理流程：主要的流程过程和模块分离清晰。</li>
<li>请求处理：通过自身的管理，线程池，异步事件驱动等当来完成任务调度</li>
</ul>
<p>再次强调：初探nginx，有疑问或不准确的地方，请直接开炮！！！</p>
<h2 id="五、参考文章"><a href="#五、参考文章" class="headerlink" title="五、参考文章"></a>五、参考文章</h2><ul>
<li>netcraft：<a href="https://news.netcraft.com/archives/2017/01/12/january-2017-web-server-survey.html" target="_blank" rel="external">https://news.netcraft.com/archives/2017/01/12/january-2017-web-server-survey.html</a></li>
<li>nginx的线程调度设计：<a href="https://www.nginx.com/blog/inside-nginx-how-we-designed-for-performance-scale/" target="_blank" rel="external">https://www.nginx.com/blog/inside-nginx-how-we-designed-for-performance-scale/</a></li>
<li>epoll详述：<a href="http://man7.org/linux/man-pages/man7/epoll.7.html" target="_blank" rel="external">http://man7.org/linux/man-pages/man7/epoll.7.html</a></li>
<li><a href="http://yaocoder.blog.51cto.com/2668309/888374" target="_blank" rel="external">http://yaocoder.blog.51cto.com/2668309/888374</a></li>
<li>线程池：<a href="https://www.nginx.com/blog/thread-pools-boost-performance-9x/" target="_blank" rel="external">https://www.nginx.com/blog/thread-pools-boost-performance-9x/</a></li>
</ul>
<p>【转载请注明：<a href="http://cuihuan.net/2017/03/14/nginx_study_1/">【【nginx学习一】基本原理学习 </a> | <a href="http://cuihuan.net">靠谱崔小拽</a> 】</p>

      
    </div>

    <div>
      
        
<div id="wechat_subscriber" style="display: block; padding: 10px 0; margin: 20px auto; width: 100%; text-align: center">
    <img id="wechat_subscriber_qcode" src="/wp_content/base/qrcode.jpg" alt="崔小拽 wechat" style="width: 200px; max-width: 100%;"/>
    <div>欢迎您扫一扫上面的微信公众号，订阅小拽的博客！</div>
</div>


      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        
  <ul class="post-copyright">
    <li class="post-copyright-author">
      <strong>本文作者:</strong>
      崔小拽
    </li>
    <li class="post-copyright-link">
      <strong>本文链接:</strong>
      <a href="http://cuihuan.net/2017/03/14/nginx_study_1/" title="【nginx学习一】基本原理学习">http://cuihuan.net/2017/03/14/nginx_study_1/</a>
    </li>
    <li class="post-copyright-license">
      <strong>版权声明: </strong>
      本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
    </li>
  </ul>


      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/nginx/" rel="tag"># nginx</a>
          
            <a href="/tags/基本原理/" rel="tag"># 基本原理</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/02/05/redis3/" rel="next" title="【redis学习三】简单高可用redis架构实践">
                <i class="fa fa-chevron-left"></i> 【redis学习三】简单高可用redis架构实践
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/06/05/CodeIgniter 性能优化/" rel="prev" title="CodeIgniter 性能优化">
                CodeIgniter 性能优化 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
        <div class="comments" id="comments">
        </div>
      
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/wp_content/base/cuihuan_title.jpg"
               alt="崔小拽" />
          <p class="site-author-name" itemprop="name">崔小拽</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
           
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/">
                <span class="site-state-item-count">51</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">95</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/cuihuan" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#一、nginx现状"><span class="nav-number">1.</span> <span class="nav-text">一、nginx现状</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二、nginx的特点"><span class="nav-number">2.</span> <span class="nav-text">二、nginx的特点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#三、nginx的核心机制"><span class="nav-number">3.</span> <span class="nav-text">三、nginx的核心机制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-运行方式"><span class="nav-number">3.1.</span> <span class="nav-text">3.1 运行方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-进程管理"><span class="nav-number">3.2.</span> <span class="nav-text">3.2 进程管理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-1-配置热加载"><span class="nav-number">3.2.1.</span> <span class="nav-text">3.2.1 配置热加载</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-2-版本更新热加载"><span class="nav-number">3.2.2.</span> <span class="nav-text">3.2.2 版本更新热加载</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-处理流程和模块"><span class="nav-number">3.3.</span> <span class="nav-text">3.3 处理流程和模块</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-1-worker处理过程"><span class="nav-number">3.3.1.</span> <span class="nav-text">3.3.1 worker处理过程</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-请求管理"><span class="nav-number">3.4.</span> <span class="nav-text">3.4 请求管理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-4-1-任务调度"><span class="nav-number">3.4.1.</span> <span class="nav-text">3.4.1 任务调度</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-4-2-线程池"><span class="nav-number">3.4.2.</span> <span class="nav-text">3.4.2 线程池</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-4-3-事件调度"><span class="nav-number">3.4.3.</span> <span class="nav-text">3.4.3 事件调度</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#四、简单总结"><span class="nav-number">4.</span> <span class="nav-text">四、简单总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#五、参考文章"><span class="nav-number">5.</span> <span class="nav-text">五、参考文章</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2015 - 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">崔小拽</span>
</div>



        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>


        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  






  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>

  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'iE7N63O9zgzx0uEfvjf9zjvc-gzGzoHsz',
        appKey: '8tHCueQDE7VSeDSDqywhCFwf',
        placeholder: 'Just go go',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>


  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === '') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  

  

  

</body>
</html>
